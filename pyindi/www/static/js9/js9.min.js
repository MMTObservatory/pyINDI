var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var c=0;return function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var c="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return c?c.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var c,b=[];!(c=a.next()).done;)b.push(c.value);return b};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.from",function(a){return a?a:function(a,b,d){b=null!=b?b:function(a){return a};var c=[],f="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if("function"==typeof f){a=f.call(a);for(var h=0;!(f=a.next()).done;)c.push(b.call(d,f.value,h++))}else for(f=a.length,h=0;h<f;h++)c.push(b.call(d,a[h],h));return c}},"es6","es3");
$jscomp.polyfill("Math.asinh",function(a){return a?a:function(a){a=Number(a);if(0===a)return a;var b=Math.log(Math.abs(a)+Math.sqrt(a*a+1));return 0>a?-b:b}},"es6","es3");$jscomp.polyfill("Math.sinh",function(a){if(a)return a;var c=Math.exp;return function(a){a=Number(a);return 0===a?a:(c(a)-c(-a))/2}},"es6","es3");$jscomp.polyfill("Math.sign",function(a){return a?a:function(a){a=Number(a);return 0===a||isNaN(a)?a:0<a?1:-1}},"es6","es3");
$jscomp.polyfill("Object.is",function(a){return a?a:function(a,b){return a===b?0!==a||1/a===1/b:a!==a&&b!==b}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,b){var c=this;c instanceof String&&(c=String(c));var e=c.length;b=b||0;for(0>b&&(b=Math.max(b+e,0));b<e;b++){var f=c[b];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,c,b){if(null==a)throw new TypeError("The 'this' value for String.prototype."+b+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,b){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,b||0)}},"es6","es3");
$jscomp.polyfill("Number.isNaN",function(a){return a?a:function(a){return"number"===typeof a&&isNaN(a)}},"es6","es3");$jscomp.findInternal=function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(c.call(b,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,c){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(b){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(b||"")+"_"+c++,b)}var c=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,c){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var b=0,d={next:function(){if(b<a.length){var e=b++;return{value:c(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,b){var c=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var e=c.length,f=a.length;b=Math.max(0,Math.min(b|0,c.length));for(var h=0;h<f&&b<e;)if(c[b++]!=a[h++])return!1;return h>=f}},"es6","es3");$jscomp.polyfill("Number.parseFloat",function(a){return a||parseFloat},"es6","es3");$jscomp.polyfill("Math.log10",function(a){return a?a:function(a){return Math.log(a)/Math.LN10}},"es6","es3");var Module;
"object"!==typeof Module&&(Module={});
var JS9=function(){var a={NAME:"JS9",VERSION:"3.1",COPYRIGHT:"Copyright (c) 2012-2020 Smithsonian Institution",DEFID:"JS9",WIDTH:512,HEIGHT:512,ANON:"Anonymous",PREFSFILE:"js9Prefs.json",WORKERFILE:"js9worker.js",ZINDEX:0,SHAPEZINDEX:4,MESSZINDEX:80,BTNZINDEX:90,MENUZINDEX:1E3,COLORSIZE:1024,SCALESIZE:16384,INVSIZE:1024,HISTSIZE:16384,INSTALLDIR:"",TOROOT:"",PLUGINS:"",LIGHTWIN:"dhtml",ANTIALIAS:!1,SCALEIREG:!0,NOMOVE:3,DBLCLICK0:5,DBLCLICK:300,TIMEOUT:250,SPINOUT:250,SUPERMENU:/^SUPERMENU_/,RESIZEDIST:20,
RESIZEFUDGE:5,RAWID0:"raw0",RAWIDX:"alt",IDFMT:"  (%s)",MINZOOM:.125,MAXZOOM:32,ADDZOOM:.1,CHROMEFILEWARNING:!0,CLIPBOARDERROR:"the local clipboard (which only holds data copied from within JS9) does not contain any content. Were you trying to paste something copied outside JS9?",CLIPBOARDERROR2:"the local clipboard (which only holds data copied from within JS9) does not contain any regions",URLEXP:/^(https?|ftp):\/\//,WCSEXP:/^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/};a.TOUCHSUPPORTED=
window.hasOwnProperty("ontouchstart")||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;a.BROWSER=function(){var a=navigator.platform,b=navigator.appName,d=navigator.userAgent,e=d.match(/version\/([.\d]+)/i),f=d.match(/(opera|chrome|safari|firefox)\/?\s*(\.?\d+(\.\d+)*)/i);f&&null!==e&&(f[2]=e[1]);f=f?[f[1],f[2],a]:[b,navigator.appVersion,"-?",a];f.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(d)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints);return f}();a.PIXEL_RATIO=
function(){var a=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1)}();a.globalOpts={helperType:"none",helperPort:2718,requireHelper:!1,allinoneHelper:!1,processQueryParams:!0,requireFits2Fits:!1,quietReturn:!1,useWasm:!0,allowFileWasm:!0,transforms:["flip","rot90","rotate"],rotateRelative:!1,clickToFocus:!0,winType:"light",
sortPreloads:!0,defcolor:"#00FF00",pngisfits:!0,fits2fits:"never",fits2png:!1,localAccess:!0,prependJS9Dir:!0,dataDir:null,alerts:!0,valposTarget:null,valposWidth:"medium",valposDCoords:!1,internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,wcsCrosshair:!1,localLoadFormat:"image",remoteLoadMethod:"proxy",csvIncludeWCS:!0,regWhichDefault:"auto",regIncludeJSON:!0,regIncludeComments:!0,regListDCoords:!1,regSaveDCoords:!1,regExpandDCoords:!1,regCopyDCoords:!0,regArrowCrosshair:!0,regSaveWCS:"",
regSaveFormat:"reg",regSaveWhich1:"all",regSaveWhich2:"selected",regMenuCreate:!0,regMenuSelection:"circle",regToClipboard:!1,regDisplay:"lightwin",reConfigSize:"medium",htimeout:1E4,lhtimeout:1E4,ehtimeout:500,ehretries:20,xtimeout:6E5,extlist:"EVENTS STDEVT",imopts:"IMOPTS",imcmap:"IMCMAP",table:{xdim:4096,ydim:4096,bin:1},image:{xdim:4096,ydim:4096,bin:1},binMode:"s",reprojSwitches:"",reprojectLimits:!1,rotationCenter:"file",runOnCR:!0,clearImageMemory:"heap",helperProtocol:location.protocol,reloadRefresh:!1,
reloadRefreshReg:!0,nextImageMask:!1,panWithinDisplay:!1,pannerDirections:!0,magnifierRegions:!0,svgBorder:!0,unremoveReg:100,resetEmptyShapeId:!1,maxMemory:2E9,loadURL:"params/load.html",corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,imsectionURL:"params/imsection.html",postMessage:!1,localStorage:!0,waitType:"spinner",spinColor:"#FF0000",spinOpacity:.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,logoDisplay:!1,lightWinPos:"center=1",lightWinClose:"ask",fallbackDisplay:!0,
refreshDragDrop:!0,reduceMosaic:"js9",internalRegcnts:!0,reduceRegcnts:!0,plot3d:{cube:"*:*:all",mode:"avg",areaunits:"pixels",color:"green"},imexamLineHeight:1,copyWcsPosFormat:"$ra $dec $sys",floatPrecision:6,mouseActions:["display value/position","change contrast/bias","pan the image"],touchActions:["display value/position","change contrast/bias","pan the image"],keyboardActions:{a:"add last region selected in regions menu",b:"toggle selected region: source/background",c:"toggle crosshair",d:"send selected region to back",
e:"toggle selected region: include/exclude","M-e":"edit selected region(s)",i:"refresh image",I:"display full image","M-i":"display selected cutouts","M-k":"toggle keyboard actions plugin",l:"toggle active shape layers","M-l":"new JS9 light window",m:"pan to mouse position","M-m":"toggle mouse/touch plugin","M-o":"open local file",P:"paste regions from local clipboard",p:"paste regions to current position","M-,":"toggle preferences plugin","M-p":"toggle preferences plugin",r:"copy region(s) to clipboard",
s:"select region",S:"select all regions","M-s":"toggle shape layers plugin",u:"undo remove of region(s)",x:"flip image around x axis",y:"flip image around y axis",9:"rotate image by 90 degrees","/":"copy wcs position to clipboard","?":"copy value and position to clipboard",0:"reset zoom","=":"zoom in","+":"zoom in","-":"zoom out","^":"raise region layer to top",">":"display next image","<":"display previous image","delete":"remove selected region",leftArrow:"move region/position left",upArrow:"move region/position up",
rightArrow:"move region/position right",downArrow:"move region/position down"},mousetouchZoom:!1,metaClickPan:!0,statusBar:"$colorbar; $colormap; $mag; $scale ($scalemin,$scalemax); $wcssys; $image0",toolbarTooltips:!1,updateTitlebar:!0,centerDivs:["JS9Menubar"],resizeDivs:["JS9Menubar","JS9Colorbar","JS9Toolbar","JS9Statusbar"],pinchWait:8,pinchThresh:6,xeqPlugins:!0,extendedPlugins:!0,intensivePlugins:!1,dynamicSelect:"click",dynamicHighlight:!0,corsProxy:"https://js9.si.edu/cgi-bin/CORS-proxy.cgi",
simbadProxy:"https://js9.si.edu/cgi-bin/simbad-proxy.cgi",catalogs:{ras:["RA","_RAJ2000","RAJ2000"],decs:["Dec","_DEJ2000","DEJ2000"],shape:"circle",color:"yellow",width:7,height:7,radius:3.5,r1:5,r2:3.5,wcssys:"ICRS",skip:"#\n",save:!0,tooltip:"$data.ra $data.dec"},topColormaps:"grey heat cool turbo viridis magma sls red green blue".split(" "),infoBox:"file object wcsfov wcscen wcspos impos physpos value regions progress".split(" "),infoBoxResize:!0,menuBar:"file edit view zoom scale color region wcs analysis help".split(" "),
menubarStyle:"classic",menuPosition:"right-5 bottom-5",menuClickEvent:"mouseup",menuSelected:"check",menuImages:!0,userMenus:!1,userMenuDivider:"&nbsp;&nbsp;&nbsp;",imagesFileSubmenu:5,toolBar:"annulus box circle ellipse line polygon text zoom+ zoom- zoom1 zoomtofit".split(" "),syncOps:"alignment colormap contrastbias flip pan regions rotate rot90 scale wcs zoom".split(" "),syncReciprocate:!0,syncWCS:!0,hiddenPluginDivs:[],separate:{layout:"auto",leftMargin:10,topMargin:10},imageTemplates:".fits,.fts,.png,.jpg,.jpeg,.fz,.ftz,.gz",
wcsUnits:{FK4:"sexagesimal",FK5:"sexagesimal",ICRS:"sexagesimal",galactic:"degrees",ecliptic:"degrees",linear:"degrees",physical:"pixels",image:"pixels"},wcsSetUpdatesDef:!0,regTemplates:".reg",sessionTemplates:".ses,.js9ses",colormapTemplates:".cmap",catalogTemplates:".cat,.tab",localTemplates:".fits,.fts",controlsMatchRegion:!1,internalColorPicker:!0,newWindowWidth:530,newWindowHeight:625,debug:0};a.favorites={scales:["linear","log","histeq"],colormaps:["cool","heat","viridis","magma"],regions:["annulus",
"box","circle","ellipse"],wcs:["FK5","ICRS","galactic:Galactic","physical","image"]};a.desktopOpts={currentPath:!0,sessionPath:!0};a.imageOpts={inherit:!1,contrast:1,bias:.5,invert:!1,exp:1E3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",scalemin:Number.NaN,scalemax:Number.NaN,flip:"none",rot90:0,rotate:0,zscalecontrast:.25,zscalesamples:600,zscaleline:120,wcssys:"native",lcs:"physical",valpos:!0,sigma:"none",opacity:1,alpha:255,nancolor:"#000000",nocolor:{red:0,green:0,blue:0,alpha:0},
zoom:1,zooms:6,topZooms:2,wcsalign:!0,rotationMode:"relative",crosshair:!1,disable:[],ltvbug:!1,listonchange:!1,whichonchange:"selected"};a.regionOpts={};a.catalogOpts={};a.crosshairOpts={};a.gridOpts={};a.emscriptenOpts={};a.blendOpts={active:!0,mode:"screen",opacity:1};a.maskOpts={active:!1,mode:"overlay",opacity:1,vopacity:0,value:0,syncops:["flip","pan","rot90","zoom"],invert:!1};a.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",fpathURL:"params/filepath.html"};a.lightOpts=
{nclick:0,dhtml:{topid:"#dhtmlwindowholder",top:".dhtmlwindow",drag:".drag-contentarea",dragBar:".drag-handle",format:"width=%spx,height=%spx,resize=%s,scrolling=0",textWin:"width=830px,height=400px,resize=1,scrolling=1",plotWin:"width=830px,height=420px,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,resize=1,scrolling=1",lcloseWin:"width=512px,height=190px,resize=1,scrolling=1",paramWin:"width=830px,height=235px,resize=1,scrolling=1",regWin0:"width=640px,height=130px,resize=1,scrolling=1",
regWin1:"width=640px,height=200px,resize=1,scrolling=1",regWin:"width=640px,height=470px,resize=1,scrolling=1",imageWin:"width=512px,height=598px,resize=1,scrolling=1",lineWin:"width=400px,height=60px,resize=1,scrolling=1"},lcloseURL:"params/lightclose.html"};a.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"};a.helpOpts={user:{heading:"JS9Help",type:"help",url:"user.html",title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},webpage:{heading:"JS9Help",
type:"help",url:"webpage.html",title:"Adding JS9 to a Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data to a Web Page"},localtasks:{heading:"JS9Help",type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},publicapi:{heading:"JS9Help",
type:"help",url:"publicapi.html",title:"The JS9 Public API"},extmsg:{heading:"JS9Help",type:"help",url:"extmsg.html",title:"External Messaging"},desktop:{heading:"JS9Help",type:"help",url:"desktop.html",title:"JS9 on the Desktop"},python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},archives:{heading:"JS9Help",type:"help",url:"archives.html",title:"Accessing Data Archives"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",title:"Setting Site Preferences"},
regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},repfile:{heading:"JS9Help",type:"help",url:"repfile.html",title:"Dealing with Large Files"},memory:{heading:"JS9Help",type:"help",url:"memory.html",title:"Dealing with Memory Limitations"},issues:{heading:"JS9Help",type:"help",url:"knownissues.html",title:"Known Issues"}};a.images=[];a.displays=[];a.colormaps=[];a.commands=[];a.plugins=
[];a.preloads=[];a.auxFiles=[];a.supermenus=[];a.preloadwaiting=[];a.publics={};a.helper={};a.fits={};a.userOpts={};a.scales="linear log histeq power sqrt squared asinh sinh".split(" ");a.wcssyss="FK4 FK5 ICRS galactic ecliptic physical image native".split(" ");a.wcsunitss=["degrees","sexagesimal","pixels"];a.regions="annulus box circle cross ellipse line point polygon text".split(" ");a.bugs={};a.bugs.hide_menu=!1;"Firefox"===a.BROWSER[0]&&0<=a.BROWSER[2].search(/Linux/)&&(a.bugs.firefox_linux=!0);
"Safari"===a.BROWSER[0]&&(a.bugs.webkit_resize=!0);/iPad|iPhone|iPod/.test(navigator.platform)&&/11_2_(?:[2-9])/.test(navigator.userAgent)&&(a.globalOpts.useWasm=!1);a.BROWSER[3]&&(a.globalOpts.maxMemory=Math.min(a.globalOpts.maxMemory,35E7),a.globalOpts.table.xdim=2048,a.globalOpts.table.ydim=2048,a.globalOpts.image.xdim=2048,a.globalOpts.image.ydim=2048,a.imageOpts.crosshair=!1,a.globalOpts.reproj={xdim:2048,ydim:2048},a.lightOpts.dhtml.regWin0="width=660px,height=130px,resize=1,scrolling=1",a.lightOpts.dhtml.regWin1=
"width=660px,height=200px,resize=1,scrolling=1",a.lightOpts.dhtml.regWin="width=660px,height=470px,resize=1,scrolling=1");window.hasOwnProperty("Jupyter")&&(a.globalOpts.useWasm=!1);window.electron&&("Chrome"===a.BROWSER[0]&&66<=parseFloat(a.BROWSER[1])&&(a.globalOpts.allowFileWasm=!0),window.electron.hostFS&&(a.hostFS=window.electron.hostFS),window.electron.multiElectron&&(a.globalOpts.localStorage=!1),window&&"function"===typeof window.eval&&(window.eval=function(){throw Error("For security reasons, Desktop JS9 does not support window.eval()");
}));a.Image=function(c,b,d){var e=this,f=null,h=0,g=0,k=function(b){b=b||{};a.isNull(b.scaleclipping)?"zscale"===e.params.scaleclipping?e.zscale(!0):"zmax"===e.params.scaleclipping&&e.zscale("zmax"):"zscale"===b.scaleclipping?e.zscale(!0):"zmax"===b.scaleclipping&&e.zscale("zmax");a.notNull(b.scalemin)&&(e.params.scalemin=b.scalemin);a.notNull(b.scalemax)&&(e.params.scalemax=b.scalemax)},l=function(b){var c=a.globalOpts.imopts,d=a.globalOpts.imcmap,g=a.globalOpts.alerts;var h=/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;
a.images.push(e);e.display.clearMessage();e.displayImage("all",f);e.notifyHelper();e.showShapeLayer("regions",!0,{local:!0});f&&((a.notNull(f.x)&&a.notNull(f.y)||a.notNull(f.px)&&a.notNull(f.py)||a.notNull(f.ra)&&a.notNull(f.dec)||a.notNull(f.wcs))&&e.setPan(f),f.regions&&(f.regions.match(h)?e.addShapes("regions",f.regions):a.LoadRegions(f.regions,{display:e.display})));a.globalOpts.alerts=!1;if(e.raw&&e.raw.header&&e.raw.header[d]){try{var k=JSON.parse(e.raw.header[d])}catch(z){k=null}if(k)try{a.AddColormap(k)}catch(z){}}if(e.raw&&
e.raw.header&&e.raw.header[d+"1"]){var l=1;for(h="";100>l;l++){var m=d+String(l);if(e.raw.header[m])h+=e.raw.header[m];else break}if(h){try{k=JSON.parse(h)}catch(z){k=null}if(k)try{a.AddColormap(k)}catch(z){}}}if(e.raw&&e.raw.header&&e.raw.header[c]){try{k=JSON.parse(e.raw.header[c])}catch(z){k=null}if(k)try{e.setParam("all",k)}catch(z){}}if(e.raw&&e.raw.header&&e.raw.header[c+"1"]){l=1;for(h="";100>l;l++)if(m=c+String(l),e.raw.header[m])h+=e.raw.header[m];else break;if(h){try{k=JSON.parse(h)}catch(z){k=
null}if(k)try{e.setParam("all",k)}catch(z){}}}a.globalOpts.alerts=g;e.xeqPlugins("image","onimageload");e.setStatus("load","complete");a.waiting(!1);if(b)try{a.xeqByName(b,window,e)}catch(z){a.error("in image onload callback",z,!1)}if(a.preloadwaiting&&a.preloadwaiting.length){var n=a.preloadwaiting.length;b=e.proxyURL||e.file;for(k=l=0;l<n;l++){var p=a.preloadwaiting[l];b.match(p.id)||p.id.match(b)?(p.loaded=!0,p.im=e):!1===p.loaded&&k++}if(!k){a.globalOpts.sortPreloads?(a.images.sort(function(b,
c){var d=0,e=0;for(l=0;l<n;l++)p=a.preloadwaiting[l],b.id===p.im.id&&(d=l),c.id===p.im.id&&(e=l);return d-e}),b=a.preloadwaiting[n-1].im||e,b.displayImage()):b=e;if(a.notNull(a.globalOpts.onpreload))try{a.xeqByName(a.globalOpts.onpreload,window,b)}catch(z){a.error("in onpreload callback",z,!1)}finally{delete a.globalOpts.onpreload}a.preloadwaiting=[]}}f&&f.allext&&e.hdus&&0<e.hdus.length&&e.displayExtension("all")};if(b)if("object"===typeof b){if(f=b,f.display)var m=f.display}else m=b;m||(m=0<a.displays.length?
a.displays[0].id:a.DEFID);this.type="image";this.display=a.lookupDisplay(m);this.params={};this.regstack=[];this.tmp={};this.params.xeqonchange=!0;this.params=$.extend(!0,this.params,a.imageOpts,f);this.display.image&&(this.params.inherit=this.display.image.params.inherit,this.params.inherit&&(this.params=$.extend(!0,this.params,this.display.image.params)));b=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.setColormap(this.params.colormap);a.globalOpts.xeqPlugins=b;this.displayMode=!0;this.clickState=
0;this.clickInRegion=!1;this.clickInLayer=null;this.queried=!1;f&&f.proxyFile&&(this.proxyFile=f.proxyFile);f&&f.proxyURL&&(this.proxyURL=f.proxyURL);f&&f.parentFile&&(this.parentFile=f.parentFile);if(f&&f.parent&&(this.parent=f.parent,this.parent.cardstr&&this.parent.ncard)){this.parent.raw={header:{},history:[],comments:[]};for(b=0;b<this.parent.ncard;b++)m=this.parent.cardstr.slice(80*b,80*(b+1)),m=a.cardpars(m),void 0!==m&&("HISTORY"===m[0]?this.parent.raw.header[m[0]+"__"+h++]=m[1]:"COMMENT"===
m[0]?this.parent.raw.header[m[0]+"__"+g++]=m[1]:this.parent.raw.header[m[0]]=m[1]);this.parent.lcs={};a.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)}f&&f.id&&(this.id=f.id);this.iy=this.ix=0;this.png={};this.png.image=new Image;this.status={};this.rgb={};this.rgb.sect={zoom:1,ozoom:1};this.layers={};this.zlayer=a.SHAPEZINDEX;this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.raws=[];this.blend=$.extend(!0,{},a.blendOpts);this.mask=$.extend(!0,{},a.maskOpts);if(c)switch(a.waiting(!0,
this.display),typeof c){case "object":this.source=f.source||"fits";this.mkRawDataFromHDU(c,$.extend({},{file:c.filename},f));k(f);if(this.params.zoom){var n=this.parseZoom(this.params.zoom);this.rgb.sect.zoom=n;this.rgb.sect.ozoom=n}this.mkSection();f&&f.rgbFile?(this.rgbFile=f.rgbFile,$(this.png.image).on("load",function(){if(e.png.image.width!==e.raw.width||e.png.image.height!==e.raw.height){var b=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",e.png.image.width,e.png.image.height,e.raw.width,
e.raw.height);a.error(b)}e.mkOffScreenCanvas();l(d)}).on("error",function(){a.waiting(!1);a.error("could not load image: "+e.id)}),this.png.image.src=this.rgbFile):l(d);break;case "string":this.source=f.source||"fits2png";this.imtab="image";this.file=a.cleanPath(c);this.id0=this.file.split("/").reverse()[0];this.id=a.getImageID(this.id0,this.display.id);this.setStatus("load","loading");$(this.png.image).on("load",function(){e.mkOffScreenCanvas();e.mkRawDataFromPNG();e.params.zoom&&(n=e.parseZoom(e.params.zoom),
e.rgb.sect.zoom=n,e.rgb.sect.ozoom=n);k(f);e.mkSection();l(d);a.DEBUG&&a.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",e.file,e.raw.width,e.raw.height,e.raw.dmin,e.raw.dmax)}).on("error",function(){a.waiting(!1);a.error("could not load image: "+e.id)});this.png.image.src=c;break;default:a.error("unknown specification type for Load: "+typeof c)}};a.Image.prototype.getImageData=function(a){var b=null,c=this.fileDimensions(),e=c.xdim;c=c.ydim;if(a)if("array"===a)b=Array.from(this.raw.data);else if("base64"===
a){b="";var f=new Uint8Array(this.raw.data.buffer),h=f.byteLength;for(a=0;a<h;a++)b+=String.fromCharCode(f[a]);b=window.btoa(b)}else a&&"false"!==a&&(b=this.raw.data);return{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,bin:this.binning.bin,header:this.raw.header,hdus:this.hdus,dwidth:this.display.width,dheight:this.display.height,fwidth:e,fheight:c,data:b}};a.Image.prototype.closeImage=function(c){var b,
d=!1;var e=a.images.length;var f=a.Dysel.getDisplayOr(this.display);c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(g){a.error("can't parse closeImage opts: "+c,g)}this.setStatus("close","closing");for(b=0;b<e;b++)a.images[b].wcsim===this&&(a.images[b].wcsim=null);for(b=0;b<e;b++)a.images[b].mask.im===this&&(a.images[b].mask.im=null,a.images[b].mask.active=!1);for(b=0;b<e;b++)if(this===a.images[b]){e=a.images[b];e===e.display.image&&(d=b+1);if(d)for(h in!1!==c.clear&&(e.display.clearMessage(),
e.display.context.clear()),e.layers)e.layers.hasOwnProperty(h)&&("main"===e.layers[h].dlayer.dtype||e.display===f)&&e.showShapeLayer(h,!1,{local:!0});e.xeqPlugins("image","onimageclose");d&&(e.display.image=null);switch(e.cmapObj.name){case "red":e.display.rgb.rim=null;break;case "green":e.display.rgb.gim=null;break;case "blue":e.display.rgb.bim=null}for(c=0;c<e.raws.length;c++){var h=e.raws[c];h.hdu&&h.hdu.fits&&(f=a.lookupVfile(h.hdu.fits.vfile),1>=f.length&&a.cleanupFITSFile(h,!0));h.altwcs&&this.freeWCS(h)}e.removeProxyFile();
e.rgb=null;e.offscreen=null;e.raw=null;e.colorData=null;e.colorCells=null;e.psColors=null;e.psInverse=null;a.images.splice(b,1);break}if(d){for(b=d-=2;0<=b;b--)if(e=a.images[b],this.display===e.display){e.displayImage("all");e.refreshLayers();d=a.images.length;break}for(b=a.images.length-1;b>d;b--)if(e=a.images[b],this.display===e.display){e.displayImage("all");e.refreshLayers();break}}};a.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=
document.createElement("canvas");this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);this.offscreen.context=this.offscreen.canvas.getContext("2d");a.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1);this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(c){a.CHROMEFILEWARNING&&"Chrome"===a.BROWSER[0]&&
""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this};a.Image.prototype.initLCS=function(c){var b=[[0,0,0],[0,0,0],[0,0,0]];c=c||this.raw.header;var d=c.CRPIX1||1,e=c.CRPIX2||1;if(c.LCSROTA2&&c.CROTA2){var f=-c.CROTA2*Math.PI/180;var h=Math.sin(f);var g=Math.cos(f);f=[[0,0,0],[0,0,0],[0,0,0]];f[0][0]=g;f[0][1]=
-h;f[0][2]=0;f[1][0]=h;f[1][1]=g;f[1][2]=0;(h=a.invertMatrix3(f))||(f=null)}b[0][0]=a.defNull(c.LTM1_1,1);b[1][0]=c.LTM2_1||0;b[0][1]=c.LTM1_2||0;b[1][1]=a.defNull(c.LTM2_2,1);b[2][0]=c.LTV1||0;b[2][1]=c.LTV2||0;if("image"===this.imtab&&this.params.ltvbug){if(a.notNull(c.LTV1))for(g=0;2>g;g++){var k=Math.abs(b[0][g]);0<k&&1>k&&(b[2][0]+=.5*k)}if(a.notNull(c.LTV2))for(g=0;2>g;g++)k=Math.abs(b[1][g]),0<k&&1>k&&(b[2][1]+=.5*k)}this.lcs.physical={forward:$.extend(!0,[],b),reverse:a.invertMatrix3(b)};
this.lcs.physical.reverse?f&&(this.lcs.physical.frot=$.extend(!0,[],f),this.lcs.physical.rrot=$.extend(!0,[],h),this.lcs.physical.cx=d-b[2][0]-1,this.lcs.physical.cy=e-b[2][1]-1):delete this.lcs.physical;b[0][0]=a.defNull(c.DTM1_1,1);b[1][0]=c.DTM2_1||0;b[0][1]=c.DTM1_2||0;b[1][1]=a.defNull(c.DTM2_2,1);b[2][0]=c.DTV1||0;b[2][1]=c.DTV2||0;this.lcs.detector={forward:$.extend(!0,[],b),reverse:a.invertMatrix3(b)};this.lcs.detector.reverse?f&&(this.lcs.detector.frot=$.extend(!0,[],f),this.lcs.detector.rrot=
$.extend(!0,[],h),this.lcs.detector.cx=d-b[2][0]-1,this.lcs.detector.cy=e-b[2][1]-1):delete this.lcs.detector;b[0][0]=a.defNull(c.ATM1_1,1);b[1][0]=c.ATM2_1||0;b[0][1]=c.ATM1_2||0;b[1][1]=a.defNull(c.ATM2_2,1);b[2][0]=c.ATV1||0;b[2][1]=c.ATV2||0;this.lcs.amplifier={forward:$.extend(!0,[],b),reverse:a.invertMatrix3(b)};this.lcs.amplifier.reverse?f&&(this.lcs.amplifier.frot=$.extend(!0,[],f),this.lcs.amplifier.rrot=$.extend(!0,[],h),this.lcs.amplifier.cx=d-b[2][0]-1,this.lcs.amplifier.cy=e-b[2][1]-
1):delete this.lcs.amplifier;this.params&&!this.lcs[this.params.lcs]&&(this.params.lcs="image");this.params&&!this.params.wcssys0&&(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs);this.lcs.physical&&!this.lcs.ophysical&&(this.lcs.ophysical=$.extend(!0,{},this.lcs.physical));return this};a.Image.prototype.mkRawDataFromIMG=function(c){var b,d;if(c){var e=c.height;var f=c.width;var h=c.data;this.raws.push({from:"img"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;this.raw.data=
new Float32Array(e*f);for(d=c=0;d<e;d++)for(b=0;b<f;b++){var g=.299*h[c]+.587*h[c+1]+.114*h[c+2];this.raw.data[(e-d)*f+b]=g;c+=4}this.raw.width=f;this.raw.height=e;this.raw.bitpix=-32;this.dataminmax();this.source="png";this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix};this.initWCS();this.initLCS();this.xeqPlugins("image","onrawdata");return this}};a.Image.prototype.mkRawDataFromPNG=function(){var c,b,d;var e=b=0;var f=[];var h=new ArrayBuffer(8);
var g=new Uint8Array(h),k=new DataView(h);if(!this.offscreen.img)return this;this.raws.push({from:"png"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;var l=this.offscreen.img.data;for(c=h=0;h<l.length&&0!==l[h];h++)if(255!==l[h]&&(f[c]=String.fromCharCode(l[h]),c++),15===c&&'{"js9Protocol":'!==f.join("")){var m=!0;break}if(15>c||m)this.mkRawDataFromIMG(this.offscreen.img);else{c=f.join("");2<a.DEBUG&&a.log("jsonHeader: %s",c);try{var n=JSON.parse(c)}catch(q){a.error("can't read FITS header from PNG file: "+
c,q)}if(1===n.js9Protocol)this.raw.header=n,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else for(this.raw.endian=n.js9Endian,this.raw.protocol=n.js9Protocol,this.raw.cardstr=n.cardstr,this.raw.ncard=n.ncard,this.raw.header={},n=this.raw.ncard,c=0;c<n;c++)m=this.raw.cardstr.slice(80*c,80*(c+1)),m=a.cardpars(m),void 0!==m&&("HISTORY"===m[0]?this.raw.header[m[0]+"__"+b++]=m[1]:"COMMENT"===m[0]?this.raw.header[m[0]+"__"+e++]=m[1]:this.raw.header[m[0]]=m[1]);
h+=1;this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:a.error("NAXIS1 missing from PNG-based FITS header");this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:a.error("NAXIS2 missing from PNG-based FITS header");this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:a.error("BITPIX missing from PNG-based FITS header");"little"===this.raw.endian?d=!0:"big"===this.raw.endian?d=!1:a.error("js9Endian missing from PNG-based FITS header");this.object=this.raw.header.OBJECT;
this.telescope=this.raw.header.TELESCOP;this.instrument=this.raw.header.INSTRUME;b=this.raw.width*this.raw.height;e=h%4;switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(b);for(c=0;c<b;c++){switch(e){case 0:var p=l[h];h+=1;e=1;break;case 1:p=l[h];h+=1;e=2;break;case 2:p=l[h];h+=2;e=0;break;case 3:p=l[h+1],h+=2,e=1}this.raw.data[c]=p}break;case 16:case -16:16===this.raw.bitpix?(this.raw.data=new Int16Array(b),n=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(b),n=DataView.prototype.getUint16);
for(c=0;c<b;c++){switch(e){case 0:g[0]=l[h];g[1]=l[h+1];p=n.call(k,0,d);h+=2;e=2;break;case 1:g[0]=l[h];g[1]=l[h+1];p=n.call(k,0,d);h+=3;e=0;break;case 2:g[0]=l[h];g[1]=l[h+2];p=n.call(k,0,d);h+=3;e=1;break;case 3:g[0]=l[h+1],g[1]=l[h+2],p=n.call(k,0,d),h+=3,e=2}this.raw.data[c]=p}break;case 32:case -32:32===this.raw.bitpix?(this.raw.data=new Int32Array(b),n=DataView.prototype.getInt32):(this.raw.data=new Float32Array(b),n=DataView.prototype.getFloat32);for(c=0;c<b;c++){switch(e){case 0:g[0]=l[h];
g[1]=l[h+1];g[2]=l[h+2];g[3]=l[h+4];p=n.call(k,0,d);h+=5;e=1;break;case 1:g[0]=l[h];g[1]=l[h+1];g[2]=l[h+3];g[3]=l[h+4];p=n.call(k,0,d);h+=5;e=2;break;case 2:g[0]=l[h];g[1]=l[h+2];g[2]=l[h+3];g[3]=l[h+4];p=n.call(k,0,d);h+=6;e=0;break;case 3:g[0]=l[h+1],g[1]=l[h+2],g[2]=l[h+3],g[3]=l[h+5],p=n.call(k,0,d),h+=6,e=1}this.raw.data[c]=p}break;case -64:this.raw.data=new Float64Array(b);for(c=0;c<b;c++){switch(e){case 0:case 4:g[0]=l[h];g[1]=l[h+1];g[2]=l[h+2];g[3]=l[h+4];g[4]=l[h+5];g[5]=l[h+6];g[6]=l[h+
8];g[7]=l[h+9];p=k.getFloat64(0,d);h+=10;e=2;break;case 1:case 5:g[0]=l[h];g[1]=l[h+1];g[2]=l[h+3];g[3]=l[h+4];g[4]=l[h+5];g[5]=l[h+7];g[6]=l[h+8];g[7]=l[h+9];p=k.getFloat64(0,d);h+=11;e=0;break;case 2:case 6:g[0]=l[h];g[1]=l[h+2];g[2]=l[h+3];g[3]=l[h+4];g[4]=l[h+6];g[5]=l[h+7];g[6]=l[h+8];g[7]=l[h+10];p=k.getFloat64(0,d);h+=11;e=1;break;case 3:case 7:g[0]=l[h+1],g[1]=l[h+2],g[2]=l[h+3],g[3]=l[h+5],g[4]=l[h+6],g[5]=l[h+7],g[6]=l[h+9],g[7]=l[h+10],p=k.getFloat64(0,d),h+=11,e=2}this.raw.data[c]=p}break;
default:a.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}this.dataminmax();this.offscreen.img=null;this.initWCS();this.initLCS();this.xeqPlugins("image","onrawdata");return this}};a.Image.prototype.mkRawDataFromHDU=function(c,b){var d=this,e,f,h,g;var k=g=0;b=b||{};if($.isArray(c)||a.isTypedArray(c)||c instanceof ArrayBuffer){$.isArray(c[0])&&(c=c.reduce(function(a,b){return a.concat(b)}));var l={image:c}}else"object"===typeof c?l=c:a.error("unknown or missing input for HDU creation");
l.data&&!l.image&&(l.image=l.data);l.image||a.error("data missing from JS9 FITS object: "+JSON.stringify(l));2>l.naxis&&a.error("can't image a FITS file with less than 2 dimensions");if(this.raw){var m=this.raw;var n=this.raw.width;var p=this.raw.height;var q=this.raw.bitpix;var r=this.params.wcssys;var v=this.params.wcsunits;this.freeWCS()}this.raws=this.raws||[];if(h=this.raws.length){b.rawid=b.rawid||a.RAWIDX;for(e=f=0;e<h;e++)if(b.rawid===this.raws[e].id){var w=this.raws[e].from;this.raws[e]=
{from:w,id:b.rawid};this.raw=this.raws[e];f++;break}f||(this.raws.push({from:"hdu",id:b.rawid}),this.raw=this.raws[h],m=null)}else this.raws.push({from:"hdu"}),this.raw=this.raws[h],this.raw.id=a.RAWID0;this.raw.hdu=l;l.axis?(this.raw.width=l.axis[1],this.raw.height=l.axis[2]):l.naxis1&&l.naxis2?(this.raw.width=l.naxis1,this.raw.height=l.naxis2):n&&p&&(this.raw.width=n,this.raw.height=p);l.bitpix?this.raw.bitpix=l.bitpix:q&&(this.raw.bitpix=q);if("base64"===l.encoding)for(w=window.atob(l.image),l.image=
new ArrayBuffer(w.length),f=new Uint8Array(l.image),e=0;e<w.length;e++)f[e]=w.charCodeAt(e);$.isArray(l.image[0])&&(l.image=l.image.reduce(function(a,b){return a.concat(b)}));switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(l.image);break;case 16:this.raw.data=new Int16Array(l.image);break;case -16:this.raw.data=new Uint16Array(l.image);break;case 32:this.raw.data=new Int32Array(l.image);break;case -32:this.raw.data=new Float32Array(l.image);break;case -64:this.raw.data=new Float64Array(l.image)}this.raw.card=
l.card;this.raw.cardstr=l.cardstr;this.raw.ncard=l.ncard;if(l.head)this.raw.header=l.head;else if(this.raw.card)for(this.raw.header={},f=this.raw.card.length,e=0;e<f;e++)h=a.cardpars(this.raw.card[e]),void 0!==h&&("HISTORY"===h[0]?this.raw.header[h[0]+"__"+g++]=h[1]:"COMMENT"===h[0]?this.raw.header[h[0]+"__"+k++]=h[1]:this.raw.header[h[0]]=h[1]);else if(this.raw.cardstr)for(this.raw.header={},f=this.raw.ncard,e=0;e<f;e++)h=this.raw.cardstr.slice(80*e,80*(e+1)),h=a.cardpars(h),void 0!==h&&("HISTORY"===
h[0]?this.raw.header[h[0]+"__"+g++]=h[1]:"COMMENT"===h[0]?this.raw.header[h[0]+"__"+k++]=h[1]:this.raw.header[h[0]]=h[1]);else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;e=this.raw.header;m||this.parentFile||this.parent||void 0===e.LTV1&&void 0===e.LTV2&&void 0===e.LTM1_1&&void 0===e.LTM2_2||(this.parent={},this.parent.raw={header:$.extend(!0,{},e)},this.parent.lcs=
{},a.Image.prototype.initLCS.call(this.parent,this.parent.raw.header));if("image"===l.imtab&&void 0!==l.x1&&1!==l.x1||void 0!==l.y1&&1!==l.y1||void 0===l.bin||1!==l.bin)g=a.defNull(l.x1,1),k=a.defNull(l.y1,1),f=l.bin||1,0>f&&(f=1/Math.abs(f)),a.notNull(e.NAXIS1)&&(e.NAXIS1/=f),a.notNull(e.NAXIS2)&&(e.NAXIS2/=f),a.notNull(e.CRPIX1)&&(e.CRPIX1=(e.CRPIX1+1-g-.5)/f+.5),a.notNull(e.CRPIX2)&&(e.CRPIX2=(e.CRPIX2+1-k-.5)/f+.5),a.notNull(e.CDELT1)&&(e.CDELT1*=f),a.notNull(e.CDELT2)&&(e.CDELT2*=f),a.notNull(e.CD1_1)&&
(e.CD1_1*=f),a.notNull(e.CD1_2)&&(e.CD1_2*=f),a.notNull(e.CD2_1)&&(e.CD2_1*=f),a.notNull(e.CD2_2)&&(e.CD2_2*=f),e.LTM1_1=a.defNull(e.LTM1_1,1),e.LTM1_1/=f,e.LTM2_1=e.LTM2_1||0,e.LTM2_1/=f,e.LTM1_2=e.LTM1_2||0,e.LTM1_2/=f,e.LTM2_2=a.defNull(e.LTM2_2,1),e.LTM2_2/=f,e.LTV1=e.LTV1||0,e.LTV1=(e.LTV1-g)/f+.5,e.LTV2=e.LTV2||0,e.LTV2=(e.LTV2-k)/f+.5;b.lcsUseRota2&&(e.LCSROTA2=!0);b.file&&b.file!==this.file?(this.file=b.file,this.id=null):b.filename&&b.filename!==this.file?(this.file=b.filename,this.id=null):
l.filename&&l.filename!==this.file&&(this.file=l.filename,this.id=null);this.file0=this.file=this.file||a.ANON+a.uniqueID();b.id&&(this.id0=b.id,this.id=a.getImageID(b.id,this.display.id,this));this.id||!this.file||this.file.match(/\[.*[^a-zA-Z0-9_].*\]/)||(b.extname||b.extnum?(b.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+b.extname+"]"):b.extnum&&0<b.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+b.extnum+"]"),l&&l.fits&&(b.extname&&(l.fits.extname=b.extname),
b.extnum&&0<b.extnum&&(l.fits.extnum=b.extnum))):l.fits?l.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+l.fits.extname+"]"):l.fits.extnum&&0<l.fits.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+l.fits.extnum+"]"):this.raw.header&&this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+="["+this.raw.header.EXTNAME+"]"));this.id||(this.id0=(this.parentFile||this.file).split("/").reverse()[0],this.id=a.getImageID(this.id0,this.display.id,
this));b.proxyFile&&(this.proxyFile=b.proxyFile);this.raw.filter=b.filter||"";this.imtab=l.imtab?l.imtab:l.table?"table":"image";this.raw.imtab=this.imtab;void 0!==l.dmin&&void 0!==l.dmax?this.dataminmax(l.dmin,l.dmax):this.dataminmax();this.object=this.raw.header.OBJECT;this.telescope=this.raw.header.TELESCOP;this.instrument=this.raw.header.INSTRUME;if(b.binstr)try{(w=b.binstr.split(/\s+/))&&2===w.length&&("table"===this.imtab&&l.table?(l.table.bin=parseFloat(w[0]),l.table.binMode=w[1]):(l.bin=parseFloat(w[0]),
l.binMode=w[1]))}catch(t){}this.binning.bin="table"===this.imtab&&l.table?l.table.bin||1:l.bin?0<l.bin?l.bin:1/Math.abs(l.bin):1;m||(this.binning.obin=this.binning.bin);this.initWCS();r&&this.setWCSSys(r);v&&this.setWCSUnits(v);this.initLCS();try{if(b.hdus)this.hdus=b.hdus;else if(this.parentFile&&a.helper.connected&&a.helper.js9helper)c={id:this.expandMacro("$id"),cmd:this.expandMacro("js9Xeq listhdus $filename"),image:this.file,fits:this.parentFile,rtype:"text"},a.helper.send("listhdus",c,function(a){if(!a.stderr&&
!a.errcode&&a.stdout)try{d.hdus=JSON.parse(a.stdout)}catch(u){d.hdus=null}});else if(this.raw&&this.raw.hdu&&this.raw.hdu.fits&&(w=a.listhdu(this.raw.hdu.fits.vfile)))try{this.hdus=JSON.parse(w)}catch(t){this.hdus=null}}catch(t){}if(this.raw.hdu.fits&&this.raw.hdu.fits.vfile){w=a.globalOpts.clearImageMemory;w=!1===w?["never"]:!0===w?["always"]:w.toLowerCase().split(/[,>]/);m=c=!1;e=0;for(b=!1;e<w.length&&!b;e++)switch(w[e]){case "never":c=!1;b=!0;break;case "always":b=c=!0;break;case "heap":m=!0;
break;case "auto":2>=this.raw.header.NAXIS&&(!this.hdus||1===this.hdus.length)?c=!0:(c=!1,b=!0);break;case "nocube":2>=this.raw.header.NAXIS?c=!0:(c=!1,b=!0);break;case "noext":this.hdus&&1!==this.hdus.length?(c=!1,b=!0):c=!0;break;case "size":w[e+1]?a.vsize(l.fits.vfile)>1E6*w[e+1]?c=!0:(c=!1,b=!0):(c=!1,b=!0)}c?(2<a.DEBUG&&a.log("removing underlying FITS vfile for %s: %s",this.id,this.raw.hdu.fits.vfile),a.cleanupFITSFile(this.raw,!0)):m&&(2<a.DEBUG&&a.log("freeing heap space for %s: %s",this.id,
this.raw.hdu.fits.vfile),a.cleanupFITSFile(this.raw,!1))}this.xeqPlugins("image","onrawdata");return this};a.Image.prototype.mkSection=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=this.rgb.sect;d.ozoom=d.zoom;switch(b.length){case 0:d.xcen=Math.floor(this.raw.width/2);d.ycen=Math.floor(this.raw.height/2);d.width=Math.min(this.raw.width,this.display.canvas.width);d.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:a.isNumber(b[0])||a.error("invalid input for generating section: "+
b[0]);d.zoom=parseFloat(b[0]);d.width=Math.min(this.raw.width*d.zoom,this.display.canvas.width);d.height=Math.min(this.raw.height*d.zoom,this.display.canvas.height);break;case 2:a.isNumber(b[0])&&a.isNumber(b[1])||a.error("invalid input for generating section: "+b[0]+" "+b[1]);d.xcen=parseFloat(b[0]);d.ycen=parseFloat(b[1]);a.notNull(d.ix)&&(d.width=Math.min(this.raw.width*d.zoom,this.display.canvas.width));a.notNull(d.iy)&&(d.height=Math.min(this.raw.height*d.zoom,this.display.canvas.height));break;
case 3:a.isNumber(b[0])&&a.isNumber(b[1])&&a.isNumber(b[2])||a.error("invalid input for generating section: "+b[0]+" "+b[1]+" "+b[2]),d.xcen=parseFloat(b[0]),d.ycen=parseFloat(b[1]),d.zoom=parseFloat(b[2]),d.width=Math.min(this.raw.width*d.zoom,this.display.canvas.width),d.height=Math.min(this.raw.height*d.zoom,this.display.canvas.height)}delete d.ix;delete d.iy;d.x0=d.xcen-d.width/(2*d.zoom);d.y0=d.ycen-d.height/(2*d.zoom);d.x1=d.xcen+d.width/(2*d.zoom);d.y1=d.ycen+d.height/(2*d.zoom);0>d.x0&&(a.globalOpts.panWithinDisplay?
d.x1-=d.x0:d.ix=d.x0*d.zoom,d.x0=0);0>d.y0&&(a.globalOpts.panWithinDisplay?d.y1-=d.y0:d.iy=d.y0*d.zoom,d.y0=0);d.x1>this.raw.width&&(a.globalOpts.panWithinDisplay?d.x0-=d.x1-this.raw.width:d.ix=(d.x1-this.raw.width)*d.zoom,d.x1=this.raw.width);d.y1>this.raw.height&&(a.globalOpts.panWithinDisplay?d.y0-=d.y1-this.raw.height:d.iy=(d.y1-this.raw.height)*d.zoom,d.y1=this.raw.height);0<d.ix&&0<d.x0&&(b=Math.min(d.ix,d.x0),d.x0-=b,d.ix+=b*d.zoom);0>d.ix&&d.x1<this.raw.width&&(b=Math.min(this.raw.width-d.x1,
Math.abs(d.ix)),d.x1+=b,d.ix-=b*d.zoom);0<d.iy&&0<d.y0&&(b=Math.min(d.iy,d.y0),d.y0-=b,d.iy+=b*d.zoom);0>d.iy&&d.y1<this.raw.height&&(b=Math.min(this.raw.height-d.y1,Math.abs(d.iy)),d.y1+=b,d.iy-=b*d.zoom);d.x0=Math.max(0,d.x0);d.x1=Math.min(this.raw.width,d.x1);d.y0=Math.max(0,d.y0);d.y1=Math.min(this.raw.height,d.y1);d.x0=Math.floor(d.x0);d.y0=Math.floor(d.y0);d.x1=Math.floor(d.x1);d.y1=Math.floor(d.y1);d.width=Math.ceil((d.x1-d.x0)*d.zoom);d.height=Math.ceil((d.y1-d.y0)*d.zoom);if(0>=d.width||
0>=d.height)b=sprintf("invalid image section: %s,%s [%s,%s, %s,%s, %s]",d.width,d.height,d.x0,d.y0,d.x1,d.y1,d.zoom),a.error(b);this.params.zoom=d.zoom;return this};a.Image.prototype.mkColorData=function(){var c,b=a.SCALESIZE,d=this.params.scalemin,e=this.params.scalemax,f=this.raw.width*this.raw.height,h=(b-1)/(e-d);if("static"===this.cmapObj.type)return this;if(!this.colorData||this.colorData.length<f)this.colorData=new Int32Array(f);var g=this.raw.data;var k=this.colorData;for(c=0;c<f;c++){var l=
g[c];k[c]=l<=d?0:l>=e?b-1:Math.floor((l-d)*h+.5)}return this};a.Image.prototype.calcContrastBias=function(c){var b=this.params.bias,d=a.COLORSIZE,e=this.params.contrast;if(1E-4>b-.5&&1E-4>e-1)return c;this.params.invert&&(b=1-b);c=Math.floor(((c/d-b)*e+.5)*d);return 0>c?0:c>=d?d-1:c};a.Image.prototype.mkColorCells=function(){var c,b=a.COLORSIZE;if("static"===this.cmapObj.type)return this;this.colorCells||(this.colorCells=[]);for(c=0;c<b;c++){var d=this.params.invert?b-c-1:c;d=this.calcContrastBias(d);
this.colorCells[c]=this.cmapObj.mkColorCell(d)}return this};a.Image.prototype.mkScaledCells=function(){var c,b;var d=a.COLORSIZE;var e=a.SCALESIZE,f=a.INVSIZE;var h=a.HISTSIZE;if(!this.colorCells||"static"===this.cmapObj.type)return this;if(!this.psColors){var g=this.psColors=[];var k=this.params.nancolor;var l=[];"#"===k.charAt(0)&&(k=k.slice(1));k=k.toUpperCase();for(c=b=0;6>b;b+=2,c++){var m="0123456789ABCDEF".indexOf(k.charAt(b));var n="0123456789ABCDEF".indexOf(k.charAt(b+1));l[c]=16*m+n}g[NaN]=
l}this.psInverse||(this.psInverse=[],this.psInverse[NaN]=0);k=this.params.scalemax-this.params.scalemin;b=this.params.scalemin;switch(this.params.scale){case "linear":for(g=0;g<e;g++)c=g/e,c=Math.floor(c*d),this.psColors[g]=this.colorCells[c];for(g=0;g<f;g++)c=g/f,this.psInverse[g]=c*k+b;break;case "log":h=this.params.exp;for(g=0;g<e;g++)c=Math.log(h*g/e+1)/Math.log(h),c=Math.floor(c*d),c>=d&&(c=d-1),this.psColors[g]=this.colorCells[c];for(g=0;g<f;g++)c=(Math.pow(h,g/f)-1)/h,this.psInverse[g]=c*k+
b;break;case "power":h=this.params.exp;for(g=0;g<e;g++)c=(Math.pow(h,g/e)-1)/h,c=Math.floor(c*d),c>=d&&(c=d-1),this.psColors[g]=this.colorCells[c];for(g=0;g<f;g++)c=Math.log(h*g/f+1)/Math.log(h),this.psInverse[g]=c*k+b;break;case "sqrt":for(g=0;g<e;g++)c=g/e,c=Math.floor(Math.sqrt(c)*d),c>=d&&(c=d-1),this.psColors[g]=this.colorCells[c];for(g=0;g<f;g++)c=g/f,this.psInverse[g]=c*c*k+b;break;case "squared":for(g=0;g<e;g++)c=g/e,c=Math.floor(c*c*d),c>=d&&(c=d-1),this.psColors[g]=this.colorCells[c];for(g=
0;g<f;g++)c=Math.sqrt(g/f),this.psInverse[g]=c*k+b;break;case "asinh":for(g=0;g<e;g++)c=g/e,c=Math.floor(Math.asinh(10*c)/3*d),c>=d&&(c=d-1),this.psColors[g]=this.colorCells[c];for(g=0;g<f;g++)c=g/f,c=Math.sinh(3*c)/10,this.psInverse[g]=c*k+b;break;case "sinh":for(g=0;g<e;g++)c=g/e,c=Math.floor(Math.sinh(3*c)/10*d),c>=d&&(c=d-1),this.psColors[g]=this.colorCells[c];for(g=0;g<f;g++)c=g/f,c=Math.asinh(10*c)/3,this.psInverse[g]=c*k+b;break;case "histeq":l=this.raw.data;var p=this.raw.width*this.raw.height;
k=this.raw.dmax-this.raw.dmin;var q=this.raw.dmax;b=this.raw.dmin;var r=c=0;m=[];if(!this.hist||!this.hist.length){this.hist=[];for(g=0;g<h;g++)m[g]=0;for(g=0;g<p;g++)l[g]>=b&&l[g]<=q&&(n=Math.floor((l[g]-b)/k*h+.5),n<h&&(m[n]+=1));for(g=0;g<h;g++)r+=m[g];n=r/h;for(g=l=0;g<h&&l<h;g++)for(this.hist[g]=l/h,c+=m[g];c>=n&&l<h;)c-=n,l++;for(c=(h-1)/h;g<h;)this.hist[g++]=c}for(g=0;g<e;g++)c=this.hist[g*h/e],c=Math.floor(c*d),this.psColors[g]=this.colorCells[c];for(g=0;g<f;g++){d=g/f;for(n=0;n<h-1&&!(this.hist[n]>
d);n++);c=n/h;this.psInverse[g]=c*k+b}break;default:a.error("unknown scale '"+this.params.scale+"'")}return this};a.Image.prototype.mkRGBImage=function(){var c,b,d,e,f=!1,h=null,g=null,k=null,l=!1,m=!1,n=!1,p=!1,q=[];if(!this.rgb)return this;!this.display.rgb.active||this!==this.display.rgb.rim&&this!==this.display.rgb.gim&&this!==this.display.rgb.bim||(l=!0,this.display.rgb.rim&&(h=this.display.rgb.rim),this.display.rgb.gim&&(g=this.display.rgb.gim),this.display.rgb.bim&&(k=this.display.rgb.bim));
var r=this.display.context;var v=this.rgb;var w=v.sect;if(this.MakeRGBImage&&"function"===typeof this.MakeRGBImage&&this.MakeRGBImage()||this.MakePrimaryImage&&"function"===typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){var t=w.width/w.zoom;var u=w.height/w.zoom;var y=w.x0;var x=this.offscreen.canvas.height-1-(w.y0+u);x=this.offscreen.context.getImageData(y,x,t,u);if(1===w.zoom)v.img=x;else for(v.img=r.createImageData(w.width,w.height),v=v.img,d=c=0;c<x.height;c++,
d++){var B=c*x.width;var z=d*w.zoom;for(b=r=0;r<x.width;r++,b++){y=4*(B+r);var A=b*w.zoom;for(e=0;e<w.zoom;e++){var C=Math.floor(z+e);var E=C*w.width;for(C=0;C<w.zoom;C++){var D=Math.floor(A+C);D=4*(E+D);v.data[D]=x.data[y];v.data[D+1]=x.data[y+1];v.data[D+2]=x.data[y+2];v.data[D+3]=x.data[y+3]}}}}return this}v.img&&v.img.width===w.width&&v.img.height===w.height||(v.img=r.createImageData(w.width,w.height));v=v.img;var F=v.data.length-4;if(!this.psColors&&!this.staticObj)return this;var G=void 0!==
this.params.opacity?Math.floor(255*this.params.opacity):void 0!==this.params.alpha?this.params.alpha:255;if(this.mask.active&&this.mask.im){var J=this.mask.im;if("mask"===this.mask.mode){m=!0;var I=a.notNull(this.mask.vopacity)?255*this.mask.vopacity:0;var K=a.notNull(this.params.opacity)?255*this.params.opacity:255;this.mask.invert&&(G=I,I=K,K=G)}else if("opacity"===this.mask.mode)n=!0;else if("overlay"===this.mask.mode){p=!0;var L=J.rgb.img;a.isNull(this.mask.opacity)&&(this.mask.opacity=1)}}else if(a.notNull(this.params.flooropacity)&&
!l){var R=255*this.params.flooropacity;var M=this.params.floorvalue;f=!0}var N=Math.max(1,Math.floor(1/w.zoom));var P=w.zoom*N;c=Math.floor(w.y1-1);for(d=0;c>=w.y0;c-=N,d++)for(B=c*this.raw.width,z=d*P,r=Math.floor(w.x0),b=0;r<w.x1;r+=N,b++){m?G=J.raw.data[B+r]>this.mask.value?K:I:n&&(G=255*J.raw.data[B+r]);if(l){if(x=h?h.colorData[B+r]:0,t=g?g.colorData[B+r]:0,u=k?k.colorData[B+r]:0,a.isNull(x)||a.isNull(t)||a.isNull(u))return this.display.rgb.active=!1,a.error("RGB images are incompatible. Turning off RGB mode.",
"",!1),this.mkRGBImage(),this}else this.staticObj||(y=this.colorData[B+r]);var Q=G;f&&this.raw.data[B+r]<=M&&(Q=R);A=b*P;for(e=0;e<w.zoom;e++)for(C=Math.ceil(z+e),E=C*w.width,C=0;C<w.zoom;C++)if(D=Math.ceil(A+C),D=4*(E+D),D<=F)if(l)v.data[D]=h?h.psColors[x][0]:0,v.data[D+1]=g?g.psColors[t][1]:0,v.data[D+2]=k?k.psColors[u][2]:0,v.data[D+3]=G;else if(this.staticObj){var H=this.raw.data[B+r];H=a.lookupStaticColor(this,H,q);v.data[D]=H.red;v.data[D+1]=H.green;v.data[D+2]=H.blue;v.data[D+3]=H.alpha}else if(void 0!==
this.psColors[y])if(p&&L.data[D+3]){H=L.data[D+3]/255*this.mask.opacity;var O=1-H;v.data[D]=L.data[D]*H+this.psColors[y][0]*O;v.data[D+1]=L.data[D+1]*H+this.psColors[y][1]*O;v.data[D+2]=L.data[D+2]*H+this.psColors[y][2]*O;v.data[D+3]=255}else v.data[D]=this.psColors[y][0],v.data[D+1]=this.psColors[y][1],v.data[D+2]=this.psColors[y][2],v.data[D+3]=Q}return this};a.Image.prototype.blendImage=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=$jscomp.makeIterator(b);d=e.next().value;
var f=e.next().value;e=e.next().value;var h=/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;if(0===b.length)return this.blend;if(!0===d||!1===d||"true"===d||"false"===d)return"true"===d?d=!0:"false"===d&&(d=!1),this.blend.active=d,this.xeqPlugins("image","onimageblend"),
this.display.blendMode&&this.displayImage(),this;if(a.notNull(d)||a.notNull(f))a.notNull(d)&&(h.test(d)||a.error("invalid composite/blend operation: "+d),this.blend.mode=d),a.notNull(f)&&("string"===typeof f?f=parseFloat(f):"number"!==typeof f&&a.error("invalid opacity: "+f),this.blend.opacity=Math.min(Math.max(f,0),1)),a.notNull(e)&&("true"===e?e=!0:"false"===e&&(e=!1),this.blend.active=e),this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.blend.active&&this.displayImage();return this};
a.Image.prototype.maskImage=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=$jscomp.makeIterator(b);d=e.next().value;e=e.next().value;var f,h;if(!b.length)return this.mask;if(!0===d||!1===d||"true"===d||"false"===d)return"true"===d?d=!0:"false"===d&&(d=!1),this.mask.active=d,this.xeqPlugins("image","onimagemask"),this.displayImage(),this;if("string"===typeof d&&"{"===d.charAt(0))try{d=JSON.parse(d)}catch(g){a.error("can't parse JSON in maskImage: "+d,g)}a.isImage(d)||
e||(e=d,d=null);d&&((f=a.lookupImage(d))||a.error("unknown image for maskImage: "+d),this.raw.width===f.raw.width&&this.raw.height===f.raw.height||a.error("maskImage: mask dims ("+f.raw.width+","+f.raw.height+") don't match image dims ("+this.raw.width+","+this.raw.height+")"),this.mask.im=f,this.mask.active=!0);if(e){if("string"===typeof e)try{e=JSON.parse(e)}catch(g){a.error("can't parse JSON in maskImage: "+e,g)}for(h in e)if(e.hasOwnProperty(h))switch(h){case "opacity":this.mask.vopacity=e[h];
break;default:this.mask[h]=e[h]}}!f||e&&!1===e.sync||"function"!==typeof this.syncImages||this.syncImages(this.mask.syncops,[f]);(f||e)&&this.displayImage()};a.Image.prototype.calcDisplayOffsets=function(c){var b=this.rgb.sect;this.ix=(this.display.canvas.width-this.rgb.img.width)/2;this.iy=(this.display.canvas.height-this.rgb.img.height)/2;a.notNull(b.ix)&&(this.ix-=b.ix/2);a.notNull(b.iy)&&(this.iy+=b.iy/2);this.ix=Math.floor(this.ix);this.iy=Math.floor(this.iy);if(c&&this.wcsAlign()){var d=this.wcsim;
c=d.rgb.sect;d=a.pix2pix(d,this,d.getPan());var e=a.globalOpts.panWithinDisplay;a.globalOpts.panWithinDisplay=!0;this.tmp.ozoom=this.rgb.sect.ozoom;this.mkSection(d.x,d.y,c.zoom);this.rgb.sect.ozoom=this.tmp.ozoom;delete this.tmp.ozoom;a.globalOpts.panWithinDisplay=e;this.ix-=(b.xcen-(b.x0+b.x1)/2)*c.zoom;this.iy+=(b.ycen-(b.y0+b.y1)/2)*c.zoom}return this};a.Image.prototype.putImage=function(c){var b=this,d=this.rgb,e=this.display.context;c=c||{};"reproject"===this.rawDataLayer()&&c.wcsim&&(this.wcsim=
c.wcsim,this.wcsim.isawcsim=!0);this.calcDisplayOffsets(!0);e.save();void 0!==c.opacity&&(e.globalAlpha=c.opacity);void 0!==c.blend&&(e.globalCompositeOperation=c.blend);if(this.params.transform){c=this.params.transform;var f=this.display.width/2;var h=this.display.height/2;e.translate(f,h);e.transform(c[0][0],c[0][1],c[1][0],c[1][1],c[2][0],c[2][1]);e.translate(-f,-h)}e.drawImage(function(c){if(!b.offscreenRGB){var d=document.createElement("canvas");var e=d.getContext("2d");a.ANTIALIAS||(e.imageSmoothingEnabled=
!1);b.offscreenRGB={canvas:d,context:e}}b.offscreenRGB.canvas.width=c.width;b.offscreenRGB.canvas.height=c.height;b.offscreenRGB.context.putImageData(c,0,0);return b.offscreenRGB.canvas}(d.img),this.ix,this.iy);e.restore();return this};a.Image.prototype.displayImage=function(c,b){var d=0;var e=[],f={};if(!1===c)return this.displayMode=!1,this;!0===c&&(this.displayMode=!0,c="all");if(!this.displayMode)return this;"object"===typeof c&&(b=c,c=null);c?"all"===c?(c="colors,scaled,rgb,display,plugins",
f.notify=!0):"rgbonly"===c?(c="rgb,nodisplay",f.notify=!0):"display"===c&&(f.notify=!0):c="rgb";c.split(",").forEach(function(a,b,c){a=a.trim();f[a]=!0;switch(a){case "colors":f.scaled=!0;f.rgb=!0;break;case "scaled":f.rgb=!0}});f.display=!0;f.plugins=!0;this.rgbFile&&(f.colors=!1,f.scaled=!1);b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(g){a.error("can't parse displayImage opts: "+b,g)}if(this.display.blendMode&&!1!==b.blendMode)for(c=0;c<a.images.length;c++){var h=a.images[c];h.display===
this.display&&h.blend.active&&(e.push(h),d++)}f.colors&&this.mkColorData();f.scaled&&(this.mkColorCells(),this.mkScaledCells());if(f.rgb&&(this.mkRGBImage(),d))for(c=e.length-1;0<=c;c--)h=e[c],h.mkRGBImage();if(f.nodisplay)return this;if(f.display){this.display.context.clear();if(d){for(c=e.length-1;0<=c;c--)e[c].calcDisplayOffsets(!1);for(c=e.length-1;0<=c;c--)h=e[c],d={wcsim:b.wcsim,blend:h.blend.mode,opacity:h.blend.opacity},h.putImage(d),h===this&&h.displayShapeLayers()}else this.putImage(b),
this.displayShapeLayers();for(this.display.image=this;this.delayedShapes&&this.delayedShapes.length;){this.tmp.syncRunning=!0;b=this.delayedShapes.shift();switch(b.mode){case "add":this.addShapes(b.layer,b.shape,b.opts);break;case "change":this.changeShapes(b.layer,b.shape,b.opts)}delete this.tmp.syncRunning}delete this.delayedShapes}this.xeqPlugins("image","onimagedisplay");return this};a.Image.prototype.refreshImage=function(c,b){b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(g){a.error("can't parse refresh opts: "+
b,g)}if(c&&"string"!==typeof c){b.rawid=b.rawid||a.RAWID0;"function"===typeof b&&(b={onrefresh:b});!b.onrefresh&&a.imageOpts.onrefresh&&(b.onrefresh=a.imageOpts.onrefresh);if(!b.resetSection){var d=this.imageToLogicalPos({x:this.rgb.sect.xcen,y:this.rgb.sect.ycen});if(this.raw.wcs&&0<this.raw.wcs){var e=a.pix2wcs(this.raw.wcs,this.rgb.sect.xcen,this.rgb.sect.ycen);var f=e.trim().split(/\s+/);var h=a.saostrtod(f[0]);a.isHMS(this.params.wcssys)&&(h*=15);f=a.saostrtod(f[1])}}e=this.rgb.sect.zoom;this.binning.obin=
this.binning.bin;this.mkRawDataFromHDU(c,b);b.resetSection?(this.mkSection(),this.mkSection(e)):(this.raw.wcs&&0<this.raw.wcs&&a.notNull(h)&&a.notNull(f)?(f=a.wcs2pix(this.raw.wcs,h,f).trim().split(/ +/),c={x:parseFloat(f[0]),y:parseFloat(f[1])}):c=this.logicalToImagePos({x:d.x,y:d.y}),0<c.x&&c.x<this.raw.width&&0<c.y&&c.y<this.raw.height?this.mkSection(c.x,c.y,e):(this.mkSection(),this.mkSection(e)));this.displayImage("colors",b);this.reFlipRot();this.notifyHelper();if(b.refreshRegions||b.resetSection||
this.binning.obin!==this.binning.bin)this.refreshLayers(),this.updateShapes("regions","all","binning");this.xeqPlugins("image","onimagerefresh");a.waiting(!1);if(b.onrefresh)try{a.xeqByName(b.onrefresh,window,this)}catch(g){a.error("in image refresh callback",g)}return this}b.onrefresh&&(b.onload=b.onrefresh,delete b.onrefresh);b.refresh=this;e=document.domain?c||this.file:c||this.fitsFile||this.file;a.Load(e,b,{display:this.display})};a.Image.prototype.fileDimensions=function(){if(this.parent&&"BINTABLE"!==
this.parent.raw.header.XTENSION){var a=this.parent.raw.header.TABDIM1?this.parent.raw.header.TABDIM1:this.parent.raw.header.NAXIS1;var b=this.parent.raw.header.TABDIM2?this.parent.raw.header.TABDIM2:this.parent.raw.header.NAXIS2}else a=this.raw.header.TABDIM1?this.raw.header.TABDIM1:this.raw.header.NAXIS1,b=this.raw.header.TABDIM2?this.raw.header.TABDIM2:this.raw.header.NAXIS2;return{xdim:a,ydim:b}};a.Image.prototype.maybePhysicalToImage=function(c){if("image"===this.imtab&&this.parent&&this.parent.lcs&&
c.x&&c.y){c={x:c.x,y:c.y};c=a.Image.prototype.logicalToImagePos.call(this.parent,c,"ophysical");var b={x:Math.floor(c.x+.5),y:Math.floor(c.y+.5)}}return b};a.Image.prototype.displaySection=function(c,b){var d=this,e,f,h,g,k,l,m,n=function(b,c,d){var e;a.isNull(b)?a.isNull(c)||(e=c):e=b;return e||d},p=function(c,e){var h="";l=$.extend(!0,{},e||{});a.isNull(l.refreshRegions)&&(l.refreshRegions=!0);a.isNull(l.resetSection)&&(l.resetSection=!0);!1!==l.waiting&&a.waiting(!0,d.display);c.fits.extname?h=
"["+c.fits.extname+"]":c.fits.extnum&&0<c.fits.extnum?h="["+c.fits.extnum+"]":d.parent&&(d.parent.extname?h="["+d.parent.extname+"]":d.parent.extnum&&0<d.parent.extnum&&(h="["+d.parent.extnum+"]"));h&&(l.id=d.id.replace(/\[.*\]/,"")+h,l.file=d.file.replace(/\[.*\]/,"")+h);if(l.separate){delete l.xcen;delete l.ycen;if("string"===typeof l.separate){h=l.separate.split(":");switch(h.length){case 1:e=h[0];break;default:e=h[0],l.id=h[1]}l.display=a.lookupDisplay(e)}else l.display=d.display;"parentFile"===
f&&d.fitsFile&&(e=a.lookupImage(d.fitsFile),l.parentFile=e&&e.parentFile?e.parentFile:d.fitsFile);g=d.listRegions("all",{mode:1,includedcoords:!0,savewcsconfig:!0,saveid:!0});b=l.ondisplaysection||l.onrefresh||b;k=new a.Image(c,l,b);k.binning.obin=k.binning.bin;g&&!1!==l.refreshRegions&&k.addShapes("regions",g,{restoreid:!0});d.reFlipRot();k.setStatus("displaySection","complete")}else if("string"===typeof l.refresh){delete l.xcen;delete l.ycen;h=l.refresh.split(":");switch(h.length){case 1:e=h[0];
break;default:e=h[0],l.id=h[1]}l.display=a.lookupDisplay(e);l.display.image?(l.rawid=d.raw.id,l.onrefresh=l.ondisplaysection||l.onrefresh||b,l.display.image.refreshImage(c,l)):("parentFile"===f&&d.fitsFile&&(e=a.lookupImage(d.fitsFile),l.parentFile=e&&e.parentFile?e.parentFile:d.fitsFile),g=d.listRegions("all",{mode:1,includedcoords:!0,savewcsconfig:!0,saveid:!0}),b=l.ondisplaysection||l.onrefresh||b,k=new a.Image(c,l,b),k.binning.obin=k.binning.bin,g&&k.addShapes("regions",g,{restoreid:!0}),d.reFlipRot())}else l.rawid=
d.raw.id,l.onrefresh=l.ondisplaysection||l.onrefresh||b,d.refreshImage(c,l);d.setStatus("displaySection","complete");a.waiting(!1)};this.raw&&this.raw.hdu&&this.raw.hdu.fits||a.error("invalid image for displaySection");c=c||{};if("full"===c){var q=this.fileDimensions();c={xdim:q.xdim,ydim:q.ydim,xcen:0,ycen:0}}else{if("selected"===c){this._selectShapes("regions","selected",function(a){a=a.pub;var c,e=0,f=0,g=1E6,h=0,k=1E6,m=0,n=a.shape;if(!d.parentFile&&a.lcs){a=a.lcs;var q=a.x;var p=a.y;if(c=d.maybePhysicalToImage({x:q,
y:p}))q=c.x,p=c.y}else q=a.x,p=a.y;switch(n){case "annulus":var r=2*a.radii[a.radii.length-1];var v=2*a.radii[a.radii.length-1];break;case "box":r=a.width;v=a.height;break;case "circle":r=2*a.radius;v=2*a.radius;break;case "cross":r=a.width;v=a.height;break;case "ellipse":r=2*a.r1;v=2*a.r2;break;case "polygon":case "line":for(r=0;r<a.pts.length;r++)e+=a.pts[r].x,f+=a.pts[r].y,a.pts[r].x>h&&(h=a.pts[r].x),a.pts[r].x<g&&(g=a.pts[r].x),a.pts[r].y>m&&(m=a.pts[r].y),a.pts[r].y<k&&(k=a.pts[r].y);a.x=e/
a.pts.length;a.y=f/a.pts.length;"line"===a.shape&&2===a.pts.length?(r=Math.sqrt((a.pts[0].x-a.pts[1].x)*(a.pts[0].x-a.pts[1].x)+(a.pts[0].y-a.pts[1].y)*(a.pts[0].y-a.pts[1].y)),v=1):(r=h-g,v=m-k);break;case "text":v=r=10}l={xcen:q,ycen:p,xdim:r,ydim:v,from:"virtualFile",separate:!0,refreshRegions:!1,resetSection:!0};d.displaySection(l,b)});return}if("string"===typeof c)try{c=JSON.parse(c)}catch(w){a.error("can't parse section opts: "+c,w)}}var r=c.separate?$.extend(!0,{},this.raw.hdu):this.raw.hdu;
(f=c.from)||(f=this.parentFile&&a.helper.connected&&a.helper.js9helper?"parentFile":"virtualFile");if(r.table)q=r.table;else{q={};q.bin=r.bin||1;"parentFile"===f&&this.raw.header&&a.notNull(this.raw.header.LTM1_1)&&(q.bin=1/Math.abs(this.raw.header.LTM1_1));var v={x:this.raw.width/2,y:this.raw.height/2};v=this.imageToLogicalPos(v);q.xcen=Math.floor(v.x+.5*(q.bin-1));q.ycen=Math.floor(v.y+.5*(q.bin-1));if(v=this.maybePhysicalToImage({x:q.xcen,y:q.ycen}))q.xcen=v.x,q.ycen=v.y;q.xdim=Math.floor(r.naxis1*
q.bin);q.ydim=Math.floor(r.naxis2*q.bin);q.filter=this.raw.filter||""}if("string"===typeof c.bin)switch(c.bin.match(/[as]$/)&&(c.binMode=c.bin.slice(-1),c.bin=c.bin.slice(0,-1)),v=q.bin||this.binning.bin,c.bin.charAt(0)){case "*":case "x":case "X":c.bin=v*parseFloat(c.bin.slice(1));break;case "/":c.bin=v/parseFloat(c.bin.slice(1));break;case "i":case "I":c.bin=2*v;break;case "o":case "O":c.bin=v/2;break;default:a.isNumber(c.bin)?c.bin=parseFloat(c.bin):a.error("invalid bin for displaySection: "+c.bin)}c.xcen=
n(c.xcen,q.xcen,0);c.ycen=n(c.ycen,q.ycen,0);switch(this.imtab){case "table":c.xdim=n(c.xdim,q.xdim,a.fits.options.table.xdim);c.ydim=n(c.ydim,q.ydim,a.fits.options.table.ydim);c.bin=n(c.bin,q.bin,a.fits.options.table.bin);break;default:c.xdim=n(c.xdim,q.xdim,a.fits.options.image.xdim),c.ydim=n(c.ydim,q.ydim,a.fits.options.image.ydim),c.bin=n(c.bin,q.bin,a.fits.options.image.bin)}c.binMode=n(c.binMode,q.binMode,a.globalOpts.binMode);"string"===typeof c.bin&&(c.bin.match(/[as]$/)&&(c.binMode=c.bin.slice(-1)),
c.bin=parseFloat(c.bin));c.bin||(c.bin=1);"image"===this.imtab&&0<c.bin&&1>c.bin&&(c.bin=1/Math.floor(1/c.bin+.5));c.filter=n(c.filter,q.filter,"");this.raw.filter=c.filter||"";!1!==c.waiting&&a.waiting(!0,this.display);this.setStatus("displaySection","processing");window.setTimeout(function(){switch(f){case "parentFile":e=d.proxyFile;m=[];m.push({name:"xcen",value:c.xcen});delete c.xcen;m.push({name:"ycen",value:c.ycen});delete c.ycen;m.push({name:"xdim",value:c.xdim});m.push({name:"ydim",value:c.ydim});
void 0!==c.xdim&&(c.xdim=0);void 0!==c.ydim&&(c.ydim=0);c.binMode&&(c.bin=""+c.bin+c.binMode,delete c.binMode);m.push({name:"bin",value:c.bin});delete c.bin;m.push({name:"filter",value:c.filter||""});m.push({name:"slice",value:c.slice||""});delete c.slice;h={id:d.expandMacro("$id"),image:d.file,fits:d.parentFile,rtype:"text"};h.cmd="js9Xeq imsection "+d.parentFile;c.extension&&(h.cmd=h.cmd.replace(/\[.*\]/,""),h.cmd+="["+c.extension+"]",delete c.extension);h.cmd+=d.expandMacro(" $xdim@$xcen,$ydim@$ycen,$bin $filter $slice",
m);a.helper.send("imsection",h,function(b){b="object"===typeof b?b:0<=b.search(a.analOpts.epattern)?{stderr:b}:{stdout:b};if(b.stderr)a.error(b.stderr);else if(b.errcode)a.error("in displaySection: "+b.errcode);else{var f=b.stdout.split(/\n/);b=a.cleanPath(f[0]);"/"!==b.charAt(0)&&(b=a.InstallDir(b));c.proxyFile=b;e&&e!==c.proxyFile&&d.removeProxyFile(e);if(f[1]){try{var g=JSON.parse(f[1])}catch(y){a.log("couldn't parse imsection as JSON: %s",b),g=null}g&&(c.extname=g.extname,c.extnum=g.extnum,c.hdus=
g.hdus,c.binstr=g.binstr,c.parent=g)}f[2]&&(g=a.cleanPath(f[2]),c.parentFile=g);a.fetchURL(b,b,c,function(b){a.cleanupFITSFile(d.raw,!0);!1!==c.waiting&&a.waiting(!0,d.display);a.fits.handleFITSFile(b,c,p)})}});break;case "virtualFile":a.cleanupFITSFile(d.raw,!1);a.getFITSImage(r.fits,r,c,function(a){p(a,c)});break;default:a.error("image section cannot be extracted from this data file")}},a.SPINOUT)};a.Image.prototype.displayExtension=function(c,b,d){var e=this,f,h,g=function(c){var f=$.extend(!0,
{},b);f.separate=!0;if(c===e.hdus.length){if(d)try{a.xeqByName(d,window,e)}catch(q){a.error("in displayExtension callback",q,!1)}}else{var h=e.hdus[c];"image"===h.type&&2<=h.naxis?e.displayExtension(h.hdu,f,function(){g(c+1)}):g(c+1)}};b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(m){a.error("can't parse extension opts: "+b,m)}b.waiting=!1;this.hdus||a.error("no FITS HDUs found for displayExtension()");a.isNull(c)&&a.error("missing extname/extnum for displayExtension()");if("all"===c)g(0);
else{if("string"===typeof c){b.extension=c;var k=c.toLowerCase();for(h=f=0;f<this.hdus.length;f++)if(this.hdus[f].name&&this.hdus[f].name.toLowerCase()===k){h++;break}h||a.error("no FITS HDU "+c+" for displayExtension()")}else"number"===typeof c&&(b.extension=c,this.hdus[c]?k=this.hdus[c].name||c.toString():a.error("no FITS HDU "+c+" for displayExtension()"));if(b.separate){f="["+k+"]";c=this.id.replace(/\[.*\]/,"")+f;for(h=f=0;f<a.images.length;f++){var l=a.images[f];if(c===l.id&&0<$("#"+l.display.id).length&&
this.display.id===l.display.id){h++;break}}if(h){l.displayImage("display",b);l.display.clearMessage();if(d)try{a.xeqByName(d,window,this)}catch(m){a.error("in displayExtension callback",m,!1)}return}}b.separate||a.cleanupFITSFile(this.raw,!1);this.displaySection(b,d);return this}};a.Image.prototype.displaySlice=function(c,b,d){b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(f){a.error("can't parse slice opts: "+b,f)}b.waiting=!1;void 0===c&&a.error("missing slice for displaySlice()");3!==
this.raw.header.NAXIS&&a.error("3D image required for displaySlice()");if("all"===c)for(c=1;c<=this.raw.header.NAXIS3;c++){var e=$.extend(!0,{},b,{separate:!0});this.displaySlice(c,e,d)}else{a.isNumber(c)?b.slice="*:*:"+c:b.slice=c;if(b.separate)for(b.id=sprintf("%s_%s",this.id.replace(/_?([0-9])+:x:x/,"").replace(/_?x:([0-9])+:x/,"").replace(/_?x:x:([0-9])+/,""),b.slice.replace(/\*/g,"x")),c=0;c<a.images.length;c++)if(e=a.images[c],b.id===e.id&&0<$("#"+e.display.id).length)return e.displayImage("display",
{display:e}),this;a.cleanupFITSFile(this.raw,!1);this.displaySection(b,d)}return this};a.Image.prototype.toArray=function(c){var b;c=c||{};c.simple=!0;var d=$.extend(!0,{},this.raw.header);if(a.notNull(c.sect)){var e=c.sect;d.NAXIS1=e.x1-e.x0;d.NAXIS2=e.y1-e.y0;a.notNull(d.CRPIX1)&&(d.CRPIX1-=e.x0);a.notNull(d.CRPIX2)&&(d.CRPIX2-=e.y0);a.notNull(d.LTV1)&&(d.LTV1-=e.x0);a.notNull(d.LTV2)&&(d.LTV2-=e.y0);var f=Math.abs(this.raw.bitpix/8);var h=(e.x1-e.x0)*f;var g=h*(e.y1-e.y0);g=new ArrayBuffer(g);
g=new Uint8Array(g);var k=e.y0;for(b=0;k<e.y1;k++,b++)a.memcpy(g.buffer,b*h,this.raw.data.buffer,(k*this.raw.width+e.x0)*f,h)}else g=this.raw.data.buffer;d=a.raw2FITS({header:d},c);c=2880-d.length%2880;2880===c&&(c=0);for(k=0;k<c;k++)d+=" ";c=2880-g.byteLength%2880;2880===c&&(c=0);k=new ArrayBuffer(d.length+g.byteLength+c);var l=new Uint8Array(k);for(k=0;k<d.length;k++)l[k]=d.charCodeAt(k);if(0<(new Int8Array((new Int16Array([1])).buffer))[0]){f=d.length;h=Math.abs(this.raw.bitpix)/8;var m=new Uint8Array(g);
for(k=0;k<m.byteLength;k+=h)for(b=k+h-1,e=0;e<h;b--,e++)l[f++]=m[b]}else l.set(new Uint8Array(g),d.length);f=d.length+g.byteLength;for(k=0;k<c;k++)l[f++]=0;return l};a.Image.prototype.wcsAlign=function(){return this.wcsim&&this.params.wcsalign&&this.display===this.wcsim.display};a.Image.prototype.getPan=function(){var c=this.rgb.sect,b=(c.x0+c.x1)/2,d=(c.y0+c.y1)/2;a.notNull(c.ix)&&(b+=c.ix/(2*c.zoom));a.notNull(c.iy)&&(d+=c.iy/(2*c.zoom));return{x:b,y:d,ox:c.xcen,oy:c.ycen,x0:c.x0,y0:c.y0,x1:c.x1,
y1:c.y1,ix:c.ix||0,iy:c.iy||0}};a.Image.prototype.setPan=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e;var f=$jscomp.makeIterator(b);d=f.next().value;f=f.next().value;if(!(0<=$.inArray("pan",this.params.disable))){0===b.length&&(d=this.raw.width/2,f=this.raw.height/2);if(1===b.length&&"string"===typeof d)if("mouse"===d&&this.ipos)d=this.ipos.x,f=this.ipos.y;else try{d=JSON.parse(d)}catch(m){a.error("can't parse setPan JSON: "+d,m)}if("object"===typeof d){b=d;a.notNull(b.x)&&
a.notNull(b.y)&&(d=b.x,f=b.y);a.notNull(b.px)&&a.notNull(b.py)&&(f=this.logicalToImagePos({x:b.px,y:b.py}),d=f.x,f=f.y);if("string"===typeof b.wcs){var h=b.wcs.trim().split(/ +/);b.ra=h[0];b.dec=h[1];3<=h.length&&(b.wcssys=h[2])}if(a.notNull(b.ra)&&a.notNull(b.dec)&&0<this.raw.wcs){if(b.wcssys){var g=this.getWCSSys();var k=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.setWCSSys(b.wcssys,!1)}"string"===typeof b.ra&&(b.ra=a.saostrtod(b.ra),a.isHMS(this.params.wcssys)&&(b.ra*=15));"string"===
typeof b.dec&&(b.dec=a.saostrtod(b.dec));h=a.wcs2pix(this.raw.wcs,b.ra,b.dec).trim().split(/ +/);d=parseFloat(h[0]);f=parseFloat(h[1]);g&&(this.setWCSSys(g,!1),a.globalOpts.xeqPlugins=k)}}a.isNumber(d)&&a.isNumber(f)||a.error("invalid input for setPan: "+d+" "+f);if(this.wcsAlign()||this.isawcsim){var l=a.globalOpts.panWithinDisplay;a.globalOpts.panWithinDisplay=!0}this.mkSection(d,f);if(this.wcsAlign()||this.isawcsim){for(g=0;g<a.images.length;g++)k=a.images[g],k!==this&&k.display===this.display&&
(k.wcsim===this||this.wcsim===k||k.wcsim&&k.wcsim===this.wcsim)&&(k.params.wcsalign||this.params.wcsalign)&&(b=a.pix2pix(this,k,{x:d,y:f}),k.mkSection(b.x,b.y));a.globalOpts.panWithinDisplay=l}this.displayImage("rgb");for(e in this.layers)this.layers.hasOwnProperty(e)&&this.layers[e].show&&this.layers[e].opts.panzoom&&this.refreshShapes(e);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetpan");return this}};a.Image.prototype.getZoom=function(){return this.rgb.sect.zoom};a.Image.prototype.parseZoom=
function(a){var b=this.rgb.sect.zoom;switch(typeof a){case "string":switch(a.charAt(0)){case "*":case "x":case "X":a=b*parseFloat(a.slice(1));break;case "/":a=b/parseFloat(a.slice(1));break;case "I":case "i":a=2*b;break;case "O":case "o":a=b/2;break;case "T":case "t":a=Math.min(this.display.width/this.raw.width,this.display.height/this.raw.height);a=Math.round(1E6*(a+1E-7))/1E6;break;default:a=parseFloat(a)}break;case "number":break;default:return}return a};a.Image.prototype.setZoom=function(c){var b,
d;if(!(0<=$.inArray("zoom",this.params.disable))){(b=this.parseZoom(c))||a.error("invalid input for setZoom: "+c);if(this.wcsAlign()||this.isawcsim){var e=a.globalOpts.panWithinDisplay;a.globalOpts.panWithinDisplay=!0}this.mkSection(b);if(this.wcsAlign()||this.isawcsim){for(c=0;c<a.images.length;c++){var f=a.images[c];if(f!==this&&f.display===this.display&&(f.wcsim===this||this.wcsim===f||f.wcsim&&f.wcsim===this.wcsim)&&(f.params.wcsalign||this.params.wcsalign)){var h=a.pix2pix(this,f,this.getPan());
f.mkSection(h.x,h.y,b)}}a.globalOpts.panWithinDisplay=e}this.displayImage("rgb");for(d in this.layers)this.layers.hasOwnProperty(d)&&this.layers[d].show&&this.layers[d].opts.panzoom&&this.refreshShapes(d);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetzoom");return this}};a.Image.prototype.alignPanZoom=function(c,b){var d;if(c){"string"===typeof c&&((d=a.getImage(c))?c=d:a.error("unknown image for alignPanZoom: "+c));b=b||{};d=c.getPan();var e=c.rgb.sect.zoom||1;if(b=a.notNull(b.syncwcs)?
b.syncwcs:a.globalOpts.syncWCS){var f=this.raw.wcsinfo||{cdelt1:1,crot:0};b=c.raw.wcsinfo||{cdelt1:1,crot:0};this.setPan(a.pix2pix(c,this,{x:d.ox,y:d.oy}));this.setZoom(e*f.cdelt1/b.cdelt1);this.setRotate(b.crot-f.crot)}else this.setPan({x:d.ox,y:d.oy}),this.setZoom(e);return this}};a.Image.prototype.getNorthIsUp=function(c){var b={},d={galactic:{ra:15*a.saostrtod("12h51m26.00s"),dec:a.saostrtod("27d7m42.0s"),wcssys:"FK5"},ecliptic:{ra:15*a.saostrtod("18h0m0.0s"),dec:a.saostrtod("66d33m38.55s"),wcssys:"ICRS"}};
var e=this.raw.wcsinfo||{cdelt1:1,cdelt2:1,crot:0};c||(c=this.getWCSSys());b.angle=0;0<e.cdelt1&&(b.flip="x");0>e.cdelt2&&(b.flip=(b.flip||"")+"y");switch(c){case "galactic":case "ecliptic":break;default:return e.crot&&(b.angle=-e.crot),b}e=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.setWCSSys(d[c].wcssys,!1);var f=a.pix2wcs(this.raw.wcs,this.raw.width/2,this.raw.height/2).trim().split(/\s+/);var h=a.saostrtod(f[0]);a.isHMS()&&(h*=15);f=a.saostrtod(f[1]);b.angle=a.angdist(h,f,d[c].ra,
d[c].dec);a.notNull(this.raw.wcsinfo.crot)&&(b.angle-=this.raw.wcsinfo.crot);this.setWCSSys(c,!1);a.globalOpts.xeqPlugins=e;return b};a.Image.prototype.getTransform=function(){return this.params.transform};a.Image.prototype.setTransform=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=0;var e=1;b=$jscomp.makeIterator(b).next().value;this&&this.raw&&this.raw.header||a.error("invalid image for setTransform");if("reset"===b)delete this.params.transform,delete this.params.transformInverse,
delete this.params.transformAngle,delete this.params.transformScale;else{var f=[[1,0,0],[0,1,0],[0,0,1]];for(b=0;b<a.globalOpts.transforms.length;b++)switch(a.globalOpts.transforms[b]){case "flip":switch(this.params.flip){case "x":var h=[[-1,0,0],[0,1,0],[0,0,1]];f=a.matrixMultiply(f,h);e=-1;break;case "y":h=[[1,0,0],[0,-1,0],[0,0,1]];f=a.matrixMultiply(f,h);e=-1;break;case "xy":h=[[-1,0,0],[0,-1,0],[0,0,1]],f=a.matrixMultiply(f,h)}break;case "rot90":if(a.notNull(this.params.rot90)){var g=this.params.rot90*
Math.PI/180;h=Math.cos(g);g=Math.sin(g);h=[[h,-g,0],[g,h,0],[0,0,1]];f=a.matrixMultiply(f,h);d+=this.params.rot90}break;case "rotate":a.notNull(this.params.rotate)&&(g=this.params.rotate*Math.PI/180,h=Math.cos(g),g=Math.sin(g),h=[[h,-g,0],[g,h,0],[0,0,1]],f=a.matrixMultiply(f,h),d+=this.params.rotate)}this.params.transform=f;this.params.transformInverse=a.invertMatrix3(f);this.params.transformAngle=e*d;this.params.transformScale=e;return this}};a.Image.prototype.getFlip=function(){return this.params.flip};
a.Image.prototype.setFlip=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=$jscomp.makeIterator(b);var e=b.next().value;b=b.next().value;if(a.isNull(e))return this;if("reset"===e)return this.params.flip="none",this.setFlip(0);b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(l){a.error("can't parse setFlip opts: "+b,l)}this.xeqStashSave("setFlip",[e]);d=this.params;var f=0,h=0,g="";var k=(e+(this.params.flip||"")).split("");for(e=0;e<k.length;e++)switch(k[e]){case "x":f++;
break;case "y":h++}1===f%2&&(g+="x");1===h%2&&(g+="y");d.flip=g||"none";this.setTransform();this.displayImage("all",b);this.refreshLayers();a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetflip");return this};a.Image.prototype.getRotate=function(){return this.params.rotate};a.Image.prototype.setRotate=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=$jscomp.makeIterator(b);b=d.next().value;d=d.next().value;if(a.isNull(b))return this;if("reset"===b)return this.params.rotate=
0,this.setRotate(0);if("string"===typeof b&&b.match(/north/i)){var e=this.getNorthIsUp();b=e.angle;a.notNull(e.flip)&&this.setParam("flip",e.flip)}"string"===typeof b&&(b=parseFloat(b));a.isNumber(b)||a.error("invalid rotation for setRotate: "+b);this&&this.raw&&this.raw.header||a.error("invalid image for setRotate");d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(f){a.error("can't parse rot opts: "+d,f)}this.xeqStashSave("setRotate",[b]);e=this.params;for(a.globalOpts.rotateRelative&&(b+=
this.params.rotate||0);0>b;)b+=360;for(;360<=b;)b-=360;e.rotate=b;this.setTransform();this.displayImage("all",d);this.refreshLayers();a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetrotate");return this};a.Image.prototype.getRot90=function(){return this.params.rot90};a.Image.prototype.setRot90=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=$jscomp.makeIterator(b);b=d.next().value;d=d.next().value;if(a.isNull(b))return this;if("reset"===b)return this.params.rot90=
0,this.setRot90(0);"string"===typeof b&&(b=parseFloat(b));this&&this.raw&&this.raw.header||a.error("invalid image for setRot90");d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(f){a.error("can't parse setRot90 opts: "+d,f)}switch(b){case 0:b=0;break;case 1:b=90;break;case -1:b=-90;break;case 90:break;case -90:break;default:a.error("invalid setRot90 rotation value: "+b+" (use: +/1, +/90)")}this.xeqStashSave("setRot90",[b]);var e=this.params;for(b+=this.params.rot90||0;0>b;)b+=360;for(;360<=
b;)b-=360;270===b&&(b=-90);e.rot90=b;this.setTransform();this.displayImage("all",d);this.refreshLayers();a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetrot90");return this};a.Image.prototype.reFlipRot=function(){var a=this.params.flip;var b=this.params.rot90,d=this.params.rotate;if("none"!==a){this.params.flip="none";var e=a.split("");for(a=0;a<e.length;a++)"x"!==e[a]&&"y"!==e[a]||this.setFlip(e[a])}if(b)for(this.params.rot90=0,e=Math.floor(Math.abs(b)/90),d=Math.sign(b),a=0;a<e;a++)this.setRot90(d);
d&&this.setRotate(d);return this};a.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom());this.binning.obin=this.binning.bin;this.rgb.sect.ozoom=this.rgb.sect.zoom};a.Image.prototype.imageToLogicalPos=function(a,b){var c="image",e=a.x;var f=a.y;b=b||this.params.lcs||"image";switch(b){case "physical":if(this.lcs.physical){c=b;var h=this.lcs.physical.reverse;var g=this.lcs.physical.rrot;var k=this.lcs.physical.cx;var l=this.lcs.physical.cy}break;case "detector":this.lcs.detector&&(c=
b,h=this.lcs.detector.reverse,g=this.lcs.detector.rrot,k=this.lcs.detector.cx,l=this.lcs.detector.cy);break;case "amplifier":this.lcs.amplifier&&(c=b,h=this.lcs.amplifier.reverse,g=this.lcs.amplifier.rrot,k=this.lcs.amplifier.cx,l=this.lcs.amplifier.cy)}h&&(e=a.x*h[0][0]+a.y*h[1][0]+h[2][0],f=a.x*h[0][1]+a.y*h[1][1]+h[2][1],g&&(a=k+(e-k)*g[0][0]+(f-l)*g[1][0]+g[2][0],f=l+(e-k)*g[0][1]+(f-l)*g[1][1]+g[2][1],e=a),"table"===this.imtab&&(g=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(e=e-
g+this.raw.header.TABMIN1),void 0!==this.raw.header.TABMIN2&&(f=f-g+this.raw.header.TABMIN2)));return{x:e,y:f,sys:c}};a.Image.prototype.logicalToImagePos=function(a,b){var c={x:a.x,y:a.y};var e=this.raw.header.CRPIX1||1;var f=this.raw.header.CRPIX2||1;b=b||this.params.lcs||"image";switch(b){case "ophysical":if(this.lcs.ophysical){var h=this.lcs.ophysical.forward;var g=this.lcs.ophysical.frot}else this.lcs.physical&&(h=this.lcs.physical.forward,g=this.lcs.physical.frot);break;case "physical":this.lcs.physical&&
(h=this.lcs.physical.forward,g=this.lcs.physical.frot);break;case "detector":this.lcs.detector&&(h=this.lcs.detector.forward,g=this.lcs.detector.frot);break;case "amplifier":this.lcs.amplifier&&(h=this.lcs.amplifier.forward,g=this.lcs.amplifier.frot)}h&&("table"===this.imtab&&(b=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(a.x=a.x-this.raw.header.TABMIN1+b),void 0!==this.raw.header.TABMIN2&&(a.y=a.y-this.raw.header.TABMIN2+b)),c.x=a.x*h[0][0]+a.y*h[1][0]+h[2][0],c.y=a.x*h[0][1]+a.y*h[1][1]+
h[2][1],g&&(a=e+(c.x-e)*g[0][0]+(c.y-f)*g[1][0]+g[2][0],g=f+(c.x-e)*g[0][1]+(c.y-f)*g[1][1]+g[2][1],c.x=a,c.y=g));return c};a.Image.prototype.displayToImagePos=function(a){var b=this.rgb.sect,c=this.rgb.img.height;var e=this.display.width/2;var f=this.display.height/2;if(this.params.transformInverse){var h=this.params.transformInverse;var g=a.x-e;a=a.y-f;e=g*h[0][0]+a*h[1][0]+e;h=g*h[0][1]+a*h[1][1]+f}else e=a.x,h=a.y;return{x:(e-this.ix+.5)/b.zoom+b.x0+.5,y:(c-(h-this.iy+.5))/b.zoom+b.y0+.5}};a.Image.prototype.imageToDisplayPos=
function(a){var b=this.rgb.sect;var c=this.rgb.img.height;var e=this.display.width/2,f=this.display.height/2;var h=(a.x-.5-b.x0)*b.zoom+this.ix-.5;c=(b.y0-(a.y-.5))*b.zoom+c+this.iy-.5;this.params.transform&&(a=this.params.transform,b=h-e,c-=f,h=b*a[0][0]+c*a[1][0]+e,c=b*a[0][1]+c*a[1][1]+f);return{x:h,y:c}};a.Image.prototype.logicalToDisplayPos=function(a,b,d){return this.imageToDisplayPos(this.logicalToImagePos(a,b,d))};a.Image.prototype.displayToLogicalPos=function(a){return this.imageToLogicalPos(this.displayToImagePos(a))};
a.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};a.Image.prototype.setWCSSys=function(c,b){if(!(0<=$.inArray("wcs",this.params.disable)))return a.isNull(b)&&(b=a.globalOpts.wcsSetUpdatesDef),"image"===c?(this.params.wcssys="image",this.params.wcsunits="pixels",a.wcsunits.image="pixels"):"physical"===c?(this.params.wcssys="physical",this.params.wcsunits="pixels",b&&(a.globalOpts.wcsUnits.physical="pixels")):this.raw.wcs&&0<this.raw.wcs&&("native"===c&&(c=this.params.wcssys0),
c=a.wcssys(this.raw.wcs,c))&&(this.params.wcssys=c.trim(),c=a.globalOpts.wcsUnits[this.params.wcssys]||"sexagesimal",this.setWCSUnits(c,b)),a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcssys"),this};a.Image.prototype.initWCS=function(c){var b,d,e=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;if(!this.raw.header)return this;c=c||this.raw.header;this.freeWCS();
this.raw.altwcs={};var f="default";this.raw.altwcs[f]={};this.raw.altwcs[f].header=c;for(b in c)c.hasOwnProperty(b)&&(d=b.match(e))&&d.length&&(f=d[2],this.raw.altwcs[f]||(this.raw.altwcs[f]={},this.raw.altwcs[f].header=$.extend({},c)),"RADESYS"===d[1]&&(d[1]="RADECSYS"),this.raw.altwcs[f].header[d[1]]=c[d[0]]);for(b in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(b)&&(c=a.raw2FITS(this.raw.altwcs[b].header),this.raw.altwcs[b].wcs=a.initwcs(c),0<this.raw.altwcs[b].wcs))try{this.raw.altwcs[b].wcsinfo=
JSON.parse(a.wcsinfo(this.raw.altwcs[b].wcs))}catch(h){}this.setWCS("default");return this};a.Image.prototype.freeWCS=function(c){var b;c=c||this.raw;if(c.altwcs)for(b in c.altwcs)c.altwcs.hasOwnProperty(b)&&0<c.altwcs[b].wcs&&(a.freewcs(c.altwcs[b].wcs),c.altwcs[b].wcs=null)};a.Image.prototype.getWCS=function(){var a;for(a in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(a)&&this.raw.wcs===this.raw.altwcs[a].wcs){var b=$.extend(!0,{},this.raw.altwcs[a].wcsinfo);b.version=a;b.wcsname=this.raw.altwcs[a].header.WCSNAME;
return b}return null};a.Image.prototype.setWCS=function(c){var b;c=c||"default";if(!this.raw||!this.raw.altwcs)return this;for(b in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(b)){var d=this.raw.altwcs[b].header.WCSNAME;if(c===b||c===d)return 0>=this.raw.altwcs[b].wcs&&a.error("invalid WCS for version: %s",c),this.raw.wcs=this.raw.altwcs[b].wcs,this.raw.wcsinfo=this.raw.altwcs[b].wcsinfo,c=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:"native"!==this.params.wcssys?this.params.wcssys.trim():
this.params.lcs,this.setWCSSys(c),this.params.wcssys0||(this.params.wcssys0=c),this.setWCSUnits(this.params.wcsunits),this}a.error("could not find WCS version: "+c)};a.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"};a.Image.prototype.setWCSUnits=function(c,b){if(!(0<=$.inArray("wcs",this.params.disable))){a.isNull(b)&&(b=a.globalOpts.wcsSetUpdatesDef);if("pixels"===c)a.isWCS(this.params.wcssys)&&(this.params.wcssys="physical"),this.params.wcsunits=
"pixels",b&&(a.globalOpts.wcsUnits[this.params.wcssys]="pixels");else if(this.raw.wcs&&0<this.raw.wcs){if(a.notWCS(this.params.wcssys)){var d=a.imageOpts.wcssys;this.setWCSSys(d)}if(c=a.wcsunits(this.raw.wcs,c))this.params.wcsunits=c.trim(),b&&(a.globalOpts.wcsUnits[this.params.wcssys]=this.params.wcsunits)}a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcsunits");return this}};a.Image.prototype.notifyHelper=function(){var c=this,b,d;var e=new RegExp("^"+a.ANON+"[0-9]*");var f=a.INSTALLDIR?
new RegExp("^"+a.INSTALLDIR):null;if(a.helper.connected&&!this.file.match(e)){switch(a.helper.type){case "get":case "post":a.helper.pageid||a.helper.send("pageid",null,function(b){b&&b.trim().match(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/)&&(a.helper.pageid=b,a.helper.js9helper="js9helper")})}e=this.file;"/"!==e.charAt(0)&&f&&(d=this.file.replace(f,""));a.helper.send("image",{image:e,image2:d},function(d){if("object"===typeof d){var e=d.stdout;d.stderr&&1<a.DEBUG&&
a.log(d.stderr)}else e=d;e&&(d=e.trim().match(/(?:[^\s[]+|\[[^\]]*\])+/g)[1],"?"!==d&&(a.globalOpts.dataDir?(e=d.lastIndexOf("/")+1,c.fitsFile=a.globalOpts.dataDir+"/"+d.slice(e)):(c.fitsFile=d,c.fitsFile.includes("/")||(b=c.file.match(/.*\//))&&b.length&&(d=new RegExp("^"+a.INSTALLDIR),b=b[0].replace(d,""),c.fitsFile=b+c.fitsFile),a.globalOpts.prependJS9Dir&&(c.fitsFile&&!c.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==c.fitsFile.charAt(0)&&(c.fitsFile="${JS9_DIR}/"+c.fitsFile),c.parentFile&&!c.parentFile.match(/^\${JS9_DIR}/)&&
"/"!==c.parentFile.charAt(0)&&(c.parentFile="${JS9_DIR}/"+c.parentFile))),1<a.DEBUG&&a.log("JS9 fitsFile: %s %s",c.file,c.fitsFile)),c.fitsFile&&(c.fitsFile=a.cleanPath(c.fitsFile)),c.parentFile&&(c.parentFile=a.cleanPath(c.parentFile)),c.queried||(c.queryHelper("all"),c.queried=!0))})}return this};a.Image.prototype.queryHelper=function(c){var b=this;c=c||"all";!a.helper.connected||"all"!==c&&"getAnalysis"!==c||this.analysisPackages||a.helper.send("getAnalysis",{fits:this.fitsFile},function(c){if(c)try{b.analysisPackages=
JSON.parse(c)}catch(e){a.log("can't get analysis",e)}});return this};a.Image.prototype.expandMacro=function(c,b){var d=this,e;if(c)return c.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g,function(c,h,g){g=function(b){var c=d.params.wcssys;if(b)switch(b){case "wcs":a.notWCS(c)&&(d.params.wcssys=d.params.wcssys0);break;case "physical":case "image":d.params.wcssys=b}return c};var f=function(a){var b;"table"===d.imtab?d.raw.hdu.table.filter&&!a.match(d.raw.hdu.table.filter)&&(a=a.match(/\]\[/)?a.slice(0,
-1)+"&&"+d.raw.hdu.table.filter+"]":a+("["+d.raw.hdu.table.filter+"]")):"image"===d.imtab&&(b=d.file.match(/\[.*\]/))&&(a=a.match(/\[.*\]/)?a.replace(/\[.*\]/,b):a+b);return a},l=h.split("(");l[1]&&(l[1]=l[1].replace(/\)$/,""));switch(l[0]){case "id":var m=d.display.divjq.attr("id");break;case "image0":m=d.id.replace(/\[EVENTS\]/i,"");break;case "image":case "png":m=d.id;break;case "filename":d.parentFile&&"this"!==l[1]?d.raw&&d.raw.filter?(m=d.parentFile,m.match(/\[.*\]/)||(m+="[EVENTS]"),m+="["+
d.raw.filter+"]"):m=f(d.parentFile):d.fitsFile?m=f(d.fitsFile):a.error("no FITS file for "+d.id);break;case "fits":d.fitsFile||a.error("no FITS file for "+d.id);m=f(d.fitsFile);break;case "parent":d.parentFile||a.error("no parent FITS file for "+d.id);m=d.parentFile;break;case "ext":d.fitsFile?(m=d.fitsFile.match(/\[.*\]/),null===m&&(m="")):a.error("no FITS file for "+d.id);break;case "imcenter":m=d.displayToLogicalPos({x:d.display.width/2,y:d.display.height/2});m=m.x+","+m.y;break;case "wcscenter":m=
d.displayToImagePos({x:d.display.width/2,y:d.display.height/2});m=a.pix2wcs(d.raw.wcs,m.x,m.y).replace(/\s+/g,",");break;case "sregions":c=g(l[1]);m=d.listRegions("source",{mode:0,includedcoords:a.globalOpts.regExpandDCoords}).replace(/\s+/g,"");c&&(d.params.wcssys=c);break;case "bregions":c=g(l[1]);m=d.listRegions("background",{mode:0,includedcoords:a.globalOpts.regExpandDCoords}).replace(/\s+/g,"");c&&(d.params.wcssys=c);break;case "regions":c=g(l[1]);m=d.listRegions("all",{mode:0,includedcoords:a.globalOpts.regExpandDCoords}).replace(/\s+/g,
"");c&&(d.params.wcssys=c);break;case "mag":m=d.params.zoom?sprintf("%s%",100*d.params.zoom):"?";break;default:if(b)for(e=b.length,g=0;g<e;g++)if(b[g].name===h){m=b[g].value;break}if(void 0===m&&d&&void 0!==d.params[h])switch(h){case "wcsunits":switch(d.params[h]){case "sexagesimal":m="hms";break;case "degrees":m="deg";break;default:m=d.params[h]}break;case "scaleclipping":switch(d.params[h]){case "dataminmax":m="data";break;default:m=d.params[h]}break;default:m="number"===typeof d.params[h]&&d.params[h]!==
Math.floor(d.params[h])?d.params[h].toFixed(2):d.params[h]}void 0===m&&(m=c)}return m})};a.Image.prototype.lookupAnalysis=function(a){var b,c,e=null;if(this.analysisPackages){for(c=0;c<this.analysisPackages.length&&!e;c++){var f=this.analysisPackages[c];for(b=0;b<f.length;b++){e=f[b];if(e.xclass&&e.xclass+":"+e.name===a)break;e=null}}if(e)return e;for(c=0;c<this.analysisPackages.length&&!e;c++)for(f=this.analysisPackages[c],b=0;b<f.length;b++){e=f[b];if(e.name===a)break;e=null}}return e};a.Image.prototype.validateAnalysis=
function(c){var b,d=/imVar\((.*),(.*)\)/,e=/js9Var\((.*),(.*)\)/;var f=/fitsHeader\(([A-Za-z0-9_]+),(.*)\)/;var h=/winVar\((.*),(.*)\)/,g=function(a,b){return a&&b?String(a).toUpperCase()===String(b).toUpperCase():!1};if(!c.title||!c.name||c.hidden)return!1;if(c.files){if(c.files.match(/^fits$/)&&!this.fitsFile||c.files.match(/^png$/)&&"fits2png"!==this.source||c.files.match(/^table$/)&&"table"!==this.imtab||c.files.match(/^image$/)&&"image"!==this.imtab)return!1;if(b=c.files.match(f))if(f=this.raw.header[b[1].toUpperCase()],
!g(f,b[2]))return!1;if(b=c.files.match(h))if(f=a.varByName(b[1],window),!g(f,b[2]))return!1;if(b=c.files.match(e))if(f=a.varByName(b[1],a),!g(f,b[2]))return!1;if(b=c.files.match(d))if(f=a.varByName(b[1],this),!g(f,b[2]))return!1}return!0};a.Image.prototype.getAnalysis=function(){var a,b,d=[];if(!this.analysisPackages)return d;for(b=0;b<this.analysisPackages.length;b++){var e=this.analysisPackages[b];for(a=0;a<e.length;a++){var f=e[a];this.validateAnalysis(f)&&d.push(f)}}return d};a.Image.prototype.runAnalysis=
function(c,b,d){var e=this,f,h,g={},k=function(b,c){a.helper||a.error(b,c);switch(a.helper.type){case "nodejs":case "socket.io":a.helper.socket&&"polling"===a.helper.socket.io.engine.transport.name?window.setTimeout(function(){a.error(b,c)},0):a.error(b,c);break;default:a.error(b,c)}};b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(l){a.error("can't parse analysis opts: "+b,l)}d=d||a.globalOpts.analysisFunc;if(a.helper.connected&&this.analysisPackages){if(f=this.lookupAnalysis(c)){f.action&&
(g.cmd=this.expandMacro(f.action,b));if(f.keys)for(g.keys={},c=0;c<f.keys.length;c++)g.keys[f.keys[c]]=this.expandMacro("$"+f.keys[c],b);g.id=this.expandMacro("$id");g.image=this.file;g.fits=this.fitsFile;g.rtype=f.rtype;switch(a.helper.type){case "nodejs":case "socket.io":c=f.xclass?f.xclass+":"+f.name:f.name;break;default:c="runAnalysis"}a.waiting(!0,this.display);this.setStatus("runAnalysis","processing");a.helper.send(c,g,function(c){var l;var n="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?
{stderr:c}:{stdout:c};n.errcode=n.errcode||0;if(d)d.call(e,n.stdout,n.stderr,n.errcode,f);else{if(n.stderr)if(c=n.stderr,0<=c.search(/WARNING:/i)&&0>c.search(/ERROR:/i))a.log(c);else{k(c,a.analOpts.epattern);return}else if(n.errcode)if(c="ERROR: running "+f.name+" ["+n.errcode+"]",n.stdout)a.log(c);else{k(c,a.analOpts.epattern);return}switch(f.rtype){case "text":case void 0:e.displayAnalysis("text",n.stdout,{divid:a.globalOpts.analysisDiv});break;case "plot":e.displayAnalysis("plot",n.stdout,{divid:a.globalOpts.analysisDiv});
break;case "alert":n.stdout&&alert(n.stdout);break;case "fits":case "png":(l=n.stdout.split(/\s+/))&&l[0]&&(c=a.cleanPath(l[0]),"/"!==c.charAt(0)&&(c=a.InstallDir(c)),n={proxyFile:c},l[1]&&(l=a.cleanPath(l[1]),n.parentFile=l),n.fits2fits=!1,n.fixpath=!1,a.Load(c,n,{display:e.display}));break;case "regions":if((l=n.stdout.split(/\s+/))&&l[0]){if(1<l.length)try{h=JSON.parse(l[1])}catch(p){h=null}h=h||{};"boolean"===typeof h.remove&&(h.remove="all");"string"===h.type?(h.remove&&e.removeShapes("regions",
h.remove),e.addShapes("regions",l[0],b)):(c=a.cleanPath(l[0]),"/"!==c.charAt(0)&&(c=a.InstallDir(c)),g={responseType:"text"},a.fetchURL(null,c,g,function(a,b){h.remove&&e.removeShapes("regions",h.remove);e.addShapes("regions",a,b)}))}break;case "catalog":(l=n.stdout.split(/\s+/))&&l[0]&&(c=a.cleanPath(l[0]),g={responseType:"text"},a.fetchURL(null,c,g,function(a,b){e.loadCatalog(null,a,b)}));break;case "none":break;default:a.error("unknown analysis result type: "+f.rtype)}}e.setStatus("runAnalysis",
"complete");a.waiting(!1)});return this}a.error("could not find analysis task: "+c)}};a.Image.prototype.displayAnalysis=function(c,b,d){var e=this,f,h;var g=a.lightOpts[a.LIGHTWIN];var k=function(){var b=a.Plot.opts.title;if(q&&r){$(a.lightOpts[a.LIGHTWIN].topid).arrive("#plotConfigForm",{onceOnly:!0},function(){a.Plot.initConfigForm.call(e,r,p)});var c=a.allinone?a.allinone.plotConfigHTML:a.InstallDir(a.Plot.opts.configURL);r.winid=e.displayAnalysis("params",c,{title:b,winformat:"width=368px,height=110px,resize=1,scrolling=1"})}};
d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(v){a.error("can't parse display opts: "+d,v)}var l=d.winformat;d.divid&&0<$("#"+d.divid).length&&(f=$("#"+d.divid));var m=d.title||"";this&&!m&&(d=this.fitsFile||this.id||"",d=d.split("/").reverse()[0],m="AnalysisResults: "+d+sprintf(a.IDFMT,this.display.id));d="Analysis_"+a.uniqueID();switch(c){case "text":b="<div class='JS9Analysis'></div><pre class='JS9AnalysisText'>"+((b||"")+"</pre></div>");if(f)f.html(b),window.electron&&a.searchbar(f[0]);
else{l=l||g.textWin;var n=a.lightWin(d,"inline",b,m,l);window.electron&&a.searchbar(n)}break;case "plot":if(b&&"string"===typeof b)try{var p=JSON.parse(b)}catch(v){a.error("can't plot return data: "+b,v)}else"object"===typeof b&&(p=b);if(!p)return;p.curscale={x:"linear",y:"linear"};b="<div id='"+d+"' class='JS9Analysis'><div id='"+d+"Plot' class='JS9Plot' ></div></div>";f?f.html(b):(l=l||g.plotWin,n=a.lightWin(d,"inline",b,m,l));var q=$("#"+d+" #"+d+"Plot");f&&(q.css("width",f.css("width")),q.css("height",
f.css("height")),q.css("margin",0));if(p.data){switch(a.globalOpts.plotLibrary){case "plotly":g=$.extend(!0,{},a.Plot.opts,p.opts);p.label&&(g.title=p.label);b={x:[],y:[],type:"scatter"};3<=p.data[0].length&&(b.error_y={type:"data",array:[],visible:!0},p.points&&p.points.yerr&&p.points.yerr.color&&(b.error_y.color=p.points.yerr.color));for(l=0;l<p.data.length;l++)b.x.push(p.data[l][0]),b.y.push(p.data[l][1]),b.error_y&&b.error_y.array&&b.error_y.array.push(p.data[l][2]);a.Plot.opts.annotate&&p.annotations&&
(g.annotations=a.Plot.annotate(p));"log"===g.xscale&&(g.xaxis=g.xaxis||{},g.xaxis.type="log",g.xaxis.autorange=!0,p.curscale.x="log");"log"===g.yscale&&(g.yaxis=g.yaxis||{},g.yaxis.type="log",g.yaxis.autorange=!0,p.curscale.y="log");try{Plotly.newPlot(q.attr("id"),[b],g)}catch(v){a.error("can't plot data (plotly)",v)}break;default:g=$.extend(!0,{},a.Plot.opts,p.opts);a.Plot.opts.annotate&&p.annotations&&(g.zoomStack.func=function(b,c){a.Plot.annotate(q,b,p)});p.color=p.color||g.color;"log"===p.xscale&&
(g.xaxis=g.xaxis||{},g.xaxis.transform=a.Plot.logfunc,g.xaxis.inverseTransform=a.Plot.expfunc,p.curscale.x="log");"log"===p.yscale&&(g.yaxis=g.yaxis||{},g.yaxis.transform=a.Plot.logfunc,g.yaxis.inverseTransform=a.Plot.expfunc,p.curscale.y="log");try{var r=$.plot(q,[p],g)}catch(v){a.error("can't plot data (flot)",v)}a.Plot.opts.annotate&&p.annotations&&a.Plot.annotate(q,r,p)}q.css("outline","none");q.attr("tabindex",0);q.on("keydown",function(b){b=a.eventToCharStr(b);switch(b){case "c":k();break;case "x":case "y":h=
"linear"!==p.curscale[b]?"linear":"log",a.Plot.rescale(q,r,p,b,h)}});l=$("<img src='"+a.InstallDir("images/gears.png")+"'>");l.on("click",k);b=$("<div class='JS9PlotGear'>");b.append(l);q.append(b)}break;case "params":case "regions":case "textline":f?a.allinone?f.html(b):$.ajax({url:b,cache:!1,dataType:"text",success:function(a){f.html(a)}}):(l="params"===c?l||g.paramWin:"regions"===c?"small"===a.globalOpts.regConfigSize?l||g.regWin0:l||g.regWin:l||g.dpathWin,n=a.allinone?"inline":"ajax",n=a.lightWin(d,
n,b,m,l))}return n};a.Image.prototype.saveFITS=function(c,b){if(window.hasOwnProperty("saveAs")){c=c?c.replace(/\.fz$/i,"").replace(/(png|jpg|jpeg)$/i,"fits"):"js9.fits";b=b||{};if("string"===typeof b){try{var d=JSON.parse(b)}catch(e){d=null}d&&(b=d)}"display"===b||"display"===b.source?(b=this.displayToImagePos({x:0,y:this.rgb.img.height}),d=this.displayToImagePos({x:this.rgb.img.width,y:0}),b={x0:b.x,y0:b.y,x1:d.x,y1:d.y},b=this.toArray({notab:!0,twoaxes:!0,sect:b})):b=this.toArray({notab:!0,twoaxes:!0});
b=new Blob([b],{type:"application/octet-binary"});a.saveAs(b,c)}else a.error("no saveAs() available to save FITS file");return c};a.Image.prototype.saveIMG=function(c,b,d){var e;if(window.hasOwnProperty("saveAs")){d=d||{};if("number"===typeof d){var f=d;d=null}else if("string"===typeof d){if(a.isNumber(d))f=parseFloat(d),d=null;else try{d=JSON.parse(d)}catch(m){d=null}d&&(f=d.quality)}c=c||"js9.png";b=b||"image/png";var h=this.display.width;var g=this.display.height;var k=document.createElement("canvas");
k.setAttribute("width",h);k.setAttribute("height",g);var l=k.getContext("2d");"image"===d.source?l.putImageData(this.rgb.img,0,0):l.drawImage(this.display.canvas,0,0);if(!1!==d.layers)for(e in this.layers)this.layers.hasOwnProperty(e)&&"main"===this.layers[e].dlayer.dtype&&this.layers[e].show&&(d=this.layers[e].dlayer.canvasjq[0],l.drawImage(d,0,0,h,g));a.notNull(f)&&(0>f||1<f)&&(f=.95);k.toBlob(function(b){a.saveAs(b,c)},b,f)}else a.error("no saveAs() available for saving image");return c};a.Image.prototype.savePNG=
function(a,b){a=a||"js9.png";a.match(/\.png$/)||(a+=".png");return this.saveIMG(a,"image/png",b)};a.Image.prototype.saveJPEG=function(a,b){a=a||"js9.jpg";a.match(/\.jpg$/)||a.match(/\.jpeg$/)||(a+=".jpg");return this.saveIMG(a,"image/jpeg",b)};a.Image.prototype.updateValpos=function(c,b){var d=null;var e=function(a,b){var c="";b=b||3;0>a&&(a=Math.abs(a),c="-");for(a=""+a;a.length<b;)a="0"+a;return c+a};if(this.params.valpos){void 0===b&&(b=!0);if(this.valpos)return b&&this.display.displayMessage("info",
this.valpos,a.globalOpts.valposTarget),this.valpos;var f={x:c.x,y:c.y,sys:"image"};var h=this.imageToLogicalPos(c);var g=this.imageToDisplayPos(c);g.sys="display";var k="image"===this.params.wcssys?f:h;d=this.raw.data[Math.floor(c.y-.5)*this.raw.width+Math.floor(c.x-.5)];switch(this.raw.bitpix){case 8:case 16:case -16:case 32:var l=e(d);break;case -32:case -64:l=a.floatFormattedString(d,this.params.precision,3);break;default:l=e(d)}e=l;var m=k.x.toFixed(3)+" "+k.y.toFixed(3)+" ("+k.sys+")";a.globalOpts.valposDCoords&&
"image"===k.sys&&(m+="&nbsp;&nbsp;&nbsp;&nbsp;"+g.x.toFixed(3)+" "+g.y.toFixed(3)+" ("+g.sys+")");var n=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+m;d={ix:f.x,iy:f.y,ipos:f.x.toFixed(2)+"\t\t "+f.y.toFixed(2),isys:"image",px:h.x,py:h.y,ppos:h.x.toFixed(2)+"\t\t "+h.y.toFixed(2),psys:"physical",dx:g.x,dy:g.y,dpos:g.x.toFixed(2)+"\t\t "+g.y.toFixed(2),dsys:"display",cx:k.x,cy:k.y,cpos:k.x.toFixed(2)+"\t\t "+k.y.toFixed(2),csys:k.sys,ra:"",dec:"",wcspos:"",wcssys:"",racen:"",deccen:"",wcsfov:"",wcspix:"",val:d,val3:l,
id:this.id,file:this.file,object:this.object||""};if(this.telescope||this.instrument)d.object&&(d.object+="  "),d.object+="(",this.telescope&&(d.object+=this.telescope,this.instrument&&(d.object+=", ")),this.instrument&&(d.object+=this.instrument),d.object+=")";if(0<this.raw.wcs&&a.isWCS(this.params.wcssys)&&(c=a.pix2wcs(this.raw.wcs,c.x,c.y).trim().split(/\s+/),n=c[0]+" "+c[1]+" ("+(c[2]||"wcs")+")",n=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+n+"&nbsp;&nbsp;&nbsp;&nbsp;"+m,d.ra=c[0],d.dec=c[1],d.wcspos=c[0]+
"\t "+c[1],d.wcssys=c[2],this.raw.wcsinfo)){c=Math.abs(this.raw.wcsinfo.cdelt1);g=Math.abs(this.raw.wcsinfo.cdelt2);f=1/60;if(this.raw.header.CUNIT1)var p=this.raw.header.CUNIT1;if(!p||p.match(/^deg/i))1<=c||1<=g?p="deg":c>=f||g>=f?(p="'",c*=60,g*=60):(p='"',c*=3600,g*=3600);k=this.rgb.sect;f=((k.x1-k.x0)*c).toFixed(0);g=((k.y1-k.y0)*g).toFixed(0);d.wcsfov=""+f+p+" \u00d7 "+g+p;f=(c/k.zoom).toFixed(3);d.wcspix=""+f+p+"/pix";d.wcsfovpix=d.wcsfov+"  ("+d.wcspix+")";c=a.pix2wcs(this.raw.wcs,(k.x1+k.x0)/
2,(k.y1+k.y0)/2).trim().split(/\s+/);d.racen=c[0];d.deccen=c[1];d.wcscen=c[0]+"\t "+c[1]}d.vstrsmall=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+m;d.vstr=n;d.vstrmedium=n;d.vstrlarge=n+"&nbsp;&nbsp;&nbsp;&nbsp;"+this.file;b&&this.display.displayMessage("info",d,a.globalOpts.valposTarget)}return d};a.Image.prototype.toggleValpos=function(){this.params.valpos=!this.params.valpos;this.params.valpos||this.display.clearMessage()};a.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,
contrast:this.params.contrast,bias:this.params.bias}};a.Image.prototype.setColormap=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=this,f=$jscomp.makeIterator(b);d=f.next().value;var h=f.next().value;f=f.next().value;var g=function(b){if(e.cmapObj)switch(e.cmapObj.name){case "red":e.display.rgb.rim===e&&(e.display.rgb.rim=null);break;case "green":e.display.rgb.gim===e&&(e.display.rgb.gim=null);break;case "blue":e.display.rgb.bim===e&&(e.display.rgb.bim=null)}delete e.staticObj;
e.cmapObj=a.lookupColormap(b);e.params.colormap=e.cmapObj.name;"static"===e.cmapObj.type&&(e.staticObj=$.extend(!0,{},e.cmapObj));switch(b){case "red":e.display.rgb.rim=e;break;case "green":e.display.rgb.gim=e;break;case "blue":e.display.rgb.bim=e}},k=function(a,b){a=parseFloat(a);Number.isNaN(a)||(e.params.contrast=a);b=parseFloat(b);Number.isNaN(b)||(e.params.bias=b)},l=function(a){var b,c;for(b=0;b<a.length;b++)if($.isArray(a[b])&&"string"===typeof a[b][0])for(c=0;c<e.staticObj.colors.length;c++){var d=
e.staticObj.colors[c];if(a[b][0]===d.name){switch(a[b].length){case 2:!1===a[b][1]||"false"===a[b][1]?d.active=!1:!0===a[b][1]||"true"===a[b][1]?d.active=!0:(c=parseFloat(a[b][1]),0<c&&1>=c&&(c*=255),d.alpha=c);break;case 3:d.min=parseFloat(a[b][1]),Number.isNaN(d.min)&&(d.min=-Infinity),d.max=parseFloat(a[b][2]),Number.isNaN(d.max)&&(d.max=Infinity)}break}}};if(!(0<=$.inArray("colormap",this.params.disable)&&this.cmapObj)){switch(b.length){case 1:switch(d){case "rgb":this.display.rgb.active=!this.display.rgb.active;
break;case "invert":this.params.invert=!this.params.invert;break;case "reset":this.params.invert=a.imageOpts.invert;this.params.contrast=a.imageOpts.contrast;this.params.bias=a.imageOpts.bias;break;default:if(this.cmapObj&&"static"===this.cmapObj.type)if($.isArray(d))l(d);else if("string"===typeof d&&"["===d.charAt(0))try{var m=JSON.parse(d);l(m)}catch(n){a.error("can't parse JSON in setColormap: "+d,n)}else g(d);else"string"===typeof d&&g(d)}break;case 2:a.isNumber(d)&&a.isNumber(h)?k(d,h):this.cmapObj&&
"static"===this.cmapObj.type&&(g(d),l(h));break;case 3:g(d),k(h,f)}this.displayImage("colors");this.xeqStashDiscard("filterRGBImage");a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetcolormap");return this}};a.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax,scaleclipping:this.params.scaleclipping}};a.Image.prototype.setScale=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];
var e=this,f=$jscomp.makeIterator(b);d=f.next().value;var h=f.next().value;f=f.next().value;var g=function(b){a.scales.includes(b)?e.params.scale=b:"dataminmax"===b?(e.params.scaleclipping="dataminmax",e.params.scalemin=e.raw.dmin,e.params.scalemax=e.raw.dmax):"zscale"===b?(void 0!==e.params.z1&&void 0!==e.params.z2||e.zscale(!1),e.params.scaleclipping="zscale",e.params.scalemin=e.params.z1,e.params.scalemax=e.params.z2):"zmax"===b?(void 0===e.params.z1&&e.zscale(!1),e.params.scaleclipping="zmax",
e.params.scalemin=e.params.z1,e.params.scalemax=e.raw.dmax):"user"===b?e.params.scaleclipping="user":a.error("unknown scale: "+b)};if(!(0<=$.inArray("scale",this.params.disable))){if(b.length){switch(b.length){case 1:g(d);break;case 2:this.params.scalemin=parseFloat(d);this.params.scalemax=parseFloat(h);this.params.scaleclipping="user";break;default:g(d),"zscale"!==d&&"zmax"!==d&&(this.params.scalemin=parseFloat(h),this.params.scalemax=parseFloat(f),this.params.scaleclipping="user")}this.params.precision=
a.floatPrecision(this.params.scalemin,this.params.scalemax);this.displayImage("colors")}a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetscale");return this}};a.Image.prototype.getOpacity=function(){var c={};a.notNull(this.params.opacity)?c.opacity=this.params.opacity:c.opacity=1;a.notNull(this.params.flooropacity)&&(c.flooropacity=this.params.flooropacity,c.floorvalue=this.params.floorvalue);return c};a.Image.prototype.setOpacity=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-
0]=arguments[d];var e=$jscomp.makeIterator(b);d=e.next().value;var f=e.next().value;e=e.next().value;if(!(0<=$.inArray("opacity",this.params.disable))){if(b.length){switch(b.length){case 1:"string"===typeof d?"reset"===d.toLowerCase()?this.params.opacity=1:"resetfloor"===d.toLowerCase()?(delete this.params.floorvalue,delete this.params.flooropacity):"resetall"===d.toLowerCase()&&(this.params.opacity=1,delete this.params.floorvalue,delete this.params.flooropacity):a.isNumber(d)&&(this.params.opacity=
parseFloat(d));break;case 2:a.isNumber(d)&&a.isNumber(f)&&(this.params.floorvalue=parseFloat(d),this.params.flooropacity=parseFloat(f));break;case 3:a.isNumber(d)&&(this.params.opacity=parseFloat(d)),a.isNumber(f)&&a.isNumber(e)&&(this.params.floorvalue=parseFloat(f),this.params.flooropacity=parseFloat(e))}("number"===typeof d||"string"===typeof d&&!d.match(/reset/))&&this.mask.active&&this.mask.im&&(this.mask.active=!1);this.displayImage("colors")}a.globalOpts.extendedPlugins&&this.xeqPlugins("image",
"onsetopacity");return this}};a.Image.prototype.getParam=function(a){return a?"all"===a?this.params:this.params[a]:null};a.Image.prototype.setParam=function(a,b){var c;if(!a)return null;if("all"===a&&"object"===typeof b){$.extend(!0,this.params,b);if(b.colormap||b.contrast||b.bias)a=this.getColormap(),b.colormap=b.colormap||a.colormap,b.contrast=b.contrast||a.contrast,b.bias=b.bias||a.bias,this.setColormap(b.colormap,b.contrast,b.bias);if(b.scale||b.scalemin||b.scalemax)a=this.getScale(),b.scale=
b.scale||a.scale,b.scalemin=b.scalemin||a.scalemin,b.scalemax=b.scalemax||a.scalemax,this.setScale(b.scale,b.scalemin,b.scalemax);b.flip&&(this.setFlip("reset"),this.setFlip(b.flip));b.rot90&&(this.setRot90("reset"),this.setRot90(b.rot90));b.rotate&&(this.setRotate("reset"),this.setRotate(b.rotate));b.invert&&(this.params.invert=b.invert,this.displayImage("colors"));b.zoom&&this.setZoom(b.zoom);b.wcssys&&this.setWCSSys(b.wcssys);b.wcsunits&&this.setWCSUnits(b.wcsunits);return this.params}if("disable"===
a){$.isArray(b)||(b=[b]);for(c=0;c<b.length;c++)a=$.inArray(b[c],this.params.disable),0>a&&this.params.disable.push(b[c]);return this.params.disable}if("enable"===a){$.isArray(b)||(b=[b]);for(c=0;c<b.length;c++)a=$.inArray(b[c],this.params.disable),0<=a&&this.params.disable.splice(a,1);return this.params.disable}c=this.params[a];this.params[a]=b;switch(a){case "colormap":this.setColormap(b);break;case "invert":this.displayImage("colors");break;case "contrast":a=this.getColormap();this.setColormap(a.colormap,
b,a.bias);break;case "bias":a=this.getColormap();this.setColormap(a.colormap,a.contrast,b);break;case "flip":this.setFlip("reset");this.setFlip(b);break;case "rot90":this.setRot90("reset");this.setRot90(b);break;case "rotate":this.setRotate("reset");this.setRotate(b);break;case "scale":this.setScale(b);break;case "scalemin":a=this.getScale();this.setScale("user",b,a.scalemax);break;case "scalemax":a=this.getScale();this.setScale("user",a.scalemin,b);break;case "scaleclipping":a=this.getScale();this.setScale(b,
a.scalemin,a.scalemax);break;case "wcssys":this.setWCSSys(b);break;case "wcsunits":this.setWCSUnits(b);break;case "zoom":this.setZoom(b)}return c};a.Image.prototype.copyParams=function(c,b,d){var e,f=[];if(c){d=d||{};if("string"===typeof c&&"["===c.charAt(0))try{c=JSON.parse(c)}catch(m){a.error("can't parse JSON in copyParams: "+c,m)}$.isArray(c)||(c=[c]);var h=$.inArray("regions",c);0<=h&&(c.splice(h,1),c.unshift("regions"));b=b||a.images;if("string"===typeof b&&"["===b.charAt(0))try{b=JSON.parse(b)}catch(m){a.error("can't parse JSON in copyParams: "+
b,m)}$.isArray(b)||(b=[b]);for(h=0;h<b.length;h++){var g=b[h];"string"===typeof g&&((g=a.lookupImage(g))||a.error("unknown image for copyParams"));if(g!==this){g!==g.display.image&&0>$.inArray(g.display.image,f)&&f.push(g.display.image);try{for(e=0;e<c.length;e++){var k=c[e];switch(k){case "alignment":g.alignPanZoom(this);break;case "contrastbias":var l=this.getParam("contrast");g.setParam("contrast",l);l=this.getParam("bias");g.setParam("bias",l);break;case "pan":l=this.getPan();g.setPan(a.pix2pix(this,
g,{x:l.ox,y:l.oy}));break;case "regions":this.copyRegions(g);break;case "shapes":d.layer&&this.copyShapes(d.layer,g);break;case "wcs":l=this.getParam("wcssys");g.setParam("wcssys",l);l=this.getParam("wcsunits");g.setParam("wcsunits",l);break;default:l=this.getParam(k),g.setParam(k,l)}}}catch(m){a.error("could not copy params for "+g.id)}finally{if(f.length)for(h=0;h<f.length;h++)f[h].displayImage()}}}}};a.Image.prototype.getStatus=function(c){if(!a.isNull(c)&&"string"===typeof c)switch(c.toLowerCase()){case "close":return this.status.close;
case "displaysection":case "displayextension":return this.status.displaySection;case "createmosaic":return this.status.createMosaic;case "load":case "preload":return a.fetchURL.status?a.fetchURL.status:this.status.load;case "loadcatalog":return this.status.loadCatalog;case "loadcolormap":return this.status.loadColormap;case "loadproxy":return this.status.loadProxy;case "loadregions":return this.status.loadRegions;case "loadsession":return this.status.loadSession;case "reproject":case "reprojectdata":case "rotate":case "rotatedata":return this.status.reprojectData;
case "runanalysis":return this.status.runAnalysis;case "separate":return this.status.separate;case "uploadfitsfile":return this.status.uploadFITSFile}};a.Image.prototype.setStatus=function(c,b){if(a.notNull(c)&&a.notNull(b))switch(b){case "error":case "complete":delete this.status.cur;break;default:this.status.cur=c}this.status[c]=b};a.Image.prototype.dataminmax=function(c,b){var d=this.raw;var e=this.params;var f=this.raw.data;var h=Number.isNaN(e.scalemin)||a.isNull(e.scalemin);var g=Number.isNaN(e.scalemax)||
a.isNull(e.scalemax);if("dataminmax"===e.scaleclipping){if(d.dmin===e.scalemin||a.isNull(d.dmin))h=!0;if(d.dmax===e.scalemax||a.isNull(d.dmax))g=!0}if(a.notNull(c)&&a.notNull(b))d.dmin=c,d.dmax=b;else if(d.dmin=Number.MAX_VALUE,d.dmax=Number.MIN_VALUE,0<d.bitpix)if(void 0!==d.header.BLANK){var k=d.header.BLANK;for(c=0;c<f.length;c++)b=f[c],b!==k&&(b<d.dmin&&(d.dmin=b),b>d.dmax&&(d.dmax=b))}else for(c=0;c<f.length;c++)b=f[c],b<d.dmin&&(d.dmin=b),b>d.dmax&&(d.dmax=b);else for(c=0;c<f.length;c++)b=f[c],
Number.isNaN(b)||(b<d.dmin&&(d.dmin=b),b>d.dmax&&(d.dmax=b));h&&(e.scalemin=d.dmin);g&&(e.scalemax=d.dmax);e.precision=a.floatPrecision(e.scalemin,e.scalemax);return this};a.Image.prototype.zscale=function(c){if(!a.zscale||!this.raw||!this.raw.data)return this;var b=this.raw.data;var d=b.length*b.BYTES_PER_ELEMENT;try{var e=a.vmalloc(d)}catch(f){a.error("image too large for zscale malloc: "+d,f)}try{a.vmemcpy(new Uint8Array(b.buffer),e)}catch(f){a.error("can't copy image to zscale heap: "+d,f)}b=
a.zscale(e,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);a.vfree(e);e=b.trim().split(/\s+/);this.params.z1=parseFloat(e[0]);this.params.z2=parseFloat(e[1]);"zmax"===c?(this.params.scalemin=this.params.z1,this.params.scalemax=this.raw.dmax):c&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);this.params.precision=a.floatPrecision(this.params.scalemin,this.params.scalemax);return this};a.Image.prototype.countsInRegions=
function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=this,f,h;d="field";var g="",k=function(b,c,d){var f=/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;if(!b)return d;if("string"===typeof b){c=e.expandMacro(b);if(!c)return d;if(c.match(f))return c}(f=e.getShapes("regions",b))&&f.length||a.error("no regions found: "+b);c="";for(b=0;b<f.length;b++){var g=f[b];e.params.wcssys?(c||(c=g.wcssys||""),c+="; "+g.wcsstr):(c||(c=g.imsys||""),c+="; "+g.imstr)}return c||d};
this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile||a.error("no virtual file available for regcnts: "+this.id);for(f=0;f<b.length;f++){var l=b[f];if("string"===typeof l&&"{"===l.charAt(0))try{b[f]=JSON.parse(l)}catch(n){a.error("can't parse JSON arg in regcnts: "+l,n)}}switch(b.length){case 0:break;case 1:"object"===typeof b[0]?h=b[0]:d=k(b[0],"$sregions","field");break;case 2:d=k(b[0],"$sregions","field");"object"===typeof b[1]?h=b[1]:g=k(b[1],"$bregions","");break;default:d=k(b[0],"$sregions",
"field"),g=k(b[1],"$bregions",""),h=b[2]}h=h||{};h.reduce=h.reduce||a.globalOpts.reduceRegcnts;h.dim=h.dim||Math.max(a.globalOpts.image.xdim,a.globalOpts.image.ydim);f=h.cmdswitches||"";b=this.raw.hdu.fits.vfile;(l=this.file.match(/\[.*\]/))&&(b+=l);"table"===this.imtab?(l=this.raw.hdu.table.filter)&&!b.match(l)&&(b=b.match(/\]\[/)?b.slice(0,-1)+"&&"+l+"]":b+("["+l+"]")):3===this.raw.header.NAXIS&&0>f.search(/(^| )-c/)&&(f+=" -c "+(this.raw.hdu.slice||1));if(h.reduce&&!this.parentFile&&(l=this.fileDimensions(),
l=Math.floor(Math.max(l.xdim,l.ydim)/h.dim+.5),1<l))if("table"===this.imtab)f+=" -b "+l;else{var m="bin"+l+"_"+b.split("/").reverse()[0];a.imsection(b,m,"0@0,0@0,"+l,"");b=m}a.waiting(!0,this.display);l=a.regcnts(b,d,g,f);a.waiting(!1);m&&a.vunlink(m);(l.match(/^ERROR/)||l.match(/FITSIO status/))&&a.error(l);h.lightwin&&this.displayAnalysis("text",l,{divid:a.globalOpts.analysisDiv});return l};a.Image.prototype.radialProfile=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=
[];var f={cmdswitches:"-j -r"};for(d=0;d<b.length;d++)if("object"===typeof b[d]){var h=$.extend(!0,{},b[d],f);e.push(h);var g=h}else e.push(b[d]);h||e.push(f);g=g||{};if(d=this.countsInRegions.apply(this,$jscomp.arrayFromIterable(e)))try{var k=JSON.parse(d)}catch(l){a.error("can't parse regcnts JSON",l)}k&&k.columnUnits&&k.columnUnits.radii||a.error("no radii available for radial profile");d=k.columnUnits.radii;b=k.columnUnits.surfBrightness;h=g.color||"green";e=g.errorcolor||"red";g=a.isNull(g.errorbars)||
g.errorbars?"y":"n";g={color:sprintf("%s",h),label:sprintf("surface brightness(%s) vs. radius(%s)",b,d),points:{errorbars:sprintf("%s",g),yerr:{show:"true",color:sprintf("%s",e)}},data:[]};for(d=0;d<k.backgroundSubtractedResults.length;d++)b=k.backgroundSubtractedResults[d],("undefined"===b.radius2||"NA"===b.radius2||b.radius1>b.radius2)&&a.error("radial profile source region must be an annulus"),b=[(b.radius1+b.radius2)/2,b.surfBrightness,b.surfError],g.data.push(b);return this.displayAnalysis("plot",
g,{divid:a.globalOpts.analysisDiv})};a.Image.prototype.plot3d=function(c,b,d){var e,f,h=[];this.raw.header&&3===this.raw.header.NAXIS||a.error("plot3d requires a data cube with 3 dimensions");d=$.extend(!0,{},d,a.globalOpts.plot3d);d.cube=d.cube||"*:*:all";var g=d.cube.split(":");for(e=0;e<g.length;e++)if("all"===g[e]){var k=e+1;break}k||a.error("plot3d requires specification of cube's third index");d.cmdswitches="-j -c "+d.cube;g=d.mode||"avg";d.areaunits?d.areaunits.match(/^p/)?(d.areaunits="pixels",
d.cmdswitches+=" -p"):d.areaunits.match(/^a/)?d.areaunits="arcsec":(d.areaunits="pixels",d.cmdswitches+=" -p"):(d.areaunits="pixels",d.cmdswitches+=" -p");e=d.color||"green";if(c=this.countsInRegions(c,b,d))try{var l=JSON.parse(c)}catch(n){a.error("can't parse regcnts results: "+c,n)}l||a.error("no regcnts info available for plot3d");c=(c=this.raw.header["CTYPE"+String(k)])?c.toLowerCase():"slice";b="avg"===g?"pixels"===d.areaunits?"counts/pixel**2":"counts/arcsec**2":"summed counts";b={color:sprintf("%s",
e),label:sprintf("%s vs %s ",b,c),data:[]};var m=this.raw.header["CRVAL"+String(k)]||0;k=this.raw.header["CDELT"+String(k)]||1;for(e=0;e<l.source.cubeSlices;e++){c="backgroundSubtractedResults"+String(e+1);for(f=h[e]=0;f<l[c].length;f++)h[e]="avg"===g?h[e]+l[c][f].surfBrightness:h[e]+l[c][f].netCounts;c=[e*k+m,h[e]];b.data.push(c)}return this.displayAnalysis("plot",b,{divid:d.divid||a.globalOpts.analysisDiv})};a.Image.prototype.rawDataLayer=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-
0]=arguments[d];var e=$jscomp.makeIterator(b);d=e.next().value;e=e.next().value;if(!b.length)return this.raw.id;d=d||{};if("string"===typeof d)if("function"===typeof e)d={rawid:d};else{var f=d;for(b=0;b<this.raws.length;b++){var h=this.raws[b];if(f===h.id){if("remove"===e){f===a.RAWID0&&a.error("can't remove primary (raw0) data layer");if(h.hdu&&h.hdu.fits){var g=a.lookupVfile(h.hdu.fits.vfile);1>=g.length&&a.cleanupFITSFile(h,!0)}this.raw=this.raws[0];if(h.current0&&h.current0.id)for(g=0;g<this.raws.length;g++)if(h.current0.id===
this.raws[g].id){this.raw=this.raws[g];break}for(g=0;g<a.images.length;g++)(d=a.images[g])&&d.xeqstash&&d.xeqStashDiscard(f);this.raws.splice(b,1)}else this.raw=h;this.raw.header.BITPIX&&(this.raw.bitpix=this.raw.header.BITPIX);this.imtab=this.raw.imtab||this.imtab;this.params.scalemin=void 0;this.params.scalemax=void 0;this.dataminmax();this.mkSection();this.initWCS();this.initLCS();this.displayImage("all");this.refreshLayers();a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onrawdatalayer");
return!0}}return!1}if("function"!==typeof e)return!1;if("string"===typeof d)try{d=JSON.parse(d)}catch(m){a.error("can't parse rawData opts: "+d,m)}var k=d.rawid||a.RAWIDX;void 0===d.oraw&&(d.oraw="current0");if("current"===d.oraw)f=this.raw;else if("current0"===d.oraw)f=this.raw.id===k?this.raw.current0:this.raw;else for(b=0;b<this.raws.length;b++)if(h=this.raws[b],d.oraw===h.id){f=h;break}f||(f=this.raws[0]);h=-1;for(b=0;b<this.raws.length;b++)if(k===this.raws[b].id){g=this.raws[b];h=b;break}if(0>
h||d.alwaysCopy){g=$.extend(!0,{},f);g.current0=f;if(d.bitpix){switch(d.bitpix){case 8:g.data=new Uint8Array(f.height*f.width);break;case 16:g.data=new Int16Array(f.height*f.width);break;case -16:g.data=new Uint16Array(f.height*f.width);break;case 32:g.data=new Int32Array(f.height*f.width);break;case -32:g.data=new Float32Array(f.height*f.width);break;case -64:g.data=new Float64Array(f.height*f.width)}var l=g.width*g.height;for(b=0;b<l;b++)g.data[b]=f.data[b];g.bitpix=d.bitpix}else switch(f.bitpix){case 8:g.data=
new Uint8Array(f.data);break;case 16:g.data=new Int16Array(f.data);break;case -16:g.data=new Uint16Array(f.data);break;case 32:g.data=new Int32Array(f.data);break;case -32:g.data=new Float32Array(f.data);break;case -64:g.data=new Float64Array(f.data)}g.id=k;g.from=d.from||g.from||"func"}e.call(this,f,g,d)&&(0<=h?this.raws[h]=g:this.raws.push(g),this.raw=g,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),!1!==d.dataminmax&&this.dataminmax(),d.updatewcs&&(this.initWCS(),this.initLCS()),
d.resetpan&&this.setPan(),this.refreshLayers(),this.displayImage("all",d),this.reFlipRot());return!0};a.Image.prototype.gaussBlurData=function(c){var b={};void 0===c&&a.error("missing sigma value for gaussBlurData");this.params.sigma=c;b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(d){a.error("can't parse gaussBlur opts: "+b,d)}b.bitpix=-64===this.raw.bitpix?-64:-32;b.oraw="current0";b.alwaysCopy=!0;b.rawid=b.rawid||"gaussBlur";b.sigma=c;this.xeqStashSave("gaussBlurData",[c],b.rawid);this.rawDataLayer(b,
function(b,e){switch(e.bitpix){case -32:var d=new Float32Array(e.data);break;case -64:d=new Float64Array(e.data);break;default:a.error("invalid temp bitpix for gaussBlur: "+e.bitpix)}gaussBlur(d,e.data,e.width,e.height,c);return!0});return this};a.Image.prototype.imarithData=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=$jscomp.makeIterator(b),f=e.next().value;d=e.next().value;e=e.next().value;if(!b.length)return"add sub mul div min max reset".split(" ");e=e||{};if("string"===
typeof e)try{e=JSON.parse(e)}catch(h){a.error("can't parse imarith opts: "+e,h)}e.rawid=e.rawid||"imarith";if("reset"===f||"remove"===f)this.rawDataLayer(e.rawid,"remove");else{void 0!==f&&void 0!==d||a.error("missing arg(s) for image arithmetic");this.xeqStashSave("imarithData",b.slice(),e.rawid);switch(f){case "add":case "sub":case "mul":case "div":case "min":case "max":e.op=f;break;default:a.error("invalid operator for image arithmetic: "+f)}"object"===typeof d?(this.raw.width===d.raw.width&&this.raw.height===
d.raw.height||a.error("images must be the same size for image arithmetic"),e.argtype="image",e.argval=d):a.isNumber(d)?(e.argtype="value",e.argval=d):((b=a.lookupImage(d))||a.error("imarith arg1 must be an image or a constant: "+d),e.argval=b,e.argtype="image");"div"===e.op&&"value"===e.argtype&&0===e.argval&&a.error("imarith can't divide by zero (nor can anyone else)");if(!e.bitpix)switch(e.argtype){case "image":e.bitpix=0<this.raw.bitpix&&0<e.argval.raw.bitpix?Math.max(this.raw.bitpix,e.argval.raw.bitpix):
0>this.raw.bitpix&&0>e.argval.raw.bitpix?Math.min(this.raw.bitpix,e.argval.raw.bitpix):0>this.raw.bitpix&&0<e.argval.raw.bitpix?this.raw.bitpix:e.argval.raw.bitpix;break;case "value":e.bitpix=-64===this.raw.bitpix?-64:-32}e.alwaysCopy=!0;e.oraw="current";this.rawDataLayer(e,function(b,c,d){switch(d.argtype){case "image":b=d.argval.raw.data;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=b[d];break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=b[d];break;case "mul":for(d=0;d<c.data.length;d++)c.data[d]*=
b[d];break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=0===b[d]?0:c.data[d]/b[d];break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],b[d]);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=Math.max(c.data[d],b[d]);break;default:a.error("unknown operation for imarith: "+d.op)}break;case "value":b=d.argval;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=b;break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=b;break;case "mul":for(d=0;d<c.data.length;d++)c.data[d]*=
b;break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=0===b?0:c.data[d]/b;break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],b);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=Math.max(c.data[d],b);break;default:a.error("unknown op for imarith: "+d.op)}break;default:a.error("unknown arg type for imarith: "+d.argtype)}return!0});return this}};a.Image.prototype.shiftData=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=$jscomp.makeIterator(b);
d=e.next().value;var f=e.next().value;e=e.next().value;void 0!==d&&void 0!==f||a.error("missing translation value(s) for shiftData");e=e||{};if("string"===typeof e)try{e=JSON.parse(e)}catch(h){a.error("can't parse shift opts: "+e,h)}e.rawid=e.rawid||"shift";e.x=parseFloat(d);e.y=parseFloat(f);this.xeqStashSave("shiftData",b.slice(),e.rawid);this.rawDataLayer(e,function(a,b,c){var d=a.data.BYTES_PER_ELEMENT;void 0===b.xoff&&(b.xoff=0);void 0===b.yoff&&(b.yoff=0);b.xoff+=c.x;b.yoff+=c.y;if(!c.fill||
"clear"===c.fill){if(0<b.bitpix){var e=c.blank||b.header.BLANK||0;b.header.BLANK=e}else e=NaN;if("function"===typeof b.data.fill)b.data.fill(e);else for(c=0;c<b.data.length;c++)b.data[c]=e}for(c=0;c<a.height;c++){var f=c+b.yoff;if(!(0>f||f>=a.height)){var g=0;var h=g+b.xoff;e=a.width;0>h&&(g-=h,e+=h,h=0);h+e>a.width&&(e-=h+e-a.width);if(0>=e)return!1;g=(c*a.width+g)*d;g=new Uint8Array(a.data.buffer,g,e*d);h=(f*a.width+h)*d;e=new Uint8Array(b.data.buffer,h,e*d);e.set(g)}}return!0});return this};a.Image.prototype.rotateData=
function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e,f;var h=e=0;d=$jscomp.makeIterator(b);var g=d.next().value,k=d.next().value;this.raws&&this.raws[0]||a.error("no raw data for reprojection");d=this.raws[0];d.header&&d.wcsinfo||a.error("no WCS info available for reprojection");k=k||{};if("string"===typeof k)try{k=JSON.parse(k)}catch(p){a.error("can't parse rotate opts: "+k,p)}k.stash="rotateData";k.rawid="rotate";k.oraw=a.RAWID0;!0!==k.resetSection&&(k.resetSection=!1);
var l=d.header;var m=$.extend(!0,{},l);k.center=k.center||a.globalOpts.rotationCenter;if("file"!==k.center&&0<this.raw.wcs){var n=this.getPan();(f=a.pix2wcs(this.raw.wcs,n.x,n.y).trim().split(/\s+/))&&1<f.length&&(m.CRPIX1=n.x,m.CRPIX2=n.y,m.CRVAL1=a.saostrtod(f[0]),a.isHMS(this.params.wcssys)&&(m.CRVAL1*=15),m.CRVAL2=a.saostrtod(f[1]))}d.wcsinfo&&(e=d.wcsinfo.cdelt1||0,h=d.wcsinfo.cdelt2||0);if("string"===typeof g)switch(g.toLowerCase()){case "northisup":case "northup":g=0;0<e&&(e=-e);0>h&&(h=-h);
break;default:g=parseInt(g,10)}a.notNull(l.CD1_1)?(h=-(g*Math.PI/180),e=Math.sin(h),h=Math.cos(h),m.CD1_1=l.CD1_1*h+l.CD1_2*e,m.CD1_2=l.CD1_1*-e+l.CD1_2*h,m.CD2_1=l.CD2_1*h+l.CD2_2*e,m.CD2_2=l.CD2_1*-e+l.CD2_2*h):(m.CROTA2=g,m.CDELT1=e,m.CDELT2=h);k.lcsUseRota2=!0;d.wcsinfo&&(m.ptype=d.wcsinfo.ptype);this.xeqStashSave("rotateData",b.slice(),k.rawid);return this.reprojectData(m,k)};a.Image.prototype.reproject=function(c,b){var d,e,f,h=!1;var g={};var k=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
var l=/TAN|SIN|ZEA|STG|ARC/,m=function(b,c){if(!c)return b;b=$.extend(!0,{},b);a.isNull(b.CRVAL1)&&!a.isNull(c.crval1)&&(b.CRVAL1=c.crval1);a.isNull(b.CRVAL2)&&!a.isNull(c.crval2)&&(b.CRVAL2=c.crval2);a.isNull(b.CRPIX1)&&!a.isNull(c.crpix1)&&(b.CRPIX1=c.crpix1);a.isNull(b.CRPIX2)&&!a.isNull(c.crpix2)&&(b.CRPIX2=c.crpix2);a.isNull(b.CDELT1)&&!a.isNull(c.cdelt1)&&(b.CDELT1=c.cdelt1);a.isNull(b.CDELT2)&&!a.isNull(c.cdelt2)&&(b.CDELT2=c.cdelt2);a.isNull(b.CROTA2)&&!a.isNull(c.crot)&&(b.CROTA2=c.crot);
return b};if(a.reproject&&c&&this!==c){this.raws&&this.raws[0]||a.error("no raw data for reprojection");var n=this.raws[0];n.header&&n.wcsinfo||a.error("no WCS info available for reprojection");b=b||{};var p=$.extend(!0,{},n.header);for(q in p)p.hasOwnProperty(q)&&k.test(q)&&delete p[q];if("object"===typeof c){c.raw&&c.raw.header?d=c.raw.header:c.BITPIX&&c.NAXIS1&&c.NAXIS2?d=c:a.error("invalid wcs object input to reproject()");for(q in d)d.hasOwnProperty(q)&&k.test(q)&&(g[q]=d[q]);p=$.extend(!0,{},
g,p);if(!p.NAXIS||!p.NAXIS1||!p.NAXIS2)return;p.NAXIS1=Math.min(p.NAXIS1,a.globalOpts.image.xdim);p.NAXIS2=Math.min(p.NAXIS2,a.globalOpts.image.ydim);var q=a.raw2FITS(p,{addcr:!0});p="wcs_"+a.uniqueID()+".txt";a.vfile(p,q);a.globalOpts.reprojectLimits&&(q=a.globalOpts.image.xdim,g=a.globalOpts.image.ydim,k=a.globalOpts.image.xdim*a.globalOpts.image.ydim,n.header.NAXIS1*n.header.NAXIS2>k&&a.error("the max reproject size is "+q+" * "+g+". You can use the Bin/Filter/Section plugin to extract a section, then save it as FITS and reproject the smaller image."))}else p=
c;try{if(!l.test(n.wcsinfo.ptype)){var r=m(n.header,n.wcsinfo);var v="owcs_"+a.uniqueID()+".txt";a.vfile(v,a.raw2FITS(r,{addcr:!0}));var w="awcs_"+a.uniqueID()+".txt";var t=a.tanhdr(v,w,"");1<a.DEBUG&&a.log("tanhdr (input): %s %s -> %s",v,w,t);a.vunlink(v);0<=t.search(/\[struct stat="OK"/)&&(b.cmdswitches=b.cmdswitches||"",b.cmdswitches+=" -i "+w)}if(c.raw&&!l.test(c.raw.wcsinfo.ptype)||c.ptype&&!l.test(c.ptype)){r=m(d,c.raw.wcsinfo);v="owcs_"+a.uniqueID()+".txt";a.vfile(v,a.raw2FITS(r,{addcr:!0}));
var u="awcs_"+a.uniqueID()+".txt";t=a.tanhdr(v,u,"");1<a.DEBUG&&a.log("tanhdr (reproj): %s %s -> %s",v,u,t);a.vunlink(v);0<=t.search(/\[struct stat="OK"/)&&(a.vunlink(p),p=u)}}catch(z){}if(n.hdu&&n.hdu.fits.vfile)c=n.hdu.fits.vfile,n.hdu.fits.extname?c+="["+n.hdu.fits.extname+"]":n.hdu.fits.extnum&&0<n.hdu.fits.extnum&&(c+="["+n.hdu.fits.extnum+"]");else{var y=this.toArray();c=this.id.replace(/\.png$/,"_png.fits");a.vfile(c,y)}u=this.id.replace(/\[.*\]/,"").replace(/\.png$/i,".fits").replace(/\.fz$/i,
"").replace(/\.gz$/i,"");u="reproj_"+a.uniqueID()+"_"+u;d=b.rawid||"reproject";for(v=0;v<this.raws.length&&(r=this.raws[v],r.id!==d||!a.cleanupFITSFile(r,!0));v++);n.hdu&&"table"===n.hdu.imtab&&n.hdu.table&&!c.match(/\[bin /)&&(c.match(/\[EVENTS\]/)||(c+="[EVENTS]"),r=n.hdu.table,n=Math.floor(r.xcen-r.xdim/2+1),v=Math.floor(r.xcen+r.xdim/2),d=Math.floor(r.ycen-r.ydim/2+1),r=Math.floor(r.ycen+r.ydim/2),c+="[bin X="+n+":"+v+",Y="+d+":"+r+"]");try{var x=u.lastIndexOf(".");0<=x&&(e=u.substring(0,x)+"_area"+
u.substring(x));var B=b.cmdswitches||"";B+=" -a 0 "+a.globalOpts.reprojSwitches;t=a.reproject(c,u,p,B);1<a.DEBUG&&a.log("reproject: %s %s %s [%s] -> %s",c,u,p,B,t);a.vunlink(e);a.vunlink(p);w&&a.vunlink(w);y&&a.vunlink(c);0>t.search(/\[struct stat="OK"/)&&(h=!0,(f=t.match(/msg="(.*)"/))&&f[1]?a.error(f[1]+" (from mProjectPP)"):a.error(t))}catch(z){if(h)return;a.vunlink(e);a.vunlink(p);t?a.error(t):a.error("WCS reproject failed",z)}return u}};a.Image.prototype.reprojectData=function(c){for(var b=[],
d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=this,f;d=$jscomp.makeIterator(b);var h=d.next().value,g=d.next().value;if(h&&a.reproject){if("string"===typeof h){if("all"===h){for(b=0;b<a.images.length;b++)d=a.images[b],this.display.id===d.display.id&&d.reprojectData(this);return}(d=a.getImage(h))?h=d:a.error("unknown WCS for reproject: "+h)}if(this!==h){g=g||{};if("string"===typeof g)try{g=JSON.parse(g)}catch(k){a.error("can't parse reproject opts: "+g,k)}g.rawid||this.xeqStashSave("reprojectData",
b.slice(),"reproject");g.stash||(g.stash="reprojectData");a.waiting(!0,this.display);this.setStatus("reprojectData","processing");window.setTimeout(function(){var b=function(b){e.xeqPlugins("image","onreprojectdata");c=c||{};c.refreshRegions=!0;!1!==g.resetSection&&(c.resetSection=!0);g.lcsUseRota2&&(c.lcsUseRota2=!0);e.refreshImage(b,c);e.setStatus("reprojectData","complete");e.xeqStashCall(e.xeqstash,[g.stash,"reprojectData"]);if("function"===typeof g.onreproject)try{a.xeqByName(g.onreproject,window,
e)}catch(n){a.error("in onreproject callback",n,!1)}};g=g||{};b=g.reprojHandler||b;if(f=e.reproject(h,g)){var c=$.extend(!0,{},a.fits.options,g);c.rawid=c.rawid||"reproject";h.raw&&h.raw.header&&(c.wcsim=h);try{a.handleFITSFile(f,c,b)}catch(m){a.error("can't process reprojected FITS file",m)}}},a.SPINOUT);return this}}};a.Image.prototype.filterRGBImage=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e;d=$jscomp.makeIterator(b).next().value;var f=[];if(!d){for(e in a.ImageFilters)a.ImageFilters.hasOwnProperty(e)&&
f.push(e);return f}switch(d){case "reset":return this.setColormap("reset"),this;case "median":d="medianFilter";break;case "edge":d="edgeDetect"}a.ImageFilters[d]||a.error("JS9 image filter '"+d+"' not available");this.xeqStashSave("filterRGBImage",b.slice());b.shift();b.unshift(this.display.context,this.rgb.img);try{a.ImageFilters[d].apply(a.ImageFilters,$jscomp.arrayFromIterable(b))}catch(h){a.error("JS9 image filter '"+d+"' failed",h)}this.displayImage("display");a.globalOpts.extendedPlugins&&this.xeqPlugins("image",
"onfilterrgbimage");return this};a.Image.prototype.moveToDisplay=function(c){var b,d,e=0,f=this.display;var h=a.lookupDisplay(c);if(!c||!h)return a.error("could not find display: "+c),null;this.display.clearMessage();this.display.context.clear();this.xeqPlugins("image","onimageclear");for(b in f.layers)f.layers.hasOwnProperty(b)&&("main"!==f.layers[b].dtype||h.layers[b]||h.newShapeLayer(b,f.layers[b].opts));if(h.image)for(b in h.layers)h.layers.hasOwnProperty(b)&&"main"===h.layers[b].dtype&&h.image.showShapeLayer(b,
!1,{local:!0});for(b in this.layers)this.layers.hasOwnProperty(b)&&(c=this.layers[b],(d=h.layers[b])?(this.showShapeLayer(b,!1,{local:!0}),c.dlayer=d,c.divjq=d.divjq,c.canvasjq=d.canvasjq,c.canvas=d.canvas):delete this.layers[b]);this.display=h;this.display.image=this;this.mkSection();this.displayImage("all");for(b in this.layers)this.layers.hasOwnProperty(b)&&this.showShapeLayer(b,!0,{local:!0});f.rgb.rim===this&&(f.rgb.rim=null,h.rgb.rim=this);f.rgb.gim===this&&(f.rgb.gim=null,h.rgb.gim=this);f.rgb.bim===
this&&(f.rgb.bim=null,h.rgb.bim=this);f.image=null;this.refreshLayers();for(b=0;b<a.images.length;b++)if(h=a.images[b],f===h.display){h.display.image=null;h.displayImage("all");h.refreshLayers();e++;break}!e&&f.winid&&f.winid.close&&(b=$.inArray(f,a.displays),0<=b&&a.displays.splice(b,1),f.winid.close());return this};a.Image.prototype.saveSession=function(c,b){var d,e,f,h,g,k,l=function(b){var c={};if(window.electron){var l=new RegExp("^"+window.electron.currentDir+"/");c.file=b.file.replace(l,"")}else c.file=
b.file;c.dwidth=b.display.width;c.dheight=b.display.height;c.params=$.extend(!0,{},b.params);c.tmp={};"active"===b.tmp.gridStatus&&(c.tmp.gridStatus="active");g=b.imageToLogicalPos({x:b.rgb.sect.xcen,y:b.rgb.sect.ycen});(k=b.maybePhysicalToImage(g))&&(g=k);c.sect={};c.sect.xcen=g.x;c.sect.ycen=g.y;c.sect.xdim=b.raw.width;c.sect.ydim=b.raw.height;c.sect.zoom=b.rgb.sect.zoom;c.layers=[];for(h in b.layers)b.layers.hasOwnProperty(h)&&(d=b.layers[h],e=d.dlayer,"main"===e.dtype&&"crosshair"!==h&&"grid"!==
h&&(f={},f.name=h,f.json=e.canvas.toJSON(e.el),f.dopts=$.extend(!0,{},e.opts),d.catalog&&(f.catalog=d.catalog),d.starbase&&(f.starbase=JSON.stringify(d.starbase)),c.layers.push(f)),e.canvas.forEachObject(function(b){b.params&&b.params.winid&&($(b.params.winid).is(":visible")?a.error("please close your region dialog box(es) to avoid a JSON circular reference error when saving this session"):b.params.winid=null)}));c.blend=b.blend;c.xeqstash=b.xeqstash;b.wcsim&&b.wcsim.id&&(c.wcsim=b.wcsim.id);delete c.params.display;
c.params.rot90=0;c.params.flip="none";c.params.crosshair=!1;return c};window.hasOwnProperty("saveAs")||a.error("no saveAs() available to save session");c=c||"js9.ses";c.match(/\.ses$/)||(c+=".ses");b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(q){a.error("can't parse session opts: "+b,q)}a.waiting(!0,this.display);var m={images:[]};if("display"===b.mode)for(b=0;b<a.images.length;b++){var n=a.images[b];n.display.id===this.display.id&&m.images.push(l(n))}else m.images.push(l(this));m.display=
{blendMode:this.display.blendMode};m.globals=$.extend(!0,{},a.globalOpts);delete m.globals.rgb;m.cmaps=[];for(b=0;b<a.colormaps.length;b++)"user"===a.colormaps[b].source&&m.cmaps.push(a.colormaps[b]);try{var p=JSON.stringify(m,null,4)}catch(q){a.error("can't create json file for save session",q)}m=new Blob([p],{type:"application/json"});a.saveAs(m,c);a.waiting(!1);return c};a.Image.prototype.xeqStashSave=function(c,b,d,e){var f,h;e=e||"image";this.xeqstash=this.xeqstash||[];for(f=0;f<b.length;f++)"object"===
typeof b[f]&&(b[f]instanceof a.Image?b[f]=b[f].id:b[f]instanceof a.Display&&(b[f]=b[f].id));switch(c){case "setRot90":f=this.xeqstash.length;if(1<=f&&this.xeqstash[f-1]&&this.xeqstash[f-1].args[0]===-b[0])return this.xeqstash.pop(),this;break;case "setFlip":f=this.xeqstash.length;if(1<=f&&this.xeqstash[f-1]&&this.xeqstash[f-1].args[0]===b[0])return this.xeqstash.pop(),this;break;default:for(f=0;f<this.xeqstash.length;f++)if((h=this.xeqstash[f])&&h.func===c&&h.context===e)return h.args=b,this}this.xeqstash.push({func:c,
args:b,id:d,context:e});return this};a.Image.prototype.xeqStashCall=function(c,b){var d=this,e,f=function(b,c){var e=c.context||"image";try{switch(e){case "image":d[b].apply(d,$jscomp.arrayFromIterable(c.args));break;case "display":d.display[b].apply(d.display,$jscomp.arrayFromIterable(c.args));break;default:d[b].apply(d,$jscomp.arrayFromIterable(c.args))}}catch(n){a.error("error executing stash: "+b,n,!1)}};c=c||this.xeqstash;if($.isArray(c))for(e=0;e<c.length;e++){var h=c[e];var g=h.func;0<=$.inArray(g,
b)||f(g,h)}else for(g in c)!c.hasOwnProperty(g)||0<=$.inArray(g,b)||(h=c[g],f(g,h))};a.Image.prototype.xeqStashDiscard=function(a){var b;if(this.xeqstash)if($.isArray(this.xeqstash))for(b=0;b<this.xeqstash.length;b++)a!==this.xeqstash[b].func&&a!==this.xeqstash[b].id||this.xeqstash.splice(b,1);else for(b in this.xeqstash)this.xeqstash.hasOwnProperty(b)&&(a===b||a===this.xeqstash[b].id)&&delete this.xeqstash[b]};a.Image.prototype.xeqPlugins=function(c,b,d){var e,f=function(a,b){a="JS9:"+a;$(document).trigger(a,
b)};if(c&&b&&a.globalOpts.xeqPlugins){var h=this.display.pluginInstances;for(e in h)if(h.hasOwnProperty(e)){var g=h[e];var k=g.plugin.opts;if(g.isActive(b)&&"function"===typeof k[b]){this.callingPlugin=b;switch(c){case "image":try{k[b].call(g,this),f(b,{im:this})}catch(m){g.errLog(b,m)}break;case "region":case "shape":try{k[b].call(g,this,d),f(b,{im:this,xreg:d})}catch(m){g.errLog(b,m)}break;case "keydown":case "keypress":var l=d.originalEvent||d;try{k[b].call(g,this,this.ipos,l),f(b,{im:this,ipos:this.ipos,
evt:l})}catch(m){g.errLog(b,m)}break;case "mouse":if(!this.clickInRegion||k[b+"_inRegion"]){l=d.originalEvent||d;try{k[b].call(g,this,this.ipos,l),f(b,{im:this,ipos:this.ipos,evt:l})}catch(m){g.errLog(b,m)}}}delete this.callingPlugin}}return this}};a.Image.prototype.uploadFITSFile=function(){var c=this,b,d=function(b){delete c.tmp.upload;window.setTimeout(function(){a.progress(!1)},1E3);b.stderr?a.error(b.stderr):b.stdout&&(c.fitsFile=b.stdout.trim(),c.proxyFile=c.fitsFile,a.globalOpts.prependJS9Dir&&
!c.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==c.fitsFile.charAt(0)&&(c.fitsFile="${JS9_DIR}/"+c.fitsFile),c.queryHelper("all"))};if(a.worker&&("nodejs"===a.helper.type||"socket.io"===a.helper.type)&&this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile){this.tmp.upload&&a.error("only one upload allowed at a time");var e=this.raw.hdu.fits.vfile;a.helper.send("quotacheck",null,function(f){(f.stderr||f.errcode)&&a.error(f.stderr||"from quotacheck: "+f.errcode);b=a.vread(e,"binary");a.worker.socketio(function(){c.tmp.upload=
!0;a.progress(!0,c.display);a.worker.postMessage("uploadFITS",[e,b],d,[b.buffer])})});return this}};a.Image.prototype.removeProxyFile=function(c){var b=this;if("boolean"===typeof c)var d=c;else if("string"===typeof c){if(c.match(/^\//))return;var e=new RegExp("^"+a.INSTALLDIR);e=c.replace(e,"");if(e.match(/\.\./))return;e=c}else{if(!this.proxyFile)return;e=this.proxyFile}e&&a.Send("removeproxy",{cmd:"js9Xeq removeproxy "+e},function(a){d&&a&&"OK"===a.stdout.trim()&&(b.proxyFile=null,b.fitsFile=null,
b.analysisPackages=null,b.queryHelper("all"))})};a.Image.prototype.starbaseToShapes=function(c,b){var d=this,e,f,h,g=a.globalOpts.catalogs;var k=a.globalOpts.catalogs.ras;var l=a.globalOpts.catalogs.decs;var m=[],n=function(b,c){return(b=a.wcs2pix(d.raw.wcs,b,c).trim().split(/ +/))&&b.length?{x:parseFloat(b[0]),y:parseFloat(b[1])}:null};var p=function(a,b,c,d){var e;if(void 0!==d)var g=d;else{g=-1;for(e=0;e<c.length;e++){for(d=0;d<b.length;d++)if(c[e].toLowerCase()===b[d].toLowerCase()){g=a[b[d]];
break}if(0<=g)break}if(0>g)for(f=c[0],h=new RegExp("^"+f,"i"),d=0;d<b.length;d++)if(b[d].match(h)){g=a[b[d]];break}if(0>g)for(f=c[0],h=new RegExp(".*"+f+".*","i"),d=0;d<b.length;d++)if(b[d].match(h)){g=a[b[d]];break}}return g};if(c&&c.data&&c.headline){var q=c.data;var r=c.headline;var v=c.delims;b=b||{};k=p(c,r,k,b.xcol);0>k&&a.error("can't find an RA column (see Preferences:catalogs)");var w=p(c,r,l,b.ycol);0>w&&a.error("can't find a Dec column (see Preferences:catalogs)");p=b.shape||g.shape||"circle";
switch(p){case "box":var t=function(){return{width:b.width||g.width||7,height:b.height||g.height||7}};break;case "circle":t=function(){return{radius:b.radius||g.radius||3.5}};break;case "ellipse":t=function(){return{r1:b.r1||g.r1||3.5,r2:b.r2||g.r2||3.5}};break;default:t=function(){return{width:b.width||7,height:b.height||7}}}var u=this.getWCSSys();var y=b.wcssys?b.wcssys:g.wcssys?g.wcssys:"ICRS";this.setWCSSys(y,!1);for(l=c=0;c<q.length;c++){var x=q[c][k];var B=q[c][w];"\x00"!==v[k]&&":h ".includes(v[k])&&
"galactic"!==y&&"ecliptic"!==y&&(x*=15);if(e=n(x,B)){var z=t();z={id:c.toString(),shape:p,x:e.x,y:e.y,width:z.width,height:z.height,radius:z.radius,r1:z.r1,r2:z.r2,angle:0,data:{ra:x,dec:B}};if(!1!==b.save&&!1!==a.globalOpts.catalogs.save)for(e=0;e<=r.length;e++)r[e]&&(z.data[r[e]]=q[c][e]);b.color&&(z.color=b.color);m[l++]=z}}this.setWCSSys(u,!1);return m}};a.Image.prototype.loadCatalog=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=$jscomp.makeIterator(b);d=e.next().value;
var f=e.next().value;e=e.next().value;var h=$.extend(!0,{},a.Catalogs.opts),g=a.globalOpts.catalogs;1===b.length&&"string"!==typeof d&&(f=d,d=null);2===b.length&&"string"!==typeof d&&(e=f,f=d,d=null);if(f){g.tooltip&&(h.tooltip=g.tooltip);e=e||{};if("string"===typeof e)try{e=JSON.parse(e)}catch(l){a.error("can't parse catalog opts: "+e,l)}e.color=e.color||g.color||"#00FF00";e.wcssys=e.wcssys||g.wcssys;e.updateWCS=!0;b={convFuncs:{def:function(b){var c={};c.val=a.saostrtod(b);c.delim=String.fromCharCode(a.saodtype());
if("\x00"!==c.delim&&" \t-.:hdmsr'\"".includes(c.delim)||a.isNumber(b))return c;c.val=b;return c}},units:e.units||g.units,skip:e.skip||g.skip};try{var k=new a.Starbase(f,b)}catch(l){a.error("could not parse catalog. Is it in tab-separated column format?")}k&&k.data&&k.data.length||a.error("no objects found in catalog");b=this.starbaseToShapes(k,e);b.length?(d=d||"catalog_"+a.uniqueID(),this.display.newShapeLayer(d,h),this.removeShapes(d),this.layers[d].catalog=f,this.layers[d].starbase=k,this.addShapes(d,
b,e)):a.error("no catalog objects found");return this}};a.Image.prototype.saveCatalog=function(c,b){b=b||this.activeShapeLayer();this.layers[b]&&this.layers[b].catalog||(b&&"undefined"!==b?a.error("no catalog available: "+b):a.error("no active catalog available"));var d=new Blob([this.layers[b].catalog],{type:"text/plain;charset=utf-8"});c=c||b+".cat";c.match(/\.cat$/)||(c+=".cat");window.hasOwnProperty("saveAs")?a.saveAs(d,c):a.error("no saveAs() available to save catalog");return c};a.Image.prototype.wcs2wcs=
function(c,b,d,e){var f=this.getWCSSys();var h=this.getWCSUnits();c=c||f;b=b||f;if("string"===typeof d){var g=a.strtoscaled(d);a.isHMS(c,g.dtype)&&(g.dval*=15);d=g.dval}"string"===typeof e&&(g=a.strtoscaled(e),e=g.dval);g=this.setWCSSys(c,!1).getWCSSys();"native"!==c&&g!==c&&a.error("unknown or invalid wcs: "+c);d=a.wcs2pix(this.raw.wcs,d,e).trim().split(/ +/);c=parseFloat(d[0]);d=parseFloat(d[1]);this.setWCSSys(b,!1);this.setWCSUnits("degrees",!1);c=a.pix2wcs(this.raw.wcs,c,d).trim();this.setWCSUnits(h,
!1);f!==b&&this.setWCSSys(f,!1);return c};a.Image.prototype.wcs2imlen=function(c){var b=1;if(c){c=a.strtoscaled(c);var d=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};void 0!==d.cdelt1?b=d.cdelt1:void 0!==d.cdelt2&&(b=d.cdelt2);switch(this.params.wcssys){case "image":break;case "physical":this.lcs&&this.lcs.physical&&(b=Math.sqrt(Math.pow(this.lcs.physical.forward[0][0],2)+Math.pow(this.lcs.physical.forward[0][1],2)),c.dval=Math.abs(c.dval*b));break;default:c.dtype&&"."!==c.dtype&&"\x00"!==c.dtype&&(c.dval=
Math.abs(c.dval/b))}return c.dval}};a.Colormap=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=$jscomp.makeIterator(b);d=e.next().value;var f=e.next().value,h=e.next().value;e=e.next().value;if(d){this.name=d;switch(b.length){case 2:$.isArray(f[0])&&"number"===typeof f[0][0]?(this.type="lut",this.colors=f):(this.type="static",this.colors=a.parseStaticColors(f));break;case 4:this.type="sao";this.vertices=[f,h,e];break;default:a.error("colormap requires a colormap name and 1 or 3 array args")}this.source=
a.inited?"user":"core";for(b=0;b<a.colormaps.length;b++)if(a.colormaps[b].name===this.name){a.colormaps[b]=this;var g=!0;break}g||a.colormaps.push(this);1<a.DEBUG&&a.log("JS9 colormap:  %s",this.name)}};a.Colormap.prototype.mkColorCell=function(c){var b=a.COLORSIZE;var d=[0,0,0];switch(this.type){case "sao":var e=c/b;for(c=0;3>c;c++){var f=this.vertices[c];var h=f.length;for(b=0;b<h&&!(f[b][0]>e);b++);b=0===b?f[0][1]:b===h?f[h-1][1]:(h=(f[b][1]-f[b-1][1])/(f[b][0]-f[b-1][0]))?h*(e-f[b-1][0])+f[b-
1][1]:f[b][1];d[c]=255*b}break;case "lut":e=this.colors.length;c=Math.floor(c*e/b);0>c?(d[0]=255*this.colors[0][0],d[1]=255*this.colors[0][1],d[2]=255*this.colors[0][2]):c<e?(d[0]=255*this.colors[c][0],d[1]=255*this.colors[c][1],d[2]=255*this.colors[c][2]):(d[0]=255*this.colors[e-1][0],d[1]=255*this.colors[e-1][1],d[2]=255*this.colors[e-1][2]);break;case "static":break;default:a.error("unknown colormap type")}return d};a.Display=function(c){var b=this;this.divjq=c instanceof jQuery?c:"object"===typeof c?
$(c):$("#"+c);this.divjq.attr("id")||this.divjq.attr("id",a.DEFID);this.id=this.divjq.attr("id");this.tmp={};this.rgb={active:!1,rim:null,gim:null,bim:null};this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=a.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=a.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),
10);this.width0=this.width;this.height0=this.height;this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",a.ZINDEX);this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",a.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq);a.allinone||(this.iconjq=$("<div>").addClass("JS9Logo").css("display","none").css("z-index",a.ZINDEX+1).appendTo(this.divjq),
this.iconimgjs=$("<img>").addClass("JS9Logo").attr("src",a.InstallDir("images/js9logo.png")).attr("alt","js9").attr("title","js9").appendTo(this.iconjq),a.globalOpts.logoDisplay&&this.iconjq.css("display","block"));a.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow","hidden"),a.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",
this.height+a.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var c=b.divjq.width(),e=b.divjq.height();a.bugs.webkit_resize&&(c-=a.RESIZEFUDGE,e-=a.RESIZEFUDGE);b.resize(c,e)}));this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1);this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq);this.image=null;this.pluginInstances={};this.layers={};this.initMessages();this.blendMode=!1;this.mouseActions=
a.globalOpts.mouseActions.slice(0);this.touchActions=a.globalOpts.touchActions.slice(0);this.mousetouchZoom=a.globalOpts.mousetouchZoom;this.divjq.on("mouseenter",this,function(b){return a.mouseEnterCB(b)});this.divjq.on("mouseover",this,function(b){return a.mouseOverCB(b)});this.divjq.on("mousedown touchstart",this,function(b){return a.mouseDownCB(b)});this.divjq.on("mousemove touchmove",this,function(b){return a.mouseMoveCB(b)});this.divjq.on("mouseup touchend",this,function(b){return a.mouseUpCB(b)});
this.divjq.on("mouseout",this,function(b){return a.mouseOutCB(b)});this.divjq.on("keypress",this,function(b){return a.keyPressCB(b)});this.divjq.on("keydown",this,function(b){return a.keyDownCB(b)});this.divjq.on("keyup",this,function(b){return a.keyUpCB(b)});this.divjq.on("wheel",this,function(b){return a.wheelCB(b)});this.divjq.on("dragenter",this,function(c){return a.dragenterCB(b.id,c)});this.divjq.on("dragover",this,function(c){return a.dragoverCB(b.id,c)});this.divjq.on("dragexit",this,function(c){return a.dragexitCB(b.id,
c)});this.divjq.on("drop",this,function(c){return a.dragdropCB(b.id,c)});this.divjq.on("contextmenu",this,function(){return!1});this.addFileDialog("Load",a.globalOpts.imageTemplates);this.addFileDialog("RefreshImage",a.globalOpts.imageTemplates);this.addFileDialog("LoadRegions",a.globalOpts.regTemplates);this.addFileDialog("LoadSession",a.globalOpts.sessionTemplates);this.addFileDialog("LoadColormap",a.globalOpts.colormapTemplates);this.addFileDialog("LoadCatalog",a.globalOpts.catalogTemplates);a.displays.push(this);
this.displayConjq.focus();a.DEBUG&&a.log("JS9 display:  %s",this.id)};a.Display.prototype.addFileDialog=function(c,b){var d=this;if(c&&a.publics[c]){var e="openLocal"+c+"-"+this.id;var f=$("<div>").addClass("JS9Hidden").appendTo(this.divjq);f=$("<input>").attr("type","file").attr("id",e).attr("multiple",!0).appendTo(f);b&&f.attr("accept",b);f.on("change",function(b){var e=b.currentTarget;if(e.files.length)switch(c){case "Load":case "RefreshImage":var f={localAccess:!0};a.waiting(!0,d)}for(b=0;b<e.files.length;b++)a.publics[c](e.files[b],
f,{display:d.id});e.value=null;return!1})}};a.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",a.MESSZINDEX).appendTo(this.divjq);this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.progressArea=$("<div>").addClass("JS9Progress").addClass("JS9Message").appendTo(this.messageContainer);this.progressBar=$("<progress>").addClass("JS9ProgressBar").attr("value",
0).attr("max",100).attr("name","progress").appendTo(this.progressArea);try{this.messageContainer.draggable({start:function(c,b){this.oicb=a.globalOpts.internalContrastBias;a.globalOpts.internalContrastBias=!1},stop:function(c,b){a.globalOpts.internalContrastBias=this.oicb}})}catch(c){}return this};a.Display.prototype.displayPlugin=function(c){var b=this,d;if("string"===typeof c)for(d=0;d<a.plugins.length;d++){var e=a.plugins[d];if(e.name===c){c=e;break}}"object"===typeof c&&c.name||a.error("unknown plugin type for displayPlugin");
var f=this.pluginInstances[c.name];switch(a.globalOpts.winType){case "light":var h=a.lightOpts[a.LIGHTWIN];if(!f||!f.status){var g=c.name.replace(/\s/g,"_");d=this.id+"_"+g+"_lightDiv";e=this.id+"_"+g+"_outerDiv";g=this.id+"_"+g+"_innerDiv";if(!f){var k=$("<div>").attr("id",e).css("display","none").appendTo($(this.divjq));$("<div>").addClass(c.name).attr("id",g).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(k)}k=c.opts.winDims[0]||a.WIDTH;var l=c.opts.winDims[1]||
a.HEIGHT;var m=c.opts.winResize?"1":"0";h=sprintf(h.format,k,l,m);k=c.opts.toolbarHTML&&0<=c.opts.toolbarHTML.search(/\$title/)?"":c.opts.winTitle||"";k+=sprintf(a.IDFMT,this.id);e=a.lightWin(d,"div",e,k,h);d=$("#"+d+" #"+g);f=a.instantiatePlugin(d,c,e);f.winHandle.onclose=function(){f.winHandle.hide();f.status="inactive";if(c.opts.onpluginclose)try{c.opts.onpluginclose.call(f,b.image)}catch(n){a.log("onplugincloseCB: %s [%s]\n%s",c.name,n.message,a.strace(n))}return!1};f.status="active";if(c.opts.onplugindisplay)try{c.opts.onplugindisplay.call(f,
this.image)}catch(n){a.log("onplugindisplayCB: %s [%s]\n%s",c.name,n.message,a.strace(n))}}else if("inactive"===f.status){if(f.winHandle&&(f.winHandle.show(),f.status="active",c.opts.onplugindisplay))try{c.opts.onplugindisplay.call(f,this.image)}catch(n){a.log("onplugindisplayCB: %s [%s]\n%s",c.name,n.message,a.strace(n))}}else if("active"===f.status&&f.winHandle&&(f.winHandle.hide(),f.status="inactive",c.opts.onpluginclose))try{c.opts.onpluginclose.call(f,this.image)}catch(n){a.log("onplugincloseCB: %s [%s]\n%s",
c.name,n.message,a.strace(n))}break;case "new":a.error("external window support for plugins not yet implemented")}};a.Display.prototype.displayLoadForm=function(c){var b=this,d=a.globalOpts.localLoadFormat,e=a.globalOpts.remoteLoadMethod,f=!a.allinone&&"none"!==a.globalOpts.helperType&&a.globalOpts.workDir&&a.globalOpts.loadProxy;c=c||{local:!0,remote:!0};a.isNull(c.title)&&(c.title="",c.local&&(c.title="Open "),c.remote&&(c.title&&(c.title+="or "),c.title+="Retrieve "),c.title+="an Image ",c.local&&
(c.title+="or Auxiliary File"));c.winformat=c.winformat||"width=640px,height=300px,resize=1,scrolling=1";var h=a.allinone?a.allinone.loadHTML:a.InstallDir(a.globalOpts.loadURL);$(a.lightOpts[a.LIGHTWIN].topid).arrive(".loadForm",{onceOnly:!0},function(a){var h=$(a).data("localfile")||b.tmp.localfile;a=$(a).data("remotefile")||b.tmp.remotefile;c.local&&($(g).find(".localfile").removeClass("nodisplay"),$(g).find(".localdoc").removeClass("nodisplay"),h&&$(g).find('input[name="localfile"]').val(h),$(g).find("input[value="+
d+"]").click());c.remote&&($(g).find(".remotefile").removeClass("nodisplay"),$(g).find(".remotedoc").removeClass("nodisplay"),a&&$(g).find('input[name="remotefile"]').val(a),f?$(g).find("input[value="+e+"]").click():($(g).find('input[value="cors"]').click(),$(g).find('input[value="proxy"]').prop("disabled",!0)))});var g=a.Image.prototype.displayAnalysis.call(null,"params",h,c);$(g).data("dispid",this.id)};a.Display.prototype.resize=function(c,b,d){var e,f,h=function(a){a.left+=k;a.top+=l;a.setCoords()};
a.globalOpts.resize||a.error("display resize not enabled");if(!c&&!b)return{width:this.width,height:this.height};if("full"===c){if(d=b,window.innerWidth&&(c=window.innerWidth),window.innerHeight)for(b=window.innerHeight,e=0;e<a.globalOpts.centerDivs.length;e++){var g=a.globalOpts.centerDivs[e];this.pluginInstances[g]&&(b-=this.pluginInstances[g].divjq.height())}}else"image"===c?(this.image||a.error("can't resize display to 'image' without an image"),d=b,c=this.image.raw.width,b=this.image.raw.height):
"reset"===c&&(d=b,c=this.width0||c,b=this.height0||b);c=Math.floor(c);b=b?Math.floor(b):c;(10>c||10>b)&&a.error("invalid dimension(s) passed to display resize");if(c===this.width&&b===this.height)return this;d=d||{};e=c;c=b;var k=(e-this.width)/2;var l=(c-this.height)/2;this.width=e;this.height=c;this.divjq.css("width",e);this.divjq.css("height",c);this.canvasjq.attr("width",e);this.canvasjq.attr("height",c);a.bugs.webkit_resize&&!this.resizing&&(this.owidth=Math.min(this.owidth,e),this.oheight=Math.min(this.oheight,
c));0<=$.inArray("JS9Menubar",a.globalOpts.resizeDivs)&&(a.isNull(d.resizeMenubar)||d.resizeMenubar)&&(b=this.pluginInstances.JS9Menubar)&&$("#"+this.id+"Menubar").css("width",e);0<=$.inArray("JS9Toolbar",a.globalOpts.resizeDivs)&&(a.isNull(d.resizeToolbar)||d.resizeToolbar)&&(b=this.pluginInstances.JS9Toolbar)&&(b.divjq.attr("data-width",String(e)+"px"),a.Toolbar.init.call(b));0<=$.inArray("JS9Colorbar",a.globalOpts.resizeDivs)&&(a.isNull(d.resizeColorbar)||d.resizeColorbar)&&(b=this.pluginInstances.JS9Colorbar)&&
(b.divjq.attr("data-width",String(e)+"px"),a.Colorbar.init.call(b));0<=$.inArray("JS9Statusbar",a.globalOpts.resizeDivs)&&(a.isNull(d.resizeStatusbar)||d.resizeStatusbar)&&(b=this.pluginInstances.JS9Statusbar)&&$("#"+this.id+"Statusbar").css("width",e);for(f in this.layers)this.layers.hasOwnProperty(f)&&(b=this.layers[f],"main"===b.dtype&&(b.divjq.css("width",e),b.divjq.css("height",c),b.canvasjq.attr("width",e),b.canvasjq.attr("height",c),b.canvas.setWidth(e),b.canvas.setHeight(c),b.canvas.calcOffset()));
for(e=0;e<a.images.length;e++)if(c=a.images[e],c.mkSection(),c.display&&this===c.display&&(c.resize?(c.resize.left+=k,c.resize.top+=l):c.resize={left:k,top:l},c===c.display.image))for(f in c.layers)c.layers.hasOwnProperty(f)&&(b=c.layers[f],"main"!==b.dlayer.type||b.json||(b.canvas.getObjects().forEach(h),b.canvas.renderAll()));a.bugs.webkit_resize&&this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE);!this.image||!a.globalOpts.resizeRedisplay&&this.resizing||(this.image.displayImage("all",
d),this.image.refreshLayers());d.center&&this.center();return this};a.Display.prototype.inResize=function(c){return a.globalOpts.resizeHandle&&c.x+a.RESIZEDIST>=this.divjq.width()&&c.y+a.RESIZEDIST>=this.divjq.height()?!0:!1};a.Display.prototype.center=function(){var c=this.divjq,b;var d=c.offset().top;var e=c.height(),f=$(window).height();var h=c.offset().left;c=c.width();var g=$(window).width();for(b=0;b<a.globalOpts.centerDivs.length;b++){var k=a.globalOpts.centerDivs[b];this.pluginInstances[k]&&
(k=this.pluginInstances[k].divjq,e+=k.height(),d=Math.min(k.offset().top,d))}d=e<f?d-(f/2-e/2):d;h=c<g?h-(g/2-c/2):h;$("html, body").animate({scrollTop:d,scrollLeft:h},250);return this};a.Display.prototype.gather=function(c){var b;c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(h){a.error("can't parse gather opts: "+c,h)}var d=c.images||a.images;for(c=0;c<d.length;c++)if((b="number"===typeof d[c]?a.images[d[c]]:d[c])&&b.display!==this){var e=b.display;var f=e.divjq.closest(".JS9GridItem");
b.moveToDisplay(this);0<f.length&&(b=$.inArray(e,a.displays),0<=b&&a.displays.splice(b,1),f.remove())}a.globalOpts.extendedPlugins&&this.image&&this.image.xeqPlugins("image","ongatherdisplay")};a.Display.prototype.separate=function(c){var b=this,d,e,f,h=0,g=0,k=0,l=1,m,n,p,q,r,v,w,t,u,y,x,B,z,A,C,E={},D=/_sep[0-9][0-9]*/,F=a.globalOpts.separate,G=function(b,c,d){c||a.error("can't init separation ops: no 'from' id");m=d.layout||a.globalOpts.separate.layout||"auto";n=d.leftMargin||F.leftMargin||0;p=
d.topMargin||F.topMargin||0;"auto"===m&&0<b.divjq.closest(".JS9GridContainer").length&&(m="grid");"grid"===m&&(CSS.supports("display","grid")?(f=b.divjq.closest(".JS9GridContainer"),0<f.length&&(q=f)):m="auto");switch(m){case "auto":k=1;g=0;break;case "horizontal":k=1;g=0;break;case "vertical":k=0;g=1;break;default:k=1,g=0}r=43;v=0;w=$("#"+c);t=$("#"+c+"Menubar");0<t.length&&(t.isactive="visible"===t.closest(".JS9PluginContainer").css("visibility"));u=$("#"+c+"Toolbar");0<u.length&&(u.isactive="visible"===
u.closest(".JS9PluginContainer").css("visibility"));y=$("#"+c+"Statusbar");0<y.length&&(y.isactive="visible"===y.closest(".JS9PluginContainer").css("visibility"));x=$("#"+c+"Colorbar");0<x.length&&!y.length&&(x.isactive="visible"===x.closest(".JS9PluginContainer").css("visibility"));0<w.length&&(B=w.width(),z=w.height(),A=w.offset().top-$(window).scrollTop()-5,C=w.offset().left-$(document).scrollLeft(),t.isactive&&(z+=t.height(),A-=t.height()),u.isactive&&(z+=u.height(),A-=u.height()),y.isactive?
(z+=y.height(),A-=y.height()):x.isactive&&(z+=x.height(),A-=x.height(),A+=7))},J=function(a,b){if(a){if(0<w.length){var c="";t.isactive&&(c+=sprintf("<div class='JS9Menubar' id='%sMenubar' data-width=%s></div>",b,w.width()));u.isactive&&(c+=sprintf("<div class='JS9Toolbar' id='%sToolbar' data-width=%s></div>",b,w.width()));c+=sprintf("<div class='JS9' id='%s' data-width=%s data-height=%s></div>",b,w.width(),w.height());y.isactive?c+=sprintf("<div style='margin-top: 2px;'><div class='JS9Statusbar' id='%sStatusbar' data-width=%s></div></div>",
b,w.width()):x.isactive&&(c+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' data-width=%s></div></div>",b,w.width()))}"auto"===m&&C+B*(k+.5)>window.innerWidth&&(g++,k=0);var d=sprintf("width=%s,height=%s,top=%s,left=%s,resize=1,scolling=1",B,z,A+(z+p+r)*g,C+(B+n+v)*k);"auto"===m||"horizontal"===m?k++:"vertical"===m&&g++}return{id:b,html:c,winopts:d}},I=function(f){var g;var k=h++;f.length>k?(k="number"===typeof f[k]?a.images[f[k]]:f[k])&&k.display===b?(k.displayImage("all"),
void 0===d?(d=k.display.id,G(k.display,d,c),!1===c.firstinplace&&h--,I(f)):(e="string"===typeof c.idbase?g=c.idbase+l++:d.replace(D,"")+"_sep"+a.uniqueID(),E[e]=k,k=J(d,e),g&&(k.id=g),"grid"===m?($("<div>").prop("id",k.id+"GridItem").addClass("JS9GridItem").append($(k.html)).appendTo(q),a.AddDivs(k.id),E[k.id].moveToDisplay(k.id),I(f)):($(a.lightOpts[a.LIGHTWIN].topid).arrive("#"+e,{onceOnly:!0},function(a){g=$(a).attr("id");window.setTimeout(function(){E[g].moveToDisplay(g);I(f)},0)}),a.LoadWindow(null,
{id:k.id},"light",k.html,k.winopts)))):I(f):a.globalOpts.extendedPlugins&&b.image&&b.image.xeqPlugins("image","onseparatedisplay")};c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(K){a.error("can't parse separate opts: "+c,K)}I(c.images||a.images)};a.Display.prototype.nextImage=function(c){var b,d=[],e=[];c=c||1;if(!this.image)return this;var f=this.image.pos;if(!a.globalOpts.nextImageMask)for(b=0;b<a.images.length;b++){var h=a.images[b];h.display===this&&h.mask.active&&h.mask.im&&e.push(h.mask.im)}for(b=
0;b<a.images.length;b++)h=a.images[b],h.display===this&&(!a.globalOpts.nextImageMask&&0<=$.inArray(h,e)||d.push(h));if(1>=d.length)return this;for(h=0;h<d.length&&this.image!==d[h];h++);for(c=h+c;c>=d.length;)c-=d.length;for(;0>c;)c+=d.length;h!==c&&(h=d[c],h.displayImage("all"),h.refreshLayers(),h.display.clearMessage(),f&&(f=h.displayToImagePos(f),h.valpos=null,h.valpos=h.updateValpos(f,!0)));return this};a.Display.prototype.loadSession=function(c,b){var d=this,e,f,h={},g=function(c){var e,g=function(){var b=
w.canvas.getObjects();b&&"undefined"!==typeof b.length&&(c.layers[w.layerName].nshape=b.length+1);a.Fabric.updateChildren(w,null,"objects");c.refreshLayers()};var k=h[c.file]||{};k.blend&&(c.blend=$.extend(!0,{},k.blend));k.tmp&&(c.tmp=$.extend(!0,{},k.tmp));k.wcsim&&(c.wcsim=a.lookupImage(k.wcsim));if(k.layers&&k.layers.length)for(e=0;e<k.layers.length;e++){var l=k.layers[e];var m=l.name;if(!(0<=$.inArray("regions",c.params.disable)&&"regions"===m)&&"crosshair"!==m&&"grid"!==m){var w=d.newShapeLayer(m,
l.dopts);c.addShapes(m,[]);w.canvas.loadFromJSON(l.json,g);l.catalog&&(c.layers[m].catalog=l.catalog);if(l.starbase)try{c.layers[m].starbase=JSON.parse(l.starbase)}catch(t){}}}c.tmp&&"active"===c.tmp.gridStatus&&c.displayCoordGrid(!0);a.notNull(f)&&(--f,0===f&&a.images.sort(function(a,b){var c=0,d=0;h[a.file]&&(c=h[a.file].i);h[b.file]&&(d=h[b.file].i);return c-d}));k.xeqstash&&c.xeqStashCall(k.xeqstash);a.globalOpts.extendedPlugins&&c.xeqPlugins("image","onsessionload");if("function"===typeof b.onsessionload)try{a.xeqByName(b.onsessionload,
window,c)}catch(t){a.error("in onsessionload callback",t,!1)}},k=function(c){c.file||a.error("session does not contain a filename");e=$.extend(!0,{},c);delete e.params.display;e.params.crosshair=!1;e.params.onload=g;c=e.file;e.sect&&(e.params.xcen=e.sect.xcen,e.params.ycen=e.sect.ycen,e.params.xdim=e.sect.xdim,e.params.ydim=e.sect.ydim,e.params.zoom=e.sect.zoom,delete e.sect);window.electron&&a.desktopOpts.sessionPath&&b.sessionPath&&"/"!==e.file.charAt(0)&&!e.file.match(a.URLEXP)&&(c=a.fixPath(b.sessionPath+
e.file,b));h[c]=e;a.Load(c,e.params,{display:d.id})},l=function(b){var c,e;b.globalOpts&&($.extend(!0,a.globalOpts,b.globalOpts),delete b.globalOpts);if(b.cmaps)for(c=0;c<b.cmaps.length;c++){var g=b.cmaps[c];if(g.name){var h=0<=$.inArray(g.name,a.globalOpts.topColormaps)?{toplevel:!0}:{toplevel:!1};a.AddColormap(g,h)}}if(b.images)for(f=b.images.length,c=0;c<b.images.length;c++)b.images[c].i=c,k(b.images[c]);else k(b);if(b.display)for(e in b.display)if(b.display.hasOwnProperty(e))switch(e){case "blendMode":a.BlendDisplay(b.display[e],
{display:d});break;default:d[e]=b.display[e]}};b=b||{};a.waiting(!0,this);"object"===typeof c?l(c):$.ajax({url:c,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(a){l(a)},error:function(b,d,e){a.error("could not load session: "+c,e)}});return this};a.Display.prototype.displayMessage=function(a,b,d){};a.Display.prototype.clearMessage=function(a){};a.Display.prototype.createMosaic=function(c,b){var d=this,e,f,h,g,k=this.image,l=function(){var b;for(b=0;b<g.length;b++)a.vunlink(g[b])},
m=function(b,c){var d;0>c.search(/\[struct stat="OK"/)&&(a.waiting(!1),l(),(d=c.match(/msg="(.*)"/))&&d[1]?a.error(d[1]+" (from "+b+")"):a.error(c||"unknown "+b+" failure"))},n=function(b,c){c=c||{};var e=$.extend(!0,{},c);!1!==c.waiting&&a.waiting(!0,d);e.display=d.id;b=new a.Image(b,e);k.setStatus("createMosaic","complete");b.setStatus("createMosaic","complete");a.waiting(!1)},p=function(c){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];if(b.verbose||1<a.DEBUG)d=sprintf.apply(null,
$jscomp.arrayFromIterable(d)),a.log(d)};b=b||{};b.reduce=b.reduce||a.globalOpts.reduceMosaic;b.dim=b.dim||Math.max(a.globalOpts.image.xdim,a.globalOpts.image.ydim);if(c)if("string"===typeof c)if("current"===c)c=this.image?[this.image]:[];else if("all"===c)for(c=[],e=0;e<a.images.length;e++)a.images[e].display.id===this.id&&c.push(a.images[e]);else c=[c];else $.isArray(c)||a.error("unknown input type for createMosaic()");else c=this.image?[this.image]:[];c.length||a.error("no images specified for createMosaic()");
for(e=0;e<c.length;e++)"string"===typeof c[e]&&((f=a.lookupImage(c[e]))?c[e]=f:a.error("unknown image for mosaic: "+c[e])),f=c[e],f.raw.hdu&&f.raw.hdu.fits&&f.raw.hdu.fits.vfile||a.error("no virtual file available for mosaic: "+f.id);a.waiting(!0,this);k.setStatus("createMosaic","processing");window.setTimeout(function(){var d=a.uniqueID();var f=function(a){return"mosaic_"+d+"_"+a};var k=f("in.lst");var w=f("in.tbl");var t=f("in.hdr");var u=f("bin.lst");var y=f("bin.tbl");var x=f("out.lst");var B=
f("out.tbl");var z=f("out.hdr");f=c[0].id.replace(/\[.*\]/,"").replace(/\.fz$/i,"").replace(/\.gz$/i,"").replace(/\.fits$/i,"_mosaic.fits");var A=f.replace(/\.fits$/,"_area.fits");g=[k,w,t,u,y,x,B,z,A];A="|                                                    fname|\n|                                                     char|\n";for(e=0;e<c.length;e++)A+=c[e].raw.hdu.fits.vfile+"\n";a.vfile(k,A);k=a.imgtbl(k,".",w,"-C");m("mImgtbl",k);a.vsize(w)||a.error("no image data found with which to construct a mosaic");
k=a.makehdr(w,t,"");m("mMakeHdr",k);if("js9"===b.reduce){A=a.vread(t).split("\n");for(e=t=0;e<A.length;e++)switch(k=A[e].split("="),k[0].trim()){case "NAXIS1":t=Math.max(t,parseFloat(k[1].trim()));break;case "NAXIS2":t=Math.max(t,parseFloat(k[1].trim()))}h=Math.max(1,Math.floor(t/b.dim+.5));A="|                                                    fname|\n|                                                     char|\n";w=a.vread(w);w=w.trim().split("\n");w.splice(0,3);for(e=0;e<w.length;e++)if(k=w[e].trim().split(/\s+/),
t=k[k.length-2],k=k[k.length-1],t&&k){var C=k+"["+t+"]";var E=k.split("/").reverse()[0].replace(/\.(g|f)z$/,"");t="bin_"+t+"_"+E;g.push(t);k="0@0,0@0,"+h;p("bin %s [%s]",C,h);a.imsection(C,t,k,"");A+=t+"\n"}a.vfile(u,A);k=a.imgtbl(u,".",y,"-C");m("mImgtbl",k);a.vsize(y)||a.error("no image data found to construct a mosaic");k=a.makehdr(y,z,"");m("mMakeHdr",k);w=a.vread(y)}else k=a.shrinkhdr(b.dim,t,z),m("mShrinkHdr",k),w=a.vread(w);w=w.trim().split("\n");w.splice(0,3);A="|                                                    fname|\n|                                                     char|\n";
for(e=0;e<w.length;e++)k=w[e].trim().split(/\s+/),t=k[k.length-2],k=k[k.length-1],t&&k&&(u="-a 1","shrink"===b.reduce&&(u+=" -h "+t),u+=" "+a.globalOpts.reprojSwitches,E=k.split("/").reverse()[0].replace(/\.(g|f)z$/,""),y="reproj_"+t+"_"+E,A+=y+"\n",g.push(y),g.push(y.replace(/\.fits$/i,"_area.fits")),p("reproject: %s [%s] -> %s",k,t,y),k=a.reproject(k,y,z,u),m("mProjectPP",k));a.vfile(x,A);k=a.imgtbl(x,".",B,"");m("mImgtbl",k);a.vsize(B)||a.error("no FITS files were added to output table for mosaic");
p("create mosaic: %s",f);k=a.madd(B,z,f,"");m("mAdd",k);l();x=$.extend(!0,{},a.fits.options,b);x.image={xdim:0,ydim:0};x.file=f;a.fits.handleFITSFile(f,x,n)},a.SPINOUT);return this};a.Display.prototype.moveImageInStack=function(c,b){var d,e,f,h;for(e=d=0;d<a.images.length;d++)if(a.images[d].display.id===this.id&&(c===e&&(f=d),b===e&&(h=d),e++),a.notNull(f)&&a.notNull(h)){a.images.splice(h,0,a.images.splice(f,1)[0]);break}};a.Command=function(c){for(var b in c)c.hasOwnProperty(b)&&(this[b]=c[b]);c.name||
a.error("command has no name");c.get||c.set||a.error("command requires get and/or set routine");a.commands.push(this);1<a.DEBUG&&a.log("JS9 command:  %s",this.name)};a.Command.prototype.getDisplayInfo=function(a){a&&a.id&&(this.display=a,this.image=a.image);return this};a.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):0===a.length?"get":"set"};a.Helper=function(){"file:"===a.globalOpts.helperProtocol&&(a.globalOpts.helperProtocol=
"http:");document.domain&&"localhost"!==document.domain||(a.globalOpts.htimeout=a.globalOpts.lhtimeout);a.globalOpts.helperProtocol+="//";this.helper=this.connected=!1;this.type=a.allinone&&!a.globalOpts.allinoneHelper?"none":a.globalOpts.helperType||"sock.io";this.pageid=null;this.connect()};a.Helper.prototype.connectinfo=function(){if(null===a.helper.connected)return"notConfigured";if(a.helper.connected){var c="connected "+a.helper.type+" "+a.helper.url;a.helper.pageid&&(c+="<p>"+a.helper.pageid);
return c}return"notConnected "+a.helper.type};a.Helper.prototype.connect=function(c){var b=this,d=a.globalOpts.ehretries,e=a.globalOpts.ehtimeout,f=function(c,d,e){b.connected=!1;b.helper=!1;b.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"error"});d=d||"timeout";e&&"timeout"!==e||(e="or connection refused");e===d&&(d="");"error"===e&&(e="is the helper running?");a.globalOpts.requireHelper?a.error("helper connect error: "+d+" ("+e+")"):a.DEBUG&&a.log("JS9 helper connect error: "+
d+" ("+e+")")},h=function(c){$.ajax({url:c,dataType:"script",timeout:a.globalOpts.htimeout,success:function(){var c={reconnection:!0,reconnectionDelay:1E3,reconnectionDelayMax:1E4,reconnectionAttempts:100,timeout:a.globalOpts.htimeout};"undefined"===typeof io?f(null,"socket io object is undefined",null):(b.socket=io.connect(b.url,c),b.socket.on("connect",function(){var c;b.connected=!0;b.helper=!0;var d=[];for(c=0;c<a.displays.length;c++)d.push(a.displays[c].id);b.socket.emit("initialize",{displays:d,
pageid:b.pageid},function(c){b.pageid=c.pageid;b.js9helper=c.js9helper;a.globalOpts.dataPathModify=c.dataPathModify;b.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"OK"});a.DEBUG&&a.log("JS9 helper: connect: "+b.type)});$(document).trigger("JS9:connected",{type:"socket.io",status:"OK"})}),b.socket.on("connect_error",function(){b.connected=!1;b.helper=!1;1<a.DEBUG&&a.log("JS9 helper: connect error")}),b.socket.on("connect_timeout",function(){b.connected=!1;b.helper=!1;1<a.DEBUG&&
a.log("JS9 helper: connect timeout")}),b.socket.on("disconnect",function(c){b.connected=!1;b.helper=!1;1<a.DEBUG&&a.log("JS9 helper: disconnect: "+c);"io server disconnect"===c&&(1<a.DEBUG&&a.log("JS9 helper: manual reconnect"),b.socket.connect())}),b.socket.on("reconnect",function(){b.connected=!0;b.helper=!0;1<a.DEBUG&&a.log("JS9 helper: reconnect")}),b.socket.on("msg",a.msgHandler))},error:function(a,b,c){f(a,b,c)}})},g=function(a,b,c){$.ajax({url:a,dataType:"jsonp",success:function(){h(b)},error:function(){0<
--c?window.setTimeout(function(){g(a,b,c)},e):f()}})};c&&(this.type=c);if(this.socket){try{this.socket.disconnect()}catch(k){a.log("warning: can't disconnect from socket")}this.socket=null}a.globalOpts.helperURL?0<=a.globalOpts.helperURL.search(/:\/\//)?this.url=a.globalOpts.helperURL:this.url=a.globalOpts.helperProtocol+a.globalOpts.helperURL:this.url=document.domain?location.origin?location.origin:a.globalOpts.helperProtocol+document.domain:a.globalOpts.helperProtocol+"localhost";this.baseurl=this.url;
switch(this.type){case "none":this.connected=null;this.ready=!0;$(document).trigger("JS9:helperReady",{type:"none",status:"OK"});break;case "get":case "post":a.globalOpts.helperCGI||a.error("cgi script name missing for helper");this.url+="/"+a.globalOpts.helperCGI;this.helper=this.connected=!0;a.DEBUG&&a.log("JS9 helper: connect: "+this.type);this.ready=!0;$(document).trigger("JS9:helperReady",{type:"get",status:"OK"});break;case "sock.io":case "nodejs":a.globalOpts.helperPort||a.error("port missing for helper");
this.url=this.url.replace(/:[0-9][0-9]*$/,"")+":"+a.globalOpts.helperPort;this.sockurl=window.electron&&window.electron.multiElectron?this.url+"/socket.io/socket.io.slim.js":this.url+"/socket.io/socket.io.js";window.electron?(this.aliveurl=this.url+"/alive",g(this.aliveurl,this.sockurl,d)):h(this.sockurl);break;default:a.error("unknown helper type: "+this.type)}};a.Helper.prototype.send=function(c,b,d){var e=this;if(!this.connected)return null;if(b&&"object"===typeof b){try{b.cookie=document.cookie}catch(f){delete b.cookie}a.globalOpts.dataPath&&
!b.dataPath&&(b.dataPath=a.globalOpts.dataPath+":.")}else b={dataPath:"."};a.TOROOT&&(b.dataPath+=":"+a.TOROOT);switch(this.type){case "get":case "post":b.key=c;a.helper.pageid&&(b.pageid=a.helper.pageid);a.DEBUG&&a.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(b),this.url);$.ajax({url:this.url,type:this.type.toUpperCase(),data:b,dataType:"text",success:function(b){"string"===typeof b&&0<=b.search(a.analOpts.epattern)&&a.log(b);d&&d(b)},error:function(b,c,d){a.DEBUG&&a.log("JS9 helper: "+
e.type+" failure: "+c+" "+d)}});break;case "sock.io":case "nodejs":a.helper.socket.emit(c,b,d)}return this};a.WebWorker=function(c){var b=this,d=function(){b.worker.onmessage=a.WebWorker.prototype.msgHandler.bind(b);b.handlers=[]};c.match(a.URLEXP)?a.fetchURL(null,c,null,function(a){b.worker=new Worker(URL.createObjectURL(a));d()}):(this.worker=new Worker(c),d())};a.WebWorker.prototype.msgHandler=function(c){var b=c.data;switch(b.cmd){case "progress":a.progress(b.result.value,b.result.max);break;
case "initsocketio":this.sockinit=!0;for(c=0;c<this.handlers.length;c++){var d=this.handlers[c];if(d.id===b.id){d.func(b.result);this.handlers.splice(c,1);break}}break;case "uploadFITS":for(c=0;c<this.handlers.length;c++)if(d=this.handlers[c],d.id===b.id){d.func(b.result);this.handlers.splice(c,1);break}break;case "connect_error":case "connect_timeout":1<a.DEBUG&&a.log("JS9 worker socketio: "+b.cmd);break;case "disconnect":a.waiting(!1);b.result?a.worker.postMessage("initsocketio",[a.helper.url,a.helper.pageid],
function(){a.error(b.result)}):1<a.DEBUG&&a.log("JS9 worker socketio: disconnect");break;case "error":a.error(b.result||"in web worker")}};a.WebWorker.prototype.postMessage=function(c,b,d,e){var f=c+a.uniqueID(),h={id:f,cmd:c,args:b};d&&(b=b||[],this.handlers.push({id:f,cmd:c,args:b,func:d}));e?this.worker.postMessage(h,e):this.worker.postMessage(h)};a.WebWorker.prototype.socketio=function(c){var b=a.helper;a.worker.sockinit?c&&c():a.worker.postMessage("initsocketio",[b.url,b.pageid],function(b){"OK"===
b?c&&c():a.error("can't init  socket.io for JS9 worker: "+b)})};a.WebWorker.prototype.terminate=function(){this.worker.terminate()};fabric.major_version=parseFloat(fabric.version.split(".")[0]);fabric.minor_version=parseFloat(fabric.version.split(".")[1]);fabric.patch_version=parseFloat(fabric.version.split(".")[2]);a.Fabric={};a.Fabric.elements="cornerSize cornerColor cornerStyle borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint lockMovementX lockMovementY lockRotation lockScalingX lockScalingY lockUniScaling selectable hasBorders params pub".split(" ");
a.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,selectionLineWidth:2,borderColor:"#00EEFF",cornerColor:"#00EEFF",cornerSize:fabric.isTouchSupported?10:6,cornerStyle:"circle",hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,strokeUniform:!0,selectable:!0,padding:0,canvas:{selection:!0},fill:"transparent",objectCaching:!1};a.Fabric.rescaleStrokeWidth=function(a,b){var c=(this.scaleX+this.scaleY)/2;4<=fabric.major_version||3===fabric.major_version&&
6===fabric.minor_version&&3<=fabric.patch_version||2<=fabric.major_version&&this.params&&"annulus"!==this.params.shape&&"cross"!==this.params.shape||(a=a||1,a*=c,!b&&this.params&&(b=this.params.sw1),b&&("group"===this.type?this.forEachObject(function(c){c.rescaleBorder(a,b)}):this.set("strokeWidth",b/a)))};a.Fabric.rescaleEvenly=function(){if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":var a=this.params.lastscale||1;this.scaleX!==a?this.scaleY=this.scaleX:
this.scaleY!==a&&(this.scaleX=this.scaleY);this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=a.Fabric.rescaleStrokeWidth;fabric.Object.prototype.rescaleEvenly=a.Fabric.rescaleEvenly;a.Fabric.newShapeLayer=function(c,b,d){var e=this,f=function(a){e.image&&e.image._updateMultiDialogs(a)},h=function(b,d){b.params.sel=null;b.display.image&&(b.display.image.layer=null);if(d){switch(d.type){case "polyline":case "polygon":a.Fabric.removePolygonAnchors(b,d)}b.display.image&&"activeSelection"!==
d.type&&b.display.image.updateShapes(c,d,"unselect")}},g=function(b,d){b.params.sel&&d.params&&b.params.sel!==d&&h(b,b.params.sel);b.display.image&&(b.display.image.layer=c);if(d){switch(d.type){case "polyline":case "polygon":a.Fabric.addPolygonAnchors(b,d),b.canvas.renderAll()}d.polyparams?b.params.sel=d.polyparams.polygon:d.params&&(b.params.sel=d);b.display.image&&"activeSelection"!==d.type&&b.display.image.updateShapes(c,d,"select");f(1)}};if(this&&c){if(this.layers[c])return this.layers[c];this.layers[c]=
{};var k=this.layers[c];k.layerName=c;k.params=[];k.params.sel=null;k.params.sellayer=null;d?k.dtype="other":(k.dtype="main",d=this.divjq);var l=d.attr("id")+"-"+c.replace(/\s+/,"_")+"-shapeLayer";k.display=this;k.opts=$.extend(!0,{},b);k.opts.canvas=k.opts.canvas||{};void 0===k.opts.canvas.selection&&(k.opts.canvas.selection=!0);k.el=a.Fabric.elements;k.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(d);k.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",l).attr("width",d.css("width")).attr("height",
d.css("height")).appendTo(k.divjq);a.bugs.webkit_resize&&"main"===k.dtype&&k.canvasjq.attr("width",this.width).attr("height",this.height);k.canvas=new fabric.Canvas(k.canvasjq[0]);k.canvas.renderOnAddRemove=!1;k.canvas.preserveObjectStacking=!0;k.opts.movable?(k.opts.lockMovementX=!1,k.opts.lockMovementY=!1,k.opts.selectable=!0,k.opts.evented=!0):!1===k.opts.movable&&(k.opts.lockMovementX=!0,k.opts.lockMovementY=!0,k.opts.selectable=!1,k.opts.evented=!1);void 0===k.opts.changeable&&void 0!==k.opts.fixinplace&&
(k.opts.changeable=!k.opts.fixinplace);k.opts.changeable?(k.opts.hasControls=!0,k.opts.hasRotatingPoint=!0,k.opts.hasBorders=!0,k.opts.lockMovementX=!1,k.opts.lockMovementY=!1,k.opts.lockRotation=!1,k.opts.lockScalingX=!1,k.opts.lockScalingY=!1,k.opts.lockUniScaling=!1,k.opts.selectable=!0,k.opts.evented=!0,k.opts.usekeyboard=!0):!1===k.opts.changeable&&(k.opts.hasControls=!1,k.opts.hasRotatingPoint=!1,k.opts.hasBorders=!1,k.opts.lockMovementX=!0,k.opts.lockMovementY=!0,k.opts.lockRotation=!0,k.opts.lockScalingX=
!0,k.opts.lockScalingY=!0,k.opts.lockUniScaling=!0,k.opts.selectable=!1,k.opts.evented=!1,k.opts.usekeyboard=!1);k.opts.selectable&&(k.opts.canvas.selection=!0);if(k.opts.onmousedown||k.opts.onmouseup||k.opts.onmousemove||k.opts.tooltip||k.opts.onmouseover||k.opts.onmouseout){k.opts.evented=!0;if(k.opts.onmousedown)k.canvas.on("mouse:down",function(b){if(k.display.image&&b.target)"main"===k.dtype&&(k.display.image.clickInRegion=!0,k.display.image.clickInLayer=c),k.opts.onmousedown.call(k.canvas,k.display.image,
b.target.pub,b.e,b.target);else if(k.canvas._selection=k.canvas.selection)k.canvas.selection=a.specialKey(b.e)});else k.canvas.on("mouse:down",function(b){if(k.canvas._selection=k.canvas.selection)k.canvas.selection=a.specialKey(b.e)});if(k.opts.onmouseup)k.canvas.on("mouse:up",function(a){k.display.image&&a.target&&k.opts.onmouseup.call(k.canvas,k.display.image,a.target.pub,a.e,a.target);k.canvas.selection=k.canvas._selection||k.canvas.selection});else k.canvas.on("mouse:up",function(){k.canvas.selection=
k.canvas._selection||k.canvas.selection});if(k.opts.onmousemove)k.canvas.on("mouse:move",function(a){k.display.image&&a.target&&k.opts.onmousemove.call(k.canvas,k.display.image,a.target.pub,a.e,a.target)});if(k.opts.onmouseover)k.canvas.on("mouse:over",function(a){k.display.image&&a.target&&k.opts.onmouseover.call(k.canvas,k.display.image,a.target.pub,a.e,a.target)});if(k.opts.onmouseout)k.canvas.on("mouse:out",function(a){k.display.image&&a.target&&k.opts.onmouseout.call(k.canvas,k.display.image,
a.target.pub,a.e,a.target)});k.opts.tooltip&&(k.canvas.on("mouse:over",function(b){k.display.image&&b.target&&a.tooltip(b.target.left+b.target.width+2,b.target.top+b.target.height+2,k.opts.tooltip,k.display.image,b.target.pub,b.e,b.target)}),k.canvas.on("mouse:out",function(b){k.display.image&&b.target&&a.tooltip(b.target.left,b.target.top,null,k.display.image,b.target.pub,b.e,b.target)}))}else k.canvas.on("mouse:down",function(b){if(k.canvas._selection=k.canvas.selection)k.canvas.selection=a.specialKey(b.e)}),
k.canvas.on("mouse:up",function(){k.canvas.selection=k.canvas._selection||k.canvas.selection});"function"===typeof k.opts.ongroupcreate&&(k.opts.canvas.selection=!0,k.opts.selectable=!0,k.canvas.on("selection:created",function(a){var b=[],c=[];k.display.image&&a.target&&"group"===a.target.type&&(a.target.forEachObject(function(a){a.pub&&(c.push(a),b.push(a.pub))}),k.opts.ongroupcreate.call(k.canvas,k.display.image,b,a.e,c))}));k.canvas.on("object:modified",function(b){var c=[];if(b.target){var d=
b.target;a.Fabric.updateChildren(k,d,"deltas");if(k.opts.sortOverlapping&&(d.setCoords(),k.canvas.forEachObject(function(a){a!==d&&d.intersectsWithObject(a)&&(1===fabric.major_version?(e=a.getWidth(),f=a.getHeight()):(e=a.getScaledWidth(),f=a.getScaledHeight()),c.push({obj:a,siz:e*f}))}),c.length)){if(1===fabric.major_version){var e=d.getWidth();var f=d.getHeight()}else e=d.getScaledWidth(),f=d.getScaledHeight();c.push({obj:d,siz:e*f});c.sort(function(a,b){return a.siz<b.siz?-1:a.siz>b.siz?1:0});
var g=c.length;for(b=0;b<g;b++)try{c[b].obj.sendToBack()}catch(w){}}}});k.canvas.on("object:scaling",function(b){b.target&&(b=b.target,b.rescaleEvenly(),b.rescaleBorder(),a.Fabric.updateChildren(k,b,"scaling"))});k.canvas.on("object:moving",function(b){b.target&&a.Fabric.updateChildren(k,b.target,"moving")});k.canvas.on("object:rotating",function(b){b.target&&a.Fabric.updateChildren(k,b.target,"rotating")});1===fabric.major_version?(k.canvas.on("object:selected",function(a){a.target&&g(k,a.target)}),
k.canvas.on("before:selection:cleared",function(a){a.target&&h(k,a.target)})):(k.canvas.on("selection:created",function(a){a.target&&g(k,a.target)}),k.canvas.on("selection:updated",function(b){b=k.canvas.getActiveObject();if("activeSelection"===b.type){var d,e=k.canvas.getActiveObjects();for(d=0;d<e.length;d++){var h=e[d];if(h.params){if(h.params.parent&&h.params.parent.obj){var l=h.params.parent.obj;0>$.inArray(l,e)&&b.addWithUpdate(l)}if(h.params.children)for(l=0;l<h.params.children.length;l++){var m=
h.params.children[l].obj;0>$.inArray(m,e)&&b.addWithUpdate(m)}switch(h.type){case "polyline":case "polygon":a.Fabric.removePolygonAnchors(k,h)}h&&k.display.image&&k.display.image.updateShapes(c,h,"select")}}k.canvas.renderAll();f(1)}else g(k,b)}),k.canvas.on("before:selection:cleared",function(a){var b=k.canvas.getActiveObject();if("activeSelection"===b.type){var c=k.canvas.getActiveObjects();for(b=0;b<c.length;b++){var d=c[b];h(k,d)}f(a.e?-1:0)}else h(k,b)}));if(k.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)if(fabric.isTouchSupported)k.divjq.on("touchstart",
function(){k.canvas.calcOffset()});else k.divjq.on("mouseenter",function(){k.canvas.calcOffset()});return k}};a.Fabric.showShapeLayer=function(c,b,d){var e=this,f,h;var g=0;if(h=this.getShapeLayer(c)){d=d||{};var k=h.canvas;var l=this.display.layers[c];if(a.isNull(b))return h.show;if(!0===b||"true"===b){if(!d.local&&(h.show=!0,this!==this.display.image))return;h.show&&(k.selection=h.opts.canvas.selection);h.json&&h.show&&k.loadFromJSON(h.json,function(){var b,d;a.Fabric.updateChildren(h.dlayer,null,
"objects");e.resize&&(k.getObjects().forEach(function(a){a.left+=e.resize.left;a.top+=e.resize.top;a.setCoords()}),k.calcOffset());h.zindex=Math.abs(h.zindex);l.divjq.css("z-index",h.zindex);for(b in e.layers)if(e.layers.hasOwnProperty(b)&&c!==b&&e.layers[b].show){var f=e.display.layers[b];f.divjq.css("z-index")<h.zindex&&(d=f.canvas.getActiveObject())&&(a.Fabric.removePolygonAnchors(f,d),f.canvas.discardActiveObject())}});for(f in this.layers)this.layers.hasOwnProperty(f)&&this.layers[f].json&&g++;
g||(this.resize=null);this.xeqPlugins("shape","onshapelayershow",c)}else{if(!d.local&&this!==this.display.image){h.show=!1;return}if(h.show){b=k.getObjects();for(f=b.length;f--;)g=b[f],g.params&&(g.params.winid&&(g.params.winid.close(),g.params.winid=null),g.params.anchors&&a.Fabric.removePolygonAnchors(h.dlayer,g));b=k.toJSON(h.dlayer.el);h.json=JSON.stringify(b);k.selection=!1;l&&(h.zindex=-Math.abs(h.zindex),l.divjq.css("z-index",h.zindex));k.clear()}d.local||(h.show=!1);this.xeqPlugins("shape",
"onshapelayerhide",c)}return this}};a.Fabric.displayShapeLayers=function(){var a;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&this.display.image.showShapeLayer(a,!1,{local:!0});if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0,{local:!0})}};a.Fabric.toggleShapeLayers=function(){var a,b;if(this.toggleLayers){for(a in this.layers)this.layers.hasOwnProperty(a)&&
(b=this.layers[a])&&this.toggleLayers[a]&&this.showShapeLayer(a,!0);delete this.toggleLayers}else for(a in this.toggleLayers={},this.layers)this.layers.hasOwnProperty(a)&&"crosshair"!==a&&(b=this.layers[a])&&b.show&&"main"===b.dlayer.dtype&&(this.toggleLayers[a]=!0,this.showShapeLayer(a,!1))};a.Fabric.getShapeLayer=function(a,b){if(!a)return null;var c=this.layers[a];if(!c){b=this.display.layers[a];if(!b)return null;this.layers[a]={};c=this.layers[a];c.show=!0;c.nshape=0;c.dlayer=b;c.opts=c.dlayer.opts;
c.canvas=c.dlayer.canvas;c.canvas.calcOffset()}return c};a.Fabric.activeShapeLayer=function(a){var b,c;if(a)if($.isArray(a)){var e=0;for(b=this.zlayer-1;e<a.length;e++){var f=this.layers[a[e]];"main"===f.dlayer.dtype&&(f.zindex=b--,f.show?c||(c=a[e]):f.zindex=-f.zindex,f.dlayer.divjq.css("z-index",f.zindex))}a=c}else{if((f=this.layers[a])&&f.show){c=f.zindex;f.zindex=this.zlayer-1;f.dlayer.divjq.css("z-index",f.zindex);for(e in this.layers)this.layers.hasOwnProperty(e)&&(b=this.layers[e],b!==f&&b.zindex===
f.zindex&&"main"===b.dlayer.dtype&&(b.zindex=c,b.dlayer.divjq.css("z-index",b.zindex)));this.xeqPlugins("shape","onshapelayeractive",a)}a=this}else{for(e in this.layers)this.layers.hasOwnProperty(e)&&(b=this.layers[e],"main"===b.dlayer.dtype&&(void 0===f||b.zindex>f)&&(f=b.zindex,c=e));a=c}return a};a.Fabric._parseShapeOptions=function(c,b,d){var e,f={},h={};if(b.remove)return{remove:b.remove};var g=b.parent||d&&d.params&&d.params.parent;delete b.parent;b.restoreid||delete b.id;delete b.restoreid;
h.tags=[];if(b.tags)if("string"===typeof b.tags){var k=b.tags.toLowerCase().split(",");for(e=0;e<k.length;e++)h.tags[e]=k[e].trim()}else if($.isArray(b.tags))for(e=0;e<b.tags.length;e++)h.tags[e]=b.tags[e].trim();if(a.notNull(b.angle)){if(!g)switch(b.shape){case "box":case "cross":case "ellipse":case "text":if(this.raw.wcsinfo)this.raw.wcsinfo.crot&&(b.angle+=this.raw.wcsinfo.crot);else if(a.notNull(this.raw.header.LTM1_1)||a.notNull(this.raw.header.LTM1_2)){try{var l=Math.atan((this.raw.header.LTM1_2||
0)/(this.raw.header.LTM1_1||0))}catch(w){l=0}l&&(l=180*-l/Math.PI,b.angle+=l)}a.notNull(this.params.transformAngle)&&(b.angle+=this.params.transformAngle);a.notNull(this.params.transformScale)&&(b.angle*=this.params.transformScale)}f.angle=-b.angle}void 0!==b.dx&&void 0!==b.dy&&(f.left=b.dx,f.top=b.dy);void 0!==b.x&&void 0!==b.y&&(l=this.imageToDisplayPos(b),f.left=l.x,f.top=l.y);void 0!==b.px&&void 0!==b.py&&(l=this.logicalToDisplayPos({x:b.px,y:b.py}),f.left=l.x,f.top=l.y);"string"===typeof b.wcs&&
(l=b.wcs.trim().split(/ +/),b.ra=l[0],b.dec=l[1],3<=l.length&&(b.wcssys=l[2]));if(void 0!==b.ra&&void 0!==b.dec&&0<this.raw.wcs){if(b.wcssys){var m=this.getWCSSys();var n=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.setWCSSys(b.wcssys,!1)}else b._wcssys&&(m=this.getWCSSys(),n=a.globalOpts.xeqPlugins,a.globalOpts.xeqPlugins=!1,this.setWCSSys(b._wcssys,!1),delete b._wcssys);"string"===typeof b.ra&&(b.ra=a.saostrtod(b.ra),a.isHMS(this.params.wcssys)&&(b.ra*=15));"string"===typeof b.dec&&(b.dec=
a.saostrtod(b.dec));l=a.wcs2pix(this.raw.wcs,b.ra,b.dec).trim().split(/ +/);m&&(this.setWCSSys(m,!1),a.globalOpts.xeqPlugins=n);l=this.imageToDisplayPos({x:parseFloat(l[0]),y:parseFloat(l[1])});f.left=l.x;f.top=l.y}void 0!==b.left&&(f.left=b.left);void 0!==b.top&&(f.top=b.top);void 0===f.left&&!0!==b.noLeftTop&&(f.left=d&&void 0!==d.left?d.left:this.display.canvasjq.attr("width")/2-1);void 0===f.top&&!0!==b.noLeftTop&&(f.top=d&&void 0!==d.top?d.top:this.display.canvasjq.attr("height")/2-1+1);b.deltax&&
(f.left+=b.deltax);b.deltay&&(f.top-=b.deltay);c="main"!==this.display.layers[c].dtype||b.preservedcoords?1:this.rgb.sect.zoom;switch(b.shape){case "annulus":h.radii=[];if(void 0!==b.radii)if("string"===typeof b.radii)for(h.radii=b.radii.replace(/ /g,"").split(","),n=e=0;e<h.radii.length;e++)""!==h.radii[e]&&(b.sizeScale&&(h.radii[e]*=b.sizeScale),h.radii[n++]=this.wcs2imlen(h.radii[e]));else{if(h.radii=b.radii,b.sizeScale)for(e=0;e<h.radii.length;e++)h.radii[e]*=b.sizeScale}else for(b.ireg&&a.SCALEIREG&&
(a.notNull(b.iradius)&&(b.iradius/=c),a.notNull(b.oradius)&&(b.oradius/=c)),b.sizeScale&&(a.notNull(b.iradius)&&(b.iradius*=b.sizeScale),a.notNull(b.oradius)&&(b.oradius*=b.sizeScale)),c=(b.oradius-b.iradius)/b.nannuli,m=b.nannuli+1,e=0;e<m;e++)n=b.iradius+c*e,b.sizeScale&&(n*=b.sizeScale),h.radii.push(n);break;case "box":case "cross":b.ireg&&a.SCALEIREG&&(a.notNull(b.width)&&(b.width/=c),a.notNull(b.height)&&(b.height/=c));b.sizeScale&&(a.notNull(b.width)&&(b.width*=b.sizeScale),a.notNull(b.height)&&
(b.height*=b.sizeScale));break;case "circle":b.ireg&&a.SCALEIREG&&a.notNull(b.radius)&&(b.radius/=c);b.sizeScale&&a.notNull(b.radius)&&(b.radius*=b.sizeScale);break;case "ellipse":b.ireg&&a.SCALEIREG&&(a.notNull(b.r1)&&(b.r1/=c),a.notNull(b.r2)&&(b.r2/=c));b.sizeScale&&(a.notNull(b.r1)&&(b.r1*=b.sizeScale),a.notNull(b.r2)&&(b.r2*=b.sizeScale));break;case "point":switch(b.ptshape){case "box":b.width=2*b.ptsize;b.height=2*b.ptsize;break;case "circle":b.radius=b.ptsize;break;case "ellipse":b.rx=b.ptsize,
b.ry=b.ptsize/2}b.lockRotation=!0;b.lockScalingX=!0;b.lockScalingY=!0;b.lockUniScaling=!0;b.hasControls=!1;b.hasRotatingPoint=!1;b.hasBorders=!0;break;case "line":case "polygon":if(void 0!==b.wcspts&&0<this.raw.wcs){b.pts=[];b.wcssys&&(m=this.getWCSSys(),n=a.globalOpts.xeqPlugins,a.globalOpts.xeqPlugins=!1,this.setWCSSys(b.wcssys,!1));for(e=0;e<b.wcspts.length;e++)l=a.wcs2pix(this.raw.wcs,b.wcspts[e].ra,b.wcspts[e].dec).trim().split(/ +/),b.pts.push({x:parseFloat(l[0]),y:parseFloat(l[1])});m&&(this.setWCSSys(m,
!1),a.globalOpts.xeqPlugins=n)}if(b.pts&&b.pts.length){if("string"===typeof b.pts){l=b.pts.replace(/ /g,"").split(",");m=l.length;if("string"===typeof l[0])for(e=0;e<m;e++)l[e]=parseFloat(l[e]);b.pts=[];for(n=e=0;e<m;e+=2,n++)b.pts[n]={x:l[e],y:l[e+1]}}m=b.pts.length;for(e=0;e<m;e++)n=b.pts[e],a.notNull(n.x)&&a.notNull(n.y)?b.pts[e]=this.imageToDisplayPos(b.pts[e]):a.notNull(n.dx)&&a.notNull(n.dy)&&(b.pts[e].x=n.dx,delete b.pts[e].dx,b.pts[e].y=n.dy,delete b.pts[e].dy);b.left&&b.top?n={x:b.left,y:b.top}:
b.dx&&b.dx?n={x:b.dx,y:b.dy}:(n=a.centerPolygon(b.pts),f.left=n.x,f.top=n.y);b.points=[];for(e=0;e<m;e++)l={x:(b.pts[e].x-n.x)/c,y:(b.pts[e].y-n.y)/c},b.points.push(l)}else d&&d.points&&d.points.length||("polygon"===b.shape&&b.polypoints?b.points=b.points||b.polypoints:"line"===b.shape&&b.linepoints&&(b.points=b.points||b.linepoints));if(b.ireg&&a.SCALEIREG)for(m=b.points.length,e=0;e<m;e++)b.points[e].x/=c,b.points[e].y/=c}for(r in b)if(b.hasOwnProperty(r))switch(r){case "tags":case "x":case "y":case "px":case "py":case "deltax":case "deltay":case "ra":case "dec":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;
case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "borderDashArray":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "send":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":case "textOpts":f[r]=
b[r];break;case "shape":var p=b[r];break;default:h[r]=b[r]}if(!(b=h.color||f.stroke)){b=h.tags;e=h.tagcolors;var q;e=e||{};for(q in e)if(e.hasOwnProperty(q)){var r=q.split("_");if(0===$(b).not(r).length&&0===$(r).not(b).length){var v=e[q];break}}if(!v)for(q in e)if(e.hasOwnProperty(q)&&(r=q.split("_"),0===$(b).not(r).length)){v=e[q];break}if(!v)for(q in e)if(e.hasOwnProperty(q)&&(r=q.split("_"),0===$(r).not(b).length)){v=e[q];break}b=v=v||d&&d.get("stroke")||e.defcolor||a.globalOpts.defcolor||"#000000"}f.stroke=
b;f.selectColor=f.stroke;if(!0===a.globalOpts.controlsMatchRegion||"corner"===a.globalOpts.controlsMatchRegion)f.cornerColor=f.stroke;if(!0===a.globalOpts.controlsMatchRegion||"border"===a.globalOpts.controlsMatchRegion)f.borderColor=f.stroke;void 0===h.changeable&&void 0!==h.fixinplace&&(h.changeable=!h.fixinplace);void 0!==h.changeable&&(d=!h.changeable,f.lockMovementX=d,f.lockMovementY=d,f.lockRotation=d,f.lockScalingX=d,f.lockScalingY=d,f.hasControls=!d,f.hasRotatingPoint=!d,f.hasBorders=!d);
void 0!==h.movable&&(d=!h.movable,f.lockMovementX=d,f.lockMovementY=d);void 0!==h.resizable&&(d=h.resizable,f.hasControls=d,f.hasBorders=d);void 0!==h.rotatable&&(d=!h.rotatable,void 0===f.lockRotation&&(f.lockRotation=d,f.hasRotatingPoint=!d));return{shape:p,opts:f,params:h}};a.Fabric._exportShapeOptions=function(a){return"object"!==typeof a?[]:Object.keys(a).filter(function(b){switch(b){case "top":case "left":case "width":case "height":case "radius":case "rx":case "ry":case "angle":case "panzoom":case "iradius":case "oradius":case "nannuli":case "aradius1":case "aradius2":case "configURL":case "sortOverlapping":case "tagcolors":case "pts":case "ptshape":case "ptsize":case "linepoints":case "polypoints":case "responseType":case "display":case "tags":case "r1":case "r2":case "x":case "y":case "dx":case "dy":case "px":case "py":case "ra":case "dec":case "shape":case "parent":case "rtn":case "_wcssys":case "file":case "savefile":case "savewhich":case "saveformat":case "savewcs":case "listonchange":case "multitext":return!1;
case "text":return"text"===a.shape?!1:!0;default:return!0}})};a.Fabric._handleChildText=function(c,b,d){if("regions"===c)if(d=d||{},"text"!==b.params.shape&&d.text&&(!b.params.children||!b.params.children.length)){var e=b.height*b.scaleX/2-12;e=1E-6>Math.abs(b.angle)?{x:b.left,y:b.top-e}:a.rotatePoint({x:b.left,y:b.top-e},b.angle,{x:b.left,y:b.top});var f=this.displayToImagePos(e);e={x:f.x,y:f.y,angle:-b.angle,color:b.stroke,text:d.text,parent:"TBD",rtn:"object"};d.textOpts&&(e=$.extend(!0,{},e,d.textOpts));
var h=this.addShapes(c,"text",e);h.params.parent={id:b.params.id,obj:b,dleft:b.left-h.left,dtop:b.top-h.top,lastscalex:b.scaleX,lastscaley:b.scaleY,lastangle:b.angle,textheight:12};this._updateShape(c,h,null,"child",h.params);void 0!==d.strokeWidth&&(h.params.parent.strokeWidth=d.strokeWidth);if(f.x!==e.x||f.y!==e.y)h.params.parent.moved=!0;d.textOpts&&void 0!==d.textOpts.ra&&void 0!==d.textOpts.dec&&(h.params.hasTextOpts=!0);b.params.children.push({id:h.params.id,obj:h});this._updateShape(c,b,null,
"addchild",b.params)}else if(b.params.children&&(d.text||d.textOpts))for(h=0;h<b.params.children.length;h++)f=b.params.children[h].obj,e=$.extend(!0,{},d.textOpts||{}),d.text&&(e.text=d.text),this.changeShapes(c,f.params.id,e)};a.Fabric.addShapes=function(c,b,d){var e,f={},h=[];if(!(0<=$.inArray("regions",this.params.disable)&&"regions"===c)){d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(t){a.error("can't parse shape opts: "+d,t)}if(this.display.image!==this)this.delayedShapes=this.delayedShapes||
[],this.delayedShapes.push({layer:c,shape:b,mode:"add",opts:d});else{if(d.file&&a.globalOpts.reloadRefreshReg)try{this.removeShapes("regions",d.file)}catch(t){}if((e=this.getShapeLayer(c))&&e.show){var g=e.canvas;if("string"===typeof b){var k=this.parseRegions(b,d);b="string"===typeof k?[{shape:k}]:k}else if(!$.isArray(b))if("object"===typeof b)b=[b];else return;if(a.isNull(e.zindex)||Number.isNaN(e.zindex)){if("main"===this.display.layers[c].dtype)switch(c){case a.Crosshair.LAYERNAME:case a.Grid.LAYERNAME:e.zindex=
1;break;default:e.zindex=this.zlayer++}else e.zindex=a.SHAPEZINDEX;var l=this.display.layers[c];l.divjq.css("z-index",e.zindex);this.xeqPlugins("shape","onshapelayercreate",c)}var m=$.extend(!0,{},a.Fabric.opts,e.opts,d);for(l=0;l<b.length;l++){var n=b[l];!0===n.preservedcoords&&((a.isNull(n.dx)||a.isNull(n.dy))&&$.isArray(n.pts)&&a.isNull(n.pts[0].dx)&&a.error("preservedcoords requires positions in display coords"),n.sticky=!0,n.preservedcoords=Object.keys(n),n.wcsconfig={wcssys:"image"});var p=
$.extend(!0,{},m,n);var q=this._parseShapeOptions(c,p);if(q.remove){if(!0===q.remove||"true"===q.remove)q.remove="all";if(!1!==q.remove&&"false"!==q.remove){this.removeShapes(c,q.remove);continue}}if(q.shape){p=q.opts;f=q.params;void 0===f.id&&(f.id=++e.nshape);void 0===f.wcsconfig&&(f.wcsconfig={wcssys:this.getWCSSys()});f.exports=this._exportShapeOptions(d).concat(this._exportShapeOptions(n));f.parent=null;f.children=[];p.stroke&&(p.color=p.stroke,p.stroke=a.colorToHex(p.stroke));e.opts.noCenteredScaling&&
0<=$.inArray(q.shape,e.opts.noCenteredScaling)&&(p.centeredScaling=!1);switch(q.shape){case "annulus":f.shape="annulus";k=p.top;q=p.left;p.top=0;p.left=0;var r=[];if(f.radii)for(n=0;n<f.radii.length;n++)p.radius=f.radii[n],r.push(new fabric.Circle(p));p.top=k;p.left=q;p.width=2*p.radius;p.height=2*p.radius;k=new fabric.Group(r,p);break;case "box":f.shape="box";k=new fabric.Rect(p);break;case "circle":f.shape="circle";k=new fabric.Circle(p);break;case "cross":f.shape="cross";k=p.top;q=p.left;n=p.angle;
r=p.width/2;var v=p.height/2;var w=[];p.left=0;p.top=0;p.angle=0;p.points=[{x:-r,y:0},{x:r,y:0}];w.push(new fabric.Polyline(p.points,p));p.points=[{x:0,y:-v},{x:0,y:v}];w.push(new fabric.Polyline(p.points,p));p.top=k;p.left=q;p.angle=n;k=new fabric.Group(w,p);break;case "ellipse":f.shape="ellipse";p.rx=f.r1;p.ry=f.r2;k=new fabric.Ellipse(p);break;case "point":f.shape="point";switch(f.ptshape){case "box":k=new fabric.Rect(p);break;case "circle":k=new fabric.Circle(p);break;case "ellipse":k=new fabric.Ellipse(p);
break;default:k=new fabric.Rect(p)}break;case "line":f.shape="line";k=new fabric.Polyline(p.points,p);break;case "polygon":f.shape="polygon";k=new fabric.Polygon(p.points,p,!0);break;case "text":f.shape="text";f.text=p.text||"Double-click to add text here";p.fill=p.stroke;p.strokeWidth=0;k=new fabric.Text(f.text,p);break;default:a.error("unknown shape: "+q.shape)}g.add(k);f.layerName=c;f.sw1=Math.max(1,Math.floor(k.strokeWidth+.5));f.listonchange=!1;k.params=f;q="main"!==this.display.layers[c].dtype||
k.params.preservedcoords?1:this.rgb.sect.zoom;if(e.opts.panzoom)switch(f.shape){case "point":case "text":break;default:k.scale(q)}k.rescaleBorder();this._handleChildText(c,k,p);"TBD"!==d.parent&&this._updateShape(c,k,null,"add",f);if(d.onaddshapes&&k.pub)try{a.xeqByName(d.onaddshapes,this,this,k.pub)}catch(t){a.error("in onaddshapes callback",t,!1)}h.push(k)}}(void 0===f.redraw||f.redraw)&&g.renderAll();return"object"===d.rtn?k:"objs"===d.rtn?h:f.id}}}};a.Fabric._selectShapes=function(c,b,d){var e;
if(!this.layers||!c||!this.layers[c])return null;"string"===typeof b&&/^[1-9]\d*$/.test(b)&&(b=parseInt(b,10));var f=this.layers[c].canvas;var h=1===fabric.major_version?f.getActiveGroup():(e=f.getActiveObject())&&"activeSelection"===e.type?e:null;b||(b=e&&"auto"===a.globalOpts.regWhichDefault?"selected":"all");c={group:null,canvas:f,layer:c};switch(typeof b){case "object":b.params&&(h&&h.contains(b)&&(c.group=h),d.call(this,b,c));break;case "number":f=f.getObjects();for(e=f.length;e--;){var g=f[e];
g.params&&b===g.params.id&&(h&&h.contains(g)?c.group=h:c.group=null,d.call(this,g,c))}break;case "string":if("selected"===b)if(1===fabric.major_version)if(f.getActiveObject())b=f.getActiveObject(),b.params&&(c.group=null,d.call(this,b,c));else{if(h)for(c.group=h,f=h.getObjects(),e=f.length;e--;)g=f[e],g.params&&!g.params.parent&&d.call(this,g,c)}else for(c.group=h,f=f.getActiveObjects(),e=f.length;e--;)g=f[e],g.params&&!g.params.parent&&d.call(this,g,c);else for(f=f.getObjects(),e=f.length;e--;)if(g=
f[e],g.params&&(!g.params.parent||"child"===b||"All"===b)&&("child"!==b||g.params.parent)){var k=g.stroke.toLowerCase();h&&h.contains(g)?c.group=h:c.group=null;if("all"===b.toLowerCase())d.call(this,g,c);else if(b.toLowerCase()===k||a.colorToHex(b).toLowerCase()===k)d.call(this,g,c);else if(b===g.params.shape)d.call(this,g,c);else if(b===g.params.file)d.call(this,g,c);else if("object"===typeof g.params.data&&b===g.params.data.syncid)d.call(this,g,c);else if("child"===b&&g.params.parent)d.call(this,
g,c);else if("dcoords"===b&&g.params.preservedcoords)d.call(this,g,c);else if("nodcoords"===b&&!g.params.preservedcoords)d.call(this,g,c);else if("parent"===b&&g.params.children&&g.params.children.length)d.call(this,g,c);else if(0<=$.inArray(b,a.wcssyss)&&g.params.wcsconfig&&g.params.wcsconfig.wcssys===b)d.call(this,g,c);else if(g.params.tags)for(k=0;k<g.params.tags.length;k++){var l=g.params.tags[k];b.match(/^\/.*\/$/)&&l.match(new RegExp(b.slice(1,-1)))?d.call(this,g,c):b===l&&d.call(this,g,c)}}}return this};
a.Fabric.selectShapes=function(a,b,d){var c=[];if(d=this.getShapeLayer(a))return d=d.canvas,d.discardActiveObject(),this._selectShapes(a,b,function(a){c.push(a)}),a=new fabric.ActiveSelection(c,{canvas:d}),d.setActiveObject(a),d.renderAll(),this};a.Fabric.updateShapes=function(a,b,d,e){var c=this;this._selectShapes(a,b,function(b,f){c._updateShape(a,b,f,d,e)});return this};a.Fabric._updateMultiDialogs=function(a){var b=this;$("form[class*='regionsConfigForm']").each(function(c,e){c=$(e).data("multi");
var d=$(e).data("winid");e=$(e).data("im");c&&d&&e===b&&e.initRegionsForm(null,{winid:d,multi:c,setmode:a})})};a.Fabric._updateShape=function(c,b,d,e,f){var h,g={},k=this.layers[c],l=/^(child||export|unexport|move|mouseout)$/;var m=function(a){return a.toFixed(2)};var n=function(b,c,d,e,f,g,h){var k=a.pix2wcs(b,d.x,d.y).trim().split(/\s+/);h.rastr=k[0];h.decstr=k[1];h.wcssys=k[2];var l=a.strtoscaled(k[0]);a.isHMS(k[2],l.dtype)&&(l.dval*=15);var m=a.strtoscaled(k[1]);h.ra=l.dval;h.dec=m.dval;if(!1!==
g.updateWCS&&(g.updateWCS||c.opts.updateWCS)){h.wcsstr=a.reg2wcs(b,e).replace(/;$/,"");"line"===d.shape&&f&&(h.wcsstr=h.wcsstr.replace(/} *$/,f+"}"));k=h.wcsstr.replace(/.*\(/,"").replace(/\).*/,"").split(",");for(b=0;b<k.length;b++)k[b]=k[b].trim();h.wcsposstr=[k[0],k[1]];switch(d.shape){case "annulus":h.wcssizestr=[k[k.length-1]];break;case "box":case "cross":h.wcssizestr=[k[2],k[3]];break;case "circle":h.wcssizestr=[k[2]];break;case "ellipse":h.wcssizestr=[k[2],k[3]];break;case "line":case "polygon":for(h.wcspts=
[],b=0;b<k.length;b+=2)l=a.strtoscaled(k[b]),a.isHMS(h.wcssys,l.dtype)&&(l.dval*=15),m=a.strtoscaled(k[b+1]),h.wcspts.push({ra:l.dval,dec:m.dval})}}};d=d||{};f=f||{};e=e||"update";var p="main"!==this.display.layers[c].dtype||b.params.preservedcoords?1:this.rgb.sect.zoom;g.mode=e;g.id=b.params.id;g.shape=b.params.shape;g.layer=c;g.color=b.color||b.stroke;g.tags=b.params.tags;g.sticky=b.params.sticky;g.preservedcoords=b.params.preservedcoords;g.parent=b.params.parent?b.params.parent.obj.params.id:null;
g.child=b.params.children&&b.params.children.length?b.params.children[0].id:null;var q=b.getCenterPoint();if(d.group){var r=d.group.getCenterPoint();q={x:q.x+r.x,y:q.y+r.y};d.group.angle&&(q=a.rotatePoint(q,d.group.angle,r))}g.dx=q.x;g.dy=q.y;q=this.displayToImagePos(q);g.x=q.x;g.y=q.y;g.lcs=this.imageToLogicalPos(q);"export"!==e&&b.params.wcsconfig&&("image"===b.params.wcsconfig.wcssys?h="image":"physical"===b.params.wcsconfig.wcssys&&(h="physical"));if("image"===h||"image"===this.params.wcssys&&
"physical"!==h){g.imsys="image";var v=g.x;var w=g.y;r=1}else g.imsys=g.lcs.sys,v=g.lcs.x,w=g.lcs.y,r=Math.sqrt(Math.pow(this.lcs.physical.reverse[0][0],2)+Math.pow(this.lcs.physical.reverse[0][1],2));g.angle=-b.angle;d.group&&(g.angle-=d.group.angle);h=g.angle;if(!g.parent)switch(g.shape){case "box":case "cross":case "ellipse":case "text":if(a.notNull(this.params.transformScale)&&(g.angle/=this.params.transformScale),a.notNull(this.params.transformAngle)&&(g.angle-=this.params.transformAngle),this.raw.wcsinfo)this.raw.wcsinfo.crot&&
(g.angle-=this.raw.wcsinfo.crot);else if(a.notNull(this.raw.header.LTM1_1)||a.notNull(this.raw.header.LTM1_2)){try{var t=Math.atan((this.raw.header.LTM1_2||0)/(this.raw.header.LTM1_1||0))}catch(z){t=0}t&&(t=180*-t/Math.PI,g.angle-=t)}}for(;0>g.angle;)g.angle+=360;for(;360<=g.angle;)g.angle-=360;q=b.scaleX/p;t=b.scaleY/p;d.group&&(q*=d.group.scaleX,t*=d.group.scaleY);switch(g.shape){case "annulus":g.shape="annulus";g.radii=[];"image"!==g.imsys&&(g.lcs.radii=[]);g.imstr="annulus("+m(v)+","+m(w)+",";
var u="annulus "+g.x+" "+g.y+" ";var y=b.getObjects();h=y.length;for(d=0;d<h;d++)p=y[d].radius*q,t=p*r,g.imstr+=m(t),u+=g.x+" "+g.y+" "+(g.x+p)+" "+g.y+" ",g.imstr=d===h-1?g.imstr+")":g.imstr+",",g.radii.push(p),"image"!==g.imsys&&g.lcs.radii.push(t);break;case "box":case "cross":g.width=b.width*q;g.height=b.height*t;t=g.width*r;u=g.height*r;"image"!==g.imsys&&(g.lcs.width=t,g.lcs.height=u);g.imstr=g.shape+"("+m(v)+","+m(w)+","+m(t)+","+m(u)+","+g.angle.toFixed(4)+")";u=g.shape+" "+g.x+" "+g.y+" "+
g.x+" "+g.y+" "+(g.x+g.width)+" "+g.y+" "+g.x+" "+g.y+" "+g.x+" "+(g.y+g.height)+" "+g.angle*Math.PI/180;break;case "circle":g.radius=b.radius*q;t=g.radius*r;"image"!==g.imsys&&(g.lcs.radius=t);g.imstr="circle("+m(v)+","+m(w)+","+m(t)+")";u="circle "+g.x+" "+g.y+" "+g.x+" "+g.y+" "+(g.x+g.radius)+" "+g.y;break;case "ellipse":g.r1=b.width*q/2;g.r2=b.height*t/2;t=g.r1*r;u=g.r2*r;"image"!==g.imsys&&(g.lcs.r1=t,g.lcs.r2=u);g.imstr="ellipse("+m(v)+","+m(w)+","+m(t)+","+m(u)+","+g.angle.toFixed(4)+")";
u="ellipse "+g.x+" "+g.y+" "+g.x+" "+g.y+" "+(g.x+g.r1)+" "+g.y+" "+g.x+" "+g.y+" "+g.x+" "+(g.y+g.r2)+" "+g.angle*Math.PI/180;break;case "point":g.width=b.width*q;g.height=b.height*t;t=g.width*r;u=g.height*r;"image"!==g.imsys&&(g.lcs.width=t,g.lcs.height=u);g.imstr="point("+m(v)+","+m(w)+")";u="point "+g.x+" "+g.y;break;case "line":case "polygon":g.imstr=g.shape+"(";u=g.shape+" ";g.pts=[];"image"!==g.imsys&&(g.lcs.pts=[]);for(d=0;d<b.points.length;d++)0<d&&(g.imstr+=",",u+=" "),t=this.displayToImagePos({x:b.left+
b.points[d].x*b.scaleX,y:b.top+b.points[d].y*b.scaleY}),t=a.rotatePoint(t,h,{x:g.x,y:g.y}),"image"===g.imsys?g.imstr+=m(t.x)+","+m(t.y):(r=this.imageToLogicalPos(t),q=r.x,r=r.y,g.imstr+=m(q)+","+m(r),g.lcs.pts.push({x:q,y:r})),u+=t.x+" "+t.y,g.pts.push(t),"line"===g.shape&&(0===d?y=0:(q=g.pts[d-1],y+=Math.sqrt((t.x-q.x)*(t.x-q.x)+(t.y-q.y)*(t.y-q.y))));if("line"===g.shape&&a.notNull(y)){g.imstr+=') {"size":'+m(y)+',"units":"pixels"';if(2===g.pts.length){for(t=180*Math.atan2(g.pts[1].y-g.pts[0].y,
g.pts[1].x-g.pts[0].x)/Math.PI;0>t;)t+=360;var x=',"posang":'+t.toFixed(4)+',"posunits":"degrees"';g.imstr+=x}g.imstr+="}"}else g.imstr+=")";g.angle=0;break;case "text":g.imstr="text("+m(v)+","+m(w)+',"'+b.text+'",'+g.angle.toFixed(4)+")",u="text "+g.x+" "+g.y+' "'+b.text+'" '+g.angle*Math.PI/180,g.text=b.text}this.raw.wcs&&0<this.raw.wcs&&(n(this.raw.wcs,k,g,u,x,f,g),b.params.wcsconfig&&b.params.wcsconfig.wcssys&&(m=a.globalOpts.xeqPlugins,a.globalOpts.xeqPlugins=!1,y=this.getWCSSys(),a.notWCS(b.params.wcsconfig.wcssys)||
(this.setWCSSys(b.params.wcsconfig.wcssys,!1),n(this.raw.wcs,k,g,u,x,f,b.params.wcsconfig)),g.wcsconfig=$.extend(!0,{},b.params.wcsconfig),this.setWCSSys(y,!1),a.globalOpts.xeqPlugins=m));g.data=b.params.data;b.set("pub",g);b.params.winid&&($(b.params.winid).is(":visible")?this.initRegionsForm(b):b.params.winid=null);if(f.nocb)return g;if(!b.params.parent&&!e.match(l)){if(this.params.xeqonchange&&k.show&&k.opts.onchange)try{this.params.xeqonchange=!1,a.xeqByName(k.opts.onchange,window,this,g)}catch(z){a.log("error in onchange: %s [%s]\n%s",
this.id,z.message,a.strace(z))}finally{this.params.xeqonchange=!0}this.xeqPlugins("shape","on"+c+"change",g)}if("regions"===c&&a.globalOpts.regToClipboard){switch(e){case "update":d=g.parent||g.id;break;default:d=null}if(a.notNull(d)){try{var B=this.listRegions(d,{mode:1,includedcoords:!0})}catch(z){B=null}B&&(a.clipboard=B)}}"regions"===c&&"wcs"===e&&this._updateMultiDialogs(!0);return g};a.Fabric.removeShapes=function(c,b,d){var e=this,f,h={mode:1,includedcoords:!0},g=[];if(f=this.getShapeLayer(c)){var k=
f.canvas;d=d||{};"regions"===c&&a.globalOpts.unremoveReg&&(this.regstack.push(this.listRegions(b,h,c)),this.regstack.length>a.globalOpts.unremoveReg&&(this.regstack=this.regstack.slice(0,a.globalOpts.unremoveReg)));this._selectShapes(c,b,function(a,b){if(!(!1===a.params.removable&&!d.overrideRemovable||a.params.sticky&&!1===d.sticky)){e._updateShape(c,a,b,"remove");a.params.winid&&(a.params.winid.close(),a.params.winid=null);if(a.params.parent){var f=a.params.parent.obj;for(b=f.params.children.length-
1;0<=b;b--)if(a===f.params.children[b].obj){f.params.children.splice(b,1);break}}for(b=0;b<a.params.children.length;b++)f=a.params.children[b].obj,g.push(f);g.push(a)}});for(b=0;b<g.length;b++)k.remove(g[b]);1===fabric.major_version?k.getActiveGroup()&&k.discardActiveGroup():k.discardActiveObject();k.renderAll();!k.getObjects().length&&a.globalOpts.resetEmptyShapeId&&(f.nshape=0);return this}};a.Fabric.getShapes=function(c,b,d){var e={},f=[];d=d||{};if("string"===typeof d)try{d=JSON.parse(d)}catch(k){a.error("can't parse getShapes opts: "+
d,k)}if("regions"===c&&("text"===d.format||"csv"===d.format)){d.mode=d.mode||1;b=this.listRegions(b,d);if("csv"===d.format){var h=b.split(";");c=0;for(b="";c<h.length;c++)if(h[c])if(h[c].toLowerCase().match(a.WCSEXP))d.includewcs&&(b+=h[c].trim()+"\n");else{var g=h[c].replace(/\(/,",").replace(/\).*/,"").trim();b+=g+"\n"}}return b}this._selectShapes(c,b,function(a){e=a.pub||{};d.includeObj&&(e.obj=a);f.push(e)});return f};a.Fabric.changeShapes=function(c,b,d){var e=this,f,h,g,k,l,m,n,p,q,r,v,w=[],
t=[];if((l=this.getShapeLayer(c))&&d){if("string"===typeof d)try{d=JSON.parse(d)}catch(x){a.error("can't parse shape opts: "+d,x)}if(this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:c,shape:b,mode:"change",opts:d});else{var u=l.canvas;var y=u.getActiveObject();this._selectShapes(c,b,function(b,B){p="main"!==e.display.layers[c].dtype||b.params.preservedcoords?1:e.rgb.sect.zoom;d.radii&&(b.params.radii=[]);d.tags&&(b.params.tags=[]);k=$.extend(!0,{},
b.params,d);g=e._parseShapeOptions(c,k,b);if(g.remove){if(!0===g.remove||"true"===g.remove)g.remove="all";if(!1!==g.remove&&"false"!==g.remove){e.removeShapes(c,g.remove||"all");return}}if(g.opts.send)switch(g.opts.send){case "front":u.sendToFront(y);u.discardActiveObject();break;case "back":u.sendToBack(y),u.discardActiveObject()}q=e._exportShapeOptions(d).filter(function(a){return!b.params.exports.hasOwnProperty(a)});g.params.exports=b.params.exports.concat(q);g.opts.stroke&&(g.opts.color=g.opts.stroke,
g.opts.stroke=a.colorToHex(g.opts.stroke));switch(b.params.shape){case "text":g.opts.stroke&&(g.opts.fill=g.opts.stroke);g.opts.strokeWidth=0;break;case "line":case "polygon":g.opts.points&&g.opts.points.length&&(b.angle=0)}b.set(g.opts);b.params=$.extend(!1,{},b.params,g.params);d.strokeWidth&&(b.params.sw1=d.strokeWidth);switch(b.params.shape){case "annulus":if(d.radii&&d.radii.length){b.forEachObject(function(a){w.push(a)});m=w.length;for(f=0;f<m;f++)b.remove(w[f]),u.remove(w[f]);m=b.params.radii.length;
n=0;r=$.extend(!0,{},d);r.stroke=r.stroke||b.get("stroke");for(f=0;f<m;f++)r.radius=b.params.radii[f],h=new fabric.Circle(r),n=Math.max(n,b.params.radii[f]),b.add(h);b.scaleX=p;b.scaleY=p;b.width=2*n;b.height=2*n;y===b&&u.setActiveObject(b)}break;case "box":d.width&&(b.scaleX=p);d.height&&(b.scaleY=p);break;case "circle":d.radius&&(b.scaleX=p,b.scaleY=p);break;case "cross":r=$.extend(!0,{},d);r.stroke=r.stroke||b.get("stroke");r.width&&(b.scaleX=p,t[0]=[{x:-r.width/2,y:0},{x:r.width/2,y:0}],delete r.width);
r.height&&(b.scaleY=p,t[1]=[{x:0,y:-r.height/2},{x:0,y:r.height/2}],delete r.height);r.angle&&delete r.angle;b.forEachObject(function(a,b){v=$.extend(!0,{},r);t[b]&&(v.points=t[b]);a.set(v)});break;case "ellipse":d.r1&&(b.rx=b.params.r1,b.scaleX=p,b.width=2*b.rx);d.r2&&(b.ry=b.params.r2,b.scaleY=p,b.height=2*b.ry);break;case "line":case "polygon":if(d.points&&d.points.length||d.pts&&d.pts.length)b.scaleX=p,b.scaleY=p;y===b&&(a.Fabric.removePolygonAnchors(l.dlayer,b),a.Fabric.addPolygonAnchors(l.dlayer,
b));a.resetPolygonCenter(b);break;case "text":d.text&&(b.params.text=d.text)}b.rescaleBorder();a.Fabric.updateChildren(l.dlayer,b,"moving");a.Fabric.updateChildren(l.dlayer,b,"scaling");a.Fabric.updateChildren(l.dlayer,b,"rotating");a.Fabric.updateChildren(l.dlayer,b,"deltas");b.setCoords();e._handleChildText(c,b,d);e._updateShape(c,b,B,"update");if(d.onchangeshapes&&b.pub)try{a.xeqByName(d.onchangeshapes,e,e,b.pub)}catch(z){a.error("in onchangeshapes callback",z,!1)}});(void 0===d.redraw||d.redraw)&&
u.renderAll();return this}}};a.Fabric.refreshShapes=function(c){var b;if(c){var d=this.getWCSSys();if("image"===d){var e=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.raw.wcs&&0<this.raw.wcs?this.setWCSSys("native",!1):this.setWCSSys("physical",!1)}if(b=this.listRegions("all",{mode:1,sticky:!1,savewcsconfig:!0,saveid:!0},c))this.removeShapes(c,"all",{overrideRemovable:!0,sticky:!1}),this.addShapes(c,b,{restoreid:!0});"image"===d&&(this.setWCSSys(d,!1),this.updateShapes(c,"all","refresh"),
a.globalOpts.xeqPlugins=e);return this}};a.Fabric.copyShapes=function(c,b,d){var e=[];if(this.getShapeLayer(c)){if("object"===typeof b)e.push(b);else if("all"===b)for(b=0;b<a.images.length;b++)this!==a.images[b]&&e.push(a.images[b]);else(b=a.lookupImage(b))&&e.push(b);if(e.length){d=this.listRegions(d,{mode:1,includedcoords:a.globalOpts.regCopyDCoords},c);for(b=0;b<e.length;b++){var f=this.display.layers[c]?this.display.layers[c].opts:a.Regions.opts;e[b].display.newShapeLayer(c,f);e[b].addShapes(c,
d)}return this}}};a.Fabric._addPolygonPoint=function(c,b,d){var e=Number.MAX_VALUE;if(b&&b.points){d=a.eventToDisplayPos(d);var f=b.getCenterPoint().x;var h=b.getCenterPoint().y;f=(d.x-f)/b.get("scaleX");var g=(d.y-h)/b.get("scaleY");for(h=-b.get("angle")*Math.PI/180;h>2*Math.PI;)h-=2*Math.PI;d=Math.cos(h)*f-Math.sin(h)*g;g=Math.sin(h)*f+Math.cos(h)*g;f=b.points;for(h=0;h<f.length;h++){var k=f[h];var l=f[(h+1)%f.length];var m=k.x<l.x?k.x:l.x;var n=k.y<l.y?k.y:l.y;var p=k.x>l.x?k.x:l.x;var q=k.y>l.y?
k.y:l.y;var r=k.x-l.x;k=k.y-l.y;var v=Math.sqrt(r*r+k*k);0!==v&&(r/=v,k/=v);v=d-l.x;var w=g-l.y;v=v*r+w*k;r=l.x+r*v;l=l.y+k*v;r<m?r=m:r>p&&(r=p);l<n?l=n:l>q&&(l=q);m=(r-d)*(r-d)+(l-g)*(l-g);if(m<e){e=m;var t=r;var u=l;var y=h===f.length?0:h}}c=this.getShapeLayer(c);a.Fabric.removePolygonAnchors(c.dlayer,b);f.splice(y+1,0,{x:t,y:u});if(1===fabric.major_version)c.canvas.setActiveObject(b);else{switch(b.type){case "polyline":case "polygon":a.Fabric.addPolygonAnchors(c.dlayer,b),c.dlayer.canvas.renderAll()}b.polyparams?
c.dlayer.params.sel=b.polyparams.polygon:b.params&&(c.dlayer.params.sel=b)}}};a.Fabric._removePolygonPoint=function(c,b){if(b&&b.polyparams){var d=b.polyparams.polygon;var e=d.points;if(!("polygon"===d.type&&3>=e.length||"polyline"===d.type&&2>=e.length)){var f=b.polyparams.point;delete b.polyparams.point;c=this.getShapeLayer(c);a.Fabric.removePolygonAnchors(c.dlayer,d);e.splice(f,1);a.resetPolygonCenter(d);c.canvas.setActiveObject(d)}}};a.Fabric.addPolygonAnchors=function(c,b){var d,e={},f=c.canvas,
h=function(b){b=b.target;var d=b.polyparams.polygon,g=b.polyparams.point,h=d.get("points"),k=c.display.image;void 0!==g&&!1!==d.params.changeable&&(d.angle?e=a.rotatePoint({x:b.left,y:b.top},-d.angle,{x:d.left,y:d.top}):(e.x=b.left,e.y=b.top),h[g].x=(e.x-d.left)/d.scaleX,h[g].y=(e.y-d.top)/d.scaleY,a.resetPolygonCenter(d),k._updateShape(d.params.layerName,d,null,"update"),k&&(k.params.listonchange||d.params.listonchange)&&k.listRegions(d,{mode:2}),f.renderAll())},g=function(b){var c,d={};for(c=0;c<
b.params.anchors.length;c++)d.x=b.left+b.points[c].x*b.scaleX,d.y=b.top+b.points[c].y*b.scaleY,b.angle&&(d=a.rotatePoint(d,b.angle,{x:b.left,y:b.top})),b.params.anchors[c].set({left:d.x,top:d.y,angle:b.angle}),b.params.anchors[c].setCoords();b._calcDimensions(!0);f.renderAll()};if(!b.params.anchors&&!1!==b.params.changeable){b.params.anchors=[];for(d=0;d<b.points.length;d++){e.x=b.left+b.points[d].x*b.scaleX;e.y=b.top+b.points[d].y*b.scaleY;b.angle&&(e=a.rotatePoint(e,b.angle,b.getCenterPoint()));
var k=new fabric.Rect({left:e.x,top:e.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:b.get("stroke"),hoverCursor:"pointer",width:a.Fabric.opts.cornerSize+2,height:a.Fabric.opts.cornerSize+2,padding:2});k.on("moving",h);k.polyparams={};k.polyparams.polygon=b;k.polyparams.point=d;b.params.anchors[d]=k;f.add(k)}b.on("moving",function(){g(b)});b.on("rotating",function(){g(b)});b.on("scaling",function(){g(b)});b.setCoords()}};a.Fabric.removePolygonAnchors=function(a,b){var c=a.canvas;
if(b&&b.params&&b.params.anchors&&!1!==b.params.changeable){for(a=0;a<b.params.anchors.length;a++)c.remove(b.params.anchors[a]);delete b.params.anchors}};a.Fabric.updateChildren=function(c,b,d){var e,f;if("regions"===c.layerName)if("objects"===d){var h={};c.canvas.getObjects().forEach(function(a){a.params&&(a.params.parent||a.params.children.length)&&(h[a.params.id]=a)});c.canvas.getObjects().forEach(function(a){if(a.params)for(a.params.parent&&(a.params.parent.obj=h[a.params.parent.id]),e=0;e<a.params.children.length;e++)a.params.children[e].obj=
h[a.params.children[e].id]})}else if(b&&b.params)if("deltas"===d){if(b.params.parent){var g=b.params.parent;g.dleft=g.obj.left-b.left;g.dtop=g.obj.top-b.top;g.moved=!0}}else for(e=0;e<b.params.children.length;e++){var k=b.params.children[e].obj;g=k.params.parent;switch(d){case "moving":k.left=b.left-g.dleft;k.top=b.top-g.dtop;break;case "rotating":for(f=b.angle;0>f;)f+=360;for(;360<=f;)f-=360;var l=f-g.lastangle;var m=a.rotatePoint({x:k.left,y:k.top},l,{x:b.left,y:b.top});k.left=m.x;k.top=m.y;g.dleft=
b.left-k.left;g.dtop=b.top-k.top;for(k.angle+=l;0>k.angle;)k.angle+=360;for(;360<=k.angle;)k.angle-=360;g.lastangle=f;break;case "scaling":g.dleft*=b.scaleX/g.lastscalex,g.dtop=b.scaleY/g.lastscaley*(g.dtop-g.textheight)+g.textheight,g.lastscalex=b.scaleX,g.lastscaley=b.scaleY,g.moved=!0,k.left=b.left-g.dleft,k.top=b.top-g.dtop}k.setCoords();c.display.image&&c.display.image.updateShapes(c.layerName,k,"updatechild")}};a.resetPolygonCenter=function(c){var b={};if(1===fabric.major_version){c._calcDimensions();
var d=(c.minX+c.width/2)*c.scaleX;var e=(c.minY+c.height/2)*c.scaleY}else e=c._calcDimensions(),d=(e.left+e.width/2)*c.scaleX,e=(e.top+e.height/2)*c.scaleY;c.angle?b=a.rotatePoint({x:c.left+d,y:c.top+e},c.angle,{x:c.left,y:c.top}):(b.x=c.left+d,b.y=c.top+e);if(1<fabric.major_version||5<=fabric.minor_version){d/=c.scaleX;var f=e/c.scaleY;for(e=0;e<c.points.length;e++)c.points[e].x-=d,c.points[e].y-=f}c.left=b.x;c.top=b.y;1<fabric.major_version&&(b=c._calcDimensions(),c.width=b.width,c.height=b.height,
c.pathOffset={x:b.left+c.width/2,y:b.top+c.height/2});c.setCoords()};a.Fabric.print=function(c){var b,d="",e=0,f=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(l){a.error("can't parse print opts: "+c,l)}var h=this.display.canvas.toDataURL("image/png");var g="<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>";
var k=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,e);g+=k+"<img src='"+h+"'></div>";for(b in this.layers)this.layers.hasOwnProperty(b)&&(h=this.layers[b],"main"===h.dlayer.dtype&&h.show&&(g+=""+k+h.dlayer.canvas.toSVG()+"</div>"));(void 0===c.colorbar||c.colorbar)&&(c=this.display.pluginInstances.JS9Colorbar)&&c.isActive()&&(e+=2,h=c.colorbarjq[0].toDataURL("image/png"),e+=this.display.height,k=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,e),g+=k+"<img src='"+
h+"'></div>",c.textjq&&c.textjq[0]&&(h=c.textjq[0].toDataURL("image/png"),e+=c.colorbarjq.height()+1,k=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,e),g+=k+"<img style='width:"+this.display.width+"px;'src='"+h+"'></div>"));g+="</body></html>";window.electron&&(d="data:text/html,"+g);(k=window.open(d,this.id,f))?k.document?(k.document.open(),k.document.write(g),k.document.close()):a.error("no method available for drawing image into print window"):a.error("could not create print window (check your pop-up blockers)")};
a.Fabric.initGraphics=function(){var c;a.Display.prototype.newShapeLayer=a.Fabric.newShapeLayer;a.Image.prototype._selectShapes=a.Fabric._selectShapes;a.Image.prototype._updateShape=a.Fabric._updateShape;a.Image.prototype._parseShapeOptions=a.Fabric._parseShapeOptions;a.Image.prototype._exportShapeOptions=a.Fabric._exportShapeOptions;a.Image.prototype._handleChildText=a.Fabric._handleChildText;a.Image.prototype._addPolygonPoint=a.Fabric._addPolygonPoint;a.Image.prototype._removePolygonPoint=a.Fabric._removePolygonPoint;
a.Image.prototype._updateMultiDialogs=a.Fabric._updateMultiDialogs;a.Image.prototype.addShapes=a.Fabric.addShapes;a.Image.prototype.updateShapes=a.Fabric.updateShapes;a.Image.prototype.getShapes=a.Fabric.getShapes;a.Image.prototype.changeShapes=a.Fabric.changeShapes;a.Image.prototype.removeShapes=a.Fabric.removeShapes;a.Image.prototype.refreshShapes=a.Fabric.refreshShapes;a.Image.prototype.copyShapes=a.Fabric.copyShapes;a.Image.prototype.selectShapes=a.Fabric.selectShapes;a.Image.prototype.getShapeLayer=
a.Fabric.getShapeLayer;a.Image.prototype.showShapeLayer=a.Fabric.showShapeLayer;a.Image.prototype.activeShapeLayer=a.Fabric.activeShapeLayer;a.Image.prototype.displayShapeLayers=a.Fabric.displayShapeLayers;a.Image.prototype.toggleShapeLayers=a.Fabric.toggleShapeLayers;a.Image.prototype.print=a.Fabric.print;for(c in a.Fabric.opts)a.Fabric.opts.hasOwnProperty(c)&&(fabric.Object.prototype[c]=a.Fabric.opts[c])};a.Fabric.initGraphics();a.MouseTouch={};a.MouseTouch.CLASS="JS9";a.MouseTouch.NAME="MouseTouch";
a.MouseTouch.WIDTH=512;a.MouseTouch.HEIGHT=220;a.MouseTouch.BASE=a.MouseTouch.CLASS+a.MouseTouch.NAME;a.MouseTouch.mouseText=[];a.MouseTouch.mouseText[0]="Move mouse, no buttons pressed:";a.MouseTouch.mouseText[1]="Move mouse, primary button pressed:";a.MouseTouch.mouseText[2]="Move mouse, secondary button pressed:";a.MouseTouch.touchText=[];a.MouseTouch.touchText[0]="Touch move, with one finger:";a.MouseTouch.touchText[1]="Touch move, with two fingers:";a.MouseTouch.touchText[2]="Touch move, with three fingers:";
a.MouseTouch.textHTML="<div style='float: left'>%s</div>";a.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>";a.MouseTouch.actionid=function(a,b){return(a+"_"+b).replace(/[^A-Za-z0-9_]/g,"_")};a.MouseTouch.addText=function(c,b){b=sprintf(a.MouseTouch.textHTML,b);return $("<div>").addClass(a.MouseTouch.BASE+"Text").html(b).appendTo(c)};a.MouseTouch.addAction=function(c,b,d){b=a.MouseTouch.actionid(b,d);d=sprintf(a.MouseTouch.actionHTML,d);return $("<div>").addClass(a.MouseTouch.BASE+
"Action").attr("id",b).html(d).appendTo(c)};a.MouseTouch.isPinch=function(c,b){var d,e,f=a.globalOpts.pinchWait,h=a.globalOpts.pinchThresh;if(!c)return-1;b=c.display;if(!b.mousetouchZoom||2!==c.pos.touches.length)return-1;switch(b.ispinch){case -1:case 1:return b.ispinch}c=Math.sqrt((c.pos.touches[0].x-c.pos.touches[1].x)*(c.pos.touches[0].x-c.pos.touches[1].x)+(c.pos.touches[0].y-c.pos.touches[1].y)*(c.pos.touches[0].y-c.pos.touches[1].y));b.dist0||(b.dist0=c);b.deltas.push(Math.floor(c-b.dist0));
if(b.deltas.length>=f){c=1;for(e=d=0;c<f;c++)b.deltas[c]>b.deltas[c-1]?d++:b.deltas[c]<b.deltas[c-1]&&e++;b.ispinch=d>=h||e>=h?1:-1;b.lastzoom=0;return b.ispinch}return 0};a.MouseTouch.Actions={};a.MouseTouch.Actions["display value/position"]=function(c,b,d){!a.specialKey(d)&&a.globalOpts.internalValPos&&c&&b&&0<b.x&&0<b.y&&b.x<=c.raw.width&&b.y<=c.raw.height&&(c.valpos=c.updateValpos(b,!0))};a.MouseTouch.Actions["change contrast/bias"]=function(c,b,d){var e=c.display;a.globalOpts.internalContrastBias&&
c&&b&&"static"!==c.cmapObj.type&&!(c.pos0&&c.pos&&Math.abs(c.pos0.x-c.pos.x)<a.NOMOVE&&Math.abs(c.pos0.y-c.pos.y)<a.NOMOVE||c.clickInRegion||a.specialKey(d)||c.rgbFile)&&(d=a.eventToDisplayPos(d,c.posOffset),b=Math.floor(d.x+.5),d=Math.floor(d.y+.5),a.globalOpts.containContrastBias&&(0>b||0>d||b>=e.canvas.width||d>=e.canvas.height)||(c.params.bias=b/e.canvas.width,c.params.contrast=d/e.canvas.height*10,a.bugs.firefox_linux?window.setTimeout(function(){c.displayImage("scaled",{blendMode:!1})},0):c.displayImage("scaled",
{blendMode:!1}),c.xeqStashDiscard("filterRGBImage"),a.globalOpts.extendedPlugins&&c.xeqPlugins("image","onchangecontrastbias")))};a.MouseTouch.Actions["change contrast/bias"].stop=function(a,b,d){a.display.blendMode&&a.displayImage("rgb")};a.MouseTouch.Actions["wheel zoom"]=function(c,b){c&&c.display.mousetouchZoom&&(b=0<b.originalEvent.deltaY?Math.min(a.MAXZOOM,c.getZoom()+a.ADDZOOM):Math.max(a.MINZOOM,c.getZoom()-a.ADDZOOM),b=Math.round(100*(b+1E-5))/100,c.setZoom(b))};a.MouseTouch.Actions["pan the image"]=
function(c,b,d){if(c){b=c.rgb.sect;d=(c.pos0.x-c.pos.x)/b.zoom;var e=(c.pos0.y-c.pos.y)/b.zoom;if(1<=Math.abs(d)||1<=Math.abs(e)){"x"===c.params.flip?d=-d:"y"===c.params.flip?e=-e:"xy"===c.params.flip&&(d=-d,e=-e);if(90===c.params.rot90){var f=d;d=-e;e=f}else 180===c.params.rot90?(d=-d,e=-e):-90===c.params.rot90&&(f=d,d=e,e=-f);d={x:b.xcen+d,y:b.ycen-e};c.params.rotate&&(d=a.rotatePoint(d,-c.params.rotate,{x:b.xcen,y:b.ycen}));c.setPan(d);c.pos0=c.pos}}};a.MouseTouch.Actions.pinch=function(c,b,d){c&&
(b=c.display,d=b.zoom0*Math.sqrt((c.pos.touches[0].x-c.pos.touches[1].x)*(c.pos.touches[0].x-c.pos.touches[1].x)+(c.pos.touches[0].y-c.pos.touches[1].y)*(c.pos.touches[0].y-c.pos.touches[1].y))/b.dist0,d=Math.max(a.MINZOOM,Math.min(a.MAXZOOM,Math.round(100*(d+1E-5))/100)),d!==b.lastzoom&&c.setZoom(d),b.lastzoom=d)};a.MouseTouch.Actions.start=function(c,b,d){c&&(b=c.display,b.ispinch=0,b.dist0=0,b.zoom0=c.rgb.sect.zoom,b.deltas=[]);b=a.MouseTouch.getAction(c,d);a.MouseTouch.Actions[b]&&a.MouseTouch.Actions[b].start&&
a.MouseTouch.Actions[b].start(c,c.ipos,d)};a.MouseTouch.Actions.stop=function(c,b,d){b=a.MouseTouch.getAction(c,d);a.MouseTouch.Actions[b]&&a.MouseTouch.Actions[b].stop&&a.MouseTouch.Actions[b].stop(c,c.ipos,d)};a.MouseTouch.getAction=function(c,b){if(!c)return e;var d=c.display;switch(c.clickState){case 0:var e=d.mouseActions[0];break;case 1:e=d.mouseActions[1];break;case 2:e=d.mouseActions[2];break;case -1:e=d.touchActions[0];break;case -2:switch(a.MouseTouch.isPinch(c,b)){case -1:e=d.touchActions[1];
break;case 1:e="pinch"}break;case -3:e=d.touchActions[2]}return e};a.MouseTouch.action=function(c,b,d){if((d=d||a.MouseTouch.getAction(c,b))&&a.MouseTouch.Actions[d])a.MouseTouch.Actions[d](c,c.ipos,b)};a.MouseTouch.mousetouchzoom=function(c,b){c=a.lookupDisplay(c);b=b.checked;c&&(c.mousetouchZoom=b)};a.MouseTouch.init=function(){var c=this,b;this.divjq.html("");this.divjq.addClass("JS9PluginScrolling");this.mousetouchContainer=$("<div>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+
"MouseTouchContainer").appendTo(this.divjq);var d=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",a.MouseTouch.BASE+"Header");this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(d).appendTo(this.mousetouchContainer);this.mousetouchTextContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer);
this.mousetouchActionContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer);if(a.TOUCHSUPPORTED){this.mousetouchTouchTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer);for(b=0;b<a.MouseTouch.touchText.length;b++)a.MouseTouch.addText.call(this,this.mousetouchTouchTextContainer,a.MouseTouch.touchText[b]);
for(b=a.MouseTouch.touchText.length;b<this.display.touchActions.length;b++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchTouchContainer=$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer);for(b=0;b<this.display.touchActions.length;b++)d=this.display.touchActions[b],a.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,"touch",d);this.mousetouchTouchContainer.sortable({start:function(a,
b){c.oidx=b.item.index()},stop:function(a,b){a=b.item.index();b=c.display.touchActions.splice(c.oidx,1)[0];c.display.touchActions.splice(a,0,b);delete c.oidx}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){this.mousetouchMouseTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer);for(b=0;3>b;b++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,a.MouseTouch.mouseText[b]);for(b=3;b<this.display.mouseActions.length;b++)a.MouseTouch.addText.call(this,
this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchMouseContainer=$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer);for(b=0;b<this.display.mouseActions.length;b++)d=this.display.mouseActions[b],a.MouseTouch.addAction.call(this,this.mousetouchMouseContainer,"mouse",d);this.mousetouchMouseContainer.sortable({start:function(a,b){c.oidx=b.item.index()},stop:function(a,b){a=b.item.index();b=c.display.mouseActions.splice(c.oidx,
1)[0];c.display.mouseActions.splice(a,0,b);delete c.oidx}})}d=sprintf("<p><div class='%s'>Use mouse wheel or pinch to zoom:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",a.MouseTouch.BASE+"Footer",this.display.id);this.mousetouchFootContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchFootContainer").html(d).appendTo(this.mousetouchContainer);
this.display.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",!0)};a.Regions={};a.Regions.CLASS="JS9";a.Regions.NAME="Regions";a.Regions.opts={updateWCS:!0,panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:2,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,
aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",saveURL:"./params/regionssave.html",sortOverlapping:!0,title:"Edit region",noCenteredScaling:["box","line"],tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(c,b,d,e){var f,h=e.params;!a.specialKey(d)&&h&&(b=(new Date).getTime(),h.lasttime&&b-h.lasttime<a.DBLCLICK&&(f=!0),h.lasttime=b);f?h.winid||
!1===h.changeable||c.displayRegionsForm(e):a.specialKey(d)&&("polygon"===e.type||"polyline"===e.type?(c._addPolygonPoint(h.layerName,e,d),c._updateShape(h.layerName,e,null,"update")):e.polyparams&&e.polyparams.polygon&&(d=e.polyparams.polygon,c._removePolygonPoint(d.params.layerName,e),c._updateShape(d.params.layerName,d,null,"update")))},onmouseup:function(){var a,b=[];this.getActiveObject()&&b.push(this.getActiveObject());1===fabric.major_version?this.getActiveGroup()&&(b=this.getActiveGroup().getObjects()):
b.push(this.getActiveObjects());for(a=0;a<b.length;a++)b[a].polyparams&&this.setActiveObject(b[a].polyparams.polygon)},onchange:null};a.Regions.init=function(c){a.Image.prototype.parseRegions=a.Regions.parseRegions;a.Image.prototype.saveRegions=a.Regions.saveRegions;a.Image.prototype.listRegions=a.Regions.listRegions;a.Image.prototype.copyRegions=a.Regions.copyRegions;a.Image.prototype.changeRegionTags=a.Regions.changeRegionTags;a.Image.prototype.toggleRegionTags=a.Regions.toggleRegionTags;a.Image.prototype.unremoveRegions=
a.Regions.unremoveRegions;a.Image.prototype.initRegionsForm=a.Regions.initConfigForm;a.Image.prototype.displayRegionsForm=a.Regions.displayConfigForm;a.Image.prototype.processRegionsForm=a.Regions.processConfigForm;var b=this.display.newShapeLayer(c||"regions",a.Regions.opts);b.canvas.on("mouse:up",function(){var a,c=[];if(b.display.image){var f=b.display.image;1===fabric.major_version?(b.canvas.getActiveObject()&&c.push(b.canvas.getActiveObject()),b.canvas.getActiveGroup()&&(c=b.canvas.getActiveGroup().getObjects())):
c.push(b.canvas.getActiveObjects());for(a=0;a<c.length;a++)if(c[a].params){f.params.listonchange?"all"===f.params.whichonchange?f.listRegions("all",{mode:2}):f.listRegions("selected",{mode:2}):c[a].params.listonchange&&f.listRegions("selected",{mode:2});break}}});return this};a.Regions.displayConfigForm=function(c,b){var d=this,e=0,f=a.Regions.opts.title;if(this&&(b=b||{},c||this.getShapes("regions").length)){b.type=b.type||"config";switch(b.type){case "save":var h=a.allinone?a.allinone.regionsSaveHTML:
a.InstallDir(a.Regions.opts.saveURL);f="Save regions";var g=a.lightOpts[a.LIGHTWIN].regWin1;break;default:h=a.allinone?a.allinone.regionsConfigHTML:a.InstallDir(a.Regions.opts.configURL),c||(b.multi=!0)}if(b.multi&&($("form[class='regionsConfigForm']").each(function(a,c){a=$(c).data("multi");var f=$(c).data("winid");c=$(c).data("im");a&&f&&c===d&&(b.winid=f,c.initRegionsForm(null,b),e++)}),f=f.replace(/regions?/,"selected regions"),e))return;$(a.lightOpts[a.LIGHTWIN].topid).arrive(".regionsConfigForm",
{onceOnly:!0},function(){b.firsttime=!0;d.updateShapes("regions",c,"wcsconfig");d.initRegionsForm(c,b)});b.winid=this.displayAnalysis("regions",h,{title:f,winformat:g});c&&(c.params.winid=b.winid)}};a.Regions.initConfigForm=function(c,b){var d=this,e,f,h,g,k,l,m,n=!1,p=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};var q={type:"multi",pub:{shape:"multi",wcsconfig:{}},params:{}};var r=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)},v=function(a){return(a||
"").replace(/\n/g,"\\n")};if(c&&c.pub)var w=c.pub.wcsconfig&&c.pub.wcsconfig.wcssys?c.pub.wcsconfig.wcssys:this.params.wcssys;else w=this.params.wcssys,c=q;b=b||{};if(c.params.winid)var t=c.params.winid;else b.winid&&(t=b.winid);if(t){var u="#"+$(t).attr("id")+" .regionsConfigForm ";if($(u).length){n=$(u).data("multi")?!0:b.multi;$(u+"."+c.pub.shape).each(function(a,b){$(b).removeClass("nodisplay")});$(u+".val").each(function(b,m){h="";f=$(m).attr("name");switch(f){case "x":case "y":c.pub.lcs&&void 0!==
c.pub.lcs[f]?h=r(c.pub.lcs[f]):void 0!==c.pub[f]&&(h=r(c.pub[f]));break;case "radii":c.pub.radii&&(h=a.notWCS(w)||!c.pub.wcsconfig.wcsstr?c.pub.imstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","):c.pub.wcsconfig.wcsstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","));break;case "pts":c.pub.pts?c.pub.pts.forEach(function(a){h&&(h+=", ");h+=a.x.toFixed(2)+", "+a.y.toFixed(2)}):c.pub.imstr&&(h=c.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;
case "linelength":if(c.pub.pts&&2===c.pub.pts.length){k=c.pub.pts[0];l=c.pub.pts[1];h=r(Math.sqrt((l.x-k.x)*(l.x-k.x)+(l.y-k.y)*(l.y-k.y)));switch(w){case "image":case "physical":break;default:h*=Math.abs(p.cdelt1),h*=Math.abs(p.cdelt2)}h=r(h);d.tmp.linelength=h}break;case "lineangle":if(c.pub.pts&&2===c.pub.pts.length){k=c.pub.pts[0];l=c.pub.pts[1];for(h=180*Math.atan2(l.y-k.y,l.x-k.x)/Math.PI;0>h;)h+=360;h=r(h);d.tmp.lineangle=h}break;case "fontFamily":c.getFontFamily&&(h=c.getFontFamily());break;
case "fontSize":c.getFontSize&&(h=c.getFontSize());break;case "fontStyle":c.getFontStyle&&(h=c.getFontStyle());break;case "fontWeight":c.getFontWeight&&(h=c.getFontWeight());break;case "colorPicker":h=void 0!==c.pub.color?a.colorToHex(c.pub.color):$(u).data("colorpicker")||a.globalOpts.defcolor;break;case "color":void 0!==c.pub.color?h=r(c.pub.color):$(u).data("colorpicker")&&(h=$(u).data("colorpicker"));break;case "strokeWidth":h=c.params.sw1?c.params.sw1:$(u).data("strokewidth")||"";break;case "strokeDashes":c.strokeDashArray?
(h=c.strokeDashArray.join(" "),h.match(/NaN/)&&(h="")):h=$(u).data("strokedashes")||"";break;case "regstr":h=a.notWCS(w)||!c.pub.wcsconfig.wcsstr?c.pub.imsys+";"+c.pub.imstr:c.pub.wcsconfig.wcssys+";"+c.pub.wcsconfig.wcsstr;break;case "xpos":switch(w){case "image":c.pub.preservedcoords&&void 0!==c.pub.dx?h=sprintf("d%.1f",c.pub.dx):void 0!==c.pub.x&&(h=sprintf("%.1f",c.pub.x));break;case "physical":c.pub.lcs?h=sprintf("%.1f",c.pub.lcs.x):void 0!==c.pub.x&&(h=sprintf("%.1f",c.pub.x));break;default:void 0!==
c.pub.wcsconfig.ra?h=sprintf("%.6f",c.pub.wcsconfig.ra):void 0!==c.pub.x&&(h=sprintf("%.1f",c.pub.x))}break;case "ypos":switch(w){case "image":c.pub.preservedcoords&&void 0!==c.pub.dy?h=sprintf("d%.1f",c.pub.dy):void 0!==c.pub.y&&(h=sprintf("%.1f",c.pub.y));break;case "physical":c.pub.lcs?h=sprintf("%.1f",c.pub.lcs.y):void 0!==c.pub.y&&(h=sprintf("%.1f",c.pub.y));break;default:void 0!==c.pub.wcsconfig.dec?h=sprintf("%.6f",c.pub.wcsconfig.dec):void 0!==c.pub.y&&(h=sprintf("%.1f",c.pub.y))}break;case "radius":case "oradius":case "length":case "width":case "r1":switch(w){case "image":void 0!==
c.pub[f]&&(h=r(c.pub[f]));break;case "physical":c.pub.lcs&&void 0!==c.pub.lcs[f]&&(h=r(c.pub.lcs[f]));break;default:void 0!==c.pub.wcsconfig.wcssizestr?h=r(c.pub.wcsconfig.wcssizestr[0]):void 0!==c.pub[f]&&(h=r(c.pub[f]))}break;case "height":case "r2":switch(w){case "image":void 0!==c.pub[f]&&(h=r(c.pub[f]));break;case "physical":c.pub.lcs&&void 0!==c.pub.lcs[f]&&(h=r(c.pub.lcs[f]));break;default:void 0!==c.pub.wcsconfig.wcssizestr?h=r(c.pub.wcsconfig.wcssizestr[1]):void 0!==c.pub[f]&&(h=r(c.pub[f]))}break;
case "wcssys":case "savewcs":y=$(u).find("[name='"+f+"']");if(!y.find("option").length)for(e=0;e<a.wcssyss.length;e++)y.append("<option>"+a.wcssyss[e]+"</option>");g="savewcs"===f?a.globalOpts.regSaveWCS||w:w;y.find("option").each(function(a,b){g===b.value&&(h=b.value)});break;case "wcsunits":c.pub.wcsunits&&(h=c.pub.wcsunits);break;case "childtext":c.params.children&&0<c.params.children.length&&(h=v(c.params.children[0].obj.text));break;case "text":void 0!==c.pub[f]&&(h=v(r(c.pub[f])));break;case "id":n?
h="selected":void 0!==c.pub.id&&(h=String(c.pub.id),$(m).css("width",h.length+"ch"));break;case "tags":void 0!==c.pub[f]&&(h=r(c.pub[f]));break;case "savefile":h=$(u).data("savefile")||d.tmp.saveregionsFile||"js9.reg";window.electron&&!h.match(/.*\//)&&(h=window.electron.currentDir+"/"+h);break;case "selectfilter":h=$(u).data("selectfilter");break;default:void 0!==c.pub[f]&&(h=r(c.pub[f]))}$(m).val(h)});(n||!this.raw.wcs||0>this.raw.wcs)&&$(u).find("[name='wcssys']").hide();"text"!==c.type&&c.params.children&&
($(u+".childtext").removeClass("nodisplay"),$(u+"[name='childtext']").prop("readonly",0<c.params.children.length));if(b.firsttime){window.electron&&$(u).find(".rsavebrowse, .rconfigbrowse").removeClass("nodisplay");n?($(u).find("label[for='savecur']").text("sel"),$(u).find("input[id='savecur']").data("tooltip","save selected regions")):$(u).find(".checkboxes").removeClass("nodisplay");if(a.favorites.wcs&&a.favorites.wcs.length){var y=$(u).find(".rwcsbuttons").removeClass("nodisplay");q=y.find(".rwcsbuttoncontainer");
if(q.length&&!q.find(".rwcsbutton").length){for(e=0;e<a.favorites.wcs.length;e++){var x=a.favorites.wcs[e];var B="string"===typeof x?x.split(":"):x;x=B[0];B=B[1]||x;if("save"===b.type){var z="rsavecol_R"+(e+2);var A="rsaveradio"}else z="rconfigcol_R"+(e+2),A="rconfigradio";q.append("<span class='rconfigcol_R rwcsbutton "+z+"'>\n                                <input type='radio'\n                                       id='rwcsbutton_"+x+"'\n                                       name='rwcsbutton'\n                                       class='rwcsradio "+
A+"}'\n                                       value='"+x+"'\n                                       data-tooltip='save using "+x+' wcs\'\n                                       onclick=\'\n                                           $(this).closest("form")\n                                           .find("[name=savewcs]")\n                                           .val("'+x+'")\n                                           .trigger("change");\'>\n                                <label for=\'rwcsbutton_'+
x+"'>"+B+"</label>\n                                </span>")}$(u).find(".rwcsbuttons").find("[value='"+w+"']").prop("checked",!0)}}a.globalOpts.internalColorPicker&&$.fn.spectrum.inputTypeColorSupport()||(y=$(u).find("input[name='colorPicker']"),y.spectrum({showButtons:!1,showInput:!1,preferredFormat:"hex6"}),y.on("move.spectrum",function(a,b){a=b.toHexString();$(u).find("input[name='color']").val(a);$(u).data("colorpicker",a)}))}void 0===c.params.listonchange&&(c.params.listonchange=!1);c.params.listonchange?
$(u+"[name='listonchange']").prop("checked",!0):$(u+"[name='listonchange']").prop("checked",!1);void 0===c.params.changeable&&void 0!==c.params.fixinplace&&(c.params.changeable=!c.params.fixinplace);void 0===c.params.changeable&&(c.params.changeable=!0);c.params.changeable?$(u+"[name='changeable']").prop("checked",!0):$(u+"[name='changeable']").prop("checked",!1);c.params.sticky?$(u+"[name='sticky']").prop("checked",!0):$(u+"[name='sticky']").prop("checked",!1);$(u+"[id='includejson']").prop("checked",
a.globalOpts.regIncludeJSON);$(u+"[id='includecomments']").prop("checked",a.globalOpts.regIncludeComments);$(u+"[id='savedcoords']").prop("checked",a.globalOpts.regSaveDCoords);$(u+"[id='includewcs']").prop("checked",a.globalOpts.csvIncludeWCS);$(u).find("input[name='saveformat']").prop("checked",!1);$(u).find("input[value='"+a.globalOpts.regSaveFormat+"']").prop("checked",!0);$(u).find("input[name='rwcsbutton']").prop("checked",!1);$(u).find("input[value='"+(a.globalOpts.regSaveWCS||w)+"']").prop("checked",
!0);x="save"===b.type?"save"+a.globalOpts.regSaveWhich1:"save"+a.globalOpts.regSaveWhich2;$(u+"[id='"+x+"']").prop("checked",!0);"save"===b.type&&$(u).find("input[name='savefile']").trigger("change");$(u).find("input[name='strokeMenu']").prop("selectedIndex",0);$(u).find("input[name='dashesMenu']").prop("selectedIndex",0);if(n)$(u).find(".regid").hide(),$(u).find(".edit").hide(),$(u).find(".childtext").hide(),$(u).find(".multi").removeClass("nodisplay"),0>=b.setmode?($(u).find("[name='multitext']").val(""),
0>b.setmode&&($(u).data("selectfilter",""),$(u).find("[name='selectfilter']").val(""))):(x=this.listRegions("selected",{mode:1,includejson:!1,includecomments:!1}).replace(/ *; */g,"\n"),$(u).find("[name='multitext']").val(x));else switch($(u).find("input:text[readonly]").css("border-color","A5A5A5").css("background","#E9E9E9"),c.pub.shape){case "box":case "cross":case "ellipse":$(u+".angle").removeClass("nodisplay");break;case "text":$(u+".textangle").removeClass("nodisplay");break;case "line":c.pub.pts&&
2===c.pub.pts.length?($(u+".linelength").removeClass("nodisplay"),$(u+".lineangle").removeClass("nodisplay")):($(u+".linelength").addClass("nodisplay"),$(u+".lineangle").addClass("nodisplay"))}$(u+".xtrareg").addClass("nodisplay");$(u+".xtracsv").addClass("nodisplay");$(u+".xtrasvg").addClass("nodisplay");$(u+".xtra"+a.globalOpts.regSaveFormat).removeClass("nodisplay");$(u).data("im",this);$(u).data("shape",c);$(u).data("winid",t);$(u).data("multi",n);a.BROWSER[3]?(t="touchstart",q="touchend"):(t=
"mouseover",q="mouseout");if("save"===b.type)$(u).on(t,function(){$(u).find("input[name='savefile']").focus()});$(u).data("tooltipInit")||($(u).data("tooltipInit",!0),$(".rconfigcol_R, .rsavecol_R").on(t,function(b){var c=b.currentTarget;b=$(c).find("input, textarea, span").data("tooltip");c=$(c).closest(a.lightOpts[a.LIGHTWIN].top).find(a.lightOpts[a.LIGHTWIN].dragBar);b&&c.length&&(m=$(c)[0].childNodes[0].nodeValue.replace(/:.*/,""),$(c)[0].childNodes[0].nodeValue=m+": "+b)}),$(".rconfigcol_R, .rsavecol_R").on(q,
function(b){b=$(b.currentTarget).closest(a.lightOpts[a.LIGHTWIN].top).find(a.lightOpts[a.LIGHTWIN].dragBar);b.length&&(m=$(b)[0].childNodes[0].nodeValue.replace(/:.*/,""),$(b)[0].childNodes[0].nodeValue=m)}))}}};a.Regions.processConfigForm=function(c,b,d){var e=1;var f={type:"multi",pub:{shape:"multi"},params:{}};var h=d.length,g={},k=this.raw.wcsinfo||{cdelt1:1,cdelt2:1},l=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)},m=function(a,b){return v?
!0:void 0===a?!1:l(a)!==l(b)},n=function(b,c,d){if("remove"===c)return"selected"===d;if("childtext"===c)return b.params.children&&0<b.params.children.length?!1:""!==d;if("strokeDashes"===c){if(b.strokeDashArray)return JSON.stringify(b.strokeDashArray)!==JSON.stringify(d);if($.isArray(d))switch(d.length){case 0:return!1;case 1:return""!==d[0];default:return""!==d[0]&&""!==d[1]}else return""!==d}if("tags"!==c&&""===d)return!1;if("misc"===c&&""!==d)return!0;if("angle"===c)return b.angle!==-parseFloat(d);
if("ix"===c)return b.pub.preservedcoords&&"d"===d.charAt(0).toLowerCase()?m(b.pub.dx,a.saostrtod(d.substring(1))):m(b.pub.x,a.saostrtod(d));if("iy"===c)return b.pub.preservedcoords&&"d"===d.charAt(0).toLowerCase()?m(b.pub.dy,a.saostrtod(d.substring(1))):m(b.pub.y,a.saostrtod(d));if("px"===c&&b.pub.lcs)return m(b.pub.lcs.x,a.saostrtod(d));if("py"===c&&b.pub.lcs)return m(b.pub.lcs.y,a.saostrtod(d));if("ra"===c)return b.pub.wcsconfig.wcsposstr?m(a.saostrtod(b.pub.wcsconfig.wcsposstr[0]),a.saostrtod(d)):
b.pub.wcsposstr?m(a.saostrtod(b.pub.wcsposstr[0]),a.saostrtod(d)):!1;if("dec"===c){if(b.pub.wcsconfig.wcsposstr)return m(a.saostrtod(b.pub.wcsconfig.wcsposstr[1]),a.saostrtod(d));if(b.pub.wcsposstr)return m(a.saostrtod(b.pub.wcsposstr[1]),a.saostrtod(d))}return"sticky"===c?v?!1:m(b.pub.sticky||!1,d):"listonchange"===c&&v?!1:b.pub.lcs&&void 0!==b.pub.lcs[c]?m(b.pub.lcs[c],d)?!0:!1:m(b.pub[c],d)||m(b.params[c],d)||m(b[c],d)?!0:!1},p=function(b){return"true"===b?!0:"false"===b?!1:a.isNumber(b)?parseFloat(b):
b},q=function(a){var b=String.fromCharCode(13,10);return(a||"").replace(/\\n/g,b)};this.lcs&&this.lcs.physical&&(e=Math.sqrt(Math.pow(this.lcs.physical.forward[0][0],2)+Math.pow(this.lcs.physical.forward[0][1],2)));if(b&&b.pub)var r=b.pub.wcsconfig&&b.pub.wcsconfig.wcssys?b.pub.wcsconfig.wcssys:this.params.wcssys;else r=this.params.wcssys,b=f;var v=$(c).data("multi");var w=b.pub.layer||"regions";for(f=0;f<h;f++){var t=d[f].name;var u=d[f].value;if("xpos"===t||"ypos"===t)switch(r){case "image":t="i"+
t.charAt(0);break;case "physical":t="p"+t.charAt(0);break;default:t=this.raw.wcs&&0<this.raw.wcs?"xpos"===t?"ra":"dec":"xpos"===t?"ix":"iy"}switch(t){case "multitext":case "colorPicker":case "savefile":case "rwcsbutton":case "savewcs":case "saveformat":case "includejson":case "includecomments":case "savewhich":case "savedcoords":break;case "text":"text"===b.type&&n(b,t,u)&&(g[t]=q(p(u)));break;case "selectfilter":u&&($(c).data("selectfilter",u),this.selectShapes(w,u));break;case "strokeDashes":var y=
u.trim().split(/\s+/);if(v&&u||n(b,t,y))g.strokeDashArray=0===y.length?[]:y.map(function(a){return parseInt(a,10)});break;case "strokeWidth":if(v&&u||!v&&n(b,t,y))g[t]=p(u);break;case "tags":v?u&&(g[t]='""'===u||"''"===u?"":p(u)):n(b,t,u)&&(g[t]=p(u));break;case "childtext":"text"!==b.type&&n(b,t,u)&&(g.text=q(p(u)));break;case "ix":n(b,t,u)&&(b.pub.preservedcoords&&"d"===u.charAt(0).toLowerCase()?(g.dx=p(u.substring(1)),void 0===g.dy&&void 0!==b.pub.dy&&(g.dy=b.pub.dy)):(g.x=p(u),void 0===g.y&&void 0!==
b.pub.y&&(g.y=b.pub.y)));break;case "iy":n(b,t,u)&&(b.pub.preservedcoords&&"d"===u.charAt(0).toLowerCase()?(g.dy=p(u.substring(1)),void 0===g.dx&&void 0!==b.pub.dx&&(g.dx=b.pub.dx)):(g.y=p(u),void 0===g.x&&void 0!==b.pub.x&&(g.x=b.pub.x)));break;case "px":n(b,t,u)&&(g.px=p(u),void 0===g.py&&b.pub.lcs&&(g.py=b.pub.lcs.y));break;case "py":n(b,t,u)&&(g.py=p(u),void 0===g.px&&b.pub.lcs&&(g.px=b.pub.lcs.x));break;case "ra":n(b,t,u)&&(g.ra=u,void 0===g.dec&&(b.pub.wcsconfig.wcsposstr?g.dec=b.pub.wcsconfig.wcsposstr[1]:
b.pub.wcsposstr&&(g.dec=b.pub.wcsposstr[1])));break;case "dec":n(b,t,u)&&(g.dec=u,void 0===g.ra&&(b.pub.wcsconfig.wcsposstr?g.ra=b.pub.wcsconfig.wcsposstr[0]:b.pub.wcsposstr&&(g.ra=b.pub.wcsposstr[0])),void 0===g.wcssys&&(g.wcssys=r));break;case "wcssys":break;case "radius":case "length":case "width":case "r1":switch(r){case "image":n(b,t,u)&&(g[t]=p(u));break;case "physical":n(b,t,u)&&(g[t]=p(u)*e);break;default:y=a.strtoscaled(u),u="."===y.dtype&&"galactic"!==r&&"ecliptic"!==r?y.dval:Math.abs(y.dval/
k.cdelt1),t=t.replace("wcs",""),n(b,t,u)&&(g[t]=p(u))}break;case "height":case "r2":switch(r){case "image":n(b,t,u)&&(g[t]=p(u));break;case "physical":n(b,t,u)&&(g[t]=p(u)*e);break;default:y=a.strtoscaled(u),u="."===y.dtype&&"galactic"!==r&&"ecliptic"!==r?y.dval:Math.abs(y.dval/k.cdelt2),t=t.replace("wcs",""),n(b,t,u)&&(g[t]=p(u))}break;case "radii":n(b,t,u)&&(g[t]=u);break;case "linelength":if(b.pub.pts&&2===b.pub.pts.length&&a.isNumber(u)&&u!==this.tmp.linelength){u=parseFloat(u);switch(r){case "image":case "physical":break;
default:void 0!==k.cdelt1?u/=Math.abs(k.cdelt1):void 0!==k.cdelt2&&(u/=Math.abs(k.cdelt2))}if(g.pts){t=g.pts[0];var x=g.pts[1]}else t=b.pub.pts[0],x=b.pub.pts[1];if(0<=$.inArray("line",a.Regions.opts.noCenteredScaling)){var B=Math.sqrt((t.x-x.x)*(t.x-x.x)+(t.y-x.y)*(t.y-x.y));var z=t.x-u*(t.x-x.x)/B;u=t.y-u*(t.y-x.y)/B;g.pts=[t,{x:z,y:u}]}else z={x:(t.x+x.x)/2,y:(t.y+x.y)/2},B=parseFloat(this.tmp.lineangle)||0,t.x=z.x-u/2,t.y=z.y,x.x=z.x+u/2,x.y=z.y,g.pts=[a.rotatePoint(t,B,z),a.rotatePoint(x,B,z)]}break;
case "lineangle":b.pub.pts&&2===b.pub.pts.length&&a.isNumber(u)&&u!==this.tmp.lineangle&&(B=parseFloat(u)-parseFloat(this.tmp.lineangle)||0,g.pts?(t=g.pts[0],x=g.pts[1]):(t=b.pub.pts[0],x=b.pub.pts[1]),0<=$.inArray("line",a.Regions.opts.noCenteredScaling)?g.pts=[t,a.rotatePoint(x,B,t)]:(z={x:(t.x+x.x)/2,y:(t.y+x.y)/2},g.pts=[a.rotatePoint(t,B,z),a.rotatePoint(x,B,z)]));break;case "remove":n(b,t,u)&&(v?g[t]="selected":void 0!==b.pub.id&&(g[t]=b.pub.id));break;case "misc":if(u.trim())try{var A=JSON.parse(u);
$.extend(g,A)}catch(C){a.error("invalid json: "+u)}break;default:n(b,t,u)&&(g[t]=p(u))}}0<Object.keys(g).length&&(v?this.changeShapes(w,"selected",g):this.changeShapes(w,b,g),this.initRegionsForm(b,{multi:v}))};a.Regions.pasteFromClipboard=function(c){var b,d=0,e=0;if(this){(b=a.CopyFromClipboard().trim())||a.error(a.CLIPBOARDERROR);if(b.match(/(annulus|box|circle|cross|ellipse|line|polygon|point|text) *\(/)){var f=a.globalOpts.regToClipboard;a.globalOpts.regToClipboard=!1;var h=this.addShapes("regions",
b,{rtn:"objs"});if(c){var g=h.length;for(c=0;c<g;c++)d+=h[c].pub.x,e+=h[c].pub.y;d/=g;e/=g;for(c=0;c<g;c++){var k=h[c].pub.x-d+this.ipos.x;var l=h[c].pub.y-e+this.ipos.y;this.changeShapes("regions",h[c].pub.id,{x:k,y:l})}}a.globalOpts.regToClipboard=f}else a.error(a.CLIPBOARDERROR2);return b}};a.Regions.listRegions=function(c,b,d){var e=this,f,h,g,k,l="";var m="none";var n=!1,p=[];var q={};var r=[],v=[],w=function(c,d){var f,g={},h=c.params,k=h.children,l=h.exports;for(f=0;f<l.length;f++){var m=l[f];
if(("text"!==m||"text"===c.type)&&"textOpts"!==m){if("strokeDashArray"===m&&c.strokeDashArray){var n=c.strokeDashArray.join("");if(""===n||n.match(/NaN/))continue}"id"===m&&b.file||"wcsconfig"===m&&b.file||"data"===m&&"object"===typeof h.data&&!1===h.data.doexport&&b.file||("strokeWidth"===m&&h.sw1?g[m]=h.sw1:void 0!==c[m]?g[m]=c[m]:void 0!==h[m]?g[m]=h[m]:d&&void 0!==d[m]&&(g[m]=d[m]))}}if(0<k.length&&k[0].obj.text){n=k[0].obj;g.text=n.text;g.textOpts=w(n);if(c.angle!==n.angle){if(g.textOpts.angle=
-n.angle,"circle"===c.params.shape||"annulus"===c.params.shape)n.params.hasTextOpts=!0}else 0===n.angle||"circle"!==c.params.shape&&"annulus"!==c.params.shape||(g.textOpts.angle=-n.angle,n.params.hasTextOpts=!0);if(n.params.parent.moved||n.params.hasTextOpts)n.pub.ra&&n.pub.dec?(y&&x&&y!==x?(n=e.wcs2wcs(y,x,n.pub.ra,n.pub.dec),n=n.trim().split(/\s+/),d=a.saostrtod(n[0]),a.isHMS(x)&&(d*=15),n=a.saostrtod(n[1])):(d=n.pub.ra,n=n.pub.dec),g.textOpts.ra=d,g.textOpts.dec=n):n.pub.lcs?(g.textOpts.px=n.pub.lcs.x,
g.textOpts.py=n.pub.lcs.y):(g.textOpts.x=n.pub.x,g.textOpts.y=n.pub.y);g.textOpts.color===c.stroke&&delete g.textOpts.color;g.textOpts.text&&delete g.textOpts.text;Object.keys(g.textOpts).length||delete g.textOpts}return g};b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(E){a.error("can't parse listRegions opts: "+b,E)}var t=b.mode;a.isNull(t)&&(t=3);d=d||"regions";if(this.getShapeLayer(d)){if(b.wcssys||b.wcsunits){var u=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;if(b.wcssys){var y=
this.getWCSSys();this.setWCSSys(b.wcssys,!1);var x=this.getWCSSys()}if(b.wcsunits){var B=this.getWCSUnits();this.setWCSUnits(b.wcsunits,!1)}this.updateShapes(d,c,"export")}a.isNull(b.includedcoords)&&(b.includedcoords=a.globalOpts.regListDCoords);p=this.getShapes(d,c,{includeObj:!0});var z=p.length;if(t)for(f=0;f<z;f++){var A=p[f];if((h=A.tags.join(","))&&"source,include"!==h&&"include,source"!==h){n=!0;break}}for(C in a.Regions.opts.tagcolors)a.Regions.opts.tagcolors.hasOwnProperty(C)&&v.push(a.Regions.opts.tagcolors[C]);
for(f=0;f<z;f++)if(A=p[f],q=A.obj,r=[],!A.sticky||!1!==b.sticky)if(!A.preservedcoords||b.includedcoords)if($.isArray(q.params.preservedcoords)){for(h=0;h<q.params.preservedcoords.length;h++){var C=q.params.preservedcoords[h];switch(C){case "pts":0>$.inArray("dx",r)&&r.push("dx");0>$.inArray("dy",r)&&r.push("dy");0>$.inArray("points",r)&&r.push("points");break;default:r.push(C)}}"none"!==m&&(l+="; ");"image"!==m&&(l+="image",l+="; ");l+=A.shape+"({";for(k=h=0;h<r.length;h++)if(C=r[h],"shape"!==C&&
"sticky"!==C&&"wcsconfig"!==C){"pts"===C&&(C="dx",q.params.preservedcoords.push("dy"),q.params.preservedcoords.push("points"));if("preservedcoords"===C)m=!0;else if(a.notNull(A[C]))m=A[C];else if(a.notNull(q[C]))m=q[C];else switch(C){case "dx":m=q.left;break;case "dy":m=q.top;break;case "color":m=q.stroke;break;default:m=null}if(m)switch(0<k++&&(l+=","),l+='"'+C+'":',typeof m){case "string":l+='"'+m+'"';break;case "object":try{l+=JSON.stringify(m)}catch(E){a.error("can't parse: "+m,E)}break;default:l+=
""+m}}l+="})";m="image"}else h=A.tags.join(","),C=h.includes("exclude")?"-":"",q=w(q,A),b.saveid&&(q.id=A.id),b.savewcsconfig&&A.wcsconfig&&0<Object.keys(A.wcsconfig).length&&(q.wcsconfig=$.extend(!0,{},A.wcsconfig)),A.color&&!v.includes(A.color)&&(q.color=A.color),n&&(g=" # "+h),A.wcsstr&&a.isWCS(this.params.wcssys)?("wcs"!==m&&("none"!==m&&(l+="; "),l=A.wcssys?l+A.wcssys:l+this.params.wcssys,m="wcs"),l+="; "+C+A.wcsstr):A.imstr&&(m!==A.imsys&&("none"!==m&&(l+="; "),l+=A.imsys,m=A.imsys),l+="; "+
C+A.imstr),!1!==b.includejson&&1===t%2&&0<Object.keys(q).length&&("line"===A.shape&&(l=l.replace(/ *{[^{}]*}$/,"")),l+=" "+JSON.stringify(q)),g&&(l+=g);!1===b.includecomments&&(l=l.replace(/ *#[^;]*/g,""));if(y||B)y&&this.setWCSSys(y,!1),B&&this.setWCSUnits(B,!1),this.updateShapes(d,c,"export"),a.globalOpts.xeqPlugins=u;1<t&&this.display.displayMessage("regions",l);return l}};a.Regions.copyRegions=function(a,b){return this.copyShapes("regions",a,b)};a.Regions.parseRegions=function(c,b){var d=this,
e,f,h=[],g=/^-?(annulus|box|circle|cross|ellipse|line|polygon|point|text)$/,k=/^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/,l=/^(image|physical)$/,m=/[dr:]/,n=/\(\s*([^)]+?)\s*\)/,p=/(\{.*\})/,q=/\s*,\s*/,r=/#(?![a-zA-Z0-9]{6}['"])/,v=function(a){return"0"===a||"false"===a.toLowerCase()?!1:!0},w=function(a){for(var b,c,d,e={},f=/([a-zA-Z][a-zA-Z0-9_]*)\s*=\s*(\d+(\s*\d+)*|[^ '"{]+|['"{][^'"}]*['"}])/g,g={color:function(a){return{color:a}},dash:function(a){if(a)return{strokeDashArray:[3,
1]}},dashlist:function(a){if(a){var b=a.split(" ");for(a=0;a<b.length;a++)b[a]=parseFloat(b[a]);return{strokeDashArray:b}}},delete:function(a){return{removable:v(a)}},edit:function(a){return{selectable:v(a)}},fixed:function(a){return{zoomable:!v(a)}},font:function(a){var b={};a=a.split(" ");var c=a.length;1<=c&&(b.fontFamily=a[0]);2<=c&&(b.fontSize=parseFloat(a[1]));3<=c&&(b.fontStyle=a[2]);4<=c&&(b.fontWeight=a[3]);return b},highlite:function(a){return{hasControls:v(a),hasBorders:v(a),hasRotatingPoint:v(a)}},
move:function(a){return{movable:v(a)}},rotate:function(a){return{rotatable:v(a)}},resize:function(a){return{resizable:v(a)}},changeable:function(a){return{changeable:v(a)}},select:function(a){return{selectable:v(a)}},text:function(a){return{text:a}},tag:function(a){return{tags:a}},width:function(a){return{strokeWidth:parseFloat(a)}}};null!==(b=f.exec(a));)if(c=b[1].toLowerCase(),b=b[2].replace(/^['"{]|['"}]$/g,""),g.hasOwnProperty(c)&&"function"===typeof g[c])for(d in c=g[c](b),c)c.hasOwnProperty(d)&&
("tags"===d&&e.hasOwnProperty(d)?e[d]+=","+c[d]:e[d]=c[d]);else e[c]=b;if(a=a.replace(f,""))e._comment=a.trim();return e},t=function(b){var c,d={opts:{},args:[],isregion:0};b.includes("(")?d.cmd=b.split("(")[0].trim().toLowerCase():b.includes("{")?d.cmd=b.split("{")[0].trim().toLowerCase():b.includes("#")?d.cmd=b.split("#")[0].trim().toLowerCase():d.cmd=b.trim().toLowerCase();d.cmd&&(d.isregion=0<=d.cmd.search(g));var e=b.trim().split(r);if((c=p.exec(e[0]))&&c[0])try{d.opts=JSON.parse(c[0].trim())}catch(M){a.error("can't parse opts: "+
c[0],M)}d.comment=e[1];if(d.comment){var f=w(d.comment.trim());void 0!==f._comment&&(d.comment=f._comment,delete f._comment)}f&&(d.opts=$.extend({},f,d.opts));(c=n.exec(b))&&c[0].match(p)?d.args=[]:c&&c[1]&&(d.args=c[1].split(q));d.isregion&&d.cmd.startsWith("-")&&(d.cmd=d.cmd.slice(1),d.comment?d.comment.match(/exclude/)||(d.comment+=",exclude"):d.comment="exclude");return d},u=function(b,c){var e={};if("d"===b.charAt(0).toLowerCase()&&"d"===c.charAt(0).toLowerCase())return e.dx=parseFloat(b.substring(1)),
e.dy=parseFloat(c.substring(1)),e;b=a.strtoscaled(b);c=a.strtoscaled(c);!b.dtype.match(m)&&!c.dtype.match(m)||z||x.match(l)||(C=!0,B=x);if(z||C)return a.isHMS(B,b.dtype)&&(b.dval*=15),"r"===b.dtype&&(b.dval=180*b.dval/Math.PI),"r"===c.dtype&&(c.dval=180*c.dval/Math.PI),c=a.wcs2pix(d.raw.wcs,b.dval,c.dval).split(/ +/),e.x=parseFloat(c[0]),e.y=parseFloat(c[1]),e;if("physical"===B)return c=d.logicalToImagePos({x:b.dval,y:c.dval}),e.x=c.x,e.y=c.y,e;e.x=b.dval;e.y=c.dval;return e},y=function(b,c){b=a.strtoscaled(b);
var e=d.raw.wcsinfo||{cdelt1:1,cdelt2:1};!b.dtype.match(m)||z||x.match(l)||(C=!0,B=x);z||C?("r"===b.dtype&&(b.dval=180*b.dval/Math.PI),b.dval=Math.abs(b.dval/e["cdelt"+c])):"physical"===B&&d.lcs&&d.lcs.physical&&(c=Math.sqrt(Math.pow(d.lcs.physical.forward[0][0],2)+Math.pow(d.lcs.physical.forward[0][1],2)),b.dval=Math.abs(b.dval*c));return b.dval};c=c.trim();if(!c.match(/(\(|\{|#|;|\n)/))return c;var x=this.getWCSSys();b=this.getWCSUnits();var B="physical";var z=a.isWCS(B);var A=c.split(/\n|;/);for(c=
0;c<A.length;c++)if("#"!==A[c].trim().substr(0,1)){var C=!1;var E=t(A[c]);var D=E.args.length;if(E.isregion){var F=$.extend(!0,{},E.opts);F.shape=E.cmd;F.wcsconfig=F.wcsconfig||{wcssys:B};2<=D&&"line"!==F.shape&&"polygon"!==F.shape&&$.extend(F,u(E.args[0],E.args[1]));F.textOpts&&void 0!==F.textOpts.ra&&void 0!==F.textOpts.dec&&(F.textOpts._wcssys=B);switch(E.cmd){case "annulus":if(0<D)for(F.radii=[],e=2;e<D;e++)F.radii.push(y(E.args[e],1));break;case "box":case "cross":3<=D&&(F.width=y(E.args[2],
1));4<=D&&(F.height=y(E.args[3],2));5<=D&&(F.angle=a.strtoscaled(E.args[4]).dval);break;case "circle":3<=D&&(F.radius=y(E.args[2],1));break;case "ellipse":3<=D&&(F.r1=y(E.args[2],1));4<=D&&(F.r2=y(E.args[3],2));5<=D&&(F.angle=a.strtoscaled(E.args[4]).dval);break;case "line":case "polygon":if(0<D)for(F.pts=[],f=e=0;e<D;e+=2,f++){var G=u(E.args[e],E.args[e+1]);a.notNull(G.dx)&&a.notNull(G.dy)?F.pts[f]={dx:G.dx,dy:G.dy}:F.pts[f]={x:G.x,y:G.y}}break;case "text":3<=D&&(F.text=E.args[2].replace(/^['"]/,
"").replace(/["']$/,"")),4<=D&&(F.angle=a.strtoscaled(E.args[3]).dval)}E.comment&&(F.tags=E.comment);h.push(F)}else E.cmd.match(k)?(e=a.globalOpts.xeqPlugins,a.globalOpts.xeqPlugins=!1,this.setWCSSys(E.cmd,!1),a.globalOpts.xeqPlugins=e,B=this.getWCSSys(),z=a.isWCS(B)):"remove"!==E.cmd&&"delete"!==E.cmd||h.push({remove:!0})}e=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.setWCSSys(x,!1);this.setWCSUnits(b);a.globalOpts.xeqPlugins=e;return h};a.Regions.saveRegions=function(c,b,d){var e,f,
h;c&&(f=c.match(/\.([^.]*)$/))&&f[1]&&f[1].match(/^(reg|svg|csv)$/)&&(e=f[1]);if("object"===typeof d){var g=d;d=null}else if(d&&"string"===typeof d){try{g=JSON.parse(d)}catch(p){g=null}g&&(d=null)}g&&(a.notNull(g.layer)&&(d=g.layer),a.notNull(g.type)&&(e=g.type),a.notNull(g.format)&&(e=g.format));g=g||{};d=d||"regions";e=e||"reg";this.layers[d]||a.error("can't find layer for saveRegions: "+d);c||(c=d&&"regions"!==d?"js9_"+d+"."+e:"js9."+e);switch(e){case "svg":try{a.globalOpts.svgBorder&&(h=this.addShapes(d,
"box",{left:this.rgb.img.width/2,top:this.rgb.img.height/2,width:this.rgb.img.width,height:this.rgb.img.height,color:"black",strokeWidth:1,tags:"SVGBorder"}));var k=this.layers[d].dlayer.canvas.toSVG();a.globalOpts.svgBorder&&this.removeShapes(d,h)}catch(p){a.error("can't convert layer to SVG: "+d)}break;case "csv":try{g.mode=1;g.file=c;a.isNull(g.includewcs)&&(g.includewcs=a.globalOpts.csvIncludeWCS);a.isNull(g.savedcoords)&&(g.includedcoords=a.globalOpts.regSaveDCoords);var l=this.listRegions(b,
g,d);f=l.split(";");var m=0;for(k="";m<f.length;m++)if(f[m])if(f[m].toLowerCase().match(a.WCSEXP))g.includewcs&&(k+=f[m].trim()+"\n");else{var n=f[m].replace(/\(/,",").replace(/\).*/,"").trim();k+=n+"\n"}}catch(p){a.error("can't convert layer to region: "+d)}break;default:try{g.mode=1,g.file=c,a.isNull(g.includejson)&&(g.includejson=a.globalOpts.regIncludeJSON),a.isNull(g.includecomments)&&(g.includecomments=a.globalOpts.regIncludeComments),a.isNull(g.savedcoords)&&(g.includedcoords=a.globalOpts.regSaveDCoords),
l=this.listRegions(b,g,d).replace(/; */g,"\n"),k=!1!==g.includecomments?"# Region file format: JS9 version 1.0\n"+l+"\n":l+"\n"}catch(p){a.error("can't convert layer to region: "+d)}}b=new Blob([k],{type:"text/plain;charset=utf-8"});window.hasOwnProperty("saveAs")?a.saveAs(b,c):a.error("no saveAs() available to save region file");return this.tmp.saveregionsFile=c};a.Regions.unremoveRegions=function(){var a=this.regstack.pop();return a?this.addShapes("regions",a):null};a.Regions.changeRegionTags=function(a,
b,d){var c;a=a||"all";b=b||[];d=d||[];$.isArray(b)||(b=b.split(",").map(function(a){return a.trim()}));$.isArray(d)||(d=d.split(",").map(function(a){return a.trim()}));var f=this.getShapes("regions",a);for(a=0;a<f.length;a++){var h=f[a].tags;var g=[];for(c=0;c<b.length;c++)0>$.inArray(b[c],h)&&g.push(b[c]);for(c=0;c<h.length;c++)0>$.inArray(h[c],d)&&g.push(h[c]);this.changeShapes("regions",f[a].id,{tags:g})}};a.Regions.toggleRegionTags=function(a,b,d){var c;var f=this.getShapes("regions",a||"all");
for(a=0;a<f.length;a++){var h=f[a].tags;var g="";for(c=0;c<h.length;c++)if(h[c]===b){g=h[c]=d;break}else if(h[c]===d){g=h[c]=b;break}g&&this.changeShapes("regions",f[a].id,{tags:h})}};a.Plot={};a.Plot.CLASS="JS9";a.Plot.NAME="Plot";a.Plot.opts={annotate:!1,annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},yaxis:{autorange:!0},title:"Plot Configuration",
configURL:"./params/plotconfig.html"};a.Plot.logfunc=function(a){return 0===a?0:Math.log(a)};a.Plot.expfunc=function(a){return 0===a?0:Math.exp(a)};a.Plot.rescale=function(c,b,d,e,f,h,g){switch(a.globalOpts.plotLibrary){case "flot":switch(e){case "x":var k=b.getAxes().xaxis;break;case "y":k=b.getAxes().yaxis}switch(f){case "linear":k.options.transform=null;k.options.inverseTransform=null;d.curscale[e]=f;break;case "log":k.options.transform=a.Plot.logfunc,k.options.inverseTransform=a.Plot.expfunc,
d.curscale[e]=f}a.isNumber(h)?k.options.min=Number.parseFloat(h):""==h&&(k.options.min=null);a.isNumber(g)?k.options.max=Number.parseFloat(g):""==g&&(k.options.max=null);b.setupGrid();b.draw();break;case "plotly":switch(e){case "x":var l={xaxis:{type:f,autorange:!0}};d.curscale[e]=f;break;case "y":l={yaxis:{type:f,autorange:!0}},d.curscale[e]=f}Plotly.restyle(c.attr("id"),l)}};a.Plot.annotate=function(c,b,d){var e;var f=[];var h=d.data,g=d.annotations.color||a.Plot.opts.annotateColor,k=function(a,
b){if(!a.text)return null;var c=a.x||0;if("%Y"===a.y.toUpperCase())for(a=1;a<b.length-1;a++){if(b[a][0]>c){var d=Math.max(b[a-1][1],b[a][1],b[a+1][1]);break}}else d=a.y;return{x:c,y:d}};switch(a.globalOpts.plotLibrary){case "flot":var l=-25;c.find(".plotAnnotation").remove();for(e=0;e<d.annotations.data.length;e++){var m=d.annotations.data[e];var n=k(m,h);f=b.pointOffset({x:n.x,y:n.y});0>f.left||f.left>c.width()||(m=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",
f.left,f.top+l,g,"&darr;"+m.text),c.append(m))}break;case "plotly":l=-30;for(e=0;e<d.annotations.data.length;e++)if(m=d.annotations.data[e],n=k(m,h))c={x:n.x,y:n.y,xref:"x",yref:"y",text:m.text,arrowcolor:g,font:{color:g},showarrow:!0,arrowhead:2,ax:0,ay:l},f.push(c);return f}};a.Plot.initConfigForm=function(c,b){var d,e;var f=c.winid;var h="#"+$(f).attr("id")+" #plotConfigForm ";var g=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(100*(a+.001))/100),String(a)};c&&b&&
"flot"===a.globalOpts.plotLibrary&&($(h+".val").each(function(f,h){d="";e=$(h).attr("name");switch(e){case "xscale":a.notNull(b.curscale.x)&&(d=g(b.curscale.x));break;case "xmin":a.notNull(c.getAxes().xaxis.options.min)&&(d=g(c.getAxes().xaxis.options.min));break;case "xmax":a.notNull(c.getAxes().xaxis.options.max)&&(d=g(c.getAxes().xaxis.options.max));break;case "yscale":a.notNull(b.curscale.y)&&(d=g(b.curscale.y));break;case "ymin":a.notNull(c.getAxes().yaxis.options.min)&&(d=g(c.getAxes().yaxis.options.min));
break;case "ymax":a.notNull(c.getAxes().yaxis.options.max)&&(d=g(c.getAxes().yaxis.options.max))}$(h).val(d)}),$(h).data("im",this),$(h).data("plot",c),$(h).data("pobj",b),$(h).data("winid",f),$(h).data("tooltipInit")||($(h).data("tooltipInit",!0),a.BROWSER[3]?(f="touchstart",h="touchend"):(f="mouseover",h="mouseout"),$(".plotcol_P").on(f,function(b){var c=b.currentTarget;b=$(c).find("input").data("tooltip");c=$(c).closest(a.lightOpts[a.LIGHTWIN].top).find(a.lightOpts[a.LIGHTWIN].dragBar);b&&c.length&&
(b=a.Plot.opts.title+": "+b,$(c)[0].childNodes[0].nodeValue=b)}),$(".plotcol_P").on(h,function(b){b=$(b.currentTarget).closest(a.lightOpts[a.LIGHTWIN].top).find(a.lightOpts[a.LIGHTWIN].dragBar);b.length&&($(b)[0].childNodes[0].nodeValue=a.Plot.opts.title)})))};a.Plot.processConfigForm=function(c,b,d,e){var f=e.length;switch(a.globalOpts.plotLibrary){case "plotly":return}for(c=0;c<f;c++){var h=e[c].name;var g=e[c].value;switch(h){case "xscale":""===g&&(g="linear");a.Plot.rescale(null,b,d,"x",g);break;
case "xmin":a.Plot.rescale(null,b,d,"x",null,g,null);break;case "xmax":a.Plot.rescale(null,b,d,"x",null,null,g);break;case "yscale":""===g&&(g="linear");a.Plot.rescale(null,b,d,"y",g);break;case "ymin":a.Plot.rescale(null,b,d,"y",null,g,null);break;case "ymax":a.Plot.rescale(null,b,d,"y",null,null,g)}}a.Plot.initConfigForm.call(this,b,d)};a.plotOpts=a.Plot.opts;a.Catalogs={};a.Catalogs.CLASS="JS9";a.Catalogs.NAME="Catalogs";a.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,
lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"},sortOverlapping:!1};a.Crosshair={};a.Crosshair.CLASS="JS9";a.Crosshair.NAME="Crosshair";a.Crosshair.LAYERNAME="crosshair";a.Crosshair.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,
lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!1,arrowSize:14,strokeWidth:1,color:"#00FF00",sortOverlapping:!1,hiddenPts:{pts:[{x:-9999,y:-9999},{x:-9999,y:-9900}]}};a.Crosshair.display=function(c,b,d){var e=a.Crosshair.LAYERNAME;d=/iPad|iPhone|iPod/.test(navigator.platform)?!0:d.shiftKey;if(c.tmp.arrowCrosshair||d&&c&&!c.tmp.shiftKey&&c.crosshair&&c.params.crosshair){if(c.tmp.arrowCrosshair&&!c.params.crosshair){var f=a.Crosshair.opts.arrowSize/c.rgb.sect.zoom;
d=b.x-f;var h=b.x+f;var g=b.y-f;var k=b.y+f}else d=0,h=c.raw.width,g=0,k=c.raw.height;h={pts:[{x:d,y:b.y},{x:h,y:b.y}],redraw:!1};c.changeShapes(e,c.crosshair.h,h);d={pts:[{x:b.x,y:g},{x:b.x,y:k}],redraw:!0};c.changeShapes(e,c.crosshair.v,d);c.crosshair.visible=!0;if(a.globalOpts.wcsCrosshair&&c&&c.raw.wcs&&0<c.raw.wcs){g=a.pix2wcs(c.raw.wcs,b.x,b.y).trim().split(/\s+/);var l=a.saostrtod(g[0]);a.isHMS(c.params.wcssys)&&(l*=15);var m=a.saostrtod(g[1]);for(b=0;b<a.displays.length;b++)if((f=a.displays[b].image)&&
f!==c&&f.crosshair&&f.params.crosshair&&0<f.raw.wcs){h=f.raw.width;k=f.raw.height;try{var n=a.wcs2pix(f.raw.wcs,l,m)}catch(p){n=null}n&&(g=n.trim().split(/\s+/),d=parseFloat(g[0]),g=parseFloat(g[1]),0<d&&d<h&&0<g&&g<k&&(h={pts:[{x:0,y:g},{x:h,y:g}],redraw:!1},f.changeShapes(e,f.crosshair.h,h),d={pts:[{x:d,y:0},{x:d,y:k}],redraw:!0},f.changeShapes(e,f.crosshair.v,d),f.crosshair.visible=!0))}}}};a.Crosshair.hide=function(c,b,d){b=a.Crosshair.LAYERNAME;d=a.Crosshair.opts.hiddenPts;if(c&&c.crosshair&&
c.crosshair.visible||c.tmp.arrowCrosshairVisible)c.changeShapes(b,c.crosshair.h,d),c.changeShapes(b,c.crosshair.v,d),c.crosshair.visible=!1,delete c.tmp.arrowCrosshairVisible};a.Crosshair.create=function(c){var b=a.Crosshair.opts.hiddenPts,d=a.Crosshair.LAYERNAME;c&&!c.crosshair&&(c.crosshair={},c.crosshair.h=c.addShapes(d,"line",b),c.crosshair.v=c.addShapes(d,"line",b),c.crosshair.visible=!1)};a.Crosshair.keyaction=function(a,b,d){a&&d&&d.shiftKey&&(a.tmp.shiftKey=!0)};a.Crosshair.keyup=function(a,
b,d){a&&a.tmp.shiftKey&&d&&!d.shiftKey&&delete a.tmp.shiftKey};a.Crosshair.init=function(){var c,b=a.Crosshair.LAYERNAME;for(c=0;c<a.displays.length;c++)a.displays[c].layers.crosshair||a.displays[c].newShapeLayer(b,a.Crosshair.opts);return this};a.Image.prototype.toggleCrosshair=function(){this.params.crosshair=!this.params.crosshair;this.params.crosshair||a.Crosshair.hide(this)};a.Image.prototype.toggleWCSCrosshair=function(){a.globalOpts.wcsCrosshair=!a.globalOpts.wcsCrosshair};a.Grid={};a.Grid.CLASS=
"JS9";a.Grid.NAME="Grid";a.Grid.LAYERNAME="grid";a.Grid.opts={movable:!1,cover:"display",reduceDims:!0,strokeWidth:1,margin:0,labelMargin:10,stride:32,raLines:8,raSkip:0,raAngle:0,decLines:8,decSkip:0,decAngle:90,sexaPrec:1,degPrec:3,lineColor:"#00FFFF",labelColor:"#00FFFF",labelFontFamily:"Helvetica, sans-serif",labelFontSize:11,labelFontStyle:"normal",labelFontWeight:300,labelRAOffx:3,labelRAOffy:-1,labelDecOffx:-14,labelDecOffy:6};a.Grid.limits=function(a,b,d,e){a=d-b;a=1<a?10:.1<a?100:.01<a?1E3:
.001<a?1E4:1E-4<a?1E5:1E6;b=Math.floor(b*a)/a;d=Math.ceil(d*a)/a;return{lo:b,hi:d,inc:Math.ceil((d-b)/e*a)/a}};a.Grid.getLabel=function(c,b,d){var e,f=!1;switch(c.wcsunits){case "sexagesimal":"ra"===d&&"galactic"!==c.wcssys&&"ecliptic"!==c.wcssys&&(b/=15);b=a.saodtostr(b,":",c.sexaPrec);var h=b.split(":");if(c.last[d])for(b="",e=0;e<h.length;e++)if(b&&(b+=":"),f||h[e]!==c.last[d][e])b+=h[e],f=!0;c.last[d]=$.extend({},h);break;default:b=b.toFixed(c.degPrec)}b=b.replace(/0+$/,"");c=b.indexOf(".");0>
c?b+=".0":c===b.length-1&&(b+="0");return b=b.replace(/:\.0/,":0.0")};a.Grid.display=function(c,b){var d,e,f,h;var g=this.display;var k=this.raw;var l=[{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0}];if(a.isNull(c))switch(this.tmp.gridStatus){case "inactive":case void 0:return!1;case "active":case "processing":return!0;default:return!0}this.removeShapes(a.Grid.LAYERNAME);if(!1===c||!this.raw.wcs||0>=this.raw.wcs)this.tmp.gridStatus="inactive";else{b=b||{};if("string"===typeof b)try{b=JSON.parse(b)}catch(C){a.error("can't parse displayCoordGrid JSON",
C)}this.tmp.gridStatus="processing";c=$.extend(!0,{},a.Grid.opts,b);c.wcsunits=this.getWCSUnits();c.wcssys=this.getWCSSys();c.last={};a.wcsunits(this.raw.wcs,"degrees");if("image"===c.cover){var m=[Math.max(1,Math.floor(k.width/g.width)),Math.max(1,Math.floor(k.height/g.height))];b=[{x:0,y:0},{x:k.width-1,y:k.height-1}]}else{m=c.reduceDims?k.width<k.height?[k.width/k.height,1]:k.height<k.width?[1,k.height/k.width]:[1,1]:[1,1];b=[];var n={x:this.ix+c.margin,y:this.iy-c.margin};var p=this.displayToImagePos(n);
b[0]={x:p.x,y:p.y};n={x:g.width-1-this.ix-c.margin,y:g.height-1-this.iy-c.margin};p=this.displayToImagePos(n);b[1]={x:p.x,y:p.y}}var q=a.pix2wcs(k.wcs,b[0].x,b[0].y).trim().split(/\s+/);l[0].ra=a.saostrtod(q[0]);l[0].dec=a.saostrtod(q[1]);q=a.pix2wcs(k.wcs,b[0].x,b[1].y).trim().split(/\s+/);l[1].ra=a.saostrtod(q[0]);l[1].dec=a.saostrtod(q[1]);q=a.pix2wcs(k.wcs,b[1].x,b[0].y).trim().split(/\s+/);l[2].ra=a.saostrtod(q[0]);l[2].dec=a.saostrtod(q[1]);q=a.pix2wcs(k.wcs,b[1].x,b[1].y).trim().split(/\s+/);
l[3].ra=a.saostrtod(q[0]);l[3].dec=a.saostrtod(q[1]);g=l[0].ra;p=l[0].dec;b=l[0].ra;var r=l[0].dec;for(q=1;4>q;q++)g=Math.min(g,l[q].ra),p=Math.min(p,l[q].dec),b=Math.max(b,l[q].ra),r=Math.max(r,l[q].dec);q=a.Grid.limits.call(this,c,g,b,c.raLines*m[0]);g=q.lo;b=q.hi;l=q.inc;q=a.Grid.limits.call(this,c,p,r,c.decLines*m[1]);p=q.lo;r=q.hi;var v=q.inc;a.wcsunits(this.raw.wcs,c.wcsunits);var w=Math.abs(this.raw.wcsinfo.cdelt1);var t=w*a.Grid.opts.stride;var u=b-t;var y=Math.abs(this.raw.wcsinfo.cdelt2);
var x=y*a.Grid.opts.stride;var B=r-x;q="image;";for(f=g;f<=b;f+=l){var z="line(";var A=y;n=e=0;for(h=p;h<=r;h+=A)(d=a.wcs2pix(k.wcs,f,h).trim().split(/ +/))&&d.length&&(m=parseFloat(d[0]),d=parseFloat(d[1]),m>=-c.margin&&m<=k.width+c.margin&&d>=-c.margin&&d<=k.height+c.margin?(z+=String(m+1+","+d+1+", "),n++,0===e?(e=1,h<B&&(A=x)):1===e&&h>B&&(e=2,A=y)):1===e&&(e=2,h-=A,A=y));1<n&&(q+=z.replace(/,\s+$/,") "),q+=' {"color": "'+c.lineColor+'"};')}for(h=p;h<=r;h+=v){z="line(";A=w;n=e=0;for(f=g;f<=b;f+=
A)(d=a.wcs2pix(k.wcs,f,h).trim().split(/ +/))&&d.length&&(m=parseFloat(d[0]),d=parseFloat(d[1]),m>=-c.margin&&m<=k.width+c.margin&&d>=-c.margin&&d<=k.height+c.margin?(z+=String(m+1+","+d+1+", "),n++,0===e?(e=1,f<u&&(A=t)):1===e&&f>u&&(e=2,A=w)):1===e&&(e=2,f-=A,A=w));1<n&&(q+=z.replace(/,\s+$/,") "),q+=' {"color": "'+c.lineColor+'"};')}e=c.labelDecOffx/this.rgb.sect.zoom;A=c.labelDecOffy/this.rgb.sect.zoom;w=0;f=t=g;for(z=0;f<=b;f+=l){for(h=p;h<=r;h+=v)(d=a.wcs2pix(k.wcs,f,h).trim().split(/ +/))&&
d.length&&(m=parseFloat(d[0]),d=parseFloat(d[1]),n=this.imageToDisplayPos({x:m,y:d}),n.x>this.ix+c.labelMargin&&n.x<this.rgb.img.width+this.ix-c.labelMargin&&n.y>this.iy+c.labelMargin&&n.y<this.rgb.img.height+this.iy-c.labelMargin&&(w>=c.decSkip?(q+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',m+e,d+A,a.Grid.getLabel.call(this,c,h,"dec"),c.decAngle,c.labelColor,c.labelFontFamily,c.labelFontSize,
c.labelFontStyle,c.labelFontWeight),z++):(f!==t&&w++,t=f)));if(z)break}e=c.labelRAOffx/this.rgb.sect.zoom;A=c.labelRAOffy/this.rgb.sect.zoom;w=0;h=t=p;for(z=0;h<=r;h+=v){for(f=g;f<=b;f+=l)(d=a.wcs2pix(k.wcs,f,h).trim().split(/ +/))&&d.length&&(m=parseFloat(d[0]),d=parseFloat(d[1]),n=this.imageToDisplayPos({x:m,y:d}),n.x>this.ix+c.labelMargin&&n.x<this.rgb.img.width+this.ix-c.labelMargin&&n.y>this.iy+c.labelMargin&&n.y<this.rgb.img.height+this.iy-c.labelMargin&&(w>=c.raSkip?(q+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',
m+e,d+A,a.Grid.getLabel.call(this,c,f,"ra"),c.raAngle,c.labelColor,c.labelFontFamily,c.labelFontSize,c.labelFontStyle,c.labelFontWeight),z++):(h!==t&&w++,t=h)));if(z)break}this.addShapes(a.Grid.LAYERNAME,q,c);this.tmp.gridStatus="active"}};a.Grid.toggle=function(a){if(a)switch(a.tmp.gridStatus){case void 0:case null:case "inactive":a.displayCoordGrid(!0);break;case "active":a.displayCoordGrid(!1)}};a.Grid.regrid=function(a){a&&"active"===a.tmp.gridStatus&&"complete"===a.status.load&&a.displayCoordGrid(!0)};
a.Grid.init=function(c){c=$.extend(!0,{},a.Catalogs.opts,a.Grid.opts,c);this.display.newShapeLayer(a.Grid.LAYERNAME,c).canvas.on("mouse:up",function(){return!1})};a.Image.prototype.displayCoordGrid=a.Grid.display;a.isImage=function(c){return"object"===typeof c&&a.notNull(c.id)&&a.notNull(c.raw)&&a.notNull(c.rgb)&&a.notNull(c.params)&&a.notNull(c.display)||"string"===typeof c&&a.lookupImage(c)?!0:!1};a.Dysel={};a.Dysel.CLASS="JS9";a.Dysel.NAME="Dysel";a.Dysel.display=null;a.Dysel.plugins=[];a.Dysel.init=
function(a){};a.Dysel.unhighlightSelection=function(){a.bugs.webkit_resize?$(".JS9").find(".JS9Image").removeClass("JS9Highlight"):$(".JS9").removeClass("JS9Highlight")};a.Dysel.highlightSelection=function(c){c&&a.Dysel.retrievePlugins().length&&1!==a.displays.length&&(a.Dysel.unhighlightSelection(),c=c.display,a.bugs.webkit_resize?$(c.divjq).find(".JS9Image").addClass("JS9Highlight"):$(c.divjq).addClass("JS9Highlight"))};a.Dysel.addPlugins=function(c){a.Dysel.plugins.push(c)};a.Dysel.retrievePlugins=
function(){return a.Dysel.plugins};a.Dysel.getDisplay=function(c){return a.Dysel.retrievePlugins().length?"previous"===c?a.Dysel.odisplay:a.Dysel.display:null};a.Dysel.getDisplayOr=function(c){return"previous"===c?a.Dysel.getDisplay(c):a.Dysel.getDisplay()||c};a.Dysel.select=function(c){c&&a.Dysel.retrievePlugins().length&&(a.Dysel.odisplay=a.Dysel.display,a.Dysel.display=c,c.image&&(a.Dysel.highlightSelection(c.image),c.image.xeqPlugins("image","ondynamicselect",null)))};a.Dysel.imageload=function(c){c&&
a.Dysel.select(c.display)};a.Dysel.imageclose=function(c){var b,d;if(c&&(d=a.Dysel.getDisplay())&&d.image===c){for(d=b=0;b<a.images.length;b++)c.display===a.images[b].display&&d++;if(1>=d)for(b=0;b<a.displays.length;b++)if(d=a.displays[b],c.display!==d&&d.image){a.Dysel.select(a.displays[b]);break}}};a.getDynamicDisplayOr=a.Dysel.getDisplayOr;a.Titlebar={};a.Titlebar.CLASS="JS9";a.Titlebar.NAME="Titlebar";a.Titlebar.init=function(c){a.Titlebar.title||(a.Titlebar.title=document.title)};a.Titlebar.imageload=
function(c){c&&a.globalOpts.updateTitlebar&&(a.Titlebar.imid=window.electron?c.fitsFile||c.file||c.id:c.id,document.title=a.Titlebar.title+": "+a.Titlebar.imid)};a.Titlebar.imagedisplay=function(c){c&&c.id!==a.Titlebar.imid&&a.globalOpts.updateTitlebar&&(a.Titlebar.imid=window.electron?c.fitsFile||c.file||c.id:c.id,document.title=a.Titlebar.title+": "+a.Titlebar.imid)};a.Titlebar.imageclose=function(){a.globalOpts.updateTitlebar&&(document.title=a.Titlebar.title)};Math.log10=Math.log10||function(a){return Math.log(a)/
Math.LN10};"function"!==typeof Object.create&&(Object.create=function(a){var b=function(){};b.prototype=a;return new b});Math.asinh=Math.asinh||function(a){return-Infinity===a?a:Math.log(a+Math.sqrt(a*a+1))};Math.sinh=Math.sinh||function(a){return(Math.exp(a)-Math.exp(-a))/2};Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(a,b){if(null==this)throw new TypeError('"this" is null or not defined');var c=Object(this),e=c.length>>>0;if(0===e)return!1;b|=0;for(b=
Math.max(0<=b?b:e-Math.abs(b),0);b<e;){var f=c[b],h=a;if(f===h||"number"===typeof f&&"number"===typeof h&&isNaN(f)&&isNaN(h))return!0;b++}return!1}});a.getRawCopy=function(a,b){var c=$.extend(!0,{},a);c.bitpix=b||a.bitpix;switch(c.bitpix){case 8:c.data=new Uint8Array(a.data);break;case 16:c.data=new Int16Array(a.data);break;case -16:c.data=new Uint16Array(a.data);break;case 32:c.data=new Int32Array(a.data);break;case -32:c.data=new Float32Array(a.data);break;case -64:c.data=new Float64Array(a.data)}return c};
a.getRawLine=function(c,b,d,e){switch(c.bitpix){case 8:var f=new Uint8Array(c.data.buffer,b,c.width);var h=new Uint8Array(d.data.buffer,e,c.width);break;case 16:case -16:f=new Uint16Array(c.data.buffer,b,c.width);h=new Uint16Array(d.data.buffer,e,c.width);break;case 32:f=new Uint32Array(c.data.buffer,b,c.width);h=new Uint32Array(d.data.buffer,e,c.width);break;case -32:f=new Float32Array(c.data.buffer,b,c.width);h=new Float32Array(d.data.buffer,e,c.width);break;case -64:f=new Float64Array(c.data.buffer,
b,c.width);h=new Float64Array(d.data.buffer,e,c.width);break;default:a.error("unknown bitpix value for flip: "+c.bitpix)}return[f,h]};a.memcpy=function(a,b,d,e,f){a=new Uint8Array(a,b,f);d=new Uint8Array(d,e,f);a.set(d)};a.jupyterFocus=function(a,b){window.hasOwnProperty("Jupyter")&&(a=a instanceof jQuery?a:$(a),a.find(b||"input, textarea").each(function(a,b){Jupyter.keyboard_manager.register_events($(b))}))};a.getImageID=function(c,b,d){var e,f=0,h=1,g=a.images.length,k=/.*<([0-9][0-9]*)>$/,l=/<[0-9][0-9]*>/;
c=c.replace(l,"");for(e=0;e<g;e++){var m=a.images[e];m.display.id===b&&m!==d&&c===m.id0.replace(l,"")&&(m.id&&0<=m.id.search(k)&&(m=m.id.replace(k,"$1"),h=Math.max(h,parseInt(m,10))),f++)}return f?c+"<"+String(h+1)+">":c};a.uniqueID=function(){var a=1;return function(){return a++}}();a.waiting=function(c,b){switch(c){case !0:if(window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType){if(b)if("object"===typeof b)var d=b.divjq[0];else"string"===typeof b&&(c=a.lookupDisplay(b))&&(d=c.divjq[0]);
d||(d=$("body").get(0));a.spinner||(a.spinner={},c={color:a.globalOpts.spinColor,opacity:a.globalOpts.spinOpacity},a.spinner.spinner=new Spinner(c));a.spinner.spinner.spin(d)}else $("body").addClass("waiting");break;case !1:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?a.spinner&&a.spinner.spinner.stop():$("body").removeClass("waiting")}};a.progress=function(c,b){if("boolean"===typeof c||"string"===typeof c)switch(c){case !0:case "indeterminate":b&&(a.progress.display=b,a.progress.display.displayMessage("progress",
c));break;case !1:case "":a.progress.display&&(a.progress.display.clearMessage("progress"),delete a.progress.display)}else"number"===typeof c&&a.progress.display&&a.progress.display.displayMessage("progress",[c,b])};a.msgHandler=function(c,b){var d=[];var e=c.cmd,f=c.id,h=a.globalOpts.alerts,g=a.globalOpts.quietReturn?"":"OK";b&&(a.globalOpts.alerts=!1);if(a.publics[e]){$.isArray(c.args)||(c.args=[c.args]);for(d=0;d<c.args.length;d++)if("''"===c.args[d]||'""'===c.args[d])c.args[d]="";d=$.extend(!0,
[],c.args);a:{var k=d;if(f){if(0<k.length){c=k[k.length-1];if("string"===typeof c)try{var l=JSON.parse(c)}catch(n){l=null}else"object"===typeof c&&(l=c);if(l&&"object"===typeof l&&l.hasOwnProperty("display")&&1===Object.keys(l).length){k.pop();break a}}l={display:f}}else l=null}switch(e){case "RunAnalysis":b&&(1===d.length&&d.push(null),d.push(b))}l&&d.push(l);try{var m=a.publics[e].apply(a.publics,$jscomp.arrayFromIterable(d))}catch(n){m="ERROR: "+n.message}if(b){a.globalOpts.alerts=h;if(m instanceof
a.Display||m instanceof a.Image)m=m.id;switch(e){case "NewShapeLayer":m&&m.layerName&&(m=m.layerName);break;case "RunAnalysis":m.match(/^ERROR:/)||(b=null)}b&&b(m)}return m}if(e&&"#"!==e){l=a.lookupCommand(e);k=a.lookupDisplay(f);if(l&&k)switch(l.getDisplayInfo(k),c.args?d=$.extend(!0,[],c.args):c.paramlist&&(d=c.paramlist.split(/ +/)),l.getWhich(d)){case "get":try{m=l.get(d)||""}catch(n){m="ERROR: "+n.message}break;case "set":try{m=l.set(d)||g}catch(n){m="ERROR: "+n.message}break;default:m="ERROR: unknown cmd type for '"+
e+"'"}else l||(m="ERROR: unknown cmd '"+e+"'"),k||(m="ERROR: unknown display ("+f+")");if(b){a.globalOpts.alerts=h;if(m instanceof a.Display||m instanceof a.Image)m=m.id;b(m)}return m}b&&b("");b&&(a.globalOpts.alerts=h)};a.lightWin=function(c,b,d,e,f){f=f||"";switch(a.LIGHTWIN){case "dhtml":f.match(/(left|top|center)=/)||(f&&(f+=","),f+=""+a.globalOpts.lightWinPos);var h=dhtmlwindow.open(c,b,d,e,f);/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+c+" "+a.lightOpts[a.LIGHTWIN].drag).css("-webkit-overflow-scrolling",
"touch").css("overflow-y","scroll");$("#"+c+" "+a.lightOpts[a.LIGHTWIN].dragBar).on("dblclick",function(){h.close()}).on("touchend",function(b){var c=(new Date).getTime(),d=$(b.currentTarget).data("lasttime");d&&c-d>a.DBLCLICK0&&c-d<a.DBLCLICK&&h.close();$(b.currentTarget).data("lasttime",c)});$("#"+c+" "+a.lightOpts[a.LIGHTWIN].dragBar).on("touchend",function(){dhtmlwindow.distancex||dhtmlwindow.distancey?0<a.lightOpts.nclick&&(a.lightOpts.nclick=0):2<=a.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),
a.lightOpts.nclick=-1):0<=a.lightOpts.nclick&&a.lightOpts.nclick++})}return h};a.checkNew=function(c){c||a.error("internal failure in a JS9 constructor")};a.specialKey=function(a){return a.metaKey||a.ctrlKey};a.strace=function(c){var b="";1<a.DEBUG&&(b=c.stack||c.stacktrace||"");return b};a.floatToString=function(c){return"number"===typeof c?sprintf("%g",parseFloat(c.toFixed(a.globalOpts.floatPrecision))):"string"===typeof c?c:String(c)};a.floatPrecision=function(a,b){return Math.max(Math.floor(Math.log10(Math.abs(a))),
Math.floor(Math.log10(Math.abs(b))))};a.floatFormattedString=function(a,b,d){var c="";if(void 0===a)return c;-2>b?(b="%."+String(2+d)+"e",c=sprintf(b,a)):0>b?c=a.toFixed(Math.abs(b)+3+d):2>b?(b="%."+String(b+d)+"f",c=sprintf(b,a)):5>b?c=a.toFixed(0+d):(b="%."+String(2+d)+"e",c=sprintf(b,a));return c};a.centerPolygon=function(a){var b;if(a&&a.length){var c=a.length;for(b=0;b<c;b++){if(void 0===e||a[b].x<e)var e=a[b].x;if(void 0===f||a[b].x>f)var f=a[b].x;if(void 0===h||a[b].y<h)var h=a[b].y;if(void 0===
g||a[b].y>g)var g=a[b].y}return{x:(e+f)/2,y:(h+g)/2}}};a.centroidPolygon=function(a,b){var c=0,e=0,f=0,h=0,g=0,k=[];if(a&&a.length){var l=a.length;if(b){for(b=0;b<l;b++)h+=a[b].x,g+=a[b].y;return{x:h/l,y:g/l}}for(b=0;b<l;b++)k[b]={},k[b].x=a[b].x,k[b].y=a[b].y;k[l]={};k[l].x=k[0].x;k[l].y=k[0].y;for(b=0;b<l;b++)a=k[b].x*k[b+1].y-k[b+1].x*k[b].y,c+=a,e+=(k[b].x+k[b+1].x)*a,f+=(k[b].y+k[b+1].y)*a;l=c/2;return{x:e/(6*l),y:f/(6*l)}}};a.lookupImage=function(c,b){var d,e,f=a.images.length;if(!c)return null;
window.electron&&(e=window.electron.currentDir+"/"+c);for(d=0;d<f;d++){var h=a.images[d];if((c===h||c===h.id||c===h.file||c===h.file.replace(/\[.*\]$/,"")||e===h.file||e===h.file.replace(/\[.*\]$/,"")||c===h.file0||c===a.TOROOT+h.file||h.fitsFile&&c===h.fitsFile)&&0<$("#"+h.display.id).length){var g=h.display.id;if(!b||"string"===typeof b&&b===g||"object"===typeof b&&b.id===g)return h}}return null};a.lookupDisplay=function(c,b){var d,e=new RegExp("[-_]?("+a.PLUGINS+")$");void 0===b&&(b=!0);if(c&&
0>c.toString().search(a.SUPERMENU)){for(d=0;d<a.displays.length;d++)if(c===a.displays[d]||c===a.displays[d].id||c===a.displays[d].oid)return a.displays[d];if("string"===typeof c)for(c=c.replace(e,""),d=0;d<a.displays.length;d++)if(c===a.displays[d]||c===a.displays[d].id||c===a.displays[d].oid)return a.displays[d];if(b)a.error("can't find JS9 display with id: "+c);else return null}return a.displays[0]};a.getImage=function(c){var b=a.lookupImage(c);!b&&(c=a.lookupDisplay(c))&&(b=c.image);return b};
a.lookupVfile=function(c){var b,d,e=[];if(!c)return e;for(b=0;b<a.images.length;b++){var f=a.images[b];for(d=0;d<f.raws.length;d++){var h=f.raws[d];h.hdu&&h.hdu.fits&&c===h.hdu.fits.vfile&&e.push({im:f,raw:h,idx:d})}}return e};a.loadScript=function(a,b,d){var c=document.getElementsByTagName("head")[0],f=document.createElement("script");f.type="text/javascript";b&&(f.onload=b);d&&(f.onerror=d);f.src=a;c.appendChild(f)};a.fetchURL=function(c,b,d,e){var f=new XMLHttpRequest;d=d||{};c||b||a.error("invalid url specification for fetchURL");
b||(b=c,c=/([^\\/]+)$/.exec(b)[1]);c||(c=/([^\\/]+)$/.exec(b)[1]);var h=d.allowCache||b.match(/\?/)?b:b+"?r="+Math.random();h=h.replace(/^\${JS9_DIR}\//,a.INSTALLDIR);f.open("GET",h,!0);f.responseType=d.responseType?d.responseType:"blob";a.globalOpts.xtimeout&&(f.timeout=a.globalOpts.xtimeout);f.onload=function(){if(4===f.readyState)if(200===f.status||0===f.status)if(delete a.fetchURL.status,"blob"===f.responseType){var g=new Blob([f.response]);c.match("://")?g.name=c.split("/").reverse()[0].replace(/\?.*$/,
""):g.name=c;"uc"===g.name&&(g.name="google_"+a.uniqueID()+".fits");e?e(g,d):a.Load(g,d)}else d.display?e(f.response,d,{display:d.display}):e(f.response,d);else 404===f.status?a.error("could not find "+b):a.error("can't load: "+b+" "+f.statusText+" "+f.status)};f.onerror=function(){a.error("cannot load: "+b+" ... please check the url/pathname")};f.ontimeout=function(){a.error("timeout awaiting response from server: "+b)};a.fetchURL.status="processing";try{f.send()}catch(g){a.error("request to load "+
b+" failed",g)}};a.saveAs=function(c,b){var d;if(window.electron){(d=b.match(/.*\//))&&d[0]&&(d=d[0],a.SaveDir(d,{onceOnly:!0}));var e=b.split("/").reverse()[0];window.setTimeout(function(){try{saveAs(c,e)}catch(f){a.error("could not saveAs",f)}},a.TIMEOUT)}else try{saveAs(c,b)}catch(f){a.error("could not saveAs",f)}};a.fitsLibrary=function(c){if(!c)return a.fits.name;var b=c.toLowerCase();switch(b){case "fitsy":a.fits=Fitsy;a.fits.datahandler(a.NewFitsImage);a.fits.options=a.userOpts.fits||a.fits.options||
{};break;case "astroem":case "cfitsio":a.fits=Astroem;a.fits.options=a.fits.options||{};a.fits.options.handler=a.NewFitsImage;a.fits.options.error=a.error;a.userOpts.fits?(a.fits.options.extlist=a.userOpts.fits.extlist,a.fits.options.table={xdim:a.userOpts.fits.xdim,ydim:a.userOpts.fits.ydim,bin:a.userOpts.fits.bin||1},a.fits.options.image={xdim:a.userOpts.fits.ixdim||a.userOpts.fits.xmax,ydim:a.userOpts.fits.iydim||a.userOpts.fits.ymax,bin:a.userOpts.fits.ibin||1}):(a.fits.options.extlist=a.globalOpts.extlist,
a.fits.options.table={bin:a.globalOpts.table.bin||1},a.notNull(a.globalOpts.table.xdim)?a.fits.options.table.xdim=a.globalOpts.table.xdim:a.notNull(a.globalOpts.dims)&&(a.fits.options.table.xdim=a.globalOpts.dims[0]),a.notNull(a.globalOpts.table.ydim)?a.fits.options.table.ydim=a.globalOpts.table.ydim:a.notNull(a.globalOpts.dims)&&(a.fits.options.table.ydim=a.globalOpts.dims[1]),a.fits.options.image={bin:a.globalOpts.image.bin||1},a.notNull(a.globalOpts.image.xdim)?a.fits.options.image.xdim=a.globalOpts.image.xdim:
a.notNull(a.globalOpts.xmax)&&(a.fits.options.image.xdim=a.globalOpts.xmax),a.notNull(a.globalOpts.image.ydim)?a.fits.options.image.ydim=a.globalOpts.image.ydim:a.notNull(a.globalOpts.ymax)&&(a.fits.options.image.ydim=a.globalOpts.ymax));a.fits.maxFITSMemory&&a.globalOpts.maxMemory&&a.fits.maxFITSMemory(a.globalOpts.maxMemory);break;default:a.error("unknown fits library: "+c)}a.fits.ready=!0;a.fits.name=b;a.fits.options.error=a.error;a.fits.options.waiting=a.waiting;return b};a.handleFITSFile=function(c,
b,d){a.fits.handleFITSFile?a.fits.handleFITSFile(c,b,d):a.error("no FITS module available to process FITS file")};a.cleanupFITSFile=function(c,b){var d;a.hostFS&&(d=new RegExp("^"+a.hostFS));return a.fits.cleanupFITSFile&&c&&c.hdu&&c.hdu.fits?(d&&c.hdu.fits.vfile&&c.hdu.fits.vfile.match(d)&&(b=!1),a.fits.cleanupFITSFile(c.hdu.fits,b),!0):!1};a.handleImageFile=function(c,b,d){var e=new FileReader;b=$.extend(!0,{},a.fits.options,b);d=d||a.Load;e.onload=function(a){var e,f,k,l=new Image;l.onload=function(){var a=
0;var g=document.createElement("canvas");var h=g.getContext("2d");var q=l.height,r=l.width;g.width=r;g.height=q;h.drawImage(l,0,0);e=h.getImageData(0,0,r,q).data;f=new Float32Array(q*r);for(h=0;h<q;h++)for(g=0;g<r;g++){var v=.299*e[a]+.587*e[a+1]+.114*e[a+2];f[(q-h)*r+g]=v;a+=4}k={head:{SIMPLE:!0,BITPIX:-32,NAXIS:2,NAXIS1:r,NAXIS2:q},filename:c.name,filedata:f,naxis:2,axis:[0,r,q],bitpix:-32,bin:1,data:f};k.dmin=Number.MAX_VALUE;k.dmax=Number.MIN_VALUE;for(a=0;a<q*r;a++)Number.isNaN(k.data[a])||(k.dmin=
Math.min(k.dmin,k.data[a]),k.dmax=Math.max(k.dmax,k.data[a]));d(k,b)};l.src=a.target.result};e.readAsDataURL(c)};a.getFITSImage=function(c,b,d,e){a.fits.getFITSImage?a.fits.getFITSImage(c,b,d,e):a.error("no FITS module available to process FITS image")};a.fits2RepFile=function(c,b,d,e,f){var h,g={},k="fits2"+e;var l=d[k]||void 0===d[k]&&a.globalOpts[k];!0===l?l="always":!1===l&&(l="never");if(l.match(/never/i))return!1;if(!a.helper.connected||"nodejs"!==a.helper.type&&"socket.io"!==a.helper.type)return"always"===
l&&a.globalOpts.requireFits2Fits&&a.error("can't run fits2fits without connected JS9 helper"),!1;if(!a.helper.js9helper)if(a.globalOpts.requireFits2Fits)a.error("js9helper not found for fits2fits processing");else return!1;switch(k){case "fits2png":break;case "fits2fits":if(!a.globalOpts.workDir)return a.globalOpts.requireFits2Fits&&a.error("can't run fits2fits without a workdir"),!1;e=d.xdim||a.fits.options.image.xdim||a.fits.options.table.xdim;var m=d.ydim||a.fits.options.image.ydim||a.fits.options.table.ydim;
var n=d.bin||a.fits.options.image.bin||a.fits.options.table.bin;var p=d.binMode||a.globalOpts.binMode;p="a"===p?"a":"";"string"===typeof n&&(n.match(/[as]$/)&&(p=n.slice(-1)),n=parseInt(n,10));n=Math.max(1,n||1);g.sect=void 0!==d.xcen&&void 0!==d.ycen?e+"@"+d.xcen+","+m+"@"+d.ycen+","+n+p:e+","+m+","+n+p;e=l.toLowerCase().split(/[>,]/);for(l=0;l<e.length;l++)switch(e[l]){case "size":e[l+1]&&(a.isNumber(e[l+1])&&(g.maxsize=1E6*parseFloat(e[l+1])),l++)}break;default:a.error("unknown FITS representation type: "+
e)}g.fits=a.cleanPath(b);g.parent=!0;a.waiting(!0,c);a.helper.send(k,g,function(b){b="object"===typeof b?b:0<=b.search(a.analOpts.epattern)?{stderr:b}:{stdout:b};b.stderr&&a.error(b.stderr,a.analOpts.epattern);if(b.stdout)switch(k){case "fits2png":b=b.stdout.replace(/\n*$/,"").split("\n").pop();"/"!==b.charAt(0)&&(b=a.InstallDir(b));var e=b.split(".").pop().toLowerCase();"png"===e?(d.source="fits2png",a.checkNew(new a.Image(b,d,f))):a.error("fits2png conversion failed: "+b);break;case "fits2fits":b.stdout.match(/^ERROR:/)&&
(a.globalOpts.requireFits2Fits?a.error(b.stdout):b.stdout=g.fits);var l=b.stdout.split(/\n/);b=a.cleanPath(l[0]);if(b===g.fits)e=$.extend(!0,{},d);else{"/"!==b.charAt(0)&&(b=a.InstallDir(b));e=$.extend(!0,{},d);delete e.xcen;delete e.ycen;delete e.bin;void 0!==e.xdim&&(e.xdim=0);void 0!==e.ydim&&(e.ydim=0);e.source="fits2fits";e.proxyFile=b;if(l[1]){try{h=JSON.parse(l[1])}catch(w){}h&&(e.extname=h.extname,e.extnum=h.extnum,e.hdus=h.hdus,e.parent=h)}l[2]&&(l=a.cleanPath(l[2]),e.parentFile=l,e.extname?
(e.parentFile=e.parentFile.replace(/\[.*\]/,""),e.parentFile+="["+e.extname+"]"):e.extnum&&0<e.extnum&&(e.parentFile=e.parentFile.replace(/\[.*\]/,""),e.parentFile.file+="["+e.extnum+"]"));f&&(e.onload=f)}e.fits2fits=!1;a.Load(b,e,{display:c})}});return!0};a.lookupColormap=function(c,b){var d;void 0===b&&(b=!0);c||(c=a.imageOpts.colormap);if(c)for(d=0;d<a.colormaps.length;d++)if(a.colormaps[d].name===c)return a.colormaps[d];if(b)a.error("unknown colormap '"+c+"'");else return null};a.lookupCommand=
function(c){var b;if(c){var d=c.toLowerCase();for(b=0;b<a.commands.length;b++)if(c=a.commands[b],c.name===d||c.alias===d||c.alias2===d)return c}return null};a.error=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=$jscomp.makeIterator(b);d=e.next().value;var f=e.next().value;e=e.next().value;var h,g,k,l="",m="",n=!0;a.waiting(!1);"processing"===a.fetchURL.status&&(a.fetchURL.status="error");for(g=0;g<a.images.length;g++){var p=a.images[g];(k=p.status.cur)&&p.status[k]&&
p.setStatus(k,"error")}"string"===typeof f?(f=d.match(f))?f[1]?d=f[1]:f[0]&&(d=f[0]):n=!1:"object"===typeof f&&(h=f);3>b.length&&(e=!0);if(n&&(h&&h.message?d+=" ("+h.message+")":d&&(h=Error(d)),(b=a.strace(h))&&(m="\n\nStacktrace:\n"+b),a.globalOpts.alerts&&(d&&"string"===typeof d&&0>d.search(/ERROR/)&&(l="JS9 ERROR: "),alert(l+(d+m))),e))throw h;};a.log=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c-0]=arguments[c];void 0!==window.console&&void 0!==window.console.log&&console.log.apply(console,
$jscomp.arrayFromIterable(b))};a.eventToCharStr=function(c){var b={37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",8:"delete",46:"delete"},d={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},e={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"};var f="number"===typeof c?c:c.which||c.keyCode;var h=String(f);d.hasOwnProperty(h)&&
(f=d[h]);f=!c.shiftKey&&65<=f&&90>=f?String.fromCharCode(f+32):!c.shiftKey&&b.hasOwnProperty(f)?b[f]:c.shiftKey&&e.hasOwnProperty(f)?e[f]:String.fromCharCode(f);a.specialKey(c)&&(f="M-"+f);return f};a.eventToDisplayPos=function(a,b){a||(a=window.event);if(a.target)var c=a.target;else a.srcElement&&(c=a.srcElement);3===c.nodeType&&(c=c.parentNode);b=b||$(c).offset();if(a.originalEvent)if(a.originalEvent.touches&&a.originalEvent.touches.length){var e=a.originalEvent.touches;c=e[0].pageX;var f=e[0].pageY}else a.originalEvent.changedTouches&&
a.originalEvent.changedTouches.length?(e=a.originalEvent.changedTouches,c=e[0].pageX,f=e[0].pageY):(c=a.pageX,f=a.pageY);else c=a.pageX,f=a.pageY;a=b.left+1;b=b.top+1;f={x:Math.floor(c-a),y:Math.floor(f-b)};if(e&&e.length)for(f.touches=[{x:f.x,y:f.y}],c=1;c<e.length;c++)f.touches[c]={x:Math.floor(e[c].pageX-a),y:Math.floor(e[c].pageY-b)};return f};a.pix2pix=function(c,b,d){if(!c||!b||0>=c.raw.wcs||0>=b.raw.wcs)return d;var e=d.x;d=d.y;var f=a.pix2wcs(c.raw.wcs,e,d).trim().split(/\s+/);var h=a.saostrtod(f[0]);
a.isHMS(c.params.wcssys)&&(h*=15);c=a.saostrtod(f[1]);f=a.wcs2pix(b.raw.wcs,h,c).trim().split(/\s+/);b=parseFloat(f[0]);c=parseFloat(f[1]);.5>Math.abs(b-e)&&(b=e);.5>Math.abs(c-d)&&(c=d);return{x:b,y:c}};a.angdist=function(a,b,d,e){var c=function(a,b){var c=[],d=Math.cos(b);c[0]=Math.cos(a)*d;c[1]=Math.sin(a)*d;c[2]=Math.sin(b);return c};a=c(a*Math.PI/180,b*Math.PI/180);d=c(d*Math.PI/180,e*Math.PI/180);return 180*-function(a,b){var c=a[0];var d=a[1];a=a[2];var e=Math.sqrt(c*c+d*d+a*a);0!=e&&(c/=e,
d/=e,a/=e);e=b[0];var f=b[1];var g=b[2];b=f*c-e*d;c=g*(c*c+d*d)-a*(e*c+f*d);return 0!=b||0!=c?Math.atan2(b,c):0}(a,d)/Math.PI};a.rotatePoint=function(a,b,d){d=d||{x:0,y:0};b=Math.PI*b/180;var c=Math.cos(b);b=Math.sin(b);return{x:c*(a.x-d.x)-b*(a.y-d.y)+d.x,y:b*(a.x-d.x)+c*(a.y-d.y)+d.y}};a.matrixMultiply=function(a,b){var c,e,f,h=a.length,g=a[0].length,k=b[0].length;var l=Array(h);for(c=0;c<h;++c)for(l[c]=Array(k),e=0;e<k;++e)for(f=l[c][e]=0;f<g;++f)l[c][e]+=a[c][f]*b[f][e];return l};a.invertMatrix3=
function(a){var b,c,e=0,f=0,h=a[0][0]*a[1][1],g=[[0,0,0],[0,0,0],[0,0,0]];for(b=0;3>b;b++)for(c=0;2>c;c++)if(void 0===a[b][c]||Number.isNaN(a[b][c]))return null;0<=h?e+=h:f+=h;h=-a[0][1]*a[1][0];0<=h?e+=h:f+=h;b=e+f;if(0===b||1E-15>Math.abs(b/(e-f)))return null;b=1/b;g[0][0]=a[1][1]*b;g[1][0]=-a[1][0]*b;g[0][1]=-a[0][1]*b;g[1][1]=a[0][0]*b;g[2][0]=-(a[2][0]*g[0][0]+a[2][1]*g[1][0]);g[2][1]=-(a[2][0]*g[0][1]+a[2][1]*g[1][1]);return g};a.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};
a.notNull=function(a){return void 0!==a&&null!==a};a.isNull=function(a){return void 0===a||null===a};a.defNull=function(c,b){return a.notNull(c)?c:b};a.isWCS=function(a){return"image"!==a&&"physical"!==a};a.notWCS=function(a){return"image"===a||"physical"===a};a.isHMS=function(c,b){b=b||String.fromCharCode(a.saodtype());return(":"===b||"h"===b)&&"galactic"!==c&&"ecliptic"!==c};a.cardpars=function(c){var b=c.slice(0,8).trim();if("HISTORY"===b||"COMMENT"===b)return[b,c.slice(9).trim()];if("="===c[8])return c=
c.slice(10).replace(/'/g," ").replace(/ \/.*/,"").trim(),"T"===c?c=!0:"F"===c?c=!1:a.isNumber(c)&&(c=parseFloat(c)),[b,c]};a.raw2FITS=function(c,b){var d,e=!1,f="",h={};var g=function(a,b,c,d){var e=a;if("XTENSION"!==b||c){var f=new RegExp(b+" *= *(-?[-+]?[0-9]*.?[0-9]*([eE][-+]?[0-9]+)?) *");a?(a=a.replace(f,"$1"),a=parseFloat(a)):a=void 0;a!==c&&(e=sprintf("%-8s= %20s / %-47s",b,c,d||""))}else e=sprintf("%s  = %20s / %-47s","SIMPLE","T","file does conform to FITS standard");h[b]=!0;return e};if(!c)return f;
b=b||{};"boolean"===typeof b&&(b={addcr:b});if(c.card||c.cardstr){var k=c.header||{};var l=c.card?c.card.length:c.ncard;for(d=0;d<l;d++){var m=c.card?c.card[d].slice(0,80):c.cardstr.slice(80*d,80*(d+1));if(!b.notab||!m.match(/^TAB(TYP|MIN|MAX|DIM)[1,2]/)){if(m.match(/^XTENSION/)&&0===d&&b.simple)f+=g(m,"XTENSION");else if(m.match(/^BITPIX /)&&c.bitpix)f+=g(m,"BITPIX",c.bitpix,"bits/pixel");else if(m.match(/^NAXIS1 /)&&c.width)f+=g(m,"NAXIS1",c.width,"x image dim");else if(m.match(/^NAXIS2 /)&&c.height)f+=
g(m,"NAXIS2",c.height,"y image dim");else if(m.match(/^CRPIX1 /)&&a.notNull(k.CRPIX1))f+=g(m,"CRPIX1",k.CRPIX1,"ref point");else if(m.match(/^CRPIX2 /)&&a.notNull(k.CRPIX2))f+=g(m,"CRPIX2",k.CRPIX2,"ref point");else if(m.match(/^CDELT1 /)&&a.notNull(k.CDELT1))f+=g(m,"CDELT1",k.CDELT1,"deg/pixel");else if(m.match(/^CDELT2 /)&&a.notNull(k.CDELT2))f+=g(m,"CDELT2",k.CDELT2,"deg/pixel");else if(m.match(/^CD1_1 /)&&a.notNull(k.CD1_1))f+=g(m,"CD1_1",k.CD1_1,"WCS matrix value");else if(m.match(/^CD1_2 /)&&
a.notNull(k.CD1_2))f+=g(m,"CD1_2",k.CD1_2,"WCS matrix value");else if(m.match(/^CD2_1 /)&&a.notNull(k.CD2_1))f+=g(m,"CD2_1",k.CD2_1,"WCS matrix value");else if(m.match(/^CD2_2 /)&&a.notNull(k.CD2_2))f+=g(m,"CD2_2",k.CD2_2,"WCS matrix value");else if(m.match(/^LTV1 /)&&a.notNull(k.LTV1))f+=g(m,"LTV1",k.LTV1,"IRAF ref. point");else if(m.match(/^LTV2 /)&&a.notNull(k.LTV2))f+=g(m,"LTV2",k.LTV2,"IRAF ref. point");else if(m.match(/^LTM1_1 /)&&a.notNull(k.LTM1_1))f+=g(m,"LTM1_1",k.LTM1_1,"IRAF matrix value");
else if(m.match(/^LTM1_2 /)&&a.notNull(k.LTM1_2))f+=g(m,"LTM1_2",k.LTM1_2,"IRAF matrix value");else if(m.match(/^LTM2_1 /)&&a.notNull(k.LTM2_1))f+=g(m,"LTM2_1",k.LTM2_1,"IRAF matrix value");else if(m.match(/^LTM2_2 /)&&a.notNull(k.LTM2_2))f+=g(m,"LTM2_2",k.LTM2_2,"IRAF matrix value");else if(b.twoaxes&&m.match(/^NAXIS /))f+=g(m,"NAXIS",2,"number of data axes");else if(b.twoaxes&&m.match(/^(NAXIS|CRPIX|CRVAL|CTYPE|CUNIT|CDELT)[34567]/))continue;else if(b.twoaxes&&m.match(/^(DATASUM|CHECKSUM)/))continue;
else"END "===m.substring(0,4)?(a.notNull(k.LTV1)&&!h.LTV1&&(f+=g(null,"LTV1",k.LTV1,"IRAF ref. point"),b.addcr&&(f+="\n")),a.notNull(k.LTV2)&&!h.LTV2&&(f+=g(null,"LTV2",k.LTV2,"IRAF ref. point"),b.addcr&&(f+="\n")),a.notNull(k.LTM1_1)&&!h.LTM1_1&&(f+=g(null,"LTM1_1",k.LTM1_1,"IRAF matrix value"),b.addcr&&(f+="\n")),a.notNull(k.LTM1_2)&&!h.LTM1_2&&(f+=g(null,"LTM1_2",k.LTM1_2,"IRAF matrix value"),b.addcr&&(f+="\n")),a.notNull(k.LTM2_1)&&!h.LTM2_1&&(f+=g(null,"LTM2_1",k.LTM2_1,"IRAF matrix value"),
b.addcr&&(f+="\n")),a.notNull(k.LTM2_2)&&!h.LTM2_2&&(f+=g(null,"LTM2_2",k.LTM2_2,"IRAF matrix value"),b.addcr&&(f+="\n")),f+=m,e=!0):f+=m;b.addcr&&(f+="\n")}}}else if(c.header||c.BITPIX){c=c.header?c.header:c;if(void 0!==c.SIMPLE||void 0!==c.simple)d=void 0!==c.SIMPLE?c.SIMPLE:c.simple,!0===d?d="T":!1===d&&(d="F"),f+=sprintf("%-8s= %20s / %-47s","SIMPLE",d,"conforms to FITS standard"),b.addcr&&(f+="\n");if(void 0!==c.BITPIX||void 0!==c.bitpix)d=void 0!==c.BITPIX?c.BITPIX:c.bitpix,f+=sprintf("%-8s= %20s / %-47s",
"BITPIX",d,"bits/pixel"),b.addcr&&(f+="\n");for(m in c)if(c.hasOwnProperty(m)&&"js9Protocol"!==m&&"js9Endian"!==m&&"SIMPLE"!==m&&"simple"!==m&&"BITPIX"!==m&&"bitpix"!==m){"END"===m&&(e=!0);if(m.match(/HISTORY__[0-9]+/))f+=sprintf("HISTORY %-72s",c[m]);else if(m.match(/COMMENT__[0-9]+/))f+=sprintf("COMMENT %-72s",c[m]);else{d=c[m];!0===d?d="T":!1===d?d="F":""===d?d="' '":Number.isNaN(d)?d="NaN":a.isNumber(d)||"'"===d.charAt(0)||(d="'"+d+"'");g=sprintf("%-8s= %20s",m,d);l=80-g.length;if(0<l)for(d=0;d<
l;d++)g+=" ";f+=g}b.addcr&&(f+="\n")}}e||(f+=sprintf("%-8s%-72s","END"," "),b.addcr&&(f+="\n"));return f};a.hdus2Str=function(a){var b,c="";if(!a)return c;for(b=0;b<a.length;b++){var e=a[b];var f=e.name?e.name:0===b?"Primary":"N/A";c+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",e.hdu,f,e.type);switch(e.type){case "image":c+=sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",e.bitpix,e.naxis);if(e.naxes.length){c+="&#09;<b>axes</b>: [";for(f=0;f<e.naxes.length;f++)c+=sprintf("%d",
e.naxes[f]),f!==e.naxes.length-1&&(c+=", ");c+="]"}break;case "table":case "ascii":f="&#09;";9>=e.rows&&(f+="&#09;");c+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",e.rows,f);for(f=0;f<e.cols.length;f++)c+=""+e.cols[f].name,f!==e.cols.length-1&&(c+=", ");c+="]"}c+="\n\n"}return c};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};
a.searchbar=function(c,b){c=$(c);var d=function(a){h.unmark({done:function(){h.mark(a,{caseSensitive:k.opts.matchcase,diacritics:k.opts.diacritics,accuracy:k.opts.matchwords?"exactly":"partially",wildcards:k.opts.matchwildcards?"enabled":"disabled",done:function(){k.results=h.find("mark");k.currentIndex=0;f()}})}})},e=function(a){var b=a.prop("data-btn");k.opts[b]?(a.removeClass("JS9SearchButton-false"),a.addClass("JS9SearchButton-true")):(a.removeClass("JS9SearchButton-true"),a.addClass("JS9SearchButton-false"))},
f=function(){if(k.results.length){var a=k.results.eq(k.currentIndex);k.results.removeClass("current");a.length&&(a.addClass("current"),a=a.position().top,0>a||a>g.height())&&(a=a+g.scrollTop()-50,g.scrollTop(a))}};b=b||".JS9AnalysisText";if(c.is(b))var h=c;else if(h=c.find(b),!h.length)return;var g=c.find(a.lightOpts[a.LIGHTWIN].drag);g.length||(g=c);var k=g.find(".JS9Searchbar");if(k.length)k.css("display","block");else{k=$("<div>").addClass("JS9Searchbar").appendTo(g);k.opts={matchcase:!1,matchdiacritics:!1,
matchwords:!1,matchwildcards:!1};var l=$("<input type='search'>").addClass("JS9SearchInput").appendTo(k);l.on("input",function(){d(this.value)});k.opts.matchwildcards?l.prop("placeholder","sea*rch template?"):l.prop("placeholder","search term(s)");b=$("<button>").addClass("JS9SearchButton").prop("data-btn","next").html("&darr;").appendTo(k);var m=$("<button>").addClass("JS9SearchButton").prop("data-btn","prev").html("&uarr;").appendTo(k);b.add(m).on("click",function(){k.results&&k.results.length&&
(k.currentIndex+=$(this).is(m)?-1:1,0>k.currentIndex&&(k.currentIndex=k.results.length-1),k.currentIndex>k.results.length-1&&(k.currentIndex=0),f())});var n=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchcase).prop("data-btn","matchcase").html("Match Case").appendTo(k);n.on("click",function(){k.opts.matchcase=!k.opts.matchcase;e(n);d(l.val())});e(n);var p=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchdiacritics).prop("data-btn","matchdiacritics").html("Match Diacritics").appendTo(k);
p.on("click",function(){k.opts.matchdiacritics=!k.opts.matchdiacritics;e(p);d(l.val())});e(p);var q=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchwords).prop("data-btn","matchwords").html("Whole Words").appendTo(k);q.on("click",function(){k.opts.matchwords=!k.opts.matchwords;e(q);d(l.val())});e(q);var r=$("<button>").addClass("JS9SearchButton JS9SearchButton-"+k.opts.matchwildcards).prop("data-btn","matchwildcards").html("Wildcards").appendTo(k);r.on("click",function(){k.opts.matchwildcards=
!k.opts.matchwildcards;k.opts.matchwildcards?l.prop("placeholder","sea*rch template?"):l.prop("placeholder","search term(s)");e(r);d(l.val())});e(r);$("<button>").addClass("JS9SearchButton").prop("data-btn","close").html("Close").appendTo(k).on("click",function(){h.unmark();l.val("");k.css("display","none")});g.css("outline","none");g.attr("tabindex","0");g.on("keydown",function(b){var c=String.fromCharCode(b.which||b.keyCode);a.specialKey(b)&&"F"===c&&("none"===k.css("display")?(k.css("display",
"block"),l.focus()):(h.unmark(),l.val(""),k.css("display","none")))})}};a.tooltip=function(c,b,d,e,f,h){var g=function(b){return b.replace(/\$([a-zA-Z0-9_./]+)/g,function(b,c,d){c=c.split(".");switch(c[0]){case "im":d=e;break;case "xreg":d=f;break;case "evt":d=h;break;case "data":d=f.data;break;default:return b}for(b=1;b<c.length;b++)d=d[c[b]],d=a.isNumber(d)?d.toFixed(6):d;void 0===d&&(d="");return d})};d?(d=g(d),e.display.tooltip.html(d),g=e.display.tooltip.width(),d=e.display.tooltip.height(),
c=Math.max(2,Math.min(c,e.display.width-(g+10))),b=Math.max(2,Math.min(b,e.display.height-(d+10))),e.display.tooltip.css({left:c,top:b,display:"inline-block"})):e.display.tooltip.html("").css({left:-9999,display:"none"})};a.xeqByName=function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=$jscomp.makeIterator(b);var e=d.next().value;d=d.next().value;b=b.slice(2);var f=typeof e;switch(f){case "function":return e.apply(d,b);case "string":f=e.split(".");var h=f.pop();for(e=0;e<f.length;e++)d=
d[f[e]];return d[h].apply(d,$jscomp.arrayFromIterable(b));default:a.error("unknown func type: "+f)}};a.varByName=function(c,b){b=b||a;var d=c.split(".");var e=d.pop();for(c=0;c<d.length;c++)if(b=b[d[c]],!b)return null;return b[e]};a.mergePrefs=function(c){var b;for(b in c)if(c.hasOwnProperty(b)&&a.hasOwnProperty(b)){var d=typeof a[b];var e=typeof c[b];if(d===e||"string"===e)switch(d){case "object":$.isArray(c[b])?a[b]=c[b]:$.extend(a[b],c[b]);break;case "number":case "string":a[b]=c[b]}}};a.loadPrefs=
function(c,b){$.ajax({url:c,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(b){a.mergePrefs(b)},error:function(d,e,f){b&&a.log("JS9 prefs file not available: %s",c)}})};a.isTypedArray=function(a){a=Object.prototype.toString.call(a);return{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};
a.Starbase=function(a,b){var c,e,f=0;var h=function(a){var b;for(b=0;b<a.length;b++)if(null===a[b].match(/^-+$/))return 0;return b};var g=function(a){return a};this.head={};this.convFuncs=[];this.data=[];this.delims=[];if(a){b=b||{};a=a.replace(/\s+$/,"").split("\n");if(b.skip&&(c=b.skip.split(""))&&c.length)for(;f<a.length&&(c[0]===a[f][0]||"\n"===c[1]&&""===a[f]);f++);if(void 0!==a[f]&&void 0!==a[f+1]){this.headline=a[f++].trim().split(/ *\t */);b.units&&(this.unitline=a[f++].trim().split(/ *\t */));
this.dashline=a[f++].trim().split(/ *\t */);for(e=h(this.dashline);0===e||e!==this.headline.length;)b.units?(this.headline=this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=a[f++].trim().split(/ *\t */),e=h(this.dashline);for(h=0;h<this.headline.length;h++)this.headline[h]=this.headline[h].replace(/\./g,"_"),this.convFuncs[h]=b.convFuncs&&b.convFuncs[this.headline[h]]?b.convFuncs[this.headline[h]]:b.convFuncs&&b.convFuncs.def?b.convFuncs.def:g;for(b=0;f<a.length&&
(!c||!c.length||c[0]!==a[f][0]&&("\n"!==c[1]||""!==a[f]));f++,b++)for(this.data[b]=a[f].split("\t"),h=0;h<this.data[b].length;h++)g=this.convFuncs[h](this.data[b][h]),this.data[b][h]=g.val,this.delims[h]=g.delim||null;for(h=0;h<this.headline.length;h++)this[this.headline[h]]=h}}};a.colorToHex=function(a){var b={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",
brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",
darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",
lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",
mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",
powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",
yellow:"#ffff00",yellowgreen:"#9acd3",antiquewhite1:"#ffefdb",antiquewhite2:"#eedfcc",antiquewhite3:"#cdc0b0",antiquewhite4:"#8b8378",cadetblue1:"#98f5ff",cadetblue2:"#8ee5ee",cadetblue3:"#7ac5cd",cadetblue4:"#53868b",darkgoldenrod1:"#ffb90f",darkgoldenrod2:"#eead0e",darkgoldenrod3:"#cd950c",darkgoldenrod4:"#8b6508",darkgrey:"#a9a9a9",darkolivegreen1:"#caff70",darkolivegreen2:"#bcee68",darkolivegreen3:"#a2cd5a",darkolivegreen4:"#6e8b3d",darkorange1:"#ff7f00",darkorange2:"#ee7600",darkorange3:"#cd6600",
darkorange4:"#8b4500",darkorchid1:"#bf3eff",darkorchid2:"#b23aee",darkorchid3:"#9a32cd",darkorchid4:"#68228b",darkseagreen1:"#c1ffc1",darkseagreen2:"#b4eeb4",darkseagreen3:"#9bcd9b",darkseagreen4:"#698b69",darkslategray1:"#97ffff",darkslategray2:"#8deeee",darkslategray3:"#79cdcd",darkslategray4:"#528b8b",darkslategrey:"#2f4f4f",deeppink1:"#ff1493",deeppink2:"#ee1289",deeppink3:"#cd1076",deeppink4:"#8b0a50",deepskyblue1:"#00bfff",deepskyblue2:"#00b2ee",deepskyblue3:"#009acd",deepskyblue4:"#00688b",
dimgrey:"#696969",dodgerblue1:"#1e90ff",dodgerblue2:"#1c86ee",dodgerblue3:"#1874cd",dodgerblue4:"#104e8b",hotpink1:"#ff6eb4",hotpink2:"#ee6aa7",hotpink3:"#cd6090",hotpink4:"#8b3a62",indianred:"#cd5c5c",indianred1:"#ff6a6a",indianred2:"#ee6363",indianred3:"#cd5555",indianred4:"#8b3a3a",lavenderblush1:"#fff0f5",lavenderblush2:"#eee0e5",lavenderblush3:"#cdc1c5",lavenderblush4:"#8b8386",lemonchiffon1:"#fffacd",lemonchiffon2:"#eee9bf",lemonchiffon3:"#cdc9a5",lemonchiffon4:"#8b8970",lightblue1:"#bfefff",
lightblue2:"#b2dfee",lightblue3:"#9ac0cd",lightblue4:"#68838b",lightcyan1:"#e0ffff",lightcyan2:"#d1eeee",lightcyan3:"#b4cdcd",lightcyan4:"#7a8b8b",lightgoldenrod:"#eedd82",lightgoldenrod1:"#ffec8b",lightgoldenrod2:"#eedc82",lightgoldenrod3:"#cdbe70",lightgoldenrod4:"#8b814c",lightgray:"#d3d3d3",lightpink1:"#ffaeb9",lightpink2:"#eea2ad",lightpink3:"#cd8c95",lightpink4:"#8b5f65",lightsalmon1:"#ffa07a",lightsalmon2:"#ee9572",lightsalmon3:"#cd8162",lightsalmon4:"#8b5742",lightskyblue1:"#b0e2ff",lightskyblue2:"#a4d3ee",
lightskyblue3:"#8db6cd",lightskyblue4:"#607b8b",lightslateblue:"#8470ff",lightslategrey:"#778899",lightsteelblue1:"#cae1ff",lightsteelblue2:"#bcd2ee",lightsteelblue3:"#a2b5cd",lightsteelblue4:"#6e7b8b",lightyellow1:"#ffffe0",lightyellow2:"#eeeed1",lightyellow3:"#cdcdb4",lightyellow4:"#8b8b7a",mediumorchid1:"#e066ff",mediumorchid2:"#d15fee",mediumorchid3:"#b452cd",mediumorchid4:"#7a378b",mediumpurple1:"#ab82ff",mediumpurple2:"#9f79ee",mediumpurple3:"#8968cd",mediumpurple4:"#5d478b",mistyrose1:"#ffe4e1",
mistyrose2:"#eed5d2",mistyrose3:"#cdb7b5",mistyrose4:"#8b7d7b",navajowhite1:"#ffdead",navajowhite2:"#eecfa1",navajowhite3:"#cdb38b",navajowhite4:"#8b795e",navyblue:"#000080",olivedrab1:"#c0ff3e",olivedrab2:"#b3ee3a",olivedrab3:"#9acd32",olivedrab4:"#698b22",orangered1:"#ff4500",orangered2:"#ee4000",orangered3:"#cd3700",orangered4:"#8b2500",palegreen1:"#9aff9a",palegreen2:"#90ee90",palegreen3:"#7ccd7c",palegreen4:"#548b54",paleturquoise1:"#bbffff",paleturquoise2:"#aeeeee",paleturquoise3:"#96cdcd",
paleturquoise4:"#668b8b",palevioletred1:"#ff82ab",palevioletred2:"#ee799f",palevioletred3:"#cd6889",palevioletred4:"#8b475d",peachpuff1:"#ffdab9",peachpuff2:"#eecbad",peachpuff3:"#cdaf95",peachpuff4:"#8b7765",rosybrown1:"#ffc1c1",rosybrown2:"#eeb4b4",rosybrown3:"#cd9b9b",rosybrown4:"#8b6969",royalblue1:"#4876ff",royalblue2:"#436eee",royalblue3:"#3a5fcd",royalblue4:"#27408b",seagreen1:"#54ff9f",seagreen2:"#4eee94",seagreen3:"#43cd80",seagreen4:"#2e8b57",skyblue1:"#87ceff",skyblue2:"#7ec0ee",skyblue3:"#6ca6cd",
skyblue4:"#4a708b",slateblue1:"#836fff",slateblue2:"#7a67ee",slateblue3:"#6959cd",slateblue4:"#473c8b",slategray1:"#c6e2ff",slategray2:"#b9d3ee",slategray3:"#9fb6cd",slategray4:"#6c7b8b",slategrey:"#708090",springgreen1:"#00ff7f",springgreen2:"#00ee76",springgreen3:"#00cd66",springgreen4:"#008b45",steelblue1:"#63b8ff",steelblue2:"#5cacee",steelblue3:"#4f94cd",steelblue4:"#36648b",violetred:"#d02090",violetred1:"#ff3e96",violetred2:"#ee3a8c",violetred3:"#cd3278",violetred4:"#8b2252",webgray:"#808080",
webgreen:"#008000",webgrey:"#808080",webmaroon:"#800000",webpurple:"#800080",x11gray:"#bebebe",x11green:"#00ff00",x11grey:"#bebebe",x11maroon:"#b03060",x11purple:"#a020f0",aquamarine1:"#7fffd4",aquamarine2:"#76eec6",aquamarine3:"#66cdaa",aquamarine4:"#458b74",azure1:"#f0ffff",azure2:"#e0eeee",azure3:"#c1cdcd",azure4:"#838b8b",bisque1:"#ffe4c4",bisque2:"#eed5b7",bisque3:"#cdb79e",bisque4:"#8b7d6b",blue1:"#0000ff",blue2:"#0000ee",blue3:"#0000cd",blue4:"#00008b",brown1:"#ff4040",brown2:"#ee3b3b",brown3:"#cd3333",
brown4:"#8b2323",burlywood1:"#ffd39b",burlywood2:"#eec591",burlywood3:"#cdaa7d",burlywood4:"#8b7355",chartreuse1:"#7fff00",chartreuse2:"#76ee00",chartreuse3:"#66cd00",chartreuse4:"#458b00",chocolate1:"#ff7f24",chocolate2:"#ee7621",chocolate3:"#cd661d",chocolate4:"#8b4513",coral1:"#ff7256",coral2:"#ee6a50",coral3:"#cd5b45",coral4:"#8b3e2f",cornsilk1:"#fff8dc",cornsilk2:"#eee8cd",cornsilk3:"#cdc8b1",cornsilk4:"#8b8878",cyan1:"#00ffff",cyan2:"#00eeee",cyan3:"#00cdcd",cyan4:"#008b8b",firebrick1:"#ff3030",
firebrick2:"#ee2c2c",firebrick3:"#cd2626",firebrick4:"#8b1a1a",gold1:"#ffd700",gold2:"#eec900",gold3:"#cdad00",gold4:"#8b7500",goldenrod1:"#ffc125",goldenrod2:"#eeb422",goldenrod3:"#cd9b1d",goldenrod4:"#8b6914",gray0:"#000000",gray1:"#030303",gray10:"#1a1a1a",gray100:"#ffffff",gray11:"#1c1c1c",gray12:"#1f1f1f",gray13:"#212121",gray14:"#242424",gray15:"#262626",gray16:"#292929",gray17:"#2b2b2b",gray18:"#2e2e2e",gray19:"#303030",gray2:"#050505",gray20:"#333333",gray21:"#363636",gray22:"#383838",gray23:"#3b3b3b",
gray24:"#3d3d3d",gray25:"#404040",gray26:"#424242",gray27:"#454545",gray28:"#474747",gray29:"#4a4a4a",gray3:"#080808",gray30:"#4d4d4d",gray31:"#4f4f4f",gray32:"#525252",gray33:"#545454",gray34:"#575757",gray35:"#595959",gray36:"#5c5c5c",gray37:"#5e5e5e",gray38:"#616161",gray39:"#636363",gray4:"#0a0a0a",gray40:"#666666",gray41:"#696969",gray42:"#6b6b6b",gray43:"#6e6e6e",gray44:"#707070",gray45:"#737373",gray46:"#757575",gray47:"#787878",gray48:"#7a7a7a",gray49:"#7d7d7d",gray5:"#0d0d0d",gray50:"#7f7f7f",
gray51:"#828282",gray52:"#858585",gray53:"#878787",gray54:"#8a8a8a",gray55:"#8c8c8c",gray56:"#8f8f8f",gray57:"#919191",gray58:"#949494",gray59:"#969696",gray6:"#0f0f0f",gray60:"#999999",gray61:"#9c9c9c",gray62:"#9e9e9e",gray63:"#a1a1a1",gray64:"#a3a3a3",gray65:"#a6a6a6",gray66:"#a8a8a8",gray67:"#ababab",gray68:"#adadad",gray69:"#b0b0b0",gray7:"#121212",gray70:"#b3b3b3",gray71:"#b5b5b5",gray72:"#b8b8b8",gray73:"#bababa",gray74:"#bdbdbd",gray75:"#bfbfbf",gray76:"#c2c2c2",gray77:"#c4c4c4",gray78:"#c7c7c7",
gray79:"#c9c9c9",gray8:"#141414",gray80:"#cccccc",gray81:"#cfcfcf",gray82:"#d1d1d1",gray83:"#d4d4d4",gray84:"#d6d6d6",gray85:"#d9d9d9",gray86:"#dbdbdb",gray87:"#dedede",gray88:"#e0e0e0",gray89:"#e3e3e3",gray9:"#171717",gray90:"#e5e5e5",gray91:"#e8e8e8",gray92:"#ebebeb",gray93:"#ededed",gray94:"#f0f0f0",gray95:"#f2f2f2",gray96:"#f5f5f5",gray97:"#f7f7f7",gray98:"#fafafa",gray99:"#fcfcfc",green1:"#00ff00",green2:"#00ee00",green3:"#00cd00",green4:"#008b00",grey:"#bebebe",grey0:"#000000",grey1:"#030303",
grey10:"#1a1a1a",grey100:"#ffffff",grey11:"#1c1c1c",grey12:"#1f1f1f",grey13:"#212121",grey14:"#242424",grey15:"#262626",grey16:"#292929",grey17:"#2b2b2b",grey18:"#2e2e2e",grey19:"#303030",grey2:"#050505",grey20:"#333333",grey21:"#363636",grey22:"#383838",grey23:"#3b3b3b",grey24:"#3d3d3d",grey25:"#404040",grey26:"#424242",grey27:"#454545",grey28:"#474747",grey29:"#4a4a4a",grey3:"#080808",grey30:"#4d4d4d",grey31:"#4f4f4f",grey32:"#525252",grey33:"#545454",grey34:"#575757",grey35:"#595959",grey36:"#5c5c5c",
grey37:"#5e5e5e",grey38:"#616161",grey39:"#636363",grey4:"#0a0a0a",grey40:"#666666",grey41:"#696969",grey42:"#6b6b6b",grey43:"#6e6e6e",grey44:"#707070",grey45:"#737373",grey46:"#757575",grey47:"#787878",grey48:"#7a7a7a",grey49:"#7d7d7d",grey5:"#0d0d0d",grey50:"#7f7f7f",grey51:"#828282",grey52:"#858585",grey53:"#878787",grey54:"#8a8a8a",grey55:"#8c8c8c",grey56:"#8f8f8f",grey57:"#919191",grey58:"#949494",grey59:"#969696",grey6:"#0f0f0f",grey60:"#999999",grey61:"#9c9c9c",grey62:"#9e9e9e",grey63:"#a1a1a1",
grey64:"#a3a3a3",grey65:"#a6a6a6",grey66:"#a8a8a8",grey67:"#ababab",grey68:"#adadad",grey69:"#b0b0b0",grey7:"#121212",grey70:"#b3b3b3",grey71:"#b5b5b5",grey72:"#b8b8b8",grey73:"#bababa",grey74:"#bdbdbd",grey75:"#bfbfbf",grey76:"#c2c2c2",grey77:"#c4c4c4",grey78:"#c7c7c7",grey79:"#c9c9c9",grey8:"#141414",grey80:"#cccccc",grey81:"#cfcfcf",grey82:"#d1d1d1",grey83:"#d4d4d4",grey84:"#d6d6d6",grey85:"#d9d9d9",grey86:"#dbdbdb",grey87:"#dedede",grey88:"#e0e0e0",grey89:"#e3e3e3",grey9:"#171717",grey90:"#e5e5e5",
grey91:"#e8e8e8",grey92:"#ebebeb",grey93:"#ededed",grey94:"#f0f0f0",grey95:"#f2f2f2",grey96:"#f5f5f5",grey97:"#f7f7f7",grey98:"#fafafa",grey99:"#fcfcfc",honeydew1:"#f0fff0",honeydew2:"#e0eee0",honeydew3:"#c1cdc1",honeydew4:"#838b83",ivory1:"#fffff0",ivory2:"#eeeee0",ivory3:"#cdcdc1",ivory4:"#8b8b83",khaki1:"#fff68f",khaki2:"#eee685",khaki3:"#cdc673",khaki4:"#8b864e",magenta1:"#ff00ff",magenta2:"#ee00ee",magenta3:"#cd00cd",magenta4:"#8b008b",maroon1:"#ff34b3",maroon2:"#ee30a7",maroon3:"#cd2990",maroon4:"#8b1c62",
orange1:"#ffa500",orange2:"#ee9a00",orange3:"#cd8500",orange4:"#8b5a00",orchid1:"#ff83fa",orchid2:"#ee7ae9",orchid3:"#cd69c9",orchid4:"#8b4789",pink1:"#ffb5c5",pink2:"#eea9b8",pink3:"#cd919e",pink4:"#8b636c",plum1:"#ffbbff",plum2:"#eeaeee",plum3:"#cd96cd",plum4:"#8b668b",purple1:"#9b30ff",purple2:"#912cee",purple3:"#7d26cd",purple4:"#551a8b",red1:"#ff0000",red2:"#ee0000",red3:"#cd0000",red4:"#8b0000",salmon1:"#ff8c69",salmon2:"#ee8262",salmon3:"#cd7054",salmon4:"#8b4c39",seashell1:"#fff5ee",seashell2:"#eee5de",
seashell3:"#cdc5bf",seashell4:"#8b8682",sienna1:"#ff8247",sienna2:"#ee7942",sienna3:"#cd6839",sienna4:"#8b4726",snow1:"#fffafa",snow2:"#eee9e9",snow3:"#cdc9c9",snow4:"#8b8989",tan1:"#ffa54f",tan2:"#ee9a49",tan3:"#cd853f",tan4:"#8b5a2b",thistle1:"#ffe1ff",thistle2:"#eed2ee",thistle3:"#cdb5cd",thistle4:"#8b7b8b",tomato1:"#ff6347",tomato2:"#ee5c42",tomato3:"#cd4f39",tomato4:"#8b3626",turquoise1:"#00f5ff",turquoise2:"#00e5ee",turquoise3:"#00c5cd",turquoise4:"#00868b",wheat1:"#ffe7ba",wheat2:"#eed8ae",
wheat3:"#cdba96",wheat4:"#8b7e66",yellow1:"#ffff00",yellow2:"#eeee00",yellow3:"#cdcd00",yellow4:"#8b8b00"};if(!a)return"";var c=a.toLowerCase();return"undefined"!==typeof b[c]?b[c]:(b=a.match(/rgb\((\d+)[,\s]+(\d+)[,\s]+(\d+)\)/i))?sprintf("#%02x%02x%02x",b[1],b[2],b[3]):a};a.parseStaticColors=function(c){var b,d=[];if("string"===typeof c)try{c=JSON.parse(c)}catch(h){}$.isArray(c)||a.error("invalid input for static colors");for(b=0;b<c.length;b++){var e="string"===typeof c[b]?c[b].split(":"):c[b];
e[0]||a.error("no color specified: "+c[b]);try{var f=tinycolor(e[0])}catch(h){a.error("invalid color: "+e[0])}a.isNull(e[1])?(e[1]=1,e[2]=Infinity):e[1]=""===e[1]?-Infinity:parseFloat(e[1]);a.isNull(e[2])?e[2]=e[1]:e[2]=""===e[2]?Infinity:parseFloat(e[2]);e={name:e[0],active:!0,red:f._r,green:f._g,blue:f._b,alpha:255*f._a,min:e[1],max:e[2]};d.push(e)}d.sort(function(a,b){return a.min-b.min});return d};a.lookupStaticColor=function(a,b,d){var c,f=a.params.nocolor||{red:0,green:0,blue:0,alpha:0};if(a&&
a.staticObj){if(b<a.staticObj.colors[0].min)return f;if(d&&d[b])return d[b];for(c=0;c<a.staticObj.colors.length;c++){var h=a.staticObj.colors[c];if(b>=h.min&&b<=h.max)return h.active||(h=f),d&&1E7>=b&&(d[b]=h),h}}return f};a.strtoscaled=function(c){c=a.saostrtod(c);var b=String.fromCharCode(a.saodtype());switch(b){case '"':c/=3600;break;case "'":c/=60;break;case "r":c*=180/Math.PI}return{dval:c,dtype:b}};a.cleanPath=function(a){return a?a.trim().replace(/\/\.\//,"/").replace(/^\.\//,""):""};a.fixPath=
function(c,b){b=b||{};window.electron&&a.desktopOpts.currentPath&&!1!==b.fixpath&&!c.match(a.URLEXP)&&(c.match(/^\${JS9_DIR}\//)?c=c.replace(/^\${JS9_DIR}\//,a.INSTALLDIR):c.match(/^\${JS9_INSTALLDIR}\//)?c=c.replace(/^\${JS9_INSTALLDIR}\//,a.INSTALLDIR):c.match(/^\${JS9_PAGEDIR}\//)?c=c.replace(/^\${JS9_PAGEDIR}\//,""):"/"!==c.charAt(0)&&(c=window.electron.currentDir+"/"+c));return c};a.localAccess=function(c){if(!c||!a.globalOpts.localAccess||!a.hostFS)return null;c=c.replace(/\[.*\]/,"");var b=
"."+c.split(".").pop().toLowerCase();c=a.hostFS+"/"+c;return 0<=a.vsize(c)&&0<=$.inArray(b,a.globalOpts.localTemplates.split(","))?(2<a.DEBUG&&a.log("local access file: %s",c),c):null};a.dirname=function(a){return a&&a.includes("/")?a.match(/.*\//)[0]:""};a.mouseDownCB=function(c){var b=c.data,d=b.image,e=$(document).scrollLeft(),f=$(document).scrollTop();if(d){a.globalOpts.clickToFocus&&(d.display.displayConjq.focus(),window.scrollTo(e,f));c.target&&(d.posOffset=$(c.target).offset());d.pos0=a.eventToDisplayPos(c,
d.posOffset);d.pos=d.pos0;d.ipos0=d.displayToImagePos(d.pos);d.ipos=d.ipos0;b.resizing=b.inResize(d.pos);if(!b.resizing){c.preventDefault();a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(d,c,"start");if(d.clickInRegion&&"regions"===d.clickInLayer){d.display.clearMessage("regions");return}a.specialKey(c)||d.xeqPlugins("mouse","onmousedown",c)}d.clickState=c.which;switch(c.which){case 3:d.clickState=2}c.originalEvent&&c.originalEvent.touches&&c.originalEvent.touches.length&&(d.clickState=-c.originalEvent.touches.length);
$(document).on("mousemove."+b.id,b,function(b){return a.mouseMoveCB(b)});$(document).on("mouseup."+b.id,b,function(b){return a.mouseUpCB(b)})}};a.mouseUpCB=function(c){var b,d=c.data;if(b=d.image){b.pos=a.eventToDisplayPos(c,b.posOffset);b.ipos=b.displayToImagePos(b.pos);var e=Math.abs(b.pos0.x-b.pos.x)<a.NOMOVE&&Math.abs(b.pos0.y-b.pos.y)<a.NOMOVE;d.inResize(b.pos)||c.preventDefault();a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(b,c,"stop");b.clickInRegion&&b.clickInLayer&&(e?1===fabric.major_version&&
b.updateShapes(b.clickInLayer,"selected","select"):b.updateShapes(b.clickInLayer,"selected","mouseup"));if(a.specialKey(c))e&&!b.clickInRegion&&a.globalOpts.metaClickPan&&b.setPan(b.ipos.x,b.ipos.y);else{b.xeqPlugins("mouse","onmouseup",c);if(e&&(b.xeqPlugins("mouse","onclick",c),a.hasOwnProperty("Menubar")))a.Menubar.onclick(b.display);"click"===a.globalOpts.dynamicSelect&&a.Dysel.getDisplayOr(d)!==d&&a.Dysel.select(d)}b.clickInRegion=!1;b.clickInLayer=null;b.clickState=0;b.posOffset=null;d.resizing&&
(d.resizing=!1,a.bugs.webkit_resize&&(c=parseInt(d.divjq.css("width"),10),e=parseInt(d.divjq.css("height"),10),c<d.owidth&&d.divjq.css("width",d.owidth+a.RESIZEFUDGE),e<d.oheight&&d.divjq.css("height",d.oheight+a.RESIZEFUDGE)),a.globalOpts.resizeRedisplay||(b.displayImage("all"),b.refreshLayers()));$(document).off("mouseup."+d.id);$(document).off("mousemove."+d.id);for(b=0;b<a.displays.length;b++)c=a.displays[b],c!==d&&c.image&&c.image.clickState&&c.divjq.trigger("mouseup")}else if(a.hasOwnProperty("Menubar"))a.Menubar.onclick(c.data)};
a.mouseMoveCB=function(c){var b=c.data;var d=b.image;!d||a.specialKey(c)||(d.pos=a.eventToDisplayPos(c,d.posOffset),d.ipos=d.displayToImagePos(d.pos),d.pos0||(d.pos0=d.pos),d.ipos0||(d.ipos0=d.ipos),b.resizing)||(c.preventDefault(),d.valpos=null,d.clickInRegion&&"regions"===d.clickInLayer&&(b=d.display.layers.regions.params.sel)&&((d.params.listonchange||b.params.listonchange||a.globalOpts.intensivePlugins)&&d._updateShape("regions",b,null,"move"),(d.params.listonchange||b.params.listonchange)&&d.listRegions("selected",
{mode:2}),a.globalOpts.intensivePlugins&&d.xeqPlugins("region","onregionsmove",b.pub)),a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(d,c),a.hasOwnProperty("Crosshair")&&d.tmp.arrowCrosshairVisible&&!d.params.crosshair&&a.Crosshair.hide(d,d.ipos,c),d.valpos||(d.valpos=d.updateValpos(d.ipos,!1)),a.specialKey(c)||d.xeqPlugins("mouse","onmousemove",c))};a.mouseEnterCB=function(c){var b=c.data,d=b.image;c.preventDefault();d&&(a.specialKey(c)||"move"===a.globalOpts.dynamicSelect&&a.Dysel.getDisplayOr(b)!==
b&&a.Dysel.select(b))};a.mouseOverCB=function(c){var b=c.data.image,d=$(document).scrollLeft(),e=$(document).scrollTop();c.preventDefault();b&&(a.globalOpts.clickToFocus||(b.display.displayConjq.focus(),window.scrollTo(d,e)),a.specialKey(c)||(b.pos=a.eventToDisplayPos(c),b.ipos=b.displayToImagePos(b.pos),a.specialKey(c)||b.xeqPlugins("mouse","onmouseover",c)))};a.mouseOutCB=function(c){var b=c.data.image;c.preventDefault();b&&(a.globalOpts.clickToFocus||b.display.displayConjq.blur(),b.clickInRegion&&
b.clickInLayer&&b.updateShapes(b.clickInLayer,"selected","mouseout"),a.specialKey(c)||(b.pos=a.eventToDisplayPos(c),b.ipos=b.displayToImagePos(b.pos),a.specialKey(c)||b.xeqPlugins("mouse","onmouseout",c)))};a.wheelCB=function(c){var b=c.data,d=b.image;b.mousetouchZoom&&d&&a.hasOwnProperty("MouseTouch")&&a.MouseTouch.Actions["wheel zoom"]&&(a.MouseTouch.Actions["wheel zoom"](d,c),c.preventDefault())};a.keyPressCB=function(a){var b=a.data.image;a.preventDefault();b&&b.xeqPlugins("keypress","onkeypress",
a)};a.keyDownCB=function(c){var b=c.data.image;c.preventDefault();if(a.hasOwnProperty("Keyboard")){var d=b?b.ipos:{x:null,y:null};a.Keyboard.action(b,d,c)}b&&b.xeqPlugins("keydown","onkeydown",c)};a.keyUpCB=function(a){var b=a.data.image;b&&b.xeqPlugins("keydown","onkeyup",a)};a.dragenterCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragoverCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragexitCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragdropCB=function(c,
b){var d;b.originalEvent&&(b=b.originalEvent);b.stopPropagation();b.preventDefault();var e=$.extend(!0,{},a.fits.options);e.display=e.display||c;e.extlist=e.extlist||a.globalOpts.extlist;var f=b.target.files||b.dataTransfer.files;var h=a.lookupDisplay(e.display);f.length?window.setTimeout(function(){for(d=0;d<f.length;d++){var b=f[d];var c=b.path||b.name||"";c.match(/\.reg$/)?a.LoadRegions(b,{display:e.display}):c.match(/\.cat$/)?a.LoadCatalog(null,b,{display:e.display}):c.match(/\.ses$/)?a.LoadSession(b,
{display:e.display}):c.match(/\.js9ses$/)?a.LoadSession(b,{display:e.display}):c.match(/\.cmap$/)?a.LoadColormap(b):(a.waiting(!0,h),e.refresh=a.globalOpts.refreshDragDrop,e.localAccess=!0,a.Load(b,e,{display:e.display}))}},a.SPINOUT):(c=b.dataTransfer.getData("text"),c.match(a.URLEXP)&&a.globalOpts.loadProxy&&a.LoadProxy(c,{display:e.display}))};a.RegisterPlugin=function(c,b,d,e){var f;if(c&&b&&d){var h=c+b;e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&
(e.menu=e.menu.toLowerCase())):e=[];a.PLUGINS&&(a.PLUGINS+="|");a.PLUGINS+=h.replace(/JS9/,"");a.PLUGINS+="|";a.PLUGINS+=b;a.plugins.push({xclass:c,xname:b,name:h,opts:e,func:d,instances:[]});e.help&&(d=e.help.match(/^.*[\\/]/),d[0]&&(f="plugins/"+d[0].replace(/[\\/]+$/,"")),d=e.help.replace(/^.*[\\/]/,""),e=e.menuItem?e.menuItem:h,a.helpOpts[b]={type:f,url:d,heading:c,title:e});a.inited&&a.instantiatePlugins()}};a.instantiatePlugin=function(c,b,d,e){var f,h="visible";if("string"===typeof b){for(f=
0;f<a.plugins.length;f++){var g=a.plugins[f];if(g.name===b){b=g;break}}"string"===typeof b&&a.error("unknown plugin: "+b)}g=Object.create(b.func.prototype);g.name=b.name;g.isActive=function(a){if("active"!==this.status||a&&!this.plugin.opts.hasOwnProperty(a))return!1;switch(this.winType){case "virtual":return!0;default:return this.divjq.is(":visible")}};g.errLog=function(b,c){a.log("error in %s: %s [%s]\n%s",b,this.name,c.message,a.strace(c))};if(c){var k=c instanceof jQuery?c:"object"===typeof c?
$(c):$("#"+c);for(f=0;f<b.instances.length;f++)if(k.is(b.instances[f].odivjq))return b.instances[f]}else k=$("div");c?d?(g.id=k.attr("id")||b.name,g.winType="light",g.winHandle=d,g.odivjq=k,g.divjq=k,g.outerdivjq=g.divjq.closest(a.lightOpts[a.LIGHTWIN].top)):(g.id=k.attr("id")||b.name,g.winType="div",0<=$.inArray(g.name,a.globalOpts.hiddenPluginDivs)&&(h="hidden"),k.wrap("<div class='JS9PluginContainer' style='visibility: "+h+"'>"),g.odivjq=k,g.divjq=k,g.divjq.addClass(b.xclass+"Plugin").addClass("JS9Plugin"),
g.odivjq.attr("id")||g.odivjq.attr("id",g.id),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),!1!==k.data("toolbarseparate")&&(b.opts.toolbarSeparate||k.data("toolbarseparate"))&&(d="<div class='"+a.lightOpts[a.LIGHTWIN].dragBar.substr(1)+"'>",$(d).insertBefore(g.divjq))):(g.id=b.name,g.winType="virtual");g.plugin=b;g.el=c;g.status="active";b.instances.push(g);if("virtual"===g.winType)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[b.name]||(g.div=null,g.display=a.displays[f],b.func.apply(g,
e),a.displays[f].pluginInstances[b.name]=g);else{g.div=g.divjq[0];g.outerdiv=g.outerdivjq[0];!b.opts.winDims||g.divjq.width()&&g.divjq.height()||(g.divjq.css("width",b.opts.winDims[0]),g.divjq.css("height",b.opts.winDims[1]));c=g.divjq.data("js9id")||g.id;if("*"===c)if(b.opts.dynamicSelect){g.display=a.displays[0];g.isDynamic=!0;a.Dysel.addPlugins(b.name);var l="*"}else a.error(b.name+" is not dynamically selectable");else g.display=a.lookupDisplay(c),l=g.display.id;if(k=k.data("toolbarhtml")||b.opts.toolbarHTML)k=
a.Image.prototype.expandMacro.call(null,k,[{name:"title",value:b.opts.winTitle||""}]),c=g.divjq.closest(a.lightOpts[a.LIGHTWIN].drag),0===c.length&&(c=g.divjq),$("<div class='JS9PluginToolbar-"+g.winType+"'>").css("z-index",a.BTNZINDEX).html(k).data("displayid",l).insertAfter(c);g.display.pluginInstances[b.name]=g;b.func.apply(g,e);if("*"===l)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[b.name]?g.display=a.displays[f]:a.displays[f].pluginInstances[b.name]=g}return g};a.instantiatePlugins=
function(){var c,b=function(b){var c,d;$("div."+b.name).each(function(c,d){a.instantiatePlugin($(d),b,null,b.opts.divArgs)});b.opts.menuItem||!b.opts.winDims||b.opts.winDims[0]||b.opts.winDims[1]||a.instantiatePlugin(null,b,null,b.opts.divArgs);for(c=0;c<b.instances.length;c++){var h=b.instances[c];if(h.isDynamic)for(d=0;d<a.displays.length;d++)a.displays[d].pluginInstances[b.name]||(a.displays[d].pluginInstances[b.name]=h)}};for(c=0;c<a.plugins.length;c++)b(a.plugins[c])};a.initEmscripten=function(){if(!window.hasOwnProperty("Astroem")){var c=
{responseType:"arraybuffer",allowCache:!0};if(a.globalOpts.useWasm&&"object"===typeof WebAssembly&&("file:"!==location.protocol||a.globalOpts.allowFileWasm))a.globalOpts.astroemWasm=a.InstallDir(Module.wasmBinaryFile||"astroemw.wasm"),a.fetchURL(a.globalOpts.astroemWasm,null,c,function(b){Module.wasmBinary=b;a.globalOpts.astroemURL=a.InstallDir("astroemw.js");try{a.loadScript(a.globalOpts.astroemURL)}catch(d){a.error("can't find "+a.globalOpts.astroemURL)}});else{a.globalOpts.astroemURL=a.InstallDir("astroem.js");
try{a.loadScript(a.globalOpts.astroemURL)}catch(b){a.error("can't find "+a.globalOpts.astroemURL)}}}};a.initFITS=function(){window.hasOwnProperty("Astroem")?(a.vmalloc=Astroem.vmalloc,a.vfree=Astroem.vfree,a.vheap=Astroem.vheap,a.vmemcpy=Astroem.vmemcpy,a.vfile=Astroem.vfile,a.vread=Astroem.vread,a.vunlink=Astroem.vunlink,a.vsize=Astroem.vsize,a.vmount=Astroem.vmount,a.arrfile=Astroem.arrfile,a.listhdu=Astroem.listhdu,a.initwcs=Astroem.initwcs,a.freewcs=Astroem.freewcs,a.wcsinfo=Astroem.wcsinfo,a.wcssys=
Astroem.wcssys,a.wcsunits=Astroem.wcsunits,a.pix2wcs=Astroem.pix2wcs,a.wcs2pix=Astroem.wcs2pix,a.reg2wcs=Astroem.reg2wcs,a.saostrtod=Astroem.saostrtod,a.saodtostr=Astroem.saodtostr,a.saodtype=Astroem.saodtype,a.zscale=Astroem.zscale,a.tanhdr=Astroem.tanhdr,a.reproject=Astroem.reproject,a.madd=Astroem.madd,a.imgtbl=Astroem.imgtbl,a.makehdr=Astroem.makehdr,a.shrinkhdr=Astroem.shrinkhdr,a.imsection=Astroem.imsection,a.regcnts=Astroem.regcnts,a.fitsLibrary("cfitsio")):window.hasOwnProperty("Fitsy")&&
a.fitsLibrary("fitsy")};a.initColormaps=function(){a.hasOwnProperty("Colormap")&&(a.checkNew(new a.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]])),a.checkNew(new a.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]])),a.checkNew(new a.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]])),a.checkNew(new a.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]])),a.checkNew(new a.Colormap("heat",[[0,0],[.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[.65,0],[.98,1],[1,1]])),a.checkNew(new a.Colormap("cool",
[[0,0],[.29,0],[.76,.1],[1,1]],[[0,0],[.22,0],[.96,1],[1,1]],[[0,0],[.53,1],[1,1]])),a.checkNew(new a.Colormap("turbo",[[.18995,.07176,.23217],[.19483,.08339,.26149],[.19956,.09498,.29024],[.20415,.10652,.31844],[.2086,.11802,.34607],[.21291,.12947,.37314],[.21708,.14087,.39964],[.22111,.15223,.42558],[.225,.16354,.45096],[.22875,.17481,.47578],[.23236,.18603,.50004],[.23582,.1972,.52373],[.23915,.20833,.54686],[.24234,.21941,.56942],[.24539,.23044,.59142],[.2483,.24143,.61286],[.25107,.25237,.63374],
[.25369,.26327,.65406],[.25618,.27412,.67381],[.25853,.28492,.693],[.26074,.29568,.71162],[.2628,.30639,.72968],[.26473,.31706,.74718],[.26652,.32768,.76412],[.26816,.33825,.7805],[.26967,.34878,.79631],[.27103,.35926,.81156],[.27226,.3697,.82624],[.27334,.38008,.84037],[.27429,.39043,.85393],[.27509,.40072,.86692],[.27576,.41097,.87936],[.27628,.42118,.89123],[.27667,.43134,.90254],[.27691,.44145,.91328],[.27701,.45152,.92347],[.27698,.46153,.93309],[.2768,.47151,.94214],[.27648,.48144,.95064],[.27603,
.49132,.95857],[.27543,.50115,.96594],[.27469,.51094,.97275],[.27381,.52069,.97899],[.27273,.5304,.98461],[.27106,.54015,.9893],[.26878,.54995,.99303],[.26592,.55979,.99583],[.26252,.56967,.99773],[.25862,.57958,.99876],[.25425,.5895,.99896],[.24946,.59943,.99835],[.24427,.60937,.99697],[.23874,.61931,.99485],[.23288,.62923,.99202],[.22676,.63913,.98851],[.22039,.64901,.98436],[.21382,.65886,.97959],[.20708,.66866,.97423],[.20021,.67842,.96833],[.19326,.68812,.9619],[.18625,.69775,.95498],[.17923,
.70732,.94761],[.17223,.7168,.93981],[.16529,.7262,.93161],[.15844,.73551,.92305],[.15173,.74472,.91416],[.14519,.75381,.90496],[.13886,.76279,.8955],[.13278,.77165,.8858],[.12698,.78037,.8759],[.12151,.78896,.86581],[.11639,.7974,.85559],[.11167,.80569,.84525],[.10738,.81381,.83484],[.10357,.82177,.82437],[.10026,.82955,.81389],[.0975,.83714,.80342],[.09532,.84455,.79299],[.09377,.85175,.78264],[.09287,.85875,.7724],[.09267,.86554,.7623],[.0932,.87211,.75237],[.09451,.87844,.74265],[.09662,.88454,
.73316],[.09958,.8904,.72393],[.10342,.896,.715],[.10815,.90142,.70599],[.11374,.90673,.69651],[.12014,.91193,.6866],[.12733,.91701,.67627],[.13526,.92197,.66556],[.14391,.9268,.65448],[.15323,.93151,.64308],[.16319,.93609,.63137],[.17377,.94053,.61938],[.18491,.94484,.60713],[.19659,.94901,.59466],[.20877,.95304,.58199],[.22142,.95692,.56914],[.23449,.96065,.55614],[.24797,.96423,.54303],[.2618,.96765,.52981],[.27597,.97092,.51653],[.29042,.97403,.50321],[.30513,.97697,.48987],[.32006,.97974,.47654],
[.33517,.98234,.46325],[.35043,.98477,.45002],[.36581,.98702,.43688],[.38127,.98909,.42386],[.39678,.99098,.41098],[.41229,.99268,.39826],[.42778,.99419,.38575],[.44321,.99551,.37345],[.45854,.99663,.3614],[.47375,.99755,.34963],[.48879,.99828,.33816],[.50362,.99879,.32701],[.51822,.9991,.31622],[.53255,.99919,.30581],[.54658,.99907,.29581],[.56026,.99873,.28623],[.57357,.99817,.27712],[.58646,.99739,.26849],[.59891,.99638,.26038],[.61088,.99514,.2528],[.62233,.99366,.24579],[.63323,.99195,.23937],
[.64362,.98999,.23356],[.65394,.98775,.22835],[.66428,.98524,.2237],[.67462,.98246,.2196],[.68494,.97941,.21602],[.69525,.9761,.21294],[.70553,.97255,.21032],[.71577,.96875,.20815],[.72596,.9647,.2064],[.7361,.96043,.20504],[.74617,.95593,.20406],[.75617,.95121,.20343],[.76608,.94627,.20311],[.77591,.94113,.2031],[.78563,.93579,.20336],[.79524,.93025,.20386],[.80473,.92452,.20459],[.8141,.91861,.20552],[.82333,.91253,.20663],[.83241,.90627,.20788],[.84133,.89986,.20926],[.8501,.89328,.21074],[.85868,
.88655,.2123],[.86709,.87968,.21391],[.8753,.87267,.21555],[.88331,.86553,.21719],[.89112,.85826,.2188],[.8987,.85087,.22038],[.90605,.84337,.22188],[.91317,.83576,.22328],[.92004,.82806,.22456],[.92666,.82025,.2257],[.93301,.81236,.22667],[.93909,.80439,.22744],[.94489,.79634,.228],[.95039,.78823,.22831],[.9556,.78005,.22836],[.96049,.77181,.22811],[.96507,.76352,.22754],[.96931,.75519,.22663],[.97323,.74682,.22536],[.97679,.73842,.22369],[.98,.73,.22161],[.98289,.7214,.21918],[.98549,.7125,.2165],
[.98781,.7033,.21358],[.98986,.69382,.21043],[.99163,.68408,.20706],[.99314,.67408,.20348],[.99438,.66386,.19971],[.99535,.65341,.19577],[.99607,.64277,.19165],[.99654,.63193,.18738],[.99675,.62093,.18297],[.99672,.60977,.17842],[.99644,.59846,.17376],[.99593,.58703,.16899],[.99517,.57549,.16412],[.99419,.56386,.15918],[.99297,.55214,.15417],[.99153,.54036,.1491],[.98987,.52854,.14398],[.98799,.51667,.13883],[.9859,.50479,.13367],[.9836,.49291,.12849],[.98108,.48104,.12332],[.97837,.4692,.11817],
[.97545,.4574,.11305],[.97234,.44565,.10797],[.96904,.43399,.10294],[.96555,.42241,.09798],[.96187,.41093,.0931],[.95801,.39958,.08831],[.95398,.38836,.08362],[.94977,.37729,.07905],[.94538,.36638,.07461],[.94084,.35566,.07031],[.93612,.34513,.06616],[.93125,.33482,.06218],[.92623,.32473,.05837],[.92105,.31489,.05475],[.91572,.3053,.05134],[.91024,.29599,.04814],[.90463,.28696,.04516],[.89888,.27824,.04243],[.89298,.26981,.03993],[.88691,.26152,.03753],[.88066,.25334,.03521],[.87422,.24526,.03297],
[.8676,.2373,.03082],[.86079,.22945,.02875],[.8538,.2217,.02677],[.84662,.21407,.02487],[.83926,.20654,.02305],[.83172,.19912,.02131],[.82399,.19182,.01966],[.81608,.18462,.01809],[.80799,.17753,.0166],[.79971,.17055,.0152],[.79125,.16368,.01387],[.7826,.15693,.01264],[.77377,.15028,.01148],[.76476,.14374,.01041],[.75556,.13731,.00942],[.74617,.13098,.00851],[.73661,.12477,.00769],[.72686,.11867,.00695],[.71692,.11268,.00629],[.7068,.1068,.00571],[.6965,.10102,.00522],[.68602,.09536,.00481],[.67535,
.0898,.00449],[.66449,.08436,.00424],[.65345,.07902,.00408],[.64223,.0738,.00401],[.63082,.06868,.00401],[.61923,.06367,.0041],[.60746,.05878,.00427],[.5955,.05399,.00453],[.58336,.04931,.00486],[.57103,.04474,.00529],[.55852,.04028,.00579],[.54583,.03593,.00638],[.53295,.03169,.00705],[.51989,.02756,.0078],[.50664,.02354,.00863],[.49321,.01963,.00955],[.4796,.01583,.01055]])),a.checkNew(new a.Colormap("viridis",[[.267004,.004874,.329415],[.26851,.009605,.335427],[.269944,.014625,.341379],[.271305,
.019942,.347269],[.272594,.025563,.353093],[.273809,.031497,.358853],[.274952,.037752,.364543],[.276022,.044167,.370164],[.277018,.050344,.375715],[.277941,.056324,.381191],[.278791,.062145,.386592],[.279566,.067836,.391917],[.280267,.073417,.397163],[.280894,.078907,.402329],[.281446,.08432,.407414],[.281924,.089666,.412415],[.282327,.094955,.417331],[.282656,.100196,.42216],[.28291,.105393,.426902],[.283091,.110553,.431554],[.283197,.11568,.436115],[.283229,.120777,.440584],[.283187,.125848,.44496],
[.283072,.130895,.449241],[.282884,.13592,.453427],[.282623,.140926,.457517],[.28229,.145912,.46151],[.281887,.150881,.465405],[.281412,.155834,.469201],[.280868,.160771,.472899],[.280255,.165693,.476498],[.279574,.170599,.479997],[.278826,.17549,.483397],[.278012,.180367,.486697],[.277134,.185228,.489898],[.276194,.190074,.493001],[.275191,.194905,.496005],[.274128,.199721,.498911],[.273006,.20452,.501721],[.271828,.209303,.504434],[.270595,.214069,.507052],[.269308,.218818,.509577],[.267968,.223549,
.512008],[.26658,.228262,.514349],[.265145,.232956,.516599],[.263663,.237631,.518762],[.262138,.242286,.520837],[.260571,.246922,.522828],[.258965,.251537,.524736],[.257322,.25613,.526563],[.255645,.260703,.528312],[.253935,.265254,.529983],[.252194,.269783,.531579],[.250425,.27429,.533103],[.248629,.278775,.534556],[.246811,.283237,.535941],[.244972,.287675,.53726],[.243113,.292092,.538516],[.241237,.296485,.539709],[.239346,.300855,.540844],[.237441,.305202,.541921],[.235526,.309527,.542944],[.233603,
.313828,.543914],[.231674,.318106,.544834],[.229739,.322361,.545706],[.227802,.326594,.546532],[.225863,.330805,.547314],[.223925,.334994,.548053],[.221989,.339161,.548752],[.220057,.343307,.549413],[.21813,.347432,.550038],[.21621,.351535,.550627],[.214298,.355619,.551184],[.212395,.359683,.55171],[.210503,.363727,.552206],[.208623,.367752,.552675],[.206756,.371758,.553117],[.204903,.375746,.553533],[.203063,.379716,.553925],[.201239,.38367,.554294],[.19943,.387607,.554642],[.197636,.391528,.554969],
[.19586,.395433,.555276],[.1941,.399323,.555565],[.192357,.403199,.555836],[.190631,.407061,.556089],[.188923,.41091,.556326],[.187231,.414746,.556547],[.185556,.41857,.556753],[.183898,.422383,.556944],[.182256,.426184,.55712],[.180629,.429975,.557282],[.179019,.433756,.55743],[.177423,.437527,.557565],[.175841,.44129,.557685],[.174274,.445044,.557792],[.172719,.448791,.557885],[.171176,.45253,.557965],[.169646,.456262,.55803],[.168126,.459988,.558082],[.166617,.463708,.558119],[.165117,.467423,
.558141],[.163625,.471133,.558148],[.162142,.474838,.55814],[.160665,.47854,.558115],[.159194,.482237,.558073],[.157729,.485932,.558013],[.15627,.489624,.557936],[.154815,.493313,.55784],[.153364,.497,.557724],[.151918,.500685,.557587],[.150476,.504369,.55743],[.149039,.508051,.55725],[.147607,.511733,.557049],[.14618,.515413,.556823],[.144759,.519093,.556572],[.143343,.522773,.556295],[.141935,.526453,.555991],[.140536,.530132,.555659],[.139147,.533812,.555298],[.13777,.537492,.554906],[.136408,
.541173,.554483],[.135066,.544853,.554029],[.133743,.548535,.553541],[.132444,.552216,.553018],[.131172,.555899,.552459],[.129933,.559582,.551864],[.128729,.563265,.551229],[.127568,.566949,.550556],[.126453,.570633,.549841],[.125394,.574318,.549086],[.124395,.578002,.548287],[.123463,.581687,.547445],[.122606,.585371,.546557],[.121831,.589055,.545623],[.121148,.592739,.544641],[.120565,.596422,.543611],[.120092,.600104,.54253],[.119738,.603785,.5414],[.119512,.607464,.540218],[.119423,.611141,.538982],
[.119483,.614817,.537692],[.119699,.61849,.536347],[.120081,.622161,.534946],[.120638,.625828,.533488],[.12138,.629492,.531973],[.122312,.633153,.530398],[.123444,.636809,.528763],[.12478,.640461,.527068],[.126326,.644107,.525311],[.128087,.647749,.523491],[.130067,.651384,.521608],[.132268,.655014,.519661],[.134692,.658636,.517649],[.137339,.662252,.515571],[.14021,.665859,.513427],[.143303,.669459,.511215],[.146616,.67305,.508936],[.150148,.676631,.506589],[.153894,.680203,.504172],[.157851,.683765,
.501686],[.162016,.687316,.499129],[.166383,.690856,.496502],[.170948,.694384,.493803],[.175707,.6979,.491033],[.180653,.701402,.488189],[.185783,.704891,.485273],[.19109,.708366,.482284],[.196571,.711827,.479221],[.202219,.715272,.476084],[.20803,.718701,.472873],[.214,.722114,.469588],[.220124,.725509,.466226],[.226397,.728888,.462789],[.232815,.732247,.459277],[.239374,.735588,.455688],[.24607,.73891,.452024],[.252899,.742211,.448284],[.259857,.745492,.444467],[.266941,.748751,.440573],[.274149,
.751988,.436601],[.281477,.755203,.432552],[.288921,.758394,.428426],[.296479,.761561,.424223],[.304148,.764704,.419943],[.311925,.767822,.415586],[.319809,.770914,.411152],[.327796,.77398,.40664],[.335885,.777018,.402049],[.344074,.780029,.397381],[.35236,.783011,.392636],[.360741,.785964,.387814],[.369214,.788888,.382914],[.377779,.791781,.377939],[.386433,.794644,.372886],[.395174,.797475,.367757],[.404001,.800275,.362552],[.412913,.803041,.357269],[.421908,.805774,.35191],[.430983,.808473,.346476],
[.440137,.811138,.340967],[.449368,.813768,.335384],[.458674,.816363,.329727],[.468053,.818921,.323998],[.477504,.821444,.318195],[.487026,.823929,.312321],[.496615,.826376,.306377],[.506271,.828786,.300362],[.515992,.831158,.294279],[.525776,.833491,.288127],[.535621,.835785,.281908],[.545524,.838039,.275626],[.555484,.840254,.269281],[.565498,.84243,.262877],[.575563,.844566,.256415],[.585678,.846661,.249897],[.595839,.848717,.243329],[.606045,.850733,.236712],[.616293,.852709,.230052],[.626579,
.854645,.223353],[.636902,.856542,.21662],[.647257,.8584,.209861],[.657642,.860219,.203082],[.668054,.861999,.196293],[.678489,.863742,.189503],[.688944,.865448,.182725],[.699415,.867117,.175971],[.709898,.868751,.169257],[.720391,.87035,.162603],[.730889,.871916,.156029],[.741388,.873449,.149561],[.751884,.874951,.143228],[.762373,.876424,.137064],[.772852,.877868,.131109],[.783315,.879285,.125405],[.79376,.880678,.120005],[.804182,.882046,.114965],[.814576,.883393,.110347],[.82494,.88472,.106217],
[.83527,.886029,.102646],[.845561,.887322,.099702],[.85581,.888601,.097452],[.866013,.889868,.095953],[.876168,.891125,.09525],[.886271,.892374,.095374],[.89632,.893616,.096335],[.906311,.894855,.098125],[.916242,.896091,.100717],[.926106,.89733,.104071],[.935904,.89857,.108131],[.945636,.899815,.112838],[.9553,.901065,.118128],[.964894,.902323,.123941],[.974417,.90359,.130215],[.983868,.904867,.136897],[.993248,.906157,.143936]])),a.checkNew(new a.Colormap("magma",[[.001462,4.66E-4,.013866],[.002258,
.001295,.018331],[.003279,.002305,.023708],[.004512,.00349,.029965],[.00595,.004843,.03713],[.007588,.006356,.044973],[.009426,.008022,.052844],[.011465,.009828,.06075],[.013708,.011771,.068667],[.016156,.01384,.076603],[.018815,.016026,.084584],[.021692,.01832,.09261],[.024792,.020715,.100676],[.028123,.023201,.108787],[.031696,.025765,.116965],[.03552,.028397,.125209],[.039608,.03109,.133515],[.04383,.03383,.141886],[.048062,.036607,.150327],[.05232,.039407,.158841],[.056615,.04216,.167446],[.060949,
.044794,.176129],[.06533,.047318,.184892],[.069764,.049726,.193735],[.074257,.052017,.20266],[.078815,.054184,.211667],[.083446,.056225,.220755],[.088155,.058133,.229922],[.092949,.059904,.239164],[.097833,.061531,.248477],[.102815,.06301,.257854],[.107899,.064335,.267289],[.113094,.065492,.276784],[.118405,.066479,.286321],[.123833,.067295,.295879],[.12938,.067935,.305443],[.135053,.068391,.315],[.140858,.068654,.324538],[.146785,.068738,.334011],[.152839,.068637,.343404],[.159018,.068354,.352688],
[.165308,.067911,.361816],[.171713,.067305,.370771],[.178212,.066576,.379497],[.184801,.065732,.387973],[.19146,.064818,.396152],[.198177,.063862,.404009],[.204935,.062907,.411514],[.211718,.061992,.418647],[.218512,.061158,.425392],[.225302,.060445,.431742],[.232077,.059889,.437695],[.238826,.059517,.443256],[.245543,.059352,.448436],[.25222,.059415,.453248],[.258857,.059706,.45771],[.265447,.060237,.46184],[.271994,.060994,.46566],[.278493,.061978,.46919],[.284951,.063168,.472451],[.291366,.064553,
.475462],[.29774,.066117,.478243],[.304081,.067835,.480812],[.310382,.069702,.483186],[.316654,.07169,.48538],[.322899,.073782,.487408],[.329114,.075972,.489287],[.335308,.078236,.491024],[.341482,.080564,.492631],[.347636,.082946,.494121],[.353773,.085373,.495501],[.359898,.087831,.496778],[.366012,.090314,.49796],[.372116,.092816,.499053],[.378211,.095332,.500067],[.384299,.097855,.501002],[.390384,.100379,.501864],[.396467,.102902,.502658],[.402548,.10542,.503386],[.408629,.10793,.504052],[.414709,
.110431,.504662],[.420791,.11292,.505215],[.426877,.115395,.505714],[.432967,.117855,.50616],[.439062,.120298,.506555],[.445163,.122724,.506901],[.451271,.125132,.507198],[.457386,.127522,.507448],[.463508,.129893,.507652],[.46964,.132245,.507809],[.47578,.134577,.507921],[.481929,.136891,.507989],[.488088,.139186,.508011],[.494258,.141462,.507988],[.500438,.143719,.50792],[.506629,.145958,.507806],[.512831,.148179,.507648],[.519045,.150383,.507443],[.52527,.152569,.507192],[.531507,.154739,.506895],
[.537755,.156894,.506551],[.544015,.159033,.506159],[.550287,.161158,.505719],[.556571,.163269,.50523],[.562866,.165368,.504692],[.569172,.167454,.504105],[.57549,.16953,.503466],[.581819,.171596,.502777],[.588158,.173652,.502035],[.594508,.175701,.501241],[.600868,.177743,.500394],[.607238,.179779,.499492],[.613617,.181811,.498536],[.620005,.18384,.497524],[.626401,.185867,.496456],[.632805,.187893,.495332],[.639216,.189921,.49415],[.645633,.191952,.49291],[.652056,.193986,.491611],[.658483,.196027,
.490253],[.664915,.198075,.488836],[.671349,.200133,.487358],[.677786,.202203,.485819],[.684224,.204286,.484219],[.690661,.206384,.482558],[.697098,.208501,.480835],[.703532,.210638,.479049],[.709962,.212797,.477201],[.716387,.214982,.47529],[.722805,.217194,.473316],[.729216,.219437,.471279],[.735616,.221713,.46918],[.742004,.224025,.467018],[.748378,.226377,.464794],[.754737,.228772,.462509],[.761077,.231214,.460162],[.767398,.233705,.457755],[.773695,.236249,.455289],[.779968,.238851,.452765],
[.786212,.241514,.450184],[.792427,.244242,.447543],[.798608,.24704,.444848],[.804752,.249911,.442102],[.810855,.252861,.439305],[.816914,.255895,.436461],[.822926,.259016,.433573],[.828886,.262229,.430644],[.834791,.26554,.427671],[.840636,.268953,.424666],[.846416,.272473,.421631],[.852126,.276106,.418573],[.857763,.279857,.415496],[.86332,.283729,.412403],[.868793,.287728,.409303],[.874176,.291859,.406205],[.879464,.296125,.403118],[.884651,.30053,.400047],[.889731,.305079,.397002],[.8947,.309773,
.393995],[.899552,.314616,.391037],[.904281,.31961,.388137],[.908884,.324755,.385308],[.913354,.330052,.382563],[.917689,.3355,.379915],[.921884,.341098,.377376],[.925937,.346844,.374959],[.929845,.352734,.372677],[.933606,.358764,.370541],[.937221,.364929,.368567],[.940687,.371224,.366762],[.944006,.377643,.365136],[.94718,.384178,.363701],[.95021,.39082,.362468],[.953099,.397563,.361438],[.955849,.4044,.360619],[.958464,.411324,.360014],[.960949,.418323,.35963],[.96331,.42539,.359469],[.965549,
.432519,.359529],[.967671,.439703,.35981],[.96968,.446936,.360311],[.971582,.45421,.36103],[.973381,.46152,.361965],[.975082,.468861,.363111],[.97669,.476226,.364466],[.97821,.483612,.366025],[.979645,.491014,.367783],[.981,.498428,.369734],[.982279,.505851,.371874],[.983485,.51328,.374198],[.984622,.520713,.376698],[.985693,.528148,.379371],[.9867,.535582,.38221],[.987646,.543015,.38521],[.988533,.550446,.388365],[.989363,.557873,.391671],[.990138,.565296,.395122],[.990871,.572706,.398714],[.991558,
.580107,.402441],[.992196,.587502,.406299],[.992785,.594891,.410283],[.993326,.602275,.41439],[.993834,.609644,.418613],[.994309,.616999,.42295],[.994738,.62435,.427397],[.995122,.631696,.431951],[.99548,.639027,.436607],[.99581,.646344,.441361],[.996096,.653659,.446213],[.996341,.660969,.45116],[.99658,.668256,.456192],[.996775,.675541,.461314],[.996925,.682828,.466526],[.997077,.690088,.471811],[.997186,.697349,.477182],[.997254,.704611,.482635],[.997325,.711848,.488154],[.997351,.719089,.493755],
[.997351,.726324,.499428],[.997341,.733545,.505167],[.997285,.740772,.510983],[.997228,.747981,.516859],[.997138,.75519,.522806],[.997019,.762398,.528821],[.996898,.769591,.534892],[.996727,.776795,.541039],[.996571,.783977,.547233],[.996369,.791167,.553499],[.996162,.798348,.55982],[.995932,.805527,.566202],[.99568,.812706,.572645],[.995424,.819875,.57914],[.995131,.827052,.585701],[.994851,.834213,.592307],[.994524,.841387,.598983],[.994222,.84854,.605696],[.993866,.855711,.612482],[.993545,.862859,
.619299],[.99317,.870024,.626189],[.992831,.877168,.633109],[.99244,.88433,.640099],[.992089,.89147,.647116],[.991688,.898627,.654202],[.991332,.905763,.661309],[.99093,.912915,.668481],[.99057,.920049,.675675],[.990175,.927196,.682926],[.989815,.934329,.690198],[.989434,.94147,.697519],[.989077,.948604,.704863],[.988717,.955742,.712242],[.988367,.962878,.719649],[.988033,.970012,.727077],[.987691,.977154,.734536],[.987387,.984288,.742002],[.987053,.991438,.749504]])),a.checkNew(new a.Colormap("inferno",
[[.001462,4.66E-4,.013866],[.002267,.00127,.01857],[.003299,.002249,.024239],[.004547,.003392,.030909],[.006006,.004692,.038558],[.007676,.006136,.046836],[.009561,.007713,.055143],[.011663,.009417,.06346],[.013995,.011225,.071862],[.016561,.013136,.080282],[.019373,.015133,.088767],[.022447,.017199,.097327],[.025793,.019331,.10593],[.029432,.021503,.114621],[.033385,.023702,.123397],[.037668,.025921,.132232],[.042253,.028139,.141141],[.046915,.030324,.150164],[.051644,.032474,.159254],[.056449,.034569,
.168414],[.06134,.03659,.177642],[.066331,.038504,.186962],[.071429,.040294,.196354],[.076637,.041905,.205799],[.081962,.043328,.215289],[.087411,.044556,.224813],[.09299,.045583,.234358],[.098702,.046402,.243904],[.104551,.047008,.25343],[.110536,.047399,.262912],[.116656,.047574,.272321],[.122908,.047536,.281624],[.129285,.047293,.290788],[.135778,.046856,.299776],[.142378,.046242,.308553],[.149073,.045468,.317085],[.15585,.044559,.325338],[.162689,.043554,.333277],[.169575,.042489,.340874],[.176493,
.041402,.348111],[.183429,.040329,.354971],[.190367,.039309,.361447],[.197297,.0384,.367535],[.204209,.037632,.373238],[.211095,.03703,.378563],[.217949,.036615,.383522],[.224763,.036405,.388129],[.231538,.036405,.3924],[.238273,.036621,.396353],[.244967,.037055,.400007],[.25162,.037705,.403378],[.258234,.038571,.406485],[.26481,.039647,.409345],[.271347,.040922,.411976],[.27785,.042353,.414392],[.284321,.043933,.416608],[.290763,.045644,.418637],[.297178,.04747,.420491],[.303568,.049396,.422182],
[.309935,.051407,.423721],[.316282,.05349,.425116],[.32261,.055634,.426377],[.328921,.057827,.427511],[.335217,.06006,.428524],[.3415,.062325,.429425],[.347771,.064616,.430217],[.354032,.066925,.430906],[.360284,.069247,.431497],[.366529,.071579,.431994],[.372768,.073915,.4324],[.379001,.076253,.432719],[.385228,.078591,.432955],[.391453,.080927,.433109],[.397674,.083257,.433183],[.403894,.08558,.433179],[.410113,.087896,.433098],[.416331,.090203,.432943],[.422549,.092501,.432714],[.428768,.09479,
.432412],[.434987,.097069,.432039],[.441207,.099338,.431594],[.447428,.101597,.43108],[.453651,.103848,.430498],[.459875,.106089,.429846],[.4661,.108322,.429125],[.472328,.110547,.428334],[.478558,.112764,.427475],[.484789,.114974,.426548],[.491022,.117179,.425552],[.497257,.119379,.424488],[.503493,.121575,.423356],[.50973,.123769,.422156],[.515967,.12596,.420887],[.522206,.12815,.419549],[.528444,.130341,.418142],[.534683,.132534,.416667],[.54092,.134729,.415123],[.547157,.136929,.413511],[.553392,
.139134,.411829],[.559624,.141346,.410078],[.565854,.143567,.408258],[.572081,.145797,.406369],[.578304,.148039,.404411],[.584521,.150294,.402385],[.590734,.152563,.40029],[.59694,.154848,.398125],[.603139,.157151,.395891],[.60933,.159474,.393589],[.615513,.161817,.391219],[.621685,.164184,.388781],[.627847,.166575,.386276],[.633998,.168992,.383704],[.640135,.171438,.381065],[.64626,.173914,.378359],[.652369,.176421,.375586],[.658463,.178962,.372748],[.66454,.181539,.369846],[.670599,.184153,.366879],
[.676638,.186807,.363849],[.682656,.189501,.360757],[.688653,.192239,.357603],[.694627,.195021,.354388],[.700576,.197851,.351113],[.7065,.200728,.347777],[.712396,.203656,.344383],[.718264,.206636,.340931],[.724103,.20967,.337424],[.729909,.212759,.333861],[.735683,.215906,.330245],[.741423,.219112,.326576],[.747127,.222378,.322856],[.752794,.225706,.319085],[.758422,.229097,.315266],[.76401,.232554,.311399],[.769556,.236077,.307485],[.775059,.239667,.303526],[.780517,.243327,.299523],[.785929,.247056,
.295477],[.791293,.250856,.29139],[.796607,.254728,.287264],[.801871,.258674,.283099],[.807082,.262692,.278898],[.812239,.266786,.274661],[.817341,.270954,.27039],[.822386,.275197,.266085],[.827372,.279517,.26175],[.832299,.283913,.257383],[.837165,.288385,.252988],[.841969,.292933,.248564],[.846709,.297559,.244113],[.851384,.30226,.239636],[.855992,.307038,.235133],[.860533,.311892,.230606],[.865006,.316822,.226055],[.869409,.321827,.221482],[.873741,.326906,.216886],[.878001,.33206,.212268],[.882188,
.337287,.207628],[.886302,.342586,.202968],[.890341,.347957,.198286],[.894305,.353399,.193584],[.898192,.358911,.18886],[.902003,.364492,.184116],[.905735,.37014,.17935],[.90939,.375856,.174563],[.912966,.381636,.169755],[.916462,.387481,.164924],[.919879,.393389,.16007],[.923215,.399359,.155193],[.92647,.405389,.150292],[.929644,.411479,.145367],[.932737,.417627,.140417],[.935747,.423831,.13544],[.938675,.430091,.130438],[.941521,.436405,.125409],[.944285,.442772,.120354],[.946965,.449191,.115272],
[.949562,.45566,.110164],[.952075,.462178,.105031],[.954506,.468744,.099874],[.956852,.475356,.094695],[.959114,.482014,.089499],[.961293,.488716,.084289],[.963387,.495462,.079073],[.965397,.502249,.073859],[.967322,.509078,.068659],[.969163,.515946,.063488],[.970919,.522853,.058367],[.97259,.529798,.053324],[.974176,.53678,.048392],[.975677,.543798,.043618],[.977092,.55085,.03905],[.978422,.557937,.034931],[.979666,.565057,.031409],[.980824,.572209,.028508],[.981895,.579392,.02625],[.982881,.586606,
.024661],[.983779,.593849,.02377],[.984591,.601122,.023606],[.985315,.608422,.024202],[.985952,.61575,.025592],[.986502,.623105,.027814],[.986964,.630485,.030908],[.987337,.63789,.034916],[.987622,.64532,.039886],[.987819,.652773,.045581],[.987926,.66025,.05175],[.987945,.667748,.058329],[.987874,.675267,.065257],[.987714,.682807,.072489],[.987464,.690366,.07999],[.987124,.697944,.087731],[.986694,.70554,.095694],[.986175,.713153,.103863],[.985566,.720782,.112229],[.984865,.728427,.120785],[.984075,
.736087,.129527],[.983196,.743758,.138453],[.982228,.751442,.147565],[.981173,.759135,.156863],[.980032,.766837,.166353],[.978806,.774545,.176037],[.977497,.782258,.185923],[.976108,.789974,.196018],[.974638,.797692,.206332],[.973088,.805409,.216877],[.971468,.813122,.227658],[.969783,.820825,.238686],[.968041,.828515,.249972],[.966243,.836191,.261534],[.964394,.843848,.273391],[.962517,.851476,.285546],[.960626,.859069,.29801],[.95872,.866624,.31082],[.956834,.874129,.323974],[.954997,.881569,.337475],
[.953215,.888942,.351369],[.951546,.896226,.365627],[.950018,.903409,.380271],[.948683,.910473,.395289],[.947594,.917399,.410665],[.946809,.924168,.426373],[.946392,.930761,.442367],[.946403,.937159,.458592],[.946903,.943348,.47497],[.947937,.949318,.491426],[.949545,.955063,.50786],[.95174,.960587,.524203],[.954529,.965896,.540361],[.957896,.971003,.556275],[.961812,.975924,.571925],[.966249,.980678,.587206],[.971162,.985282,.602154],[.976511,.989753,.61676],[.982257,.994109,.631017],[.988362,.998364,
.644924]])),a.checkNew(new a.Colormap("plasma",[[.050383,.029803,.527975],[.063536,.028426,.533124],[.075353,.027206,.538007],[.086222,.026125,.542658],[.096379,.025165,.547103],[.10598,.024309,.551368],[.115124,.023556,.555468],[.123903,.022878,.559423],[.132381,.022258,.56325],[.140603,.021687,.566959],[.148607,.021154,.570562],[.156421,.020651,.574065],[.16407,.020171,.577478],[.171574,.019706,.580806],[.17895,.019252,.584054],[.186213,.018803,.587228],[.193374,.018354,.59033],[.200445,.017902,
.593364],[.207435,.017442,.596333],[.21435,.016973,.599239],[.221197,.016497,.602083],[.227983,.016007,.604867],[.234715,.015502,.607592],[.241396,.014979,.610259],[.248032,.014439,.612868],[.254627,.013882,.615419],[.261183,.013308,.617911],[.267703,.012716,.620346],[.274191,.012109,.622722],[.280648,.011488,.625038],[.287076,.010855,.627295],[.293478,.010213,.62949],[.299855,.009561,.631624],[.30621,.008902,.633694],[.312543,.008239,.6357],[.318856,.007576,.63764],[.32515,.006915,.639512],[.331426,
.006261,.641316],[.337683,.005618,.643049],[.343925,.004991,.64471],[.35015,.004382,.646298],[.356359,.003798,.64781],[.362553,.003243,.649245],[.368733,.002724,.650601],[.374897,.002245,.651876],[.381047,.001814,.653068],[.387183,.001434,.654177],[.393304,.001114,.655199],[.399411,8.59E-4,.656133],[.405503,6.78E-4,.656977],[.41158,5.77E-4,.65773],[.417642,5.64E-4,.65839],[.423689,6.46E-4,.658956],[.429719,8.31E-4,.659425],[.435734,.001127,.659797],[.441732,.00154,.660069],[.447714,.00208,.66024],
[.453677,.002755,.66031],[.459623,.003574,.660277],[.46555,.004545,.660139],[.471457,.005678,.659897],[.477344,.00698,.659549],[.48321,.00846,.659095],[.489055,.010127,.658534],[.494877,.01199,.657865],[.500678,.014055,.657088],[.506454,.016333,.656202],[.512206,.018833,.655209],[.517933,.021563,.654109],[.523633,.024532,.652901],[.529306,.027747,.651586],[.534952,.031217,.650165],[.54057,.03495,.64864],[.546157,.038954,.64701],[.551715,.043136,.645277],[.557243,.047331,.643443],[.562738,.051545,
.641509],[.568201,.055778,.639477],[.573632,.060028,.637349],[.579029,.064296,.635126],[.584391,.068579,.632812],[.589719,.072878,.630408],[.595011,.07719,.627917],[.600266,.081516,.625342],[.605485,.085854,.622686],[.610667,.090204,.619951],[.615812,.094564,.61714],[.620919,.098934,.614257],[.625987,.103312,.611305],[.631017,.107699,.608287],[.636008,.112092,.605205],[.640959,.116492,.602065],[.645872,.120898,.598867],[.650746,.125309,.595617],[.65558,.129725,.592317],[.660374,.134144,.588971],[.665129,
.138566,.585582],[.669845,.142992,.582154],[.674522,.147419,.578688],[.67916,.151848,.575189],[.683758,.156278,.57166],[.688318,.160709,.568103],[.69284,.165141,.564522],[.697324,.169573,.560919],[.701769,.174005,.557296],[.706178,.178437,.553657],[.710549,.182868,.550004],[.714883,.187299,.546338],[.719181,.191729,.542663],[.723444,.196158,.538981],[.72767,.200586,.535293],[.731862,.205013,.531601],[.736019,.209439,.527908],[.740143,.213864,.524216],[.744232,.218288,.520524],[.748289,.222711,.516834],
[.752312,.227133,.513149],[.756304,.231555,.509468],[.760264,.235976,.505794],[.764193,.240396,.502126],[.76809,.244817,.498465],[.771958,.249237,.494813],[.775796,.253658,.491171],[.779604,.258078,.487539],[.783383,.2625,.483918],[.787133,.266922,.480307],[.790855,.271345,.476706],[.794549,.27577,.473117],[.798216,.280197,.469538],[.801855,.284626,.465971],[.805467,.289057,.462415],[.809052,.293491,.45887],[.812612,.297928,.455338],[.816144,.302368,.451816],[.819651,.306812,.448306],[.823132,.311261,
.444806],[.826588,.315714,.441316],[.830018,.320172,.437836],[.833422,.324635,.434366],[.836801,.329105,.430905],[.840155,.33358,.427455],[.843484,.338062,.424013],[.846788,.342551,.420579],[.850066,.347048,.417153],[.853319,.351553,.413734],[.856547,.356066,.410322],[.85975,.360588,.406917],[.862927,.365119,.403519],[.866078,.36966,.400126],[.869203,.374212,.396738],[.872303,.378774,.393355],[.875376,.383347,.389976],[.878423,.387932,.3866],[.881443,.392529,.383229],[.884436,.397139,.37986],[.887402,
.401762,.376494],[.89034,.406398,.37313],[.89325,.411048,.369768],[.896131,.415712,.366407],[.898984,.420392,.363047],[.901807,.425087,.359688],[.904601,.429797,.356329],[.907365,.434524,.35297],[.910098,.439268,.34961],[.9128,.444029,.346251],[.915471,.448807,.34289],[.918109,.453603,.339529],[.920714,.458417,.336166],[.923287,.463251,.332801],[.925825,.468103,.329435],[.928329,.472975,.326067],[.930798,.477867,.322697],[.933232,.48278,.319325],[.93563,.487712,.315952],[.93799,.492667,.312575],[.940313,
.497642,.309197],[.942598,.502639,.305816],[.944844,.507658,.302433],[.947051,.512699,.299049],[.949217,.517763,.295662],[.951344,.52285,.292275],[.953428,.52796,.288883],[.95547,.533093,.28549],[.957469,.53825,.282096],[.959424,.543431,.278701],[.961336,.548636,.275305],[.963203,.553865,.271909],[.965024,.559118,.268513],[.966798,.564396,.265118],[.968526,.5697,.261721],[.970205,.575028,.258325],[.971835,.580382,.254931],[.973416,.585761,.25154],[.974947,.591165,.248151],[.976428,.596595,.244767],
[.977856,.602051,.241387],[.979233,.607532,.238013],[.980556,.613039,.234646],[.981826,.618572,.231287],[.983041,.624131,.227937],[.984199,.629718,.224595],[.985301,.63533,.221265],[.986345,.640969,.217948],[.987332,.646633,.214648],[.98826,.652325,.211364],[.989128,.658043,.2081],[.989935,.663787,.204859],[.990681,.669558,.201642],[.991365,.675355,.198453],[.991985,.681179,.195295],[.992541,.68703,.19217],[.993032,.692907,.189084],[.993456,.69881,.186041],[.993814,.704741,.183043],[.994103,.710698,
.180097],[.994324,.716681,.177208],[.994474,.722691,.174381],[.994553,.728728,.171622],[.994561,.734791,.168938],[.994495,.74088,.166335],[.994355,.746995,.163821],[.994141,.753137,.161404],[.993851,.759304,.159092],[.993482,.765499,.156891],[.993033,.77172,.154808],[.992505,.777967,.152855],[.991897,.784239,.151042],[.991209,.790537,.149377],[.990439,.796859,.14787],[.989587,.803205,.146529],[.988648,.809579,.145357],[.987621,.815978,.144363],[.986509,.822401,.143557],[.985314,.828846,.142945],[.984031,
.835315,.142528],[.982653,.841812,.142303],[.98119,.848329,.142279],[.979644,.854866,.142453],[.977995,.861432,.142808],[.976265,.868016,.143351],[.974443,.874622,.144061],[.97253,.88125,.144923],[.970533,.887896,.145919],[.968443,.894564,.147014],[.966271,.901249,.14818],[.964021,.90795,.14937],[.961681,.914672,.15052],[.959276,.921407,.151566],[.956808,.928152,.152409],[.954287,.934908,.152921],[.951726,.941671,.152925],[.949151,.948435,.152178],[.946602,.95519,.150328],[.944152,.961916,.146861],
[.941896,.96859,.140956],[.940015,.975158,.131326]])),a.checkNew(new a.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]])),a.checkNew(new a.Colormap("aips0",[[.196,.196,.196],[.475,0,.608],[0,0,.785],[.373,.655,.925],[0,.596,0],[0,.965,0],[1,1,0],[1,.694,0],[1,0,0]])),a.checkNew(new a.Colormap("sls",[[0,0,0],[.043442,0,.052883],[.086883,0,.105767],[.130325,0,.15865],[.173767,0,.211533],[.217208,0,.264417],[.26065,0,.3173],[.304092,0,.370183],[.347533,0,.423067],[.390975,
0,.47595],[.434417,0,.528833],[.477858,0,.581717],[.5213,0,.6346],[.506742,0,.640217],[.492183,0,.645833],[.477625,0,.65145],[.463067,0,.657067],[.448508,0,.662683],[.43395,0,.6683],[.419392,0,.673917],[.404833,0,.679533],[.390275,0,.68515],[.375717,0,.690767],[.361158,0,.696383],[.3466,0,.702],[.317717,0,.712192],[.288833,0,.722383],[.25995,0,.732575],[.231067,0,.742767],[.202183,0,.752958],[.1733,0,.76315],[.144417,0,.773342],[.115533,0,.783533],[.08665,0,.793725],[.057767,0,.803917],[.028883,0,
.814108],[0,0,.8243],[0,.019817,.838942],[0,.039633,.853583],[0,.05945,.868225],[0,.079267,.882867],[0,.099083,.897508],[0,.1189,.91215],[0,.138717,.926792],[0,.158533,.941433],[0,.17835,.956075],[0,.198167,.970717],[0,.217983,.985358],[0,.2378,1],[0,.268533,1],[0,.299267,1],[0,.33,1],[0,.360733,1],[0,.391467,1],[0,.4222,1],[0,.452933,1],[0,.483667,1],[0,.5144,1],[0,.545133,1],[0,.575867,1],[0,.6066,1],[0,.631733,.9753],[0,.656867,.9506],[0,.682,.9259],[0,.707133,.9012],[0,.732267,.8765],[0,.7574,
.8518],[0,.782533,.8271],[0,.807667,.8024],[0,.8328,.7777],[0,.857933,.753],[0,.883067,.7283],[0,.9082,.7036],[0,.901908,.676675],[0,.895617,.64975],[0,.889325,.622825],[0,.883033,.5959],[0,.876742,.568975],[0,.87045,.54205],[0,.864158,.515125],[0,.857867,.4882],[0,.851575,.461275],[0,.845283,.43435],[0,.838992,.407425],[0,.8327,.3805],[0,.832308,.354858],[0,.831917,.329217],[0,.831525,.303575],[0,.831133,.277933],[0,.830742,.252292],[0,.83035,.22665],[0,.829958,.201008],[0,.829567,.175367],[0,.829175,
.149725],[0,.828783,.124083],[0,.828392,.098442],[0,.828,.0728],[.033167,.834167,.066733],[.066333,.840333,.060667],[.0995,.8465,.0546],[.132667,.852667,.048533],[.165833,.858833,.042467],[.199,.865,.0364],[.232167,.871167,.030333],[.265333,.877333,.024267],[.2985,.8835,.0182],[.331667,.889667,.012133],[.364833,.895833,.006067],[.398,.902,0],[.43095,.902,0],[.4639,.902,0],[.49685,.902,0],[.5298,.902,0],[.56275,.902,0],[.5957,.902,0],[.62865,.902,0],[.6616,.902,0],[.69455,.902,0],[.7275,.902,0],[.76045,
.902,0],[.7934,.902,0],[.810617,.897133,.003983],[.827833,.892267,.007967],[.84505,.8874,.01195],[.862267,.882533,.015933],[.879483,.877667,.019917],[.8967,.8728,.0239],[.913917,.867933,.027883],[.931133,.863067,.031867],[.94835,.8582,.03585],[.965567,.853333,.039833],[.982783,.848467,.043817],[1,.8436,.0478],[.995725,.824892,.0516],[.99145,.806183,.0554],[.987175,.787475,.0592],[.9829,.768767,.063],[.978625,.750058,.0668],[.97435,.73135,.0706],[.970075,.712642,.0744],[.9658,.693933,.0782],[.961525,
.675225,.082],[.95725,.656517,.0858],[.952975,.637808,.0896],[.9487,.6191,.0934],[.952975,.600408,.085617],[.95725,.581717,.077833],[.961525,.563025,.07005],[.9658,.544333,.062267],[.970075,.525642,.054483],[.97435,.50695,.0467],[.978625,.488258,.038917],[.9829,.469567,.031133],[.987175,.450875,.02335],[.99145,.432183,.015567],[.995725,.413492,.007783],[1,.3948,0],[.998342,.3619,0],[.996683,.329,0],[.995025,.2961,0],[.993367,.2632,0],[.991708,.2303,0],[.99005,.1974,0],[.988392,.1645,0],[.986733,.1316,
0],[.985075,.0987,0],[.983417,.0658,0],[.981758,.0329,0],[.9801,0,0],[.955925,0,0],[.93175,0,0],[.907575,0,0],[.8834,0,0],[.859225,0,0],[.83505,0,0],[.810875,0,0],[.7867,0,0],[.762525,0,0],[.73835,0,0],[.714175,0,0],[.69,0,0],[.715833,.083333,.083333],[.741667,.166667,.166667],[.7675,.25,.25],[.793333,.333333,.333333],[.819167,.416667,.416667],[.845,.5,.5],[.870833,.583333,.583333],[.896667,.666667,.666667],[.9225,.75,.75],[.948333,.833333,.833333],[.974167,.916667,.916667],[1,1,1],[1,1,1],[1,1,1],
[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]])),a.checkNew(new a.Colormap("a",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.25,1],[.5,0],[.77,0],[1,1]],[[0,0],[.125,0],[.5,1],[.64,.5],[.77,0],[1,0]])),a.checkNew(new a.Colormap("b",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.5,0],[.75,1],[1,1]],[[0,0],[.25,1],[.5,0],[.75,0],[1,1]])),a.checkNew(new a.Colormap("bb",[[0,0],[.5,1],[1,1]],[[0,0],[.25,0],[.75,1],[1,1]],[[0,0],[.5,0],[1,1]])),a.checkNew(new a.Colormap("he",[[0,0],[.015,.5],[.25,.5],[.5,.75],[1,1]],[[0,0],[.065,
0],[.125,.5],[.25,.75],[.5,.81],[1,1]],[[0,0],[.015,.125],[.03,.375],[.065,.625],[.25,.25],[1,1]])),a.checkNew(new a.Colormap("hsv",function(){var a,b=0,d=[];for(a=0;200>a;a++,b++){var e=1-a/199;var f=360*e+270;var h=Math.abs(Math.sin(3.1416*e));for(e=Math.pow(1-e,1/3);360<=f;)f-=360;f/=60;var g=Math.floor(f);var k=f-g;f=e*(1-h);var l=e*(1-h*k);h=e*(1-h*(1-k));d[b]=[];switch(g){case 0:d[b].push(e);d[b].push(h);d[b].push(f);break;case 1:d[b].push(l);d[b].push(e);d[b].push(f);break;case 2:d[b].push(f);
d[b].push(e);d[b].push(h);break;case 3:d[b].push(f);d[b].push(l);d[b].push(e);break;case 4:d[b].push(h);d[b].push(f);d[b].push(e);break;case 5:d[b].push(e),d[b].push(f),d[b].push(l)}}return d}())),a.checkNew(new a.Colormap("rainbow",[[0,1],[.2,0],[.6,0],[.8,1],[1,1]],[[0,0],[.2,0],[.4,1],[.8,1],[1,0]],[[0,1],[.4,1],[.6,0],[1,0]])),a.checkNew(new a.Colormap("standard",[[0,0],[.333,.3],[.333,0],[.666,.3],[.666,.3],[1,1]],[[0,0],[.333,.3],[.333,.3],[.666,1],[.666,0],[1,.3]],[[0,0],[.333,1],[.333,0],
[.666,.3],[.666,0],[1,.3]])),a.checkNew(new a.Colormap("staircase",function(){var a,b=0,d=[];for(a=1;5>=a;a++,b++){var e=a/5;d[b]=[];d[b].push(.3*e);d[b].push(.3*e);d[b].push(e)}for(a=1;5>=a;a++,b++)e=a/5,d[b]=[],d[b].push(.3*e),d[b].push(e),d[b].push(.3*e);for(a=1;5>=a;a++,b++)e=a/5,d[b]=[],d[b].push(e),d[b].push(.3*e),d[b].push(.3*e);return d}())),a.checkNew(new a.Colormap("color",[[0,0,0],[.18431,.18431,.18431],[.37255,.37255,.37255],[.56078,.56078,.56078],[.74902,.74902,.74902],[.93725,.93725,
.93725],[0,.18431,.93725],[0,.37255,.74902],[0,.49804,.49804],[0,.74902,.3098],[0,.93725,0],[.3098,.62353,0],[.49804,.49804,0],[.62353,.3098,0],[.93725,0,0],[.74902,0,.3098]])))};a.initCommands=function(){a.hasOwnProperty("Command")&&(a.checkNew(new a.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,b,d="",e=this.image;if(e&&e.analysisPackages)for(b=0;b<e.analysisPackages.length;b++){var f=e.analysisPackages[b];for(a=0;a<f.length;a++){var h=f[a];
d&&(d+=", ");var g=h.xclass?h.xclass+":"+h.name:h.name;d+=h.title+" ("+g+")"}b<e.analysisPackages.length-1&&(d+="\n")}return d},set:function(c){var b,d=this.image;d&&((b=d.lookupAnalysis(c[0]))?b.purl?(c=d.displayAnalysis("params",a.InstallDir(b.purl),{title:b.title+": "+d.fitsFile}),$(c).data("dispid",d.display.id).data("aname",b.name)):d.runAnalysis(b.name):a.error("unknown analysis command '"+c[0]+"'"))}})),a.checkNew(new a.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",
get:function(){var a;if(a=this.image)return a=a.getColormap(),a.colormap+" "+a.contrast+" "+a.bias},set:function(a){var b=this.image;b&&b.setColormap.apply(b,$jscomp.arrayFromIterable(a))}})),a.checkNew(new a.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var c,b="";for(c=0;c<a.colormaps.length;c++)b&&(b+=", "),b+=a.colormaps[c].name;return b}})),a.checkNew(new a.Command({name:"global",help:"set/get a JS9.globalOpts parameter",set:function(c){if(1==c.length){if(c=
a.globalOpts[c[0]],a.notNull(c))switch(typeof c){case "boolean":return c?"true":"false";case "number":return String(c);case "string":return c;case "object":return JSON.stringify(c);default:return""}}else if(2<=c.length){var b=c[0];c=c[1];if("string"===typeof b&&"string"===typeof c)switch(typeof a.globalOpts[b]){case "boolean":a.globalOpts[b]=c.match(/true/i)?!0:!1;break;case "number":a.globalOpts[b]=parseFloat(c);break;case "string":a.globalOpts[b]=c;break;case "object":try{c=JSON.parse(c)}catch(d){a.error("invalid JSON for global cmd: "+
c)}a.globalOpts[b]=c}}}})),a.checkNew(new a.Command({name:"grid",help:"set/get coordinate grid for current image",get:function(){var a,b=this.image;b&&(a=b.displayCoordGrid());return a?"true":"false"},set:function(a){var b=this.image;if(b){var c=a[0].match(/true/i)?!0:!1;b.displayCoordGrid(c,a[1])}}})),a.checkNew(new a.Command({name:"help",help:"get list of available commmands",get:function(){var c,b="<table class='JS9CmdHelp'>";for(c=0;c<a.commands.length;c++){var d=a.commands[c];b+="<tr><td>"+d.name+
"</td><td>"+d.help;d.alias&&(b+=" ("+d.alias,d.alias2&&(b+=", "+d.alias2),b+=")");b+="</td></tr>"}return b+'<tr><td colspan="2">&nbsp;</td></tr><tr><td colspan="2">Or execute JS9 public access routines (use spaceless args, please):</td></tr><tr><td colspan="2">&nbsp;</td></tr><tr><td colspan="2">SetColormap heat</td></tr><tr><td colspan="2">GetColormap</td></tr><tr><td colspan="2">{"colormap":"heat","contrast":3.75,"bias":0.736328125}</td></tr><tr><td colspan="2">AddRegions circle(23:23:27.9,+58:48:42.8,3") {"color":"cyan"}</td></tr></table>'}})),
a.checkNew(new a.Command({name:"helper",help:"set/get helper connection",get:function(){return a.helper.connectinfo()},set:function(c){a.helper.connect(c[0].trim())}})),a.checkNew(new a.Command({name:"image",help:"get name of current image or display specified image",get:function(){var a=this.image;if(a)return a.file},set:function(c){var b;for(b=0;b<a.images.length;b++){var d=a.images[b];if(0<=d.file.search(c[0])&&d.display===this.display){d.displayImage("display");break}}}})),a.checkNew(new a.Command({name:"images",
help:"get list of currently loaded images",get:function(){var c,b="";for(c=0;c<a.images.length;c++){var d=a.images[c];d.display===this.display&&(b&&(b+=", "),b+=d.file)}return b}})),a.checkNew(new a.Command({name:"load",help:"load image(s)",set:function(c){var b,d=c.length;for(b=0;b<d;b++){var e=null;var f=b+1;if(f<d&&c[f].startsWith("{"))try{e=JSON.parse(c[f])}catch(h){e=null}e?(a.Load(c[b],e,{display:this.display.id}),b++):a.Load(c[b],{display:this.display.id})}}})),a.checkNew(new a.Command({name:"pan",
help:"set/get pan location for current image",get:function(){var a;if(a=this.image)return a=a.getPan(),a.x+" "+a.x},set:function(a){var b=this.image;b&&b.setPan.apply(b,$jscomp.arrayFromIterable(a))}})),a.checkNew(new a.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(c){var b=this.image;if(b)return c=a.Pix2WCS(parseFloat(c[0]),parseFloat(c[1]),{display:b}),c.str}})),a.checkNew(new a.Command({name:"print",help:"print image window",get:function(){var a=this.image;
a&&a.print()}})),a.checkNew(new a.Command({name:"refresh",help:"refresh image using specified file (def: use last file)",set:function(c){var b=c.length;var d=this.image;if(0===b){var e={refresh:d};a.Load(d.file,e,{display:this.display.id})}else for(d=0;d<b;d++){e=null;var f=d+1;if(f<b&&c[f].startsWith("{"))try{e=JSON.parse(c[f])}catch(h){e=null}e?(e.refresh=!0,a.Load(c[d],e,{display:this.display.id}),d++):(e={refresh:!0},a.Load(c[d],e,{display:this.display.id}))}}})),a.checkNew(new a.Command({name:"regcnts",
help:"counts in regions for current image",get:function(){var a=this.image;a&&a.countsInRegions("$sregions","$bregions",{lightwin:!0})},set:function(a){var b=this.image;if(b)return b.countsInRegions.apply(b,$jscomp.arrayFromIterable(a))}})),a.checkNew(new a.Command({name:"regions",alias:"reg",alias2:"region",help:"add or list region(s)",get:function(){var a=this.image;if(a)return a.listRegions("all",{mode:0})||""},set:function(a){var b=this.image;b&&("delete"===a[0]||"remove"===a[0]?(a=a.slice(1).join(" "),
b.removeShapes("regions",a)):(a=a.join(" "),b.addShapes("regions",a)))}})),a.checkNew(new a.Command({name:"resize",help:"set/get display size for current image",get:function(){var a;if(a=this.image)return a=a.display,a.width+" "+a.height},set:function(a){var b;if((b=this.image)&&a.length){b=b.display;var c=parseInt(a[0],10);a=1<a.length?parseInt(a[1],10):c;b.resize(c,a)}}})),a.checkNew(new a.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;if(a=this.image)return a=
a.getScale(),a.scale+" "+a.scalemin+" "+a.scalemax},set:function(a){var b=this.image;b&&b.setScale.apply(b,$jscomp.arrayFromIterable(a))}})),a.checkNew(new a.Command({name:"scales",help:"get list of available scales",get:function(){return a.scales.join(", ")}})),a.checkNew(new a.Command({name:"section",help:"display section of current image",set:function(c){var b=this.image;if(1===c.length&&"full"===c[0])b.displaySection("full");else if(c=c.join(" ")){try{var d=JSON.parse(c)}catch(e){a.error("invalid JSON section")}b.displaySection(d)}}})),
a.checkNew(new a.Command({name:"status",help:"get status for specified (or current) image",get:function(c){var b,d="";for(b=0;b<a.images.length;b++){var e=a.images[b];if(0<=e.file.search(c[0])){var f=e;break}}f?b=1:(b=0,f=this.image);if(f){if(b>c.length)return f.status.load;for(;b<c.length;b++)switch(e=c[b].toLowerCase().trim(),e){case "load":d&&(d+="\n"),d+=f.status.load}}return d}})),a.checkNew(new a.Command({name:"url",help:"display a url",set:function(c){a.DisplayHelp(c[0])}})),a.checkNew(new a.Command({name:"wcssys",
help:"set/get wcs system for current image",get:function(){var a=this.image;if(a)return a.getWCSSys()},set:function(a){var b=this.image;b&&b.setWCSSys(a[0])}})),a.checkNew(new a.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var a=this.image;if(a)return a.getWCSUnits()},set:function(a){var b=this.image;b&&b.setWCSUnits(a[0])}})),a.checkNew(new a.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return a.wcssyss.join(", ")}})),a.checkNew(new a.Command({name:"wcsunits",
help:"get list of available wcs units",get:function(){return a.wcsunitss.join(", ")}})),a.checkNew(new a.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(c){var b=this.image;if(b)return c=a.WCS2Pix(parseFloat(c[0]),parseFloat(c[1]),{display:b}),c.str}})),a.checkNew(new a.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;if(a)return a.getZoom()},set:function(a){var b=this.image;b&&b.setZoom(a[0])}})))};a.initAnalysis=function(){$(document).on("keypress",
".js9AnalysisForm, .js9Form, .js9Input",function(a){var b;if(13===(a.which||a.keyCode)){a.preventDefault();if(b=$(a.currentTarget).data("enterfunc")){var c=$(a.currentTarget).find("[name='"+b+"']");c.length?c.click():(c=$(a.currentTarget).siblings("[name='"+b+"']"),c.length&&c.click())}return!1}})};a.parsePublicArgs=function(a){var b=null;a=Array.from(a);var c=a[a.length-1];c&&"object"===typeof c&&c.hasOwnProperty("display")&&1===Object.keys(c).length&&(b=c.display,a.pop());return{argv:a,display:b}};
a.mkPublic=function(c,b){"string"===typeof b?a.Image.prototype[b]?(a[c]=function(c){for(var d=[],f=0;f<arguments.length;++f)d[f-0]=arguments[f];f=a.parsePublicArgs(d);d=f.argv;if(f=a.getImage(f.display))return d=f[b].apply(f,$jscomp.arrayFromIterable(d)),d===f||d===f.display?a.globalOpts.quietReturn?"":"OK":d},a.publics[c]=a[c]):a.error("unknown image func for mkPublic: "+b):"function"===typeof b?(a[c]=b,a.publics[c]=a[c]):a.error("unsupported type for mkPublic: "+typeof b)};a.mkPublic("CloseImage",
"closeImage");a.mkPublic("DisplayImage","displayImage");a.mkPublic("DisplayExtension","displayExtension");a.mkPublic("DisplaySlice","displaySlice");a.mkPublic("DisplaySection","displaySection");a.mkPublic("BlendImage","blendImage");a.mkPublic("MaskImage","maskImage");a.mkPublic("GetColormap","getColormap");a.mkPublic("SetColormap","setColormap");a.mkPublic("GetZoom","getZoom");a.mkPublic("SetZoom","setZoom");a.mkPublic("GetPan","getPan");a.mkPublic("SetPan","setPan");a.mkPublic("AlignPanZoom","alignPanZoom");
a.mkPublic("GetScale","getScale");a.mkPublic("SetScale","setScale");a.mkPublic("GetOpacity","getOpacity");a.mkPublic("SetOpacity","setOpacity");a.mkPublic("SetFlip","setFlip");a.mkPublic("GetFlip","getFlip");a.mkPublic("SetRotate","setRotate");a.mkPublic("GetRotate","getRotate");a.mkPublic("SetRot90","setRot90");a.mkPublic("GetRot90","getRot90");a.mkPublic("GetParam","getParam");a.mkPublic("SetParam","setParam");a.mkPublic("CopyParams","copyParams");a.mkPublic("GetValPos","updateValpos");a.mkPublic("ImageToDisplayPos",
"imageToDisplayPos");a.mkPublic("DisplayToImagePos","displayToImagePos");a.mkPublic("ImageToLogicalPos","imageToLogicalPos");a.mkPublic("LogicalToImagePos","logicalToImagePos");a.mkPublic("GetWCSUnits","getWCSUnits");a.mkPublic("SetWCSUnits","setWCSUnits");a.mkPublic("GetWCS","getWCS");a.mkPublic("SetWCS","setWCS");a.mkPublic("GetWCSSys","getWCSSys");a.mkPublic("SetWCSSys","setWCSSys");a.mkPublic("ShowShapeLayer","showShapeLayer");a.mkPublic("ActiveShapeLayer","activeShapeLayer");a.mkPublic("ToggleShapeLayers",
"toggleShapeLayers");a.mkPublic("AddShapes","addShapes");a.mkPublic("RemoveShapes","removeShapes");a.mkPublic("GetShapes","getShapes");a.mkPublic("ChangeShapes","changeShapes");a.mkPublic("CopyShapes","copyShapes");a.mkPublic("SelectShapes","selectShapes");a.mkPublic("DisplayCoordGrid","displayCoordGrid");a.mkPublic("Print","print");a.mkPublic("SavePNG","savePNG");a.mkPublic("SaveJPEG","saveJPEG");a.mkPublic("SaveFITS","saveFITS");a.mkPublic("UploadFITSFile","uploadFITSFile");a.mkPublic("CountsInRegions",
"countsInRegions");a.mkPublic("RadialProfile","radialProfile");a.mkPublic("Plot3D","plot3d");a.mkPublic("RunAnalysis","runAnalysis");a.mkPublic("GetAnalysis","getAnalysis");a.mkPublic("RawDataLayer","rawDataLayer");a.mkPublic("GaussBlurData","gaussBlurData");a.mkPublic("ImarithData","imarithData");a.mkPublic("RotateData","rotateData");a.mkPublic("ReprojectData","reprojectData");a.mkPublic("ShiftData","shiftData");a.mkPublic("FilterRGBImage","filterRGBImage");a.mkPublic("MoveToDisplay","moveToDisplay");
a.mkPublic("LookupImage",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);return a.lookupImage(b.argv[0],b.display)});a.mkPublic("LookupDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);return a.lookupDisplay(b.argv[0]||b.display,b.argv[1])});a.mkPublic("DisplayNextImage",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);if(b=a.lookupDisplay(d.display))return d=
parseFloat(d.argv[0])||1,b.nextImage(d)});a.mkPublic("RenameDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e;d=a.parsePublicArgs(b);switch(d.argv.length){case 0:return;case 1:b=d.display;d=d.argv[0];break;default:b=d.argv[0],d=d.argv[1]}(e=a.lookupDisplay(b))&&e.id&&(b=e.id,e.oid||(e.oid=b),e.id=d,a.helper.send("renameDisplay",{odisplay:b,ndisplay:e.id}))});a.mkPublic("CloseDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);
b=a.lookupDisplay(d.argv[0],!1);if(!b){b=a.lookupDisplay(d.display);var e=d.argv[0]}if(e=d.argv[1]||e)try{var f=new RegExp(e)}catch(h){a.error("invalid regexp for CloseDisplay: "+e)}for(e=a.images.length-1;0<=e;e--)d=a.images[e],d.display===b&&(f?(d.id.match(f)||d.file.match(f)||d.fitsFile.match(f))&&d.closeImage():d.closeImage())});a.mkPublic("AddColormap",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b),f=function(b,c){var d;"object"!==typeof b&&
a.error("invalid colormap object for JS9.AddColormap()");$.isArray(b)||(b=[b]);for(d=0;d<b.length;d++){var e=b[d];e.name||a.error("missing name for colormap in JS9.AddColormap()");e.vertices?a.AddColormap(e.name,e.vertices[0],e.vertices[1],e.vertices[2],c):e.colors?a.AddColormap(e.name,e.colors,c):a.error("unknown colormap type for JS9.AddColormap()")}};b=e.argv[0];var h=e.argv[1];d=e.argv[2];var g=e.argv[3];var k=e.argv[4];if(b instanceof Blob)d=new FileReader,d.onload=function(b){try{l=JSON.parse(b.target.result)}catch(n){a.error("can't parse JSON colormap",
n)}f(l,h)},d.readAsText(b);else if("object"===typeof b)f(b,h);else switch(e.argv.length){case 1:try{var l=JSON.parse(b)}catch(m){a.error("can't parse JSON colormap",m)}f(l);break;case 2:case 3:if("string"===typeof h)try{h=JSON.parse(h)}catch(m){a.error("can't parse JSON colormap",m)}a.checkNew(new a.Colormap(b,h));2===e.argv.length?a.globalOpts.topColormaps.push(b):("object"!==typeof d||!1!==d.toplevel)&&a.globalOpts.topColormaps.push(b);break;case 4:case 5:if("string"===typeof h)try{h=JSON.parse(h)}catch(m){a.error("can't parse JSON colormap",
m)}if("string"===typeof d)try{d=JSON.parse(d)}catch(m){a.error("can't parse JSON colormap",m)}if("string"===typeof g)try{g=JSON.parse(g)}catch(m){a.error("can't parse JSON colormap",m)}a.checkNew(new a.Colormap(b,h,d,g));4===e.argv.length?a.globalOpts.topColormaps.push(b):k&&"object"===typeof k&&!1===k.toplevel||a.globalOpts.topColormaps.push(b);break;default:a.error("AddColormap() requires a colormap name and 1 or 3 args")}});a.mkPublic("LoadColormap",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-
0]=arguments[d];d=a.parsePublicArgs(b);b=d.argv[0];var e=d.argv[1];b||a.error("JS9.LoadColormap: no file specified for colormap load");"object"===typeof b?a.AddColormap(b,e):"string"===typeof b?(b=a.fixPath(b,e),a.fetchURL(null,b,null,function(b){a.AddColormap(b,e)})):a.error("unknown file type for LoadColormap: "+typeof b)});a.mkPublic("SetRGBMode",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b),f=a.lookupDisplay(e.display),h=["red","green","blue"],
g=["rid","gid","bid"];var k=e.argv[0];var l=e.argv[1];void 0===k&&(k=!f.rgb.active);if(l)for(b=0;3>b;b++)d=l[g[b]],"string"===typeof d&&(d=a.LookupImage(d)),d&&d.setColormap(h[b]);"true"===k?k=!0:"false"===k&&(k=!1);f.rgb.active=!!k;a.DisplayImage({display:e.display});return f.rgb.active});a.mkPublic("GetRGBMode",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);b=a.lookupDisplay(b.display);return{active:b.rgb.active,rid:b.rgb.rim?b.rgb.rim.id:null,gid:b.rgb.gim?
b.rgb.gim.id:null,bid:b.rgb.bim?b.rgb.bim.id:null}});a.mkPublic("SetValPos",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=null;var e=a.parsePublicArgs(b);b=a.getImage(e.display);e=e.argv[0];b&&(d=b.params.valpos,b.params.valpos=e);return d});a.mkPublic("SetImageInherit",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=null;var e=a.parsePublicArgs(b);b=a.getImage(e.display);e=e.argv[0];b&&(d=b.params.inherit,b.params.inherit=e);return d});a.mkPublic("GetImageInherit",
function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=null;b=a.parsePublicArgs(b);if(b=a.getImage(b.display))d=b.params.inherit;return d});a.mkPublic("Load",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e;d="fits";var f=a.parsePublicArgs(b);var h=f.argv[0];b=f.argv[1];if(h){f=f.display?f.display:0<a.displays.length?a.displays[0].id:a.DEFID;if("object"===typeof b)b=$.extend(!0,{},b);else if(b&&"string"===typeof b)try{b=JSON.parse(b)}catch(l){b={}}else b=
{};b.display=b.display||f;if(b.onload)var g=b.onload;else a.imageOpts.onload&&(g=a.imageOpts.onload,b.onload=g);delete a.fetchURL.status;if(h instanceof Blob){if(h.path||h.name)if(b.filename=h.path||h.name,f="object"===typeof b.refresh?b.refresh:a.lookupImage(b.filename,b.display))if(a.isNull(b.refresh)&&(b.refresh=a.globalOpts.reloadRefresh),b.refresh)b.refresh=f;else{f.displayImage("display",b);f.refreshLayers();f.display.clearMessage();if(b.onload)try{a.xeqByName(b.onload,window,f)}catch(l){a.error("in image onload callback",
l,!1)}a.waiting(!1);return}else delete b.refresh;else delete b.refresh;b.filename||(b.filename=a.ANON+a.uniqueID());if(h.type&&h.type.includes("image/"))switch(h.type){case "image/fits":break;default:d="img"}else b.filename.split(".").pop().match(/(png|jpg|jpeg)/i)&&(d="img");switch(d){case "fits":var k=$.extend(!0,{},a.fits.options,b);h.path&&b.localAccess&&(g=a.localAccess(h.path))&&(h=h.path,k.file=h,k.vfile=g);try{a.handleFITSFile(h,k,a.NewFitsImage)}catch(l){a.error("can't process FITS file",
l)}break;case "img":try{a.handleImageFile(h,b,a.Load)}catch(l){a.error("can't process IMG file",l)}}}else if("object"===typeof h)a.checkNew(new a.Image(h,b,g));else if("string"!==typeof h&&a.error("unknown file type for Load: "+typeof h),"U0lNUExFICA9"===h.slice(0,12)&&(h=window.atob(h)),"SIMPLE  ="===h.slice(0,9)){g=[];for(e=0;e<h.length;e++)g[e]=h.charCodeAt(e);e=new Blob([new Uint8Array(g)]);b.filename||(b.filename=a.ANON+a.uniqueID());e.name=b.filename;k=$.extend(!0,{},a.fits.options,b);try{a.handleFITSFile(e,
k,a.NewFitsImage)}catch(l){a.error("can't process FITS file",l)}}else{a.isNull(b.refresh)&&(b.refresh=a.globalOpts.reloadRefresh);if(b.refresh)if("object"===typeof b.refresh)f=b.refresh;else{if(d=h.split("/").reverse()[0],f=a.lookupImage(d,b.display))b.refresh=f}else d=h.split("/").reverse()[0],f=a.lookupImage(d,b.display);if(f&&!b.refresh){f.displayImage("all",b);f.display.clearMessage();if(b.onload)try{a.xeqByName(b.onload,window,f)}catch(l){a.error("in image onload callback",l,!1)}a.waiting(!1)}else h=
a.cleanPath(h),"png"===h.split(".").pop().toLowerCase()?a.globalOpts.pngisfits?a.checkNew(new a.Image(h,b,g)):(h=a.fixPath(h,b),a.fetchURL(null,h,b,a.NewFitsImage)):a.fits2RepFile(b.display,h,b,"fits")||a.fits2RepFile(b.display,h,b,"png",g)||(b.display&&(e=a.lookupDisplay(b.display)),a.waiting(!0,e),f&&b.refresh&&a.cleanupFITSFile(f.raw,!0),h=a.fixPath(h,b),e=h.replace(/\[.*\]/,""),(g=a.localAccess(h))?(k=$.extend(!0,{},a.fits.options,b),k.file=h,k.vfile=g,window.setTimeout(function(){try{a.handleFITSFile(h,
k,a.NewFitsImage)}catch(l){a.error("can't process FITS file",l)}},0)):a.fetchURL(h,e,b))}}else a.error("JS9.Load: no file specified for image load")});a.mkPublic("LoadWindow",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e,f,h,g,k,l,m,n=a.lightOpts[a.LIGHTWIN];var p=a.parsePublicArgs(b);var q=function(b){b=$.inArray(b,a.displays);0<=b&&a.displays.splice(b,1)};var r=function(b,c,d){var f;c=c||{};c.clone&&(f=a.lookupDisplay(c.clone,!1));d&&(k=d.match(/(.*width=)([0-9]+)(px,height=)([0-9]+)(px.*)/,
"$1@@H@@$3"),l=parseInt(k[2],10),m=parseInt(k[4],10));var g="<hr class='hline0'>";!f||0<$("#"+c.clone+"Menubar").length&&!f.pluginInstances.JS9Menubar.isDynamic?g+="<div class='JS9Menubar' id='"+b+"Menubar'></div>":d&&(m-=40);g+="<div class='JS9' id='"+b+"'></div>";!f||0<$("#"+c.clone+"Colorbar").length&&0===$("#"+c.clone+"Statusbar").length&&!f.pluginInstances.JS9Colorbar.isDynamic?(e=f&&f.pluginInstances.JS9Colorbar?"data-showTicks='"+f.pluginInstances.JS9Colorbar.showTicks+"'":"",g+="<div style='margin-top: 2px;'><div class='JS9Colorbar' id='"+
b+"Colorbar' "+e+"></div></div>",f&&f.pluginInstances.JS9Colorbar&&!f.pluginInstances.JS9Colorbar.showTicks&&(m-=15)):d&&(m-=44);!f||0<$("#"+c.clone+"Statusbar").length&&!f.pluginInstances.JS9Statusbar.isDynamic?g+="<div class='JS9Statusbar' id='"+b+"Statusbar'></div>":d&&(m-=40);return d?(a.Dysel.retrievePlugins().length&&(l+=2,m+=2),{html:g,winopts:k[1]+String(l)+k[3]+String(m)+k[5]}):g};var v=function(b,c){var d=new a.Display(x);d.winid=A;a.helper.send("addDisplay",{display:x});a.instantiatePlugins();
c.display=x;b&&a.Load(b,c);return d};var w=function(b){var c;var d=0;var e=[];for(c=0;c<a.images.length;c++)d=a.images[c],d.display.id===x&&e.push(d);if(!e.length)return q(b),!0;if("move"===a.globalOpts.lightWinClose){if(a.isNull(a.globalOpts.lightWinMoveTo)||a.globalOpts.lightWinMoveTo===x)d=0;else for(d=c=0;c<a.displays.length;c++)if(a.displays[c].id===a.globalOpts.lightWinMoveTo){d++;break}d||(a.globalOpts.lightWinClose="ask",delete a.globalOpts.lightWinMoveTo)}switch(a.globalOpts.lightWinClose){case "close":q(b);
for(c=0;c<e.length;c++)try{e[c].closeImage()}catch(J){}return!0;case "move":q(b);for(c=0;c<e.length;c++)try{e[c].moveToDisplay(a.globalOpts.lightWinMoveTo)}catch(J){}return!0;default:return f="lightCloseID"+a.uniqueID(),a.allinone?(h="inline",g=a.allinone.lightCloseHTML):(h="ajax",g=a.InstallDir(a.lightOpts.lcloseURL)),$(a.lightOpts[a.LIGHTWIN].topid).arrive("#lightWinCloseForm",{onceOnly:!0},function(){var b;var c=$("#lightWinCloseForm").find("#lightWinCloseSel");for(b=0;b<a.displays.length;b++)a.displays[b].id!==
x&&c.append($("<option>",{value:a.displays[b].id,text:a.displays[b].id}))}),B=a.lightWin(f,h,g,"Closing a light window",n.lcloseWin),$(B).data("dispid",x),$(B).data("winid",A),!1}};d=p.argv[0];var t=p.argv[1];var u=p.argv[2];b=p.argv[3];p=p.argv[4];if("object"===typeof t)t=$.extend(!0,{},t);else if(t&&"string"===typeof t)try{t=JSON.parse(t)}catch(E){t={}}else t={};u=u||"light";var y=(u||"")+"win";switch(u){case "light":if(t.id){var x=t.id;delete t.id}else x=y+a.uniqueID();var B="d"+x;if(b)p=p||n.imageWin;
else{var z=r(x,t,n.imageWin);b=z.html;p=p||z.winopts}z=sprintf("JS9 Display"+a.IDFMT,x);var A=a.lightWin(B,"inline",b,z,p);var C=v(d,t);A.onclose=function(){return w(C)};return x;case "new":t.id?(x=t.id,delete t.id):x=y+a.uniqueID();p=p||"width="+a.globalOpts.newWindowWidth+", height="+a.globalOpts.newWindowHeight;v=document.getElementsByTagName("head")[0].innerHTML;v=v.replace(/src=['"].*astroemw?\.js['"]/,"");v.match(/src=["'].*js9\.js/)||v.match(/src=["'].*js9\.min\.js/)||(v+='<script type="text/javascript" src="js9.min.js">\x3c/script>');
r=b||r(x,t);b="<html><head>"+v+"</head><body";d&&(b+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",d,JSON.stringify(t)));b+=">"+r+"</body></html>\n";window.electron&&(z="data:text/html,<html><body><script>window.addEventListener('message', (ev) => {document.documentElement.innerHTML=ev.data\x3c/script><p></body></html>");if(z=window.open(z,x,p))return z.document?(z.document.open(),z.document.write(b),z.document.close()):z.postMessage?a.error("LoadWindow('new') is disabled on the Desktop for security reasons"):
a.error("no method available for drawing image into window"),x;a.error("could not create window (check your pop-up blockers)")}});a.mkPublic("LoadProxy",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e,f,h=a.parsePublicArgs(b);var g=h.argv[0];var k=h.argv[1];a.globalOpts.loadProxy||a.error("proxy load not available for server");a.globalOpts.workDir||a.error("proxy load requires a temp workDir for server");g||a.error("no url specified for proxy load");g=g.trim();g.match(/dropbox\.com/)?
(g=g.replace("www.dropbox.com","dl.dropboxusercontent.com"),g=g.replace("?dl=0","")+"?raw=1"):g.match(/drive\.google\.com/)&&(g=g.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1"));h.display&&(f=a.lookupDisplay(h.display));if("object"===typeof k)k=$.extend(!0,{},k);else if("string"===typeof k)try{k=JSON.parse(k)}catch(l){k={}}k=k||{};k.ofile?(b=k.ofile,delete k.ofile):b="";a.waiting(!0,f);a.Send("loadproxy",{cmd:"js9Xeq loadproxy "+g+" "+b},function(b){b="object"===typeof b?
b:0<=b.search(a.analOpts.epattern)?{stderr:b}:{stdout:b};b.errcode=b.errcode||0;b.stderr?a.error(b.stderr):b.stdout?(void 0===k.fits2png&&(k.fits2png=!1),e=a.cleanPath(b.stdout),k.proxyFile=e,"/"!==e.charAt(0)&&(e=a.InstallDir(e)),k.fixpath=!1,k.proxyURL=g,a.Load(e,k,{display:h.display})):a.error("internal error: no return from load proxy command")})});a.mkPublic("Preload",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e;d="";var f=null,h=null,g=b.length,k=a.globalOpts.alerts;
var l=a.parsePublicArgs(b);var m=a.URLEXP,n=/\.ses$/,p=/\.cmap$/;var q=l.argv[0];a.globalOpts.loadProxy&&a.helper.baseurl&&(e=new RegExp("^"+a.helper.baseurl));l.display&&(h={display:l.display},--g);switch(g){case 0:q=(null===a.helper.connected||a.helper.connected)&&a.fits.name&&0<a.preloads.length?2:3;break;case 1:q="boolean"===typeof q?q&&0<a.preloads.length?2:3:(null===a.helper.connected||a.helper.connected)&&a.fits.name?1:0;break;default:q=(null===a.helper.connected||a.helper.connected)&&a.fits.name?
1:0}switch(q){case 0:for(q=0;q<g;q++)if(l=q+1,l<g&&"object"===typeof b[l])f=$.extend(!0,{},b[l]),a.preloads.push([b[q],f,h]),q++;else if(l<g&&b[l].startsWith("{")){try{f=JSON.parse(b[l])}catch(v){f=null}a.preloads.push([b[q],f,h]);q++}else a.preloads.push([b[q],null,h]);break;case 1:a.globalOpts.alerts=!1;for(q=0;q<g;q++){var r=e&&b[q].match(m)&&!b[q].match(e)?a.LoadProxy:b[q].match(n)?a.LoadSession:b[q].match(p)?a.LoadColormap:a.Load;l=q+1;if(l<g&&"object"===typeof b[l]){r!==a.Load&&r!==a.LoadProxy||
a.preloadwaiting.push({id:a.cleanPath(b[q]),loaded:!1});try{h?r(b[q],b[l],h):r(b[q],b[l])}catch(v){d=d+" "+b[q]}q++}else if(l<g&&b[l].startsWith("{")){try{f=JSON.parse(b[l])}catch(v){f=null}r!==a.Load&&r!==a.LoadProxy||a.preloadwaiting.push({id:a.cleanPath(b[q]),loaded:!1});try{h?r(b[q],f,h):r(b[q],f)}catch(v){d=d+" "+b[q]}q++}else{r!==a.Load&&r!==a.LoadProxy||a.preloadwaiting.push({id:a.cleanPath(b[q]),loaded:!1});try{h?r(b[q],null,h):r(b[q],null)}catch(v){d=d+" "+b[q]}}}a.globalOpts.alerts=k;d&&
a.error("could not preload image(s): "+d);break;case 2:a.globalOpts.alerts=!1;for(q=0;q<a.preloads.length;q++){r=e&&a.preloads[q][0].match(m)&&!a.preloads[q][0].match(e)?a.LoadProxy:a.preloads[q][0].match(n)?a.LoadSession:a.preloads[q][0].match(p)?a.LoadColormap:a.Load;r!==a.Load&&r!==a.LoadProxy||a.preloadwaiting.push({id:a.cleanPath(a.cleanPath(a.preloads[q][0])),loaded:!1});try{a.preloads[q][2]?r(a.preloads[q][0],a.preloads[q][1],a.preloads[q][2]):r(a.preloads[q][0],a.preloads[q][1])}catch(v){d=
d+" "+a.preloads[q][0]}}a.globalOpts.alerts=k;d&&a.error("could not preload image(s): "+d);a.preloads=[]}});a.mkPublic("RefreshImage",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b),f=a.getImage(e.display),h=function(a){f.refreshImage(a,g)};d=e.argv[0];var g=e.argv[1]||{};if(f)if(g.id=f.id,d instanceof Blob){g.rawid&&g.rawid!==f.raw.id||a.cleanupFITSFile(f.raw,!0);try{a.handleFITSFile(d,a.fits.options,h)}catch(k){a.error("can't refresh FITS file",
k)}}else f.refreshImage(d,g);else d instanceof Blob&&a.Load.apply(a,$jscomp.arrayFromIterable(b))});a.mkPublic("GetStatus",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);d=a.getImage(b.argv[1]||b.display);var e=b.argv[0]||"load";return b.argv.length?a.fetchURL.status&&e.match(/^(pre)?load$/i)?a.fetchURL.status:d?d.getStatus(e):"none":"Load CreateMosaic DisplaySection LoadCatalog LoadRegions ReprojectData RotateData RunAnalysis".split(" ")});a.mkPublic("GetLoadStatus",
function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];return a.GetStatus.apply(a,["load"].concat($jscomp.arrayFromIterable(b)))});a.mkPublic("CopyToClipboard",function(c,b){var d;a.clipboard=c;var e=document.createElement("textarea");e.style.position="fixed";e.style.top=0;e.style.left=0;e.style.width="2em";e.style.height="2em";e.style.padding=0;e.style.border="none";e.style.outline="none";e.style.boxShadow="none";e.style.background="transparent";e.value=c;document.body.appendChild(e);
e.select();try{if(d=document.execCommand("copy"))var f="OK";else f="MANUAL",a.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",c):window.prompt("copy to clipboard: Ctrl+C",c)}catch(h){f="ERROR"}document.body.removeChild(e);b&&b.display&&(b.display.divjq.trigger("mouseout"),b.display.divjq.trigger("mouseenter"));return f});a.mkPublic("CopyFromClipboard",function(){return a.clipboard||""});a.mkPublic("OpenFileMenu",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];
b=a.parsePublicArgs(b);(b=a.lookupDisplay(b.display))&&$("#openLocalLoad-"+b.id).click()});a.mkPublic("OpenRegionsMenu",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);(b=a.lookupDisplay(b.display))&&$("#openLocalLoadRegions-"+b.id).click()});a.mkPublic("OpenSessionMenu",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);(b=a.lookupDisplay(b.display))&&$("#openLocalLoadSession-"+b.id).click()});a.mkPublic("OpenCatalogsMenu",
function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);(b=a.lookupDisplay(b.display))&&$("#openLocalLoadCatalog-"+b.id).click()});a.mkPublic("OpenColormapMenu",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);(b=a.lookupDisplay(b.display))&&$("#openLocalLoadColormap-"+b.id).click()});a.mkPublic("SaveColormap",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);var f=
function(a){var b=a;if("string"===typeof a)try{b=JSON.parse(a)}catch(n){}return b},h=function(b){var c,d,e=[];for(c=0;c<b.length;c++)if(d=a.lookupColormap(b[c]))d=$.extend(!0,{},d),delete d.type,e.push(d);return 1===e.length?e[0]:e};b=e.argv[0];d=e.argv[1];if(window.hasOwnProperty("saveAs")){if(e=a.getImage(e.display)){b=f(b);d=f(d);if(b)"string"===typeof b?(g=b,"string"===typeof d?k=h([d]):$.isArray(d)?k=h(d):(k=$.extend(!0,{},e.cmapObj),delete k.type)):$.isArray(b)&&(g="js9.cmap",k=h(b));else{var g=
"js9.cmap";var k=$.extend(!0,{},e.cmapObj);delete k.type}k=JSON.stringify(k);k=new Blob([k],{type:"text/plain"});a.saveAs(k,g)}}else a.error("no saveAs() available to save colormap");return g});a.mkPublic("NewFitsImage",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=e.argv[0];d=e.argv[1]||{};e=a.lookupDisplay(e.display||d.display||a.DEFID);if(d.refresh){if("object"===typeof d.refresh)var f=d.refresh;else e&&e.image&&(f=e.image);if(f)d.onload&&
(d.onrefresh=d.onload,delete d.onload),f.refreshImage(b,d);else{if(d.onload)var h=d.onload;a.checkNew(new a.Image(b,d,h))}}else d.onload&&(h=d.onload),a.checkNew(new a.Image(b,d,h))});a.mkPublic("GetImage",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);d=b.argv[0];"string"!==typeof d&&(d=b.display);return a.getImage(d)});a.mkPublic("GetImageData",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);b=a.getImage(d.display);
d=d.argv[0];return b?b.getImageData(d):null});a.mkPublic("GetDisplayData",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=[];var e=a.parsePublicArgs(b);b=e.display||a.displays[0].id;var f=e.argv[0];for(e=0;e<a.images.length;e++){var h=a.images[e];h.display.id===b&&d.push(h.getImageData(f))}return d});a.mkPublic("GetFITSHeader",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d="";var e=a.parsePublicArgs(b);b=a.getImage(e.display);e=e.argv[0];b&&b.raw&&
(d=a.raw2FITS(b.raw,{addcr:e}));return d});a.mkPublic("BlendDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=[];var e=a.parsePublicArgs(b);b=e.display||a.DEFID;var f=a.lookupDisplay(b);e=e.argv[0];f||a.error("no JS9 display found: "+b);if(void 0===e||"mode"===e)return f.blendMode;if("list"===e){for(e=0;e<a.images.length;e++){var h=a.images[e];h.display.id===b&&h.blend.active&&d.push(h.id)}return d}if("reset"===e){for(e=0;e<a.images.length;e++)h=a.images[e],h.display.id===
b&&h.blend.active&&h.blendImage(!1);e=!1}"true"===e?e=!0:"false"===e&&(e=!1);f.blendMode=!!e;f.image&&(f.image.xeqPlugins("image","ondisplayblend"),f.image.displayImage());return f.blendMode});a.mkPublic("LoadAuxFile",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);d=a.getImage(e.display);b=e.argv[0];e=e.argv[1];d?d.loadAuxFile(b,e):a.error("could not find image for aux file: "+b)});a.mkPublic("SubmitAnalysis",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-
0]=arguments[d];var e,f;var h=a.lightOpts[a.LIGHTWIN];var g=a.parsePublicArgs(b);var k=g.argv[0];b=g.argv[1];d=g.argv[2];b?h=a.lookupDisplay(g.display).id:(h=$(k).closest(h.top),b=h.data("aname"),h=h.data("dispid"));b?h&&(e=a.getImage(h)):f="internal error: could not find analysis task name";if(e){k=$(k).closest("form");try{var l=k.serializeArray();l=l.concat($("#"+k.attr("id")+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:"false"}}).get())}catch(m){l=null}e.runAnalysis(b,
l,d)}else f="internal error: could not find image";f&&a.error(f);return!1});a.mkPublic("Send",function(c,b,d){a.helper.connected?a.helper.send(c,b,d):a.error("no JS9 helper available")});a.mkPublic("EventToDisplayPos",function(c){return a.eventToDisplayPos(c)});a.mkPublic("PixToWCS",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=1;var e=a.parsePublicArgs(b);if(b=a.getImage(e.display)){var f=e.argv[0];if("object"===typeof f&&a.notNull(f.x)&&a.notNull(f.y)){var h=f.x;f=f.y}else h=
e.argv[0],f=e.argv[1];a.isNumber(h)&&a.isNumber(f)||a.error("invalid input for PixToWCS");if(0<b.raw.wcs)return h=a.pix2wcs(b.raw.wcs,h,f).trim(),f=h.split(/ +/),"sexagesimal"===b.params.wcsunits&&"galactic"!==b.params.wcssys&&"ecliptic"!==b.params.wcssys&&(d=15),{ra:a.saostrtod(f[0])*d,dec:a.saostrtod(f[1]),sys:f[2],str:h}}});a.Pix2WCS=a.PixToWCS;a.mkPublic("WCSToPix",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);if(d=a.getImage(e.display)){var f=
e.argv[0];"object"===typeof f&&a.notNull(f.ra)&&a.notNull(f.dec)?(b=f.ra,f=f.dec):(b=e.argv[0],f=e.argv[1]);a.isNumber(b)&&a.isNumber(f)||a.error("invalid input for WCSToPix");if(0<d.raw.wcs)return d=a.wcs2pix(d.raw.wcs,b,f).trim().split(/ +/),b=parseFloat(d[0]),f=parseFloat(d[1]),d=sprintf("%f %f",b,f),{x:b,y:f,str:d}}return null});a.WCS2Pix=a.WCSToPix;a.mkPublic("NewShapeLayer",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);d=a.getImage(e.display);
b=e.argv[0];e=e.argv[1];return d?d.display.newShapeLayer(b,e):null});a.mkPublic("AddRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);d=a.getImage(e.display);b=e.argv[0];e=e.argv[1];return d?(b||a.error("no region specified for AddRegions"),d.addShapes("regions",b,e)):null});a.mkPublic("RemoveRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);b=a.getImage(d.display);d=d.argv[0];return b?
(b.removeShapes("regions",d),b.display.clearMessage("regions"),a.globalOpts.quietReturn?"":"OK"):null});a.mkPublic("CopyRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=a.getImage(e.display);d=e.argv[0];e=e.argv[1];return b?(b.copyRegions(d,e),a.globalOpts.quietReturn?"":"OK"):null});a.mkPublic("GetRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);return(d=a.getImage(b.display))?(b.argv.unshift("regions"),
d.getShapes.apply(d,$jscomp.arrayFromIterable(b.argv))):null});a.mkPublic("ListRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);return(d=a.getImage(e.display))?(b=e.argv[0]||"all",e=e.argv[1]||{mode:2},d.listRegions(b,e,e.layer)):null});a.mkPublic("EditRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);if(b=a.getImage(b.display))if(d=b.layers.regions)(d=d.canvas.getActiveObject())&&"activeSelection"!==
d.type?b.displayRegionsForm(d):b.displayRegionsForm(null,{multi:!0});return null});a.mkPublic("ChangeRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=a.getImage(e.display);d=e.argv[0];e=e.argv[1];b&&b.changeShapes("regions",d,e);return null});a.mkPublic("SaveRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);d=a.getImage(b.display);var e=b.argv[0],f=b.argv[1],h=b.argv[2];if(d)if(1===b.argv.length&&
"dialogbox"===e)d.displayRegionsForm(null,{type:"save"});else return d.saveRegions(e,f,h);return null});a.mkPublic("SelectRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);d=a.getImage(e.display);b=e.argv[0];e=e.argv[1];return d?d.selectShapes("regions",b,e):null});a.mkPublic("ChangeRegionTags",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=a.getImage(e.display);d=e.argv[0];var f=e.argv[1];
e=e.argv[2];return b?b.changeRegionTags(d,f,e):null});a.mkPublic("ToggleRegionTags",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=a.getImage(e.display);d=e.argv[0];var f=e.argv[1];e=e.argv[2];return b?b.toggleRegionTags(d,f,e):null});a.mkPublic("UnremoveRegions",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);return(b=a.getImage(b.display))?b.unremoveRegions():null});a.mkPublic("LoadRegions",function(c){for(var b=
[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);var e=a.getImage(d.display),f=function(a,b){b&&void 0!==b.display&&delete b.display;e.addShapes("regions",a,b);e.setStatus("loadRegions","complete");if(h&&h.onload)h.onload(e)};b=d.argv[0];var h=d.argv[1];b||a.error("JS9.LoadRegions: no file specified for regions load");if(e){e.setStatus("loadRegions","processing");if("object"===typeof h)h=$.extend(!0,{},h);else if(h&&"string"===typeof h)try{h=JSON.parse(h)}catch(g){h={}}else h=
{};if("object"===typeof b){if(d=b.path||b.name)h.file=d.split("/").reverse()[0];d=new FileReader;d.onload=function(a){f(a.target.result,h)};d.readAsText(b)}else"string"===typeof b?(h.responseType="text",b=a.fixPath(b,h),h.file=b.split("/").reverse()[0],a.fetchURL(null,b,h,f)):a.error("unknown file type for LoadRegions: "+typeof b)}});a.mkPublic("InstallDir",function(c){return c?a.cleanPath(a.INSTALLDIR+c):""});a.mkPublic("AddDivs",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];
var e,f=a.parsePublicArgs(b);for(b=0;b<f.argv.length;b++)if(e=f.argv[b])if(0===$("#"+e).length)a.DEBUG&&a.log("warning: can't find div, skipping AddDivs(): %s",e);else{for(d=0;d<a.displays.length;d++){var h=a.displays[d];if(h.id===e){var g=!0;break}}g?a.DEBUG&&a.log("warning: div already added, skipping AddDivs(): %s",e):(a.checkNew(new a.Display(e)),a.helper.send("addDisplay",{display:e}))}a.instantiatePlugins()});a.mkPublic("InstantiatePlugins",function(){a.instantiatePlugins()});a.mkPublic("ResizeDisplay",
function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);"string"!==typeof d.argv[0]||a.isNumber(d.argv[0])||"full"===d.argv[0]||"reset"===d.argv[0]||"image"===d.argv[0]?b=a.lookupDisplay(d.display):(b=a.lookupDisplay(d.argv[0]||d.display),d.argv.splice(0,1));b||a.error("invalid display for resize");d=b.resize.apply(b,$jscomp.arrayFromIterable(d.argv));return d===b?a.globalOpts.quietReturn?"":"OK":d});a.mkPublic("SelectDisplay",function(c){for(var b=[],d=0;d<
arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);(b=a.lookupDisplay(b.argv[0]||b.display))||a.error("invalid display for select");a.hasOwnProperty("Menubar")||a.error("Menubar is required for display selection");a.Menubar.onclick(b)});a.mkPublic("GatherDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);switch(d.argv.length){case 0:b=d.display;var e=null;break;case 1:"object"===typeof d.argv[0]||"string"===typeof d.argv[0]&&"{"===
d.argv[0].charAt(0)?(b=d.display,e=d.argv[0]):b=d.argv[0]||d.display;break;default:b=d.argv[0]||d.display,e=d.argv[1]}(b=a.lookupDisplay(b))||a.error("invalid display for gather");b.gather(e)});a.mkPublic("SeparateDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d=a.parsePublicArgs(b);switch(d.argv.length){case 0:b=d.display;var e=null;break;case 1:"object"===typeof d.argv[0]||"string"===typeof d.argv[0]&&"{"===d.argv[0].charAt(0)?(b=d.display,e=d.argv[0]):b=d.argv[0]||
d.display;break;default:b=d.argv[0]||d.display,e=d.argv[1]}(b=a.lookupDisplay(b))||a.error("invalid display for separate");b.separate(b,e)});a.mkPublic("CenterDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);(b=a.lookupDisplay(b.argv[0]||b.display))||a.error("invalid display for center");b.center()});a.mkPublic("RemoveDisplay",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);var e=a.lookupDisplay(b.argv[0]||
b.display);e||a.error("invalid display for remove");b=$.inArray(e,a.displays);if(0<=b){d=e.divjq.closest(".JS9GridContainer");var f=e.divjq.closest(".JS9GridItem");0<d.length&&0<f.length?1<d.find(".JS9GridItem").length?(a.CloseDisplay(e.id),f.remove(),a.displays.splice(b,1)):a.error("can't remove last display in grid: "+e.id):e.winid&&e.winid.close?(a.CloseDisplay(e.id),e.winid.close()):a.error("can only remove displays within a grid or lightwins")}else a.error("can't find display in display list: "+
e.id)});a.mkPublic("SaveSession",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];d={};var e=a.parsePublicArgs(b);b=e.argv[0];var f=e.argv[1];if("object"===typeof b)d=$.extend(!0,{},b);else if("string"===typeof b)try{d=JSON.parse(b)}catch(g){var h=b;if(f)if("object"===typeof f)d=$.extend(!0,{},f);else try{d=JSON.parse(f)}catch(k){d={}}}d.mode||(d.mode="display");b=a.lookupDisplay(e.display?e.display:d.display?d.display:0<a.displays.length?a.displays[0].id:a.DEFID);if(!b.image)return null;
h||(h="display"===d.mode?"js9-"+(new Date).toISOString().slice(0,10)+".ses":b.image.id+".ses");return b.image.saveSession(h,d)});a.mkPublic("LoadSession",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);var e=b.argv[0];var f=b.argv[1];e||a.error("JS9.LoadSession: no file specified for load");if("object"===typeof f)f=$.extend(!0,{},f);else if(f&&"string"===typeof f)try{f=JSON.parse(f)}catch(g){f={}}else f={};var h=a.lookupDisplay(b.display?b.display:f.display?
f.display:0<a.displays.length?a.displays[0].id:a.DEFID);f.display=h.id;"object"===typeof e?(b=new FileReader,b.onload=function(b){b=JSON.parse(b.target.result);f.sessionPath=a.dirname(e.path||e.name||"");h.loadSession(b,f)},b.readAsText(e)):"string"===typeof e?(f.responseType="text",f.display=h.id,e=a.fixPath(e,f),a.fetchURL(null,e,f,function(b,c){b=JSON.parse(b);c.sessionPath=a.dirname(e);h.loadSession(b,c)})):a.error("unknown file type for LoadSession: "+typeof e)});a.mkPublic("SaveCatalog",function(c){for(var b=
[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=a.getImage(e.display);d=e.argv[0];e=e.argv[1];if(b)return b.saveCatalog(d,e)});a.mkPublic("LoadCatalog",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e;b=a.parsePublicArgs(b);var f=b.argv[0];var h=b.argv[1];var g=b.argv[2];f instanceof Blob&&(g=h,h=f,f=null);h||a.error("JS9.LoadCatalog: no file specified for catalog load");if(e=a.getImage(b.display)){e.setStatus("loadCatalog","processing");
if("object"===typeof g)g=$.extend(!0,{},g);else if(g&&"string"===typeof g)try{g=JSON.parse(g)}catch(k){g={}}else g={};if(h instanceof Blob)b=new FileReader,b.onload=function(a){!f&&h.name&&(f=h.name.replace(/\.[^.]*$/,""));e.loadCatalog(f,a.target.result,g);e.setStatus("loadCatalog","complete");if(g&&g.onload)g.onload(e)},b.readAsText(h);else if("string"===typeof h)if(h.match(/\t/)){if(e.loadCatalog(f,h,g),e.setStatus("loadCatalog","complete"),g&&g.onload)g.onload(e)}else g.responseType="text",h=
a.fixPath(h,g),a.fetchURL(null,h,g,function(a){e.loadCatalog(f,a,g);e.setStatus("loadCatalog","complete");if(g&&g.onload)g.onload(e)});else a.error("unknown file type for LoadCatalog: "+typeof h)}});a.mkPublic("CreateMosaic",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=a.lookupDisplay(e.display);d=e.argv[0];e=e.argv[1];if(b)return b.createMosaic(d,e)});a.mkPublic("DisplayPlugin",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];
var e=a.parsePublicArgs(b);d=a.lookupDisplay(e.display);b=e.argv[0];if(d&&e.argv[0]){var f=b.toLowerCase();for(e=0;e<a.plugins.length;e++){var h=a.plugins[e];var g=h.name;if(g===b||g.toLowerCase().substr(-f.length)===f){d.displayPlugin(h);return}}a.error("can't find plugin: "+b)}});a.mkPublic("DisplayHelp",function(c){var b,d=a.lightOpts[a.LIGHTWIN].textWin;if(c){var e=c.split("/").reverse()[0];var f="help_"+a.uniqueID();(b=a.helpOpts[c])?(c=a.InstallDir(b.type+"/"+b.url),a.lightWin(f,"iframe",c,
b.title||e,d)):a.lightWin(f,"iframe",c,e,d)}});a.mkPublic("LightWindow",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];var e=a.parsePublicArgs(b);b=e.argv[0]||"lightWindow"+a.uniqueID();d=e.argv[1]||"inline";var f=e.argv[2],h=e.argv[3]||"JS9 light window";e=e.argv[4]||a.lightOpts[a.LIGHTWIN].textWin;f||a.error("no content specified for LightWindow");return a.lightWin(b,d,f,h,e)});a.mkPublic("WindowPrint",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];
b=a.parsePublicArgs(b);var e={cmd:"print"};window.electron?(b.argv[0]&&(e.opts=b.argv[0]),window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){a.error("could not print window",f)}},a.TIMEOUT)):a.error("WindowPrint is only available for the JS9 desktop app")});a.mkPublic("WindowToPDF",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);var e={cmd:"pdf"};window.electron?(e.filename=b.argv[0]||"js9.pdf",b.argv[1]&&(e.opts=b.argv[1]),window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){a.error("could not create window pdf",
f)}},a.TIMEOUT)):a.error("WindowToPDF is only available for the JS9 desktop app")});a.mkPublic("SaveScript",function(c){for(var b=[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);var e={cmd:"script"};window.electron?(e.filename=b.argv[0]||"js9msg",window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){a.error("could not create messaging script",f)}},a.TIMEOUT)):a.error("SaveScript is only available for the JS9 desktop app")});a.mkPublic("SaveDir",function(c){for(var b=
[],d=0;d<arguments.length;++d)b[d-0]=arguments[d];b=a.parsePublicArgs(b);var e={cmd:"savedir"};window.electron?(void 0!==b.argv[0]?(e.dirname=b.argv[0],b.argv[1]&&(e.opts=b.argv[1])):a.error("SaveDir requires a directory name"),window.setTimeout(function(){try{window.electron.sendMsg(e)}catch(f){a.error("could not set save directory",f)}},a.TIMEOUT)):a.error("SaveDir is only available for the JS9 desktop app")});a.init=function(){var c;window.HTMLCanvasElement&&JSON||a.error("your browser does not support JS9 (no HTML5 canvas and/or JSON). Please try a modern version of Firefox, Chrome, Safari, Opera, or Edge.");
window.hasOwnProperty("JS9Prefs")&&"object"===typeof JS9Prefs&&JS9Prefs.globalOpts&&JS9Prefs.globalOpts.installDir&&(a.INSTALLDIR=JS9Prefs.globalOpts.installDir);if(!a.INSTALLDIR){try{$('link[href$="js9.css"]').each(function(b,c){(b=$(c).attr("href"))&&"js9.css"===b.split("/").reverse()[0]&&(a.INSTALLDIR=b.replace(/js9\.css$/,""))})}catch(g){a.INSTALLDIR=""}a.INSTALLDIR&&(a.INSTALLDIR=a.cleanPath(a.INSTALLDIR))}a.INSTALLDIR&&"/"!==a.INSTALLDIR.slice(-1)&&(a.INSTALLDIR+="/");a.TOROOT=a.INSTALLDIR.replace(/([^/.])+/g,
"..");window.hasOwnProperty("JS9Inline")&&"object"===typeof JS9Inline&&(a.inline=$.extend(!0,{},JS9Inline));"dhtml"===a.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),dhtmlwindow.imagefiles=a.inline?[a.inline["images/min.gif"],a.inline["images/close.gif"],a.inline["images/restore.gif"],a.inline["images/resize.gif"]]:a.allinone?[a.allinone.min,a.allinone.close,a.allinone.restore,a.allinone.resize]:[a.InstallDir("images/min.gif"),
a.InstallDir("images/close.gif"),a.InstallDir("images/restore.gif"),a.InstallDir("images/resize.gif")],window.hasOwnProperty("Jupyter")&&$(a.lightOpts[a.LIGHTWIN].topid).arrive("input",function(b){a.jupyterFocus($(b).parent())}));a.globalOpts.plotLibrary=a.globalOpts.plotLibrary||"flot";"plotly"!==a.globalOpts.plotLibrary||window.hasOwnProperty("Plotly")||(a.globalOpts.plotLibrary="flot");window.hasOwnProperty("JS9Prefs")&&"object"===typeof JS9Prefs?a.mergePrefs(JS9Prefs):a.PREFSFILE&&(a.loadPrefs(a.InstallDir(a.PREFSFILE),
0),a.loadPrefs(a.PREFSFILE,0));a.hasOwnProperty("Regions")&&$.extend(!0,a.Regions.opts,a.regionOpts);delete a.regionOpts;a.hasOwnProperty("Catalogs")&&$.extend(!0,a.Catalogs.opts,a.catalogOpts);delete a.catalogOpts;a.hasOwnProperty("Crosshair")&&$.extend(!0,a.Crosshair.opts,a.crosshairOpts);delete a.crosshairOpts;a.hasOwnProperty("Grid")&&$.extend(!0,a.Grid.opts,a.gridOpts);delete a.gridOpts;a.hasOwnProperty("Module")&&$.extend(!0,Module,a.emscriptenOpts);delete a.emscriptenOpts;a.globalOpts.resize||
(a.globalOpts.resizeHandle=!1);void 0!==a.analOpts.prependJS9Dir&&(a.globalOpts.prependJS9Dir=a.analOpts.prependJS9Dir,delete a.analOpts.prependJS9Dir);void 0!==a.analOpts.dataDir&&(a.globalOpts.dataDir=a.analOpts.dataDir,delete a.analOpts.dataDir);void 0!==a.globalOpts.regionsToClipboard&&void 0===a.globalOpts.regToClipboard&&(a.globalOpts.regToClipboard=a.globalOpts.regionsToClipboard,delete a.globalOpts.regionsToClipboard);void 0!==a.globalOpts.regionDisplay&&void 0===a.globalOpts.regDisplay&&
(a.globalOpts.regDisplay=a.globalOpts.regionDisplay,delete a.globalOpts.regionDisplay);void 0!==a.globalOpts.regionConfigSize&&void 0===a.globalOpts.regConfigSize&&(a.globalOpts.regConfigSize=a.globalOpts.regionConfigSize,delete a.globalOpts.regionConfigSize);void 0!==a.globalOpts.regionTemplates&&void 0===a.globalOpts.regTemplates&&(a.globalOpts.regTemplates=a.globalOpts.regionTemplates,delete a.globalOpts.regionTemplates);a.BROWSER[3]&&(a.globalOpts.resizeHandle=!1);if(window.hasOwnProperty("localStorage")&&
a.globalOpts.localStorage){try{var b=localStorage.getItem("globals")}catch(g){b=null}if(b){try{a.userOpts.displays=JSON.parse(b)}catch(g){}a.userOpts.displays&&$.extend(!0,a.globalOpts,a.userOpts.displays)}try{b=localStorage.getItem("images")}catch(g){b=null}if(b){try{a.userOpts.images=JSON.parse(b)}catch(g){}a.userOpts.images&&$.extend(!0,a.imageOpts,a.userOpts.images)}try{b=localStorage.getItem("fits")}catch(g){b=null}if(b)try{a.userOpts.fits=JSON.parse(b)}catch(g){}try{b=localStorage.getItem("regions")}catch(g){b=
null}if(b){try{a.userOpts.regions=JSON.parse(b)}catch(g){}a.userOpts.regions&&$.extend(!0,a.Regions.opts,a.userOpts.regions)}try{b=localStorage.getItem("grid")}catch(g){b=null}if(b){try{a.userOpts.images=JSON.parse(b)}catch(g){}a.userOpts.images&&$.extend(!0,a.Grid.opts,a.userOpts.images)}try{b=localStorage.getItem("catalog")}catch(g){b=null}if(b){try{a.userOpts.images=JSON.parse(b)}catch(g){}a.userOpts.images&&$.extend(!0,a.Catalogs.Opts,a.userOpts.images)}}a.DEBUG=a.DEBUG||a.globalOpts.debug||0;
$("div.JS9").each(function(b,c){a.checkNew(new a.Display($(c)))});if(window.Worker&&!a.allinone)try{a.worker=new a.WebWorker(a.InstallDir(a.WORKERFILE))}catch(g){}a.allinone?a.initFITS():a.initEmscripten();window.electron&&(a.globalOpts.helperType="nodejs");a.helper=new a.Helper;window.addEventListener("message",function(b){var c=b.origin||b.originalEvent.origin;b=b.data;"null"===c&&(c="unknown");if(a.globalOpts.postMessage){if("string"===typeof b)try{var d=JSON.parse(b)}catch(m){a.error("can't parse msg: "+
b,m)}else"object"===typeof b?d=b:a.error("invalid msg from postMessage");a.msgHandler(d,function(a,b,c,e){e=e||{};parent.postMessage({cmd:d.cmd,res:{name:e.name,rtype:e.rtype,rdata:a,stdout:a,stderr:b,errcode:c}},"*")})}else a.DEBUG&&(c="JS9 ignoring postMessage, origin: "+c,c="string"===typeof b?c+(" data: "+b):"object"===typeof b?c+(" obj: "+JSON.stringify(Object.keys(b))):c+(" typeof: "+typeof b),a.log(c))},!1);window.hasOwnProperty("ImageFilters")&&(a.ImageFilters=ImageFilters);a.initColormaps();
a.initCommands();a.initAnalysis();a.RegisterPlugin(a.MouseTouch.CLASS,a.MouseTouch.NAME,a.MouseTouch.init,{menuItem:"Mouse/Touch",onplugindisplay:a.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,winDims:[a.MouseTouch.WIDTH,a.MouseTouch.HEIGHT]});a.RegisterPlugin(a.Regions.CLASS,a.Regions.NAME,a.Regions.init,{divArgs:["regions"],winDims:[0,0]});a.RegisterPlugin(a.Crosshair.CLASS,a.Crosshair.NAME,a.Crosshair.init,{onmousemove:a.Crosshair.display,onkeyboardaction:a.Crosshair.keyaction,
onkeyup:a.Crosshair.keyup,onimageload:a.Crosshair.create,winDims:[0,0]});a.RegisterPlugin(a.Grid.CLASS,a.Grid.NAME,a.Grid.init,{onsetpan:a.Grid.regrid,onsetzoom:a.Grid.regrid,onsetwcssys:a.Grid.regrid,onsetwcsunits:a.Grid.regrid,onimageload:a.Grid.regrid,onupdateprefs:a.Grid.regrid,winDims:[0,0]});a.RegisterPlugin(a.Dysel.CLASS,a.Dysel.NAME,a.Dysel.init,{onimageload:a.Dysel.imageload,onimageclose:a.Dysel.imageclose,winDims:[0,0]});a.RegisterPlugin(a.Titlebar.CLASS,a.Titlebar.NAME,a.Titlebar.init,
{onimageload:a.Titlebar.imageload,onimagedisplay:a.Titlebar.imagedisplay,onimageclose:a.Titlebar.imageclose,winDims:[0,0]});a.instantiatePlugins();a.plugins.sort(function(a,b){a=a.opts.menuItem;b=b.opts.menuItem;return a?!b||a<b?-1:a>b?1:0:1});if(a.globalOpts.processQueryParams&&(c=new URL(window.location),c.searchParams)){b={};c=$jscomp.makeIterator(c.searchParams);for(var d=c.next();!d.done;d=c.next()){var e=$jscomp.makeIterator(d.value);d=e.next().value;e=e.next().value;switch(d){case "url":case "file":var f=
e;break;case "display":var h={display:e};break;default:b[d]=e}}f&&(h?a.Preload(f,b,h):a.Preload(f,b))}$(document).scrollTop(0);a.inited=!0;$(document).trigger("JS9:init")};return a}();
$(document).ready(function(){$(document).on("JS9:ready",function(){JS9.readied||(JS9.readied=!0,JS9.Preload(!0))});$(document).on("JS9:init",function(){JS9.helper.ready&&JS9.fits.ready&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("astroem:ready",function(){JS9.initFITS();if(window.electron&&JS9.hostFS)try{JS9.vmount("/",JS9.hostFS)||delete JS9.hostFS}catch(a){delete JS9.hostFS}JS9.helper.ready&&JS9.inited&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("JS9:helperReady",
function(){JS9.fits.ready&&JS9.inited&&!JS9.readied&&$(document).trigger("JS9:ready",{status:"OK"})});0===$('div[data-js9init="false"]').length&&JS9.init()});
